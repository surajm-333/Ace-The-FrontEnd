/**
 * @license
 * Copyright (c) 2017 Dailymotion (http://www.dailymotion.com)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * src/remux/mp4-generator.js and src/demux/exp-golomb.js implementation in this project
 * are derived from the HLS library for video.js (https://github.com/videojs/videojs-contrib-hls)
 *
 * That work is also covered by the Apache 2 License, following copyright:
 * Copyright (c) 2013-2015 Brightcove
 *
 * src/utils/url-toolkit.js implementation in this project
 * is derived from the url-toolkit library (https://github.com/tjenkinson/url-toolkit)
 *
 * That work is also covered by the Apache 2 License, following copyright:
 * Copyright (c) 2016 Tom Jenkinson
 */
/*! Modules included in this bundle:
* name: rxjs
*  license: Apache-2.0
*  version: 7.0.0-beta.5
* 
* name: events
*  license: MIT
*  version: 3.2.0
*  text:
*  MIT
*  
*  Copyright Joyent, Inc. and other Node contributors.
*  
*  Permission is hereby granted, free of charge, to any person obtaining a
*  copy of this software and associated documentation files (the
*  "Software"), to deal in the Software without restriction, including
*  without limitation the rights to use, copy, modify, merge, publish,
*  distribute, sublicense, and/or sell copies of the Software, and to permit
*  persons to whom the Software is furnished to do so, subject to the
*  following conditions:
*  
*  The above copyright notice and this permission notice shall be included
*  in all copies or substantial portions of the Software.
*  
*  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
*  OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
*  NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
*  DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
*  OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
*  USE OR OTHER DEALINGS IN THE SOFTWARE.
*  
* name: typescript
*  license: Apache-2.0
*  version: 3.9.7
* 
* name: util
*  license: MIT
*  version: 0.11.1
*  text:
*  Copyright Joyent, Inc. and other Node contributors. All rights reserved.
*  Permission is hereby granted, free of charge, to any person obtaining a copy
*  of this software and associated documentation files (the "Software"), to
*  deal in the Software without restriction, including without limitation the
*  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
*  sell copies of the Software, and to permit persons to whom the Software is
*  furnished to do so, subject to the following conditions:
*  
*  The above copyright notice and this permission notice shall be included in
*  all copies or substantial portions of the Software.
*  
*  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
*  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
*  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
*  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
*  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
*  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
*  IN THE SOFTWARE.
*  
* name: tslib
*  license: 0BSD
*  version: 1.13.0
* 
* name: inherits
*  license: ISC
*  version: 2.0.3
*  text:
*  The ISC License
*  
*  Copyright (c) Isaac Z. Schlueter
*  
*  Permission to use, copy, modify, and/or distribute this software for any
*  purpose with or without fee is hereby granted, provided that the above
*  copyright notice and this permission notice appear in all copies.
*  
*  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
*  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND
*  FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
*  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
*  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
*  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
*  PERFORMANCE OF THIS SOFTWARE.
*  
*  
* name: webworkify-webpack
*  license: MIT
*  version: 2.1.5
* 
*/
!(function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("Hls",[],t):"object"==typeof exports?exports.Hls=t():e.Hls=t()})(window,(function(){return (function(e){function t(t){for(var i,s,a=t[0],n=t[1],o=0,d=[];o<a.length;o++)s=a[o],Object.prototype.hasOwnProperty.call(r,s)&&r[s]&&d.push(r[s][0]),r[s]=0;for(i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);for(l&&l(t);d.length;)d.shift()()}var i={},r={0:0};function s(t){if(i[t])return i[t].exports;var r=i[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.e=function(){return Promise.resolve()},s.m=e,s.c=i,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(i,r,function(t){return e[t]}.bind(null,r));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s.oe=function(e){throw console.error(e),e};var a=window.webpackJsonpHls=window.webpackJsonpHls||[],n=a.push.bind(a);a.push=t,a=a.slice();for(var o=0;o<a.length;o++)t(a[o]);var l=n;return s(s.s=28)})([(function(e,t,i){"use strict";var r;i.d(t,"e",(function(){return r})),i.d(t,"o",(function(){return s})),i.d(t,"q",(function(){return a})),i.d(t,"t",(function(){return n})),i.d(t,"l",(function(){return o})),i.d(t,"i",(function(){return l})),i.d(t,"r",(function(){return d})),i.d(t,"h",(function(){return h})),i.d(t,"a",(function(){return c})),i.d(t,"g",(function(){return u})),i.d(t,"d",(function(){return f})),i.d(t,"f",(function(){return g})),i.d(t,"n",(function(){return p})),i.d(t,"k",(function(){return m})),i.d(t,"j",(function(){return y})),i.d(t,"u",(function(){return v})),i.d(t,"b",(function(){return b})),i.d(t,"p",(function(){return S})),i.d(t,"s",(function(){return T})),i.d(t,"m",(function(){return E})),i.d(t,"c",(function(){return _})),(function(e){e.Upgraded="Upgraded",e.Downgraded="Downgraded"})(r||(r={}));class s extends Error{constructor(e,t,i,r){super(r),this.type=e,this.details=t,this.fatal=i,this.reason=r}}class a extends s{constructor(e,t,i,r,s,a,n,o,l){super(e,t,i,r),this.decryptdata=a,this.stats=n,this.levelIds=o,this.keyErrorReason=l,this.response=s,this.decryptdata=a,this.stats=n,this.levelIds=o,this.keyErrorReason=l}}class n extends s{constructor(e,t,i,r,s){super(e,t,i,r),this.response=s}}class o extends s{constructor(e,t,i,r,s){super(e,t,i,r),this.frag=s}}class l extends s{constructor(e,t,i,r){super(e,t,i,r)}}class d extends s{constructor(e,t,i,r,s,a,n){super(e,t,i,r),this.response=s,this.bytes=a,this.frag=n}}class h extends s{constructor(e,t,i,r){super(e,t,i,r)}}class c extends Error{constructor(e){super(e)}}const u={NETWORK_ERROR:"networkError",MEDIA_ERROR:"mediaError",MUX_ERROR:"muxError",KEY_SYSTEM_ERROR:"keySystemError",OTHER_ERROR:"otherError"},f={MANIFEST_LOAD_ERROR:"manifestLoadError",MANIFEST_LOAD_TIMEOUT:"manifestLoadTimeOut",MANIFEST_PARSING_ERROR:"manifestParsingError",MANIFEST_INCOMPATIBLE_CODECS_ERROR:"manifestIncompatibleCodecsError",MANIFEST_INCOMPATIBLE_VIDEO_RANGE_ERROR:"manifestIncompatibleVideoRangeError",LEVEL_LOAD_ERROR:"levelLoadError",LEVEL_LOAD_TIMEOUT:"levelLoadTimeOut",LEVEL_SWITCH_ERROR:"levelSwitchError",AUDIO_TRACK_LOAD_ERROR:"audioTrackLoadError",AUDIO_TRACK_LOAD_TIMEOUT:"audioTrackLoadTimeOut",SUBTITLE_TRACK_LOAD_ERROR:"subtitleTrackLoadError",SUBTITLE_TRACK_LOAD_TIMEOUT:"subtitleTrackLoadTimeout",FRAG_LOAD_ERROR:"fragLoadError",FRAG_LOOP_LOADING_ERROR:"fragLoopLoadingError",FRAG_LOAD_TIMEOUT:"fragLoadTimeOut",FRAG_DECRYPT_ERROR:"fragDecryptError",FRAG_PARSING_ERROR:"fragParsingError",REMUX_ALLOC_ERROR:"remuxAllocError",BUFFER_ADD_CODEC_ERROR:"bufferAddCodecError",BUFFER_APPEND_ERROR:"bufferAppendError",BUFFER_STALLED_ERROR:"bufferStalledError",BUFFER_FULL_ERROR:"bufferFullError",BUFFER_SEEK_OVER_HOLE:"bufferSeekOverHole",BUFFER_NUDGE_ON_STALL:"bufferNudgeOnStall",INTERNAL_EXCEPTION:"internalException",WEBVTT_EXCEPTION:"webVTTException",KEY_LOAD_ERROR:"keyLoadError",KEY_LOAD_TIMEOUT:"keyLoadTimeOut",KEY_SYSTEM_GENERIC_ERROR:"keySystemGenericError",CERT_LOAD_ERROR:"certificateLoadError",CERT_LOAD_TIMEOUT:"certificateLoadTimeOut",SESSION_DATA_LOAD_ERROR:"sessionDataLoadError",SESSION_DATA_LOAD_TIMEOUT:"sessionDataLoadTimeOut"},g={PlaylistNotReceived:{code:-12884,text:"Playlist not received"},CryptResponseReceivedSlowly:{code:-16833,text:"Crypt key received slowly"},LivePlaylistUpdateError:{code:-12888,text:"Live playlist not updated"},NoResponseFromMediaRequest:{code:-12889,text:"No response for fragment"},IncompatibleAsset:{code:-12927,text:"IncompatibleAsset"},CorruptStream:{code:-16041,text:"Corrupt fragment"},InternalError:{code:-12645,text:"InternalException"},CantSwitchInTime:{code:-12644,text:"CantSwitchInTime"},VideoDecoderBadDataErr:{code:-12909,text:"Buffer error"},InsufficientDataAvailable:{code:-12928,text:"Incomplete data"},AllocationFailed:{code:-12862,text:"AllocationFailed"},PlaylistErrorMissingEXTM3U:{code:-12269,text:"Response doesnt have #EXTM3U tag"},PlaylistErrorInvalidEntry:{code:-12264,text:"Invalid entry"},PlaylistErrorBadTargetDuration:{code:-12271,text:"Invalid targetduration"},NoValidAlternates:{code:-12925,text:"No valid alternates"},FormatError:{code:-12642,text:"Incorrect playlist format"}},p={SeekToUnbufferedTimeRanges:"SeekToUnbufferedTimeRanges",InvalidFormat:"InvalidFormat",FatalErrorWhileLoading:"FatalErrorWhileLoading",ApplicationInitiated:"ApplicationInitiated"};class m extends s{constructor(e){super(u.OTHER_ERROR,f.INTERNAL_EXCEPTION,!1,e)}}class y extends s{constructor(e,t,i){super(u.MEDIA_ERROR,f.FRAG_LOOP_LOADING_ERROR,t,e),this.frag=i,this.response=g.CorruptStream,this.frag=i}}class v extends s{constructor(e,t,i,r){super(u.MEDIA_ERROR,e,t,i),this.response=r}}class b extends v{constructor(e,t,i,r,s,a){super(e,t,i,r),this.parent=s,this.maxTotalBytes=a}}class S extends s{constructor(e,t,i,r,s){super(u.NETWORK_ERROR,e,t,i),this.isTimeout=s,this.response={code:r,text:i}}}class T extends S{constructor(e,t,i,r,s,a,n){switch(super("",e,t,i,r),this.loaderType=s,this.url=a,this.variantId=n,s){case"manifest":this.details=r?f.MANIFEST_LOAD_TIMEOUT:f.MANIFEST_LOAD_ERROR;break;case"level":this.details=r?f.LEVEL_LOAD_TIMEOUT:f.LEVEL_LOAD_ERROR;break;case"audioTrack":this.details=r?f.AUDIO_TRACK_LOAD_TIMEOUT:f.AUDIO_TRACK_LOAD_ERROR;break;case"subtitleTrack":this.details=r?f.SUBTITLE_TRACK_LOAD_TIMEOUT:f.SUBTITLE_TRACK_LOAD_ERROR}}}class E extends S{constructor(e,t,i,r,s){super(r?f.FRAG_LOAD_TIMEOUT:f.FRAG_LOAD_ERROR,e,t,i,r),this.frag=s}}class _ extends s{constructor(e,t,i,r,s,a,n){super(u.MEDIA_ERROR,e,t,i),this.stallType=s,this.buffer=a,this.hole=n,this.response=r}}}),(function(e,t,i){"use strict";var r;i.d(t,"a",(function(){return r})),(function(e){e.MEDIA_ATTACHING="hlsMediaAttaching",e.MEDIA_ATTACHED="hlsMediaAttached",e.MEDIA_DETACHING="hlsMediaDetaching",e.MEDIA_DETACHED="hlsMediaDetached",e.BUFFER_CREATED="hlsBufferCreated",e.BUFFER_APPENDING="hlsBufferAppending",e.BUFFER_APPENDED="hlsBufferAppended",e.BUFFER_FLUSHED="hlsBufferFlushed",e.BUFFER_SOURCE_RESETTING="hlsBufferSourceResetting",e.BUFFER_SOURCE_RESET="hlsBufferSourceReset",e.MANIFEST_LOADING="hlsManifestLoading",e.MANIFEST_LOADED="hlsManifestLoaded",e.MANIFEST_PARSED="hlsManifestParsed",e.LEVEL_SWITCHING="hlsLevelSwitching",e.LEVEL_SWITCHED="hlsLevelSwitched",e.LEVEL_LOADING="hlsLevelLoading",e.LEVEL_LOADED="hlsLevelLoaded",e.LEVEL_UPDATED="hlsLevelUpdated",e.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",e.LEVELS_CHANGED="hlsLevelsChanged",e.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",e.AUDIO_TRACK_SWITCH="hlsAudioTrackSwitch",e.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",e.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",e.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",e.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",e.SUBTITLE_TRACKS_CREATED="hlsSubtitleTracksCreated",e.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",e.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",e.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",e.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",e.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",e.INLINE_STYLES_PARSED="hlsInlineStylesParsed",e.SESSION_DATA_PARSED="hlsSessionDataParsed",e.SESSION_DATA_LOADING="hlsSessionDataLoading",e.SESSION_DATA_LOADED="hlsSessionDataLoaded",e.SESSION_DATA_COMPLETE="hlsSessionDataComplete",e.INIT_PTS_FOUND="hlsInitPtsFound",e.FRAG_LOADING="hlsFragLoading",e.FRAG_LOAD_PROGRESS="hlsFragLoadProgress",e.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",e.FRAG_LOADED="hlsFragLoaded",e.FRAG_DECRYPTED="hlsFragDecrypted",e.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",e.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",e.FRAG_PARSING_CAPTIONDATA="hlsFragParsingCaptiondata",e.FRAG_PARSING_METADATA="hlsFragParsingMetadata",e.FRAG_PARSING_DATA="hlsFragParsingData",e.FRAG_PARSED="hlsFragParsed",e.FRAG_BUFFERED="hlsFragBuffered",e.FRAG_CHANGED="hlsFragChanged",e.FPS_DROP="hlsFpsDrop",e.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",e.INTERNAL_ERROR="hlsInternalError",e.ERROR="hlsError",e.DESTROYING="hlsDestroying",e.KEY_REQUEST_STARTED="hlsKeyRequestStarted",e.LICENSE_CHALLENGE_CREATED="hlsLicenseChallengeCreated",e.KEY_LOADED="hlsKeyLoaded",e.STREAM_STATE_TRANSITION="hlsStreamStateTransition",e.LICENSE_RELEASED="hlsLicenseReleased",e.UNRESOLVED_URI_LOADING="hlsUnresolvedUriLoading",e.UNRESOLVED_URI_LOADED="hlsUnresolvedUriLoaded",e.DESIRED_RATE_CHANGED="hlsDesiredRateChanged",e.PLAYER_STATE_CHANGE="hlsPlayerStateChange",e.SEEKING="hlsSeeking",e.SEEKED="hlsSeeked",e.BANDWIDTH_CHANGED="hlsBandwidthChanged",e.BUFFER_CHANGED="hlsBufferChanged",e.STALLED="hlsStalled",e.RESUME_FROM_STALL="hlsResumeFromStall",e.PREFERRED_HOST_CHANGED="hlsPreferredHostChanged",e.READY_FOR_NEXT_ITEM="hlsReadyForNextItem",e.ITEM_TRANSITIONED="hlsItemTransitioned",e.ITEM_EVICTED="hlsItemEvicted",e.DATERANGE_UPDATED="hlsDaterangeUpdated"})(r||(r={})),t.b=r}),(function(e,t,i){"use strict";i.d(t,"c",(function(){return a})),i.d(t,"a",(function(){return n}));const r=new Set(["ac-3","mp4a.a5","mp4a.A5"]),s=new Set(["ec-3","mp4a.a6","mp4a.A6"]);function a(e){return"number"==typeof e&&isFinite(e)}const n={aac:1024,mp3:1024,ac3:1536,ec3:1536},o={isAC3:function(e){return Boolean(e&&r.has(e))},isEC3:function(e){return Boolean(e&&s.has(e))},isDolbyAtmos:function(e,t){let i=t.split("/");return Boolean(o.isEC3(e)&&i.length>1&&"JOC"===i[1])},isAAC:function(e){let t;return Boolean(e&&("aac"===e||null!==(t=e.match(/^mp4a\.40\.(.*)/))&&"34"!==t[1]))},isMP3:function(e){let t;return Boolean(e&&("mp3"===e||null!==(t=e.match(/^mp4a\.40\.(.*)/))&&"34"===t[1]))},isxHEAAC:function(e){return Boolean(e&&("xheaac"===e||"mp4a.40.42"===e))},isALAC:function(e){return Boolean(e&&"alac"===e)},isFLAC:function(e){return Boolean(e&&"fLaC"===e)},isAVC:function(e){return Boolean(e&&e.match(/^avc[13]\.(.*)/))},isHEVC:function(e){return Boolean(e&&e.match(/^(hev|hvc)1\..*/))},isDolby:function(e){return Boolean(e&&e.match(/^dv(h1|he|a1|av)\..*/))},isVP09:function(e){return Boolean(e&&e.match(/^vp09\..*/))},isCompatibleCodecString:function(e,t){let i=e.split(","),r=t.split(","),s=i.filter(e=>o.isVideoCodec(e)),a=r.filter(e=>o.isVideoCodec(e)),n=i.filter(e=>o.isAudioCodec(e)),l=r.filter(e=>o.isAudioCodec(e)),d=0===s.length&&0===a.length||s.length===a.length&&o.isCompatibleVideoCodec(s[0],a[0]),h=0===n.length&&0===l.length||n.length===l.length&&o.isCompatibleAudioCodec(n[0],l[0]);return d&&h},isVideoCodec:function(e){return o.isAVC(e)||o.isDolby(e)||o.isHEVC(e)||o.isVP09(e)},isAudioCodec:function(e){return o.isAC3(e)||o.isEC3(e)||o.isAAC(e)||o.isMP3(e)||o.isxHEAAC(e)||o.isALAC(e)||o.isFLAC(e)},isCompatibleVideoCodec:function(e,t){return Boolean(e&&t&&(e===t||o.isDolby(e)&&o.isDolby(t)||o.isHEVC(e)&&o.isHEVC(t)||o.isAVC(e)&&o.isAVC(t)||o.isVP09(e)&&o.isVP09(t)))},isCompatibleAudioCodec:function(e,t){return Boolean(e&&t&&(e===t||o.isAAC(e)&&o.isAAC(t)||o.isAC3(e)&&o.isAC3(t)||o.isEC3(e)&&o.isEC3(t)||o.isMP3(e)&&o.isMP3(t)||o.isALAC(e)&&o.isALAC(t)||o.isFLAC(e)&&o.isFLAC(t)||o.isxHEAAC(e)&&o.isxHEAAC(t)))},getSegmentCodec:function(e){let t;if(o.isAAC(e))t="aac";else if(o.isAC3(e))t="ac3";else if(o.isEC3(e))t="ec3";else{if("mp3"!==e)throw"invalid audio config, codec "+e;t="mp3"}return t},getChannelCount:function(e){if(!e)return 0;let t=e.split("/"),i=parseInt(t[0]);return a(i)?i:0}};t.b=o}),(function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));const r=()=>r;function s(e){return e<10?"0"+e:e.toString()}const a=["debug","log","info","warn","error"];class n{constructor(){this._enabled={},this.streamAndSessionIDStr=""}_fn(e,...t){return"function"!=typeof this._enabled[e]?r:(t=[`${(function(){const e=new Date,t=e.getTimezoneOffset(),i=s(Math.floor(Math.abs(t)/60)),r=s(Math.abs(t)%60);let a=t<=0?"UTC+"+i:"UTC-"+i;return a=r?a+":"+r:a,e.getFullYear()+"-"+s(e.getMonth()+1)+"-"+s(e.getDate())+" "+s(e.getHours())+":"+s(e.getMinutes())+":"+s(e.getSeconds())+"."+(e.getMilliseconds()/1e3).toFixed(3).slice(2,5)+" "+a})()}${this.streamAndSessionIDStr} | [${e}] >`,...t],this._enabled[e].bind(this,t.map(e=>"string"==typeof e?e:e&&"function"==typeof e.toString?e.toString():Object.prototype.toString.call(e)).join(" ")))}trace(...e){return this._fn("trace",...e)}debug(...e){return this._fn("debug",...e)}log(...e){return this._fn("log",...e)}info(...e){return this._fn("info",...e)}warn(...e){return this._fn("warn",...e)}error(...e){return this._fn("error",...e)}_set(e,t){this._enabled[e]=t||console[e]}enable(e,t){e&&(this._enabled={},(null!=t&&a.indexOf(t)>=0?a.slice(a.indexOf(t)):a).forEach(t=>this._set(t,"boolean"!=typeof e&&e[t]||console[t])))}setStreamAndSessionIDs(e,t){this.sessionID=e,this.streamID=t,this.streamAndSessionIDStr=this.getStreamAndSessionIDString()}getStreamAndSessionIDString(){return(this.sessionID?"| [SessionID: "+this.sessionID.slice(0,8):"")+(this.streamID?", StreamID: "+this.streamID+"]":"]")}}const o=new n;o.enable("undefined"==typeof globalHlsLogConfig||globalHlsLogConfig),t.b=o}),(function(e,t,i){"use strict";var r=i(2);const s=Math.pow(2,32)-1;class a{static init(){var e;for(e in a.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],free:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],dec3:[],"ec-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[],uuid:[],encv:[],enca:[],frma:[],schm:[],schi:[],senc:[],saio:[],saiz:[],sinf:[],tenc:[],sbgp:[],seig:[],sgpd:[],pssh:[]},a.types)a.types.hasOwnProperty(e)&&(a.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);var t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);a.HDLR_TYPES={video:t,audio:i};var r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),s=new Uint8Array([0,0,0,0,0,0,0,0]);a.STTS=a.STSC=a.STCO=s,a.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),a.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),a.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),a.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var n=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);a.FTYP=a.box(a.types.ftyp,n,l,n,o),a.DINF=a.box(a.types.dinf,a.box(a.types.dref,r))}static set16(e,t,i){return t[i]=e>>8&255,t[i+1]=255&e,i+2}static set32(e,t,i){return t[i]=e>>24&255,t[i+1]=e>>16&255,t[i+2]=e>>8&255,t[i+3]=255&e,i+4}static box(e,...t){for(var i,r=Array.prototype.slice.call(arguments,1),s=8,a=r.length,n=a;a--;)s+=r[a].byteLength;for((i=new Uint8Array(s))[0]=s>>24&255,i[1]=s>>16&255,i[2]=s>>8&255,i[3]=255&s,i.set(e,4),a=0,s=8;a<n;a++)i.set(r[a],s),s+=r[a].byteLength;return i}static hdlr(e){return a.box(a.types.hdlr,a.HDLR_TYPES[e])}static mdat(e){return a.box(a.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(s+1)),r=Math.floor(t%(s+1));return a.box(a.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r,85,196,0,0]))}static mdia(e){let t=a.mdhd(e.info.timescale,e.info.duration),i=a.hdlr(e.type),r=a.minf(e);return a.box(a.types.mdia,t,i,r)}static mfhd(e){return a.box(a.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?a.box(a.types.minf,a.box(a.types.smhd,a.SMHD),a.DINF,a.stbl(e)):a.box(a.types.minf,a.box(a.types.vmhd,a.VMHD),a.DINF,a.stbl(e))}static moof(e,t){a.types||a.init();let i=a.traf(t,e);return a.box(a.types.moof,a.mfhd(t.sequenceNumber),i)}static moov(e){for(var t=e.length,i=[];t--;)i[t]=a.trak(e[t]);return a.box.apply(null,[a.types.moov,a.mvhd(e[0].info.timescale,e[0].info.duration)].concat(i).concat(a.mvex(e)))}static mvex(e){for(var t=e.length,i=[];t--;)i[t]=a.trex(e[t]);return a.box(a.types.mvex,...i)}static mvhd(e,t){t*=e;const i=Math.floor(t/(s+1)),r=Math.floor(t%(s+1));var n=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return a.box(a.types.mvhd,n)}static sdtp(e){var t,i,r=e.samples||[],s=new Uint8Array(4+r.length);for(i=0;i<r.length;i++)t=r[i].flags,s[i+4]=t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;return a.box(a.types.sdtp,s)}static stbl(e){let t=a.stsd(e),i=a.box(a.types.stts,a.STTS),r=a.box(a.types.stsc,a.STSC),s=a.box(a.types.stsz,a.STSZ),n=a.box(a.types.stco,a.STCO);return a.box(a.types.stbl,t,i,r,s,n)}static avc1(e){var t,i,r,s=[],n=[];let o=e.info.encrypted?a.types.encv:a.types.avc1;for(t=0;t<e.config.sps.length;t++)r=(i=e.config.sps[t]).byteLength,s.push(r>>>8&255),s.push(255&r),s=s.concat(Array.prototype.slice.call(i));for(t=0;t<e.config.pps.length;t++)r=(i=e.config.pps[t]).byteLength,n.push(r>>>8&255),n.push(255&r),n=n.concat(Array.prototype.slice.call(i));var l=a.box(a.types.avcC,new Uint8Array([1,s[3],s[4],s[5],255,224|e.config.sps.length].concat(s).concat([e.config.pps.length]).concat(n))),d=e.config.width,h=e.config.height,c=e.config.pixelRatio[0],u=e.config.pixelRatio[1],f=e.info.encrypted&&e.info.decryptdata?a.sinf(e.info.decryptdata,e.type,a.types.avc1):new Uint8Array;return a.box(o,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,d>>8&255,255&d,h>>8&255,255&h,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l,f,a.box(a.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),a.box(a.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,255&c,u>>24,u>>16&255,u>>8&255,255&u])))}static esds(e){var t=e.esdsConfig.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.esdsConfig).concat([6,1,2]))}static audioStsd(e){var t=e.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0])}static dac3(e){let t=e.extraData;return new Uint8Array([t>>16&255,t>>8&255,255&t])}static dec3(e){return e.extraDataBytes}static mp4a(e,t){let i=a.types.mp4a,r=null;e.encrypted&&e.decryptdata?(i=a.types.enca,r=a.sinf(e.decryptdata,"audio",a.types.mp4a)):r=new Uint8Array;let s=a.audioStsd(t),n=a.box(a.types.esds,a.esds(t));return a.box(i,s,n,r)}static mp3(e){return a.box(a.types[".mp3"],a.audioStsd(e))}static ac3(e,t){let i=a.types["ac-3"],r=null;return e.encrypted&&e.decryptdata?(i=a.types.enca,r=a.sinf(e.decryptdata,"audio",a.types["ac-3"])):r=new Uint8Array,a.box(i,a.audioStsd(t),a.box(a.types.dac3,a.dac3(t)),r)}static ec3(e,t){let i=a.types["ec-3"],r=null;return e.encrypted&&e.decryptdata?(i=a.types.enca,r=a.sinf(e.decryptdata,"audio",a.types["ec-3"])):r=new Uint8Array,a.box(i,a.audioStsd(t),a.box(a.types.dec3,a.dec3(t)),r)}static stsd(e){if("audio"===e.type){if("mp3"===e.config.segmentCodec&&"mp3"===e.config.codec)return a.box(a.types.stsd,a.STSD,a.mp3(e.config));if("ac3"===e.config.segmentCodec)return a.box(a.types.stsd,a.STSD,a.ac3(e.info,e.config));if("ec3"===e.config.segmentCodec)return a.box(a.types.stsd,a.STSD,a.ec3(e.info,e.config));if("aac"===e.config.segmentCodec)return a.box(a.types.stsd,a.STSD,a.mp4a(e.info,e.config));throw"unknown segmentCodec "+e.config.segmentCodec}return a.box(a.types.stsd,a.STSD,a.avc1(e))}static tkhd(e){let t=e.info.id,i=e.info.duration*e.info.timescale,r=Math.floor(i/(s+1)),n=Math.floor(i%(s+1)),o=0,l=0;return"video"===e.type&&(o=e.config.width,l=e.config.height),a.box(a.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,n>>24,n>>16&255,n>>8&255,255&n,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,o>>8&255,255&o,0,0,l>>8&255,255&l,0,0]))}static traf(e,t){const i=a.senc(e);var r=a.sdtp(e),n=i.boxData,o=n.length?a.saio(76):new Uint8Array,l=n.length?a.saiz(i.defaultSampleInfoSize,i.sampleInfoSizes):new Uint8Array,d=a.sbgp(e),h=a.sgpd(e),c=e.id,u=Math.floor(t/(s+1)),f=Math.floor(t%(s+1));return a.box(a.types.traf,a.box(a.types.tfhd,new Uint8Array([0,2,0,0,c>>24,c>>16&255,c>>8&255,255&c])),a.box(a.types.tfdt,new Uint8Array([1,0,0,0,u>>24,u>>16&255,u>>8&255,255&u,f>>24,f>>16&255,f>>8&255,255&f])),n,o,l,d,h,a.trun(e,r.length+n.length+d.length+h.length+o.length+l.length+16+20+8+16+8+8),r)}static trak(e){if("trakData"in e)return e.trakData;e.info.duration=e.info.duration||4294967295;let t=a.types.trak,i=a.tkhd(e),r=a.mdia(e);return a.box(t,i,r)}static trex(e){var t=e.info.id;return a.box(a.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){var i,r,s,n,o,l,d=e.samples||[],h=d.length,c=12+16*h,u=new Uint8Array(c);for(t+=8+c,u.set([0,0,15,1,h>>>24&255,h>>>16&255,h>>>8&255,255&h,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),i=0;i<h;i++)s=(r=d[i]).duration,n=r.size,o=r.flags,l=r.cts,u.set([s>>>24&255,s>>>16&255,s>>>8&255,255&s,n>>>24&255,n>>>16&255,n>>>8&255,255&n,o.isLeading<<2|o.dependsOn,o.isDependedOn<<6|o.hasRedundancy<<4|o.paddingValue<<1|o.isNonSync,61440&o.degradPrio,15&o.degradPrio,l>>>24&255,l>>>16&255,l>>>8&255,255&l],12+16*i);return a.box(a.types.trun,u)}static initSegment(e){a.types||a.init();var t,i=a.moov(e);return(t=new Uint8Array(a.FTYP.byteLength+i.byteLength)).set(a.FTYP),t.set(i,a.FTYP.byteLength),t}static saio(e){const t=e+4+4;return a.box(a.types.saio,new Uint8Array([0,0,0,0,0,0,0,1,t>>24&255,t>>16&255,t>>8&255,255&t]))}static saiz(e,t){Object(r.c)(e)||(e=0);const i=t.length;let s=0===e?new Uint8Array(t):new Uint8Array;return a.box(a.types.saiz,new Uint8Array([0,0,0,0,e,i>>24&255,i>>16&255,i>>8&255,255&i]),s)}static senc(e){const t=e.samples||[],i=t.length;let s=0,n=NaN,o=!0,l=[];if(!e.encrypted||i<=0)return{boxData:new Uint8Array,sampleInfoSizes:l,defaultSampleInfoSize:0};const d=e.defaultPerSampleIVSize?e.defaultPerSampleIVSize:0;for(const e of t)e.subsamples&&(s+=e.subsamples.length);if(s<=0)return{boxData:new Uint8Array,sampleInfoSizes:l,defaultSampleInfoSize:0};let h=new Uint8Array(2*i+i*d+6*s+4),c=this.set32(i,h,0);for(const e of t){let t=e.subsamples?e.subsamples:[],i=2;e.iv&&(h.set(e.iv,c),c+=e.iv.byteLength,i+=e.iv.byteLength),c=this.set16(t.length,h,c);for(const e of t)c=this.set16(e[0],h,c),c=this.set32(e[1],h,c),i+=6;l.push(i),Object(r.c)(n)||(n=i),o=o&&n===i,n=i}return{boxData:a.box(a.types.senc,new Uint8Array([0,0,0,2]),h),defaultSampleInfoSize:o?n:0,sampleInfoSizes:l}}static sinf(e,t,i){return a.box(a.types.sinf,a.frma(i),a.schm(),a.schi(e,t))}static frma(e){return a.box(a.types.frma,new Uint8Array(e))}static schm(){return a.box(a.types.schm,new Uint8Array([0,0,0,0,99,98,99,115,0,1,0,0]))}static schi(e,t){return a.box(a.types.schi,a.tenc(e,t))}static tenc(e,t){let i=0;"video"===t&&(i=25);let r=new Uint8Array(17);if(r[0]=16,e.iv&&16===e.iv.byteLength&&r.set(e.iv,1),!e.keyId)throw"tenc: no key id found in decryptdata";return a.box(a.types.tenc,new Uint8Array([1,0,0,0,0,i,1,0]),e.keyId,r)}static sbgp(e){if(!e.encrypted||0===e.samples.length||!e.samples[0].decryptdata)return new Uint8Array;let t=e.samples.length;return a.box(a.types.sbgp,new Uint8Array([0,0,0,0]),new Uint8Array(a.types.seig),new Uint8Array([0,0,0,1,t>>24&255,t>>16&255,t>>8&255,255&t,0,1,0,1]))}static sgpd(e){if(!e.encrypted||0===e.samples.length||!e.samples[0].decryptdata)return new Uint8Array;let t=e.samples[0].decryptdata,i=0;"video"===e.type&&(i=25);let r=new Uint8Array(17);if(r[0]=16,t.iv&&r.set(t.iv,1),!t.keyId)throw"sgpd: no keyid in decryptdata";return a.box(a.types.sgpd,new Uint8Array([1,0,0,0]),new Uint8Array(a.types.seig),new Uint8Array([0,0,0,37,0,0,0,1]),new Uint8Array([0,i,1,0]),t.keyId,r)}static pssh(e,t,i){if(a.types||a.init(),!e)throw new TypeError("Bad system id");if(16!==e.byteLength)throw new RangeError("Invalid system id");let r,s,n;if(t){r=1,s=new Uint8Array(16*t.length);for(let e=0;e<t.length;e++){let i=t[e];if(16!==i.byteLength)throw new RangeError("Invalid key");s.set(i,16*e)}}else r=0,s=new Uint8Array;r>0?(n=new Uint8Array(4),t.length>0&&new DataView(n.buffer).setUint32(0,t.length,!1)):n=new Uint8Array;let o=new Uint8Array(4);return i&&i.byteLength>0&&new DataView(o.buffer).setUint32(0,i.byteLength,!1),a.box(a.types.pssh,new Uint8Array([r,0,0,0]),e,n,s,o,i||new Uint8Array)}}t.a=a}),(function(e,t,i){"use strict";i.d(t,"a",(function(){return d}));var r,s=i(10);let a,n;const o={strToUtf8array:function(e){const t=s.a.Buffer.from(e,"utf-8");return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)},utf8arrayToStr:function(e){return s.a.Buffer.from(e).toString("utf-8")}};let l={strToUtf8array:function(e){const t=unescape(encodeURIComponent(e)),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i},utf8arrayToStr:function(e){return String.fromCharCode.apply(null,e)}};"undefined"!=typeof TextEncoder&&"undefined"!=typeof TextDecoder?l={strToUtf8array:function(e){return a||(a=new TextEncoder),a.encode(e)},utf8arrayToStr:function(e){return n||(n=new TextDecoder("utf-8")),n.decode(e)}}:"function"==typeof(null===(r=s.a.Buffer)||void 0===r?void 0:r.from)&&(l=o);class d{constructor(){this.transfer=[]}add(e){this.transfer.indexOf(e)<0&&this.transfer.push(e)}}t.b=l}),,,(function(e,t,i){"use strict";var r,s;function a(e){return"data1"in e}i.d(t,"c",(function(){return a})),i.d(t,"b",(function(){return r})),i.d(t,"a",(function(){return s})),i(1),i(16),(function(e){e.LowBuffer="LowBuffer",e.HighBuffer="HighBuffer",e.Seek="Seek"})(r||(r={})),(function(e){e.INIT="init"})(s||(s={}))}),(function(e,t,i){"use strict";var r=i(10);function s(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/\=+$/,"")}class a{static strToBase64Encode(e){return btoa(e)}static base64DecodeToStr(e){return atob(e)}static base64Encode(e){return btoa(String.fromCharCode(...e))}static base64UrlEncode(e){return s(a.base64Encode(e))}static base64Decode(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0))}}class n{static strToBase64Encode(e){return r.a.Buffer.from(e).toString("base64")}static base64DecodeToStr(e){return r.a.Buffer.from(e,"base64").toString()}static base64Encode(e){return r.a.Buffer.from(e).toString("base64")}static base64UrlEncode(e){return s(n.base64Encode(e))}static base64Decode(e){const t=r.a.Buffer.from(e,"base64");return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}}const o=void 0!==r.a.Buffer?n:a;t.a=o}),(function(e,t,i){"use strict";const r=e=>e&&e.Math===Math&&e;t.a=r("object"==typeof globalThis&&globalThis)||r("object"==typeof window&&window)||r("object"==typeof self&&self)||r("object"==typeof global&&global)||Function("return this")()}),(function(e,t,i){"use strict";var r,s="object"==typeof Reflect?Reflect:null,a=s&&"function"==typeof s.apply?s.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};r=s&&"function"==typeof s.ownKeys?s.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var n=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}e.exports=o,e.exports.once=function(e,t){return new Promise((function(i,r){function s(){void 0!==a&&e.removeListener("error",a),i([].slice.call(arguments))}var a;"error"!==t&&(a=function(i){e.removeListener(t,s),r(i)},e.once("error",a)),e.once(t,s)}))},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var l=10;function d(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function h(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function c(e,t,i,r){var s,a,n,o;if(d(i),void 0===(a=e._events)?(a=e._events=Object.create(null),e._eventsCount=0):(void 0!==a.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),a=e._events),n=a[t]),void 0===n)n=a[t]=i,++e._eventsCount;else if("function"==typeof n?n=a[t]=r?[i,n]:[n,i]:r?n.unshift(i):n.push(i),(s=h(e))>0&&n.length>s&&!n.warned){n.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+n.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=n.length,o=l,console&&console.warn&&console.warn(o)}return e}function u(e,t,i){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},s=function(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}.bind(r);return s.listener=i,r.wrapFn=s,s}function f(e,t,i){var r=e._events;if(void 0===r)return[];var s=r[t];return void 0===s?[]:"function"==typeof s?i?[s.listener||s]:[s]:i?(function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t})(s):p(s,s.length)}function g(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function p(e,t){for(var i=new Array(t),r=0;r<t;++r)i[r]=e[r];return i}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");l=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return h(this)},o.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r="error"===e,s=this._events;if(void 0!==s)r=r&&void 0===s.error;else if(!r)return!1;if(r){var n;if(t.length>0&&(n=t[0]),n instanceof Error)throw n;var o=new Error("Unhandled error."+(n?" ("+n.message+")":""));throw o.context=n,o}var l=s[e];if(void 0===l)return!1;if("function"==typeof l)a(l,this,t);else{var d=l.length,h=p(l,d);for(i=0;i<d;++i)a(h[i],this,t)}return!0},o.prototype.addListener=function(e,t){return c(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return c(this,e,t,!0)},o.prototype.once=function(e,t){return d(t),this.on(e,u(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return d(t),this.prependListener(e,u(this,e,t)),this},o.prototype.removeListener=function(e,t){var i,r,s,a,n;if(d(t),void 0===(r=this._events))return this;if(void 0===(i=r[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(s=-1,a=i.length-1;a>=0;a--)if(i[a]===t||i[a].listener===t){n=i[a].listener,s=a;break}if(s<0)return this;0===s?i.shift():(function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()})(i,s),1===i.length&&(r[e]=i[0]),void 0!==r.removeListener&&this.emit("removeListener",e,n||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,i,r;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var s,a=Object.keys(i);for(r=0;r<a.length;++r)"removeListener"!==(s=a[r])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},o.prototype.listeners=function(e){return f(this,e,!0)},o.prototype.rawListeners=function(e){return f(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):g.call(e,t)},o.prototype.listenerCount=g,o.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]}}),(function(e,t,i){"use strict";function r(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),r(i(22)),r(i(24))}),(function(e,t,i){"use strict";var r=i(1),s=i(0),a=i(3),n=i(5);class o{constructor(e,t){this._hasTimeStamp=!1,this._audioType=null,this._length=0,this._frames=[],this.logger=null==t?a.b:t;for(var i,r,s,n,l=0;;)if(s=o.readUTF(e,l,3),l+=3,"ID3"===s){this._minor=e[l++],this._revision=e[l++];let t=e[l++];if(128&t&&(this._unsynchronized=!0,this.logger.error("id3 tag is unsynchronized")()),64&t&&(this._hasExtendedHeader=!0,this.logger.warn("id3 tag has extended header")()),i=o.readSynchSafeUint32(e.subarray(l,l+4)),r=(l+=4)+i,this._hasExtendedHeader){let t=o.readSynchSafeUint32(e.subarray(l,l+4));this.logger.warn(`id3 tag has ${t}-byte extended header. usually 6 or 10 bytes`)(),l+=t}this.minor>2?this._parseID3Frames(e,l,r):this.logger.error("[id3] doesn't support older than v2.3 tags")(),l=r}else{if("3DI"!==s)return void((n=l-=3)&&(this.hasTimeStamp||this.logger.warn("ID3 tag found, but no timestamp")(),this._length=n,this._payload=e.slice(0,n)));l+=7}}static isHeader(e,t){return 73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}static readSynchSafeUint32(e){return 2097152*(127&e[0])+16384*(127&e[1])+128*(127&e[2])+(127&e[3])}static readUTF(e,t,i){var r="",s=t,a=t+i;do{r+=String.fromCharCode(e[s++])}while(s<a);return r}isID3Frame(e,t){return e[t+4]<128&&e[t+5]<128&&e[t+6]<128&&e[t+7]<128}decodeID3Frame(e){return"TXXX"===e.type?this.decodeTxxxFrame(e):"WXXX"===e.type?this.decodeWxxxFrame(e):"PRIV"===e.type?this.decodePrivFrame(e):"T"===e.type[0]?this.decodeTextFrame(e):{key:e.type,data:e.data}}decodeTxxxFrame(e){if(e.size<2)return;if(3!==e.data[0])return;let t=1,i=this.utf8ArrayToStr(e.data.subarray(t));return t+=i.length+1,{key:"TXXX",description:i,data:this.utf8ArrayToStr(e.data.subarray(t))}}decodeWxxxFrame(e){if(e.size<2)return;if(3!==e.data[0])return;let t=1,i=this.utf8ArrayToStr(e.data.subarray(t));return t+=i.length+1,{key:"WXXX",description:i,data:n.b.utf8arrayToStr(e.data.subarray(t))}}decodeTextFrame(e){if(e.size<2)return;if(3!==e.data[0])return;let t=e.data.subarray(1);return{key:e.type,data:this.utf8ArrayToStr(t)}}decodePrivFrame(e){if(e.size<2)return;let t=this.utf8ArrayToStr(e.data);return{key:"PRIV",info:t,data:e.data.slice(t.length+1)}}_extractID3Frame(e,t,i,r,s){let a,n=r+i;return n<=s?(this.logger.info(`[QE Critical] [id3] parsed frame id ${t} size ${i}`)(),a={type:t,data:e.slice(r,n)}):this.logger.error(`id3 frame ${t} size ${i} exceeded ${s}`)(),a}_parseID3Frames(e,t,i){for(var r,s,a,n;t+8<=i;){if(this.logger.info(`[id3] _parseID3Frames ${t} ${i}`)(),!this.isID3Frame(e,t))return void this.logger.error(`[id3] illegal id3 frame @ offset ${t}. skip this id3 tag`)();if(r=o.readUTF(e,t,4),t+=4,""===r)return void this.logger.info("[id3] empty tagId. padding.")();if(0===(s=o.readSynchSafeUint32(e.subarray(t,t+4))))return void this.logger.info("[id3] zero tag length. padding.")();t+=4,e[t++],e[t++],a=t,this.logger.info("[id3] tag id:"+r+" tagLen "+s+" offset "+t+" endPos "+i)();let d=this._extractID3Frame(e,r,s,a,i);if(d){let e=this.decodeID3Frame(d);this._frames.push(e)}switch(r){case"PRIV":if(53===s&&"com.apple.streaming.transportStreamTimestamp"===o.readUTF(e,t,44)){t+=44,t+=4;var l=1&e[t++];this._hasTimeStamp=!0,n=((e[t++]<<23)+(e[t++]<<15)+(e[t++]<<7)+e[t++])/45,l&&(n+=47721858.84),n=Math.round(n),this.logger.info("ID3 timestamp found: "+n)(),this._timeStamp=n}else s>=45&&"com.apple.streaming.audioDescription"===o.readUTF(e,t,36)?(t+=37,this._audioType=o.readUTF(e,t,4),t+=4,t+=s-41,this.logger.info("ID3 audio description found: "+this._audioType)()):t+=s;break;default:t+=s}this.logger.info(`[id3] ${r} default tagLen ${s} offset ${t} endPos ${i}`)()}}utf8ArrayToStr(e){let t,i,r="",s=0,a=e.length;for(;s<a;){let a=e[s++];switch(a>>4){case 0:return r;case 1:case 2:case 3:case 4:case 5:case 6:case 7:r+=String.fromCharCode(a);break;case 12:case 13:t=e[s++],r+=String.fromCharCode((31&a)<<6|63&t);break;case 14:t=e[s++],i=e[s++],r+=String.fromCharCode((15&a)<<12|(63&t)<<6|(63&i)<<0)}}}get hasTimeStamp(){return this._hasTimeStamp}get timeStamp(){return this._timeStamp}get audioType(){return this._audioType}get length(){return this._length}get payload(){return this._payload}get frames(){return this._frames}get minor(){return this._minor}get revision(){return this._revision}}var l=o;class d{bsReadAndUpdate(e,t,i){let r=this.readBits(e,t,i);return this.updateOffset(t,i),r}bsWriteAndUpdate(e,t,i,r){let s=this.writeBits(e,t,i,r);return this.updateOffset(t,i),s}bsSkip(e,t){this.updateOffset(e,t)}readBits(e,t,i){if(!e||!t)return;let r,s=t.byteOffset,a=t.usedBits;if(a>=8||a+i>32)return;let n=new Uint32Array(1),o=new Uint32Array(1),l=new Uint8Array(1);if(!(a>=8||i>32)){if(a){let t=8-a,n=i<t?t-i:0;o[0]=4278190080>>>32-t,r=(e[s]&o[0])>>>n,s+=1,i-=t}for(;i>0;){l[0]=e[s];let t=Math.min(i,8),a=8-t;o[0]=4278190080>>>24+a<<a,n[0]=(l[0]&o[0])>>a,r=r?r<<t|n[0]:n[0],s+=1,i-=t}return r}}writeBits(e,t,i,r){if(!e||!t)return;let s=t.byteOffset,a=t.usedBits;if(a>=8||a+i>32)return;let n=new Uint32Array(1),o=new Uint32Array(1),l=new Uint32Array(1),d=new Uint8Array(1);for(n[0]=r,a&&(o[0]=n[0]<<32-i,l[0]=4278190080,d[0]=(o[0]&l[0])>>>24+a,e[s]&=~(l[0]>>>24+a),e[s]|=d[0],s+=1,i-=8-a);i>0;){o[0]=n[0]<<32-i,l[0]=4278190080,d[0]=(o[0]&l[0])>>>24;let t=i<0?8-i:0;e[s]&=~(l[0]>>>24>>>t<<t),e[s]|=d[0],i-=8,s+=1}return 0}updateOffset(e,t){if(!e||!t||e.usedBits+t>32)return;let i=e.usedBits%8,r=Math.floor((i+t)/8),s=(i+t)%8;e.byteOffset+=r,e.usedBits=s}}var h=function(e,t,i){let a,n=new d,o=!1,h=0;for(;i<t.length;){if(i+8>t.length)return a={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"error parsing ec-3, not enough data"},void e.trigger(r.b.INTERNAL_ERROR,a);let d=0;if(l.isHeader(t,i)&&(i+=d=new l(t.subarray(i)).length||0),11!==t[i]||119!==t[i+1])return a={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ec-3 magic"},void e.trigger(r.b.INTERNAL_ERROR,a);let c={byteOffset:i+2,usedBits:0},u=n.bsReadAndUpdate(t,c,2),f=n.bsReadAndUpdate(t,c,3);if(0===u||2===u)if(!0===o){if(0===f)break}else o=!0;else if(1!==u)return a={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"reserved stream type"},void e.trigger(r.b.INTERNAL_ERROR,a);let g=2*(n.bsReadAndUpdate(t,c,11)+1);i+=g,h+=g+(d||0)}return h},c=function(e,t,i){let a,n={frmsiz:0,fscod:0,numblkscod:0,acmod:0,lfeon:0,bsid:0,strmtyp:0,substreamid:0,chanmape:0,chanmap:0,mixdef:0,mixdeflen:0,bsmod:0},o={fscod:0,acmod:0,lfeon:0,bsid:0,bsmod:0,chan_loc:0,data_rate:0,num_ind_sub:0,num_dep_sub:[],complexity_index_type_a:0},h=new d,c=!1,u=0;for(;i<t.length;){if(i+8>t.length)return a={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"error parsing ec-3, not enough data"},void e.trigger(r.b.INTERNAL_ERROR,a);let d=0;if(l.isHeader(t,i)&&(i+=d=new l(t.subarray(i)).length||0),11!==t[i]||119!==t[i+1])return a={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ec-3 magic"},void e.trigger(r.b.INTERNAL_ERROR,a);let f={byteOffset:i+2,usedBits:0};if(n.strmtyp=h.bsReadAndUpdate(t,f,2),n.substreamid=h.bsReadAndUpdate(t,f,3),0===n.strmtyp||2===n.strmtyp){if(!0===c){if(0===n.substreamid)break}else c=!0;o.num_ind_sub++,o.num_dep_sub.push(0)}else{if(1!==n.strmtyp)return a={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"reserved stream type"},void e.trigger(r.b.INTERNAL_ERROR,a);o.num_dep_sub[o.num_ind_sub-1]++}if(n.frmsiz=h.bsReadAndUpdate(t,f,11),n.fscod=h.bsReadAndUpdate(t,f,2),3===n.fscod?(h.bsSkip(f,2),n.numblkscod=3):n.numblkscod=h.bsReadAndUpdate(t,f,2),n.acmod=h.bsReadAndUpdate(t,f,3),n.lfeon=h.bsReadAndUpdate(t,f,1),n.bsid=h.bsReadAndUpdate(t,f,5),h.bsSkip(f,5),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,8),0===n.acmod&&(h.bsSkip(f,5),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,8)),1===n.strmtyp&&(n.chanmape=h.bsReadAndUpdate(t,f,1),n.chanmape&&(n.chanmap=h.bsReadAndUpdate(t,f,16))),h.bsReadAndUpdate(t,f,1)&&(n.acmod>2&&h.bsSkip(f,2),1&n.acmod&&n.acmod>2&&h.bsSkip(f,6),4&n.acmod&&h.bsSkip(f,6),n.lfeon&&h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,5),0===n.strmtyp)){if(h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,6),0===n.acmod&&h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,6),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,6),n.mixdef=h.bsReadAndUpdate(t,f,2),1===n.mixdef)h.bsSkip(f,5);else if(2===n.mixdef)h.bsSkip(f,12);else if(3===n.mixdef){n.mixdeflen=h.bsReadAndUpdate(t,f,5),h.bsReadAndUpdate(t,f,1)&&(h.bsSkip(f,5),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&(h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4))),h.bsReadAndUpdate(t,f,1)&&(h.bsSkip(f,5),h.bsReadAndUpdate(t,f,1)&&(h.bsSkip(f,7),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,8)));let e=n.mixdeflen+2+(f.usedBits?1:0);f.byteOffset+=e}if(n.acmod<2&&(h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,14),0===n.acmod&&h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,14)),h.bsReadAndUpdate(t,f,1))if(0===n.numblkscod)h.bsSkip(f,5);else for(let e=0;e<n.numblkscod;e++)h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,5)}if(n.bsmod=0,h.bsReadAndUpdate(t,f,1)&&(n.bsmod=h.bsReadAndUpdate(t,f,3),h.bsSkip(f,2),2===n.acmod&&h.bsSkip(f,4),n.acmod>=6&&h.bsSkip(f,2),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,8),0===n.acmod&&h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,8),n.fscod<3&&h.bsSkip(f,1)),0===n.strmtyp&&3!==n.numblkscod&&h.bsSkip(f,1),2===n.strmtyp){let e;(e=3===n.numblkscod?1:h.bsReadAndUpdate(t,f,1))&&h.bsReadAndUpdate(t,f,6)}if(h.bsReadAndUpdate(t,f,1)){let e=h.bsReadAndUpdate(t,f,6);if(0===n.strmtyp&&0===n.substreamid&&1===e){let e=h.bsReadAndUpdate(t,f,7),i=h.bsReadAndUpdate(t,f,1),r=h.bsReadAndUpdate(t,f,8);0===e&&1===i&&r>=1&&r<=16&&(o.complexity_index_type_a=r)}}if(n.chanmape)o.chan_loc|=n.chanmap;else{let e=[40960,16384,40960,57344,41472,57856,47104,63488];o.chan_loc|=e[n.acmod]}0===n.strmtyp&&(o.fscod=n.fscod,o.bsid=n.bsid,o.bsmod=n.bsmod,o.acmod=n.acmod,o.lfeon=n.lfeon),o.chan_loc|=n.lfeon?1:0;let g=2*(n.frmsiz+1);i+=g,u+=g+(d||0)}let f=0;for(let e=0;e<16;e++)o.chan_loc&1<<e&&f++;o.lfeon&&f++;let g=10+3*o.num_ind_sub,p=[48e3,44100,32e3][o.fscod];o.data_rate=p/1536*u*8,g=10+3*o.num_ind_sub;for(let e=0;e<o.num_ind_sub;e++)o.num_dep_sub[e]>0&&g++;o.complexity_index_type_a>0&&(g+=2);let m=new Uint8Array(g),y={byteOffset:0,usedBits:0};h.bsWriteAndUpdate(m,y,32,g),h.bsWriteAndUpdate(m,y,32,1684366131),h.bsWriteAndUpdate(m,y,13,o.data_rate),h.bsWriteAndUpdate(m,y,3,o.num_ind_sub);for(let e=0;e<o.num_ind_sub;e++)h.bsWriteAndUpdate(m,y,2,o.fscod),h.bsWriteAndUpdate(m,y,5,o.bsid),h.bsWriteAndUpdate(m,y,1,0),h.bsWriteAndUpdate(m,y,1,0===e?0:1),h.bsWriteAndUpdate(m,y,3,o.bsmod),h.bsWriteAndUpdate(m,y,3,o.acmod),h.bsWriteAndUpdate(m,y,1,o.lfeon),h.bsWriteAndUpdate(m,y,3,0),h.bsWriteAndUpdate(m,y,4,o.num_dep_sub[e]),o.num_dep_sub[e]>0?h.bsWriteAndUpdate(m,y,9,o.chan_loc):h.bsWriteAndUpdate(m,y,1,0);return o.complexity_index_type_a>0&&(h.bsWriteAndUpdate(m,y,7,0),h.bsWriteAndUpdate(m,y,1,1),h.bsWriteAndUpdate(m,y,8,o.complexity_index_type_a)),{samplerate:p,channelCount:f,segmentCodec:"ec3",codec:"ec-3",extraDataBytes:m}};class u{constructor(e,t,i,r,s){this.observer=e,this.remuxer=t,this.config=i,this.typeSupported=r,this.logger=s}static probe(e){throw new Error("Method not implemented.")}resetTimeStamp(e){}resetInitSegment(e,t,i,r){}destroy(){}}class f extends u{constructor(e,t,i,r,s){super(e,t,i,r,s),this.observer=e,this.remuxer=t,this.config=i,this.typeSupported=r,this.logger=s,this.esRemuxer=t}}class g{constructor(e,t){this.observer=e,this.config=t}resetInitSegment(){}resetTimeStamp(e){}destroy(){}}let p=[48e3,44100,32e3],m=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920];var y=function(e,t){return 1536/e.samplerate*t},v=function(e,t,i){let a;if(i+8>t.length)return a={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"error parsing ac-3, not enough data"},void e.trigger(r.b.INTERNAL_ERROR,a);if(11!==t[i]||119!==t[i+1])return a={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ac-3 magic"},void e.trigger(r.b.INTERNAL_ERROR,a);let n=t[i+4]>>6;if(n>=3)return a={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ac-3 samplingRateCode:"+n},void e.trigger(r.b.INTERNAL_ERROR,a);let o=63&t[i+4],l=t[i+6]>>5,d=0;2===l?d+=2:(1&l&&1!==l&&(d+=2),4&l&&(d+=2));let h=(t[i+6]<<8|t[i+7])>>12-d&1,c=[2,1,2,3,3,4,4,5][l]+h,u=t[i+5]>>3,f=7&t[i+5];return{samplerate:p[n],channelCount:c,segmentCodec:"ac3",codec:"ac-3",extraData:n<<22|u<<17|f<<14|l<<11|h<<10|o>>1<<5}},b=function(e,t,i){let a;if(i+8>t.length)return a={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"error parsing ac-3, not enough data"},void e.trigger(r.b.INTERNAL_ERROR,a);if(11!==t[i]||119!==t[i+1])return a={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ac-3 magic"},void e.trigger(r.b.INTERNAL_ERROR,a);let n=t[i+4]>>6;if(n>=3)return a={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ac-3 samplingRateCode:"+n},void e.trigger(r.b.INTERNAL_ERROR,a);let o=63&t[i+4];return 2*m[3*o+n]},S=function(e,t,i,a){let n,o,l,d,h,c=navigator.userAgent.toLowerCase(),u=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];if(n=1+((192&t[i+2])>>>6),!((o=(60&t[i+2])>>>2)>u.length-1))return d=(1&t[i+2])<<2,d|=(192&t[i+3])>>>6,/firefox/i.test(c)?o>=6?(n=5,h=new Array(4),l=o-3):(n=2,h=new Array(2)):-1!==c.indexOf("android")?(n=2,h=new Array(2)):(n=5,h=new Array(4),a&&(-1!==a.indexOf("mp4a.40.29")||-1!==a.indexOf("mp4a.40.5"))||!a&&o>=6?l=o-3:((a&&-1!==a.indexOf("mp4a.40.2")||!a&&1===d)&&(n=2,h=new Array(2)),l=o)),h[0]=n<<3,h[0]|=(14&o)>>1,h[1]|=(1&o)<<7,h[1]|=d<<3,5===n&&(h[1]|=(14&l)>>1,h[2]=(1&l)<<7,h[2]|=8,h[3]=0),{esdsConfig:h,samplerate:u[o],channelCount:d,segmentCodec:"aac",codec:"mp4a.40."+n};e.trigger(r.b.INTERNAL_ERROR,{type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ADTS sampling index:"+o})};const T={BitratesMap:[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap:[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],SamplesCoefficients:[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],BytesInSlot:[0,1,1,4],onFrame:function(e,t,i,r,s,a,n){var o=n+a*(10368e4/r);e.esSamples.push({unit:t,pts:o,dts:o}),e.len+=t.length},onNoise:function(e){a.b.warn("mpeg audio has noise: "+e.length+" bytes")()},parseFrames:function(e,t,i,r,s,a){if(i+2>r)return-1;if(255===t[i]||224==(224&t[i+1])){if(i+24>r)return-1;var n=t[i+1]>>3&3,o=t[i+1]>>1&3,l=t[i+2]>>4&15,d=t[i+2]>>2&3,h=!!(2&t[i+2]);if(1!==n&&0!==l&&15!==l&&3!==d){var c=1e3*[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160][14*(3===n?3-o:3===o?3:4)+l-1],u=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3][3*(3===n?0:2===n?1:2)+d],f=h?1:0,g=t[i+3]>>6==3?1:2,p=3===o?(3===n?12:6)*c/u+f<<2:(3===n?144:72)*c/u+f|0;return i+p>r?-1:(T.onFrame(e,t.subarray(i,i+p),c,u,g,s,a),p)}}for(var m=i+2;m<r;){if(255===t[m-1]&&224==(224&t[m]))return T.onNoise(t.subarray(i,m-1)),m-i-1;m++}return-1},parse:function(e,t,i,r){for(var s,a=t.length,n=0;i<a&&(s=T.parseFrames(e,t,i,a,n++,r))>0;)i+=s},getAudioConfig:function(e,t){let i=e[t+1]>>3&3,r=e[t+1]>>1&3,s=e[t+2]>>4&15,a=e[t+2]>>2&3,n=e[t+2]>>1&1;if(1!==i&&0!==s&&15!==s&&3!==a){let o=3===i?3-r:3===r?3:4,l=1e3*T.BitratesMap[14*o+s-1],d=3===i?0:2===i?1:2,h=T.SamplingRateMap[3*d+a],c=e[t+3]>>6==3?1:2,u=T.SamplesCoefficients[i][r],f=T.BytesInSlot[r];return{segmentCodec:"mp3",codec:"mp3",samplerate:h,channelCount:c,frameLength:parseInt(u*l/h+n,10)*f}}},isHeaderPattern:function(e,t){return 255===e[t]&&224==(224&e[t+1])&&0!=(6&e[t+1])},probe:function(e,t){if(t+1<e.length&&T.isHeaderPattern(e,t)){let i=4,r=T.getAudioConfig(e,t),s=i;r&&r.frameLength&&(s=r.frameLength);let a=t+s;if(a===e.length||a+1<e.length&&T.isHeaderPattern(e,a))return!0}return!1}};var E=T,_=i(4),D=i(2);class I{static getTrack(e,t,i,r){let s;switch(D.b.getSegmentCodec(i)){case"aac":{let a;(a=S(e,1===r?new Uint8Array([255,241,92,64,1,127,252]):new Uint8Array([255,241,92,128,1,191,252]),0,i))&&(s={type:"audio",info:{id:t,timescale:a.samplerate,duration:0,encrypted:!1,decryptdata:void 0},config:a})}break;case"ac3":case"ec3":{let i;(i=v(e,new Uint8Array([11,119,69,17,128,64,47,132]),0))&&(s={type:"audio",info:{id:t,timescale:i.samplerate,duration:0,encrypted:!1,decryptdata:void 0},config:i})}}return s}static getSample(e,t){let i;switch(e){case"mp4a.40.2":case"mp4a.40.5":i=1===t?new Uint8Array([0,208,0,7]):new Uint8Array([33,0,3,64,104,28]);break;case"ac-3":case"ec-3":i=new Uint8Array([11,119,69,17,128,64,47,132,41,3,253,214,124,253,243,215,233,95,185,123,78,20,40,106,97,190,74,253,43,218,208,140,191,176,144,120,214,181,44,124,129,251,91,109,187,109,198,225,43,172,116,140,176,123,38,144,211,247,225,64,29,53,175,96,16,57,121,87,78,203,81,37,7,72,228,132,37,169,38,231,97,229,247,194,208,8,12,83,74,139,137,17,22,26,221,203,107,113,94,93,75,33,208,247,146,105,39,143,6,36,1,227,108,70,11,180,152,218,182,218,209,59,85,104,201,70,37,82,219,68,55,225,144,99,149,0,119,26,14,69,164,241,204,222,81,177,142,80,20,100,97,143,101,221,140,113,31,208,124,25,64,29,49,77,140,30,155,74,214,204,138,229,109,172,95,130,70,230,134,88,59,179,212,155,232,0,0,0,0,0,173,234])}return i}static getSegment(e,t,i,r){let s=I.getSample(e.config.codec,e.config.channelCount);if(!s)return;let a=[],n={id:e.info.id,sequenceNumber:t,type:"audio",encrypted:!1,samples:a,defaultPerSampleIVSize:0},o=D.a[e.config.segmentCodec],l=Math.ceil(r*e.info.timescale/o),d=0,h=l*s.byteLength+8,c=new Uint8Array(h);c[0]=h>>24&255,c[1]=h>>16&255,c[2]=h>>8&255,c[3]=255&h,_.a.types||_.a.init(),c.set(_.a.types.mdat,4),d+=8;for(var u=0;u<l;u++)a.push({duration:o,size:s.byteLength,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,isNonSync:0,paddingValue:0}}),c.set(s,d),d+=s.byteLength;let f=_.a.moof(i,n),g=new Uint8Array(f.byteLength+c.byteLength);return g.set(f),g.set(c,f.byteLength),g}}var w=I;i(16),i(9);const R={bin2str:e=>String.fromCharCode.apply(null,e),readUint16(e,t){const i=e[t]<<8|e[t+1];return i<0?65536+i:i},readSint32:(e,t)=>e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],readUint32(e,t){const i=R.readSint32(e,t);return i<0?4294967296+i:i},readUint64(e,t){let i=R.readUint32(e,t);return(i*=Math.pow(2,32))+R.readUint32(e,t+4)},writeUint32(e,t,i){e[t]=i>>24,e[t+1]=i>>16&255,e[t+2]=i>>8&255,e[t+3]=255&i},writeUint64(e,t,i){const r=Math.pow(2,32)-1,s=Math.floor(i/(r+1)),a=Math.floor(i%(r+1));R.writeUint32(e,t,s),R.writeUint32(e,t+4,a)},findBox(e,t){let i,r,s,a,n,o=[];if(!t.length)return[];for(i=0;i<e.byteLength;)r=R.readUint32(e,i),s=R.bin2str(e.subarray(i+4,i+8)),a=r>1?i+r:e.byteLength,s===t[0]&&(1===t.length?o.push(e.subarray(i+8,a)):(n=R.findBox(e.subarray(i+8,a),t.slice(1))).length&&(o=o.concat(n))),i=a;return o},findBoxWithOffset(e,t,i,r){let s,a,n,o,l,d=[];if(!i.length)return[];for(s=0;s<e.byteLength;)a=R.readUint32(e,s),n=R.bin2str(e.subarray(s+4,s+8)),o=a>1?s+a:e.byteLength,n===i[0]&&(r&&r.push({offset:s+t,type:n,size:a}),1===i.length?d.push({offset:s+t,type:n,data:e.subarray(s+8,o),boxSize:a,walkedPath:r?r.slice(0):void 0}):(l=R.findBoxWithOffset(e.subarray(s+8,o),s+t+8,i.slice(1),r?r.slice(0):void 0)).length&&(d=d.concat(l),r=r?r.slice(0,-1):void 0)),s=o;return d}};class A extends g{constructor(e,t){super(e,t)}static _isCommonEncryptionInternal(e){return Boolean(e&&!("NONE"===e||"AES-128"===e))}static remuxInitSegment(e,t,i){if(!t)return e;let r=e;if(A._isCommonEncryptionInternal(t.method)){let s=t.keyId,n=!1,o=[];R.findBoxWithOffset(e,0,["moov","trak"]).forEach(r=>{let l,d,h=r.data,c=0,u=R.findBoxWithOffset(h,0,["mdia","minf","stbl","stsd"],[])[0],f=u.data.subarray(8),g=null,p=R.findBoxWithOffset(f,u.offset+16,["enca"])[0];p?(g=p.data.subarray(28),d="audio",c=u.offset+16+8+28):(p=R.findBoxWithOffset(f,u.offset+16,["encv"])[0])&&(g=p.data.subarray(78),d="video",c=u.offset+16+8+78),g&&R.findBoxWithOffset(g,c,["sinf"]).forEach(e=>{let r=e.data,o=R.findBox(r,["frma"])[0],c=R.findBox(r,["schm"])[0];if(!o)return void a.b.error("missing frma box")();if(!c)return void a.b.error("missing schm box")();let f=R.bin2str(c.subarray(4,8));if("aac "===R.bin2str(o.subarray(0,4))&&(_.a.types||_.a.init(),a.b.info("found frma with type 'aac ', patching to 'mp4a'")(),o.set(_.a.types.mp4a,0)),"cbcs"===f||"cenc"===f){i&&i.push(r);let e=R.findBox(r,["schi","tenc"])[0];if(e){const i=8;e.subarray(i,i+16).find((function(e){return 0!==e})),e.set(s,i);let r=e[6],a=e[7];if(1===r&&0===a){let i=e[24];i>0&&t.iv&&i===t.iv.length&&e.set(t.iv,25)}}}else if("cbc2"===f){n=!0,_.a.types||_.a.init();let i=R.findBoxWithOffset(r,0,["frma"])[0],s=_.a.box(_.a.types.schi,_.a.tenc(t,d)),a=_.a.box(_.a.types.sinf,r.subarray(i.offset,i.boxSize),_.a.schm(),s),o=(l=_.a.box(_.a.types.trak,h.subarray(0,e.offset),a,h.subarray(e.offset+e.boxSize))).subarray(8),c=a.byteLength-e.boxSize;u.walkedPath&&(u.walkedPath.push({type:"stsd",offset:p.offset,size:p.boxSize}),u.walkedPath.forEach(e=>{R.writeUint32(o,e.offset,e.size+c)}))}});let m=R.findBoxWithOffset(h,0,["edts"])[0];m&&(_.a.types||_.a.init(),h.set(_.a.types.free,m.offset+4)),l||(l=e.subarray(r.offset,r.offset+r.boxSize)),o.push(l)}),n&&(r=A.remuxCbc2InitSegment(e,o)||e)}return r}static remuxCbc2InitSegment(e,t){let i=R.findBoxWithOffset(e,0,["ftyp"])[0];if(!i)return void a.b.error("no ftyp found")();let r=R.findBoxWithOffset(e,i.boxSize,["moov"])[0],s=[],n=0;for(;n<r.data.byteLength;){let e=R.readUint32(r.data,n),i=R.bin2str(r.data.subarray(n+4,n+8)),a=e>1?n+e:r.data.byteLength;switch(i){case"trak":t&&(s=s.concat(t),t=void 0);break;default:s.push(r.data.subarray(n,a))}n=a}let o=_.a.box(_.a.types.moov,...s),l=new Uint8Array(i.boxSize+o.byteLength);return l.set(e.subarray(0,i.boxSize)),l.set(o,i.boxSize),l}static remuxOverflowSegment(e){_.a.types||_.a.init();let t,i=R.findBoxWithOffset(e,0,["moof","traf","tfdt"],[]),r=e.byteLength;if(i.forEach(e=>{0===e.data[0]&&(r+=4)}),r>e.byteLength){t=new Uint8Array(r);let i=0,s=0;for(;s<e.byteLength;){let r=R.readUint32(e,s),a=R.bin2str(e.subarray(s+4,s+8)),n=r>1?s+r:e.byteLength;if("moof"===a){let r=A.remuxOverflowMoof(e.subarray(s+8,n));t.set(r,i),i+=r.byteLength}else t.set(e.subarray(s,n),i),i+=r;s=n}}else a.b.warn("no increase in size")();return t||e}static remuxOverflowMoof(e){let t=0,i=[];for(;t<e.byteLength;){let r=R.readUint32(e,t);if("traf"===R.bin2str(e.subarray(t+4,t+8))){let s=A.remuxOverflowTraf(e.subarray(t+8,t+r));i.push(s)}else i.push(e.subarray(t,t+r));t=r>1?t+r:e.byteLength}let r=_.a.box(_.a.types.moof,...i),s=r.byteLength-e.byteLength-8;return R.findBoxWithOffset(r,0,["moof","traf","trun"],[]).forEach(e=>{if(0!=(1&e.data[3])){let t=R.readUint32(e.data,8);R.writeUint32(e.data,8,t+s)}}),R.findBoxWithOffset(r,0,["moof","traf","saio"],[]).forEach(e=>{let t=1&e.data[0],i=4;1&e.data[3]&&(i+=8);let r=R.readUint32(e.data,i);if(i+=4,t)for(let t=0;t<r;t++){let t=R.readUint64(e.data,i);R.writeUint64(e.data,i,t+s),i+=8}else for(let t=0;t<r;t++){let t=R.readUint32(e.data,i);R.writeUint32(e.data,i,t+s),i+=4}}),r}static remuxOverflowTraf(e){let t=0,i=[];for(;t<e.byteLength;){let r=R.readUint32(e,t);if("tfdt"===R.bin2str(e.subarray(t+4,t+8))&&0===e[t+8]){let r=R.readUint32(e,t+12),s=_.a.box(_.a.types.tfdt,new Uint8Array([1,0,0,0,0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r]));i.push(s)}else i.push(e.subarray(t,t+r));t=r>1?t+r:e.byteLength}return _.a.box(_.a.types.traf,...i)}remuxText(e){e.captionSamples.sort((function(e,t){return e.pts-t.pts})),e.captionSamples.length&&this.observer.trigger(r.b.FRAG_PARSING_CAPTIONDATA,{samples:e.captionSamples}),e.captionSamples=[]}remuxIFrame(e,t,i,s,a){if(!t.samples||!t.samples.length||!t.samples[0].data)return;var n=this.observer;let o,l,d=_.a.moof(e*t.timescale,t),h=new Uint8Array(d.byteLength+t.samples[0].data.byteLength+8);h.set(d),R.writeUint32(h,d.byteLength,t.samples[0].data.byteLength+8),h.set(_.a.types.mdat,d.byteLength+4),h.set(t.samples[0].data,d.byteLength+8),t.sequenceNumber++,i?(l="audiovideo",i.sequenceNumber=t.sequenceNumber,t.sequenceNumber++,o=w.getSegment(i,i.sequenceNumber,e*i.info.timescale,s)):l="video";let c={data1:h,data2:o,startPTS:e,startDTS:e,type:l,dropped:0,track:a};n.trigger(r.b.FRAG_PARSING_DATA,c),n.trigger(r.b.FRAG_PARSED)}remuxRawData(e,t,i,s,a,n,o,l){const d=this.observer;let h;t&&s?h="audiovideo":t?h="audio":s&&(h="video");let c=Math.max(i,e),u={data1:o,track:l,startPTS:n,startDTS:n,endPTS:void 0,endDTS:void 0,type:h,dropped:0};c&&(u.endPTS=n+c,u.endDTS=n+c),d.trigger(r.b.FRAG_PARSING_DATA,u),a&&a.captionSamples.length&&this.remuxText(a),d.trigger(r.b.FRAG_PARSED)}remuxEmsg(e,t,i,s,a,n){let o=this.observer,l="";e&&(l+="audio"),t&&(l+="video");let d={data1:a,startPTS:s,startDTS:s,type:l,dropped:0,track:n};o.trigger(r.b.FRAG_PARSING_DATA,d),i&&i.id3Samples.length>0&&(this.remuxID3(i),this.emitId3Samples(i)),o.trigger(r.b.FRAG_PARSED)}emitId3Samples(e){e.id3Samples.length&&this.observer.trigger(r.b.FRAG_PARSING_METADATA,{samples:e.id3Samples})}remuxID3(e){let t;const i=e.id3Samples.length;if(i)for(let r=0;r<i;r++)(t=e.id3Samples[r]).pts=t.pts-10,t.dts=t.dts-10}}var k=A;const C=Math.pow(2,32)-1,L=Math.pow(2,20)-1;class P extends u{constructor(e,t,i,r,s){super(e,t,i,{},s),this.mp4Remuxer=t,this.audioPrimingDelay=i.audioPrimingDelay,this.audioPrimingDelay}resetTimeStamp(e){Object(D.c)(e)?this.initData.audio&&!this.initData.video?(this.initPtsTs={baseTime:Math.round(e*this.initData.audio.timescale/9e4),timescale:this.initData.audio.timescale},this.logger.info(`resetting audio track initPTS: ${this.initPtsTs.baseTime}/${this.initPtsTs.timescale}, seconds: ${this.initPtsTs.baseTime/this.initPtsTs.timescale}`)()):this.initPtsTs={baseTime:e,timescale:9e4}:this.initPtsTs=void 0}static isHEVCFlavor(e){if(!e)return!1;let t=e.indexOf("."),i=t<0?e:e.substring(0,t);return"hvc1"===i||"hev1"===i||"chvc"===i||"qhvc"===i||"qhev"===i||"muxa"===i||"dvh1"===i||"dvhe"===i||"cdh1"===i||"qdh1"===i||"qdhe"===i}resetInitSegment(e,t,i){if(this._silentAudioTrack=void 0,e&&e.byteLength){let s=k.remuxInitSegment(e,i);const a=this.initData=P.parseInitSegment(s);let n;a.foundLargeTimescale&&this.logger.warn("large timescale found, will check for 32 bit tfdts")();const o=a.audioCodec,l=a.videoCodec;if(a.audio&&a.video?n={type:"audiovideo",container:"video/mp4",codec:o+","+l,initSegment:s}:(a.audio&&o&&(n={type:"audio",container:"audio/mp4",codec:o,initSegment:s}),a.video&&l&&(n={type:"video",container:"video/mp4",codec:l,initSegment:s})),a.video){const i=a.video,r=e.subarray(i.trakOffset,i.trakOffset+i.trakSize);this._videoTrack=Object.assign(Object.assign({},i),{info:{id:i.id,timescale:i.timescale,duration:t},trakData:r,sequenceNumber:0,samples:[]}),this.trySEICaptions=!D.b.isVP09(l),this._captionTrack=Object.assign(Object.assign({},a.caption),{sequenceNumber:0,captionSamples:[]})}a.audio&&o&&(this._audioTrack=Object.assign({},a.audio)),a.caption&&(this.trySEICaptions=!1,this._captionTrack=Object.assign(Object.assign({},a.caption),{sequenceNumber:0,captionSamples:[]})),this.remuxedInitDataTrack=n;let d={track:n};this.observer.trigger(r.b.FRAG_PARSING_INIT_SEGMENT,d)}}static probe(e){return R.findBox(e.subarray(0,Math.min(e.length,512e3)),["moof"]).length>0}static parseHvcC(e){let t;if(e){let i=e[0];if(1===i){let i=e[1];t={profileSpace:i>>6,tierFlag:(32&i)>>5?"H":"L",profileIDC:31&i,profileCompat:R.readUint32(e,2),constraintIndicator:e.subarray(6,12),levelIDC:e[12]}}else a.b.warn(`Unhandled version ${i} in hvcC box`)()}else a.b.warn("No hvcC box")();return t}static hvcCToCodecString(e,t){let i=e+"."+(t.profileSpace?String.fromCharCode(t.profileSpace+"A"-1):"")+t.profileIDC+"."+t.profileCompat.toString(16).toUpperCase()+"."+t.tierFlag+t.levelIDC,r="";for(let e=t.constraintIndicator.length-1;e>=0;--e){let i=t.constraintIndicator[e];if(0!==i||""!==r){let e=i.toString(16).toUpperCase();r="."+(""===r?e:e+r)}}return i+r}static parseDvcC(e){let t;return e?t={versionMajor:e[0],versionMinor:e[1],profile:e[2]>>1&127,level:e[2]<<5&32|e[3]>>3&31}:a.b.warn("No dvcC box")(),t}static dvcCToCodecString(e,t){return e+"."+(t.profile<10?"0"+t.profile:t.profile)+"."+(t.level<10?"0"+t.level:t.level)}static parseVpcC(e){let t;return e?t={profile:e[4],level:e[5],bitDepth:e[6]>>4&15}:a.b.warn("No vpcC box")(),t}static vpcCToCodecString(e,t){return e+"."+(t.profile<10?"0"+t.profile:t.profile)+"."+(t.level<10?"0"+t.level:t.level)+"."+t.bitDepth}static parseInitSegment(e){let t={foundLargeTimescale:!1,tracksById:{}};return R.findBoxWithOffset(e,0,["moov","trak"]).forEach(e=>{let i=e.data;const r=R.findBox(i,["tkhd"])[0];if(r){let s=r[0],a=0===s?12:20,n=R.readUint32(r,a);const o=R.findBox(i,["mdia","mdhd"])[0];if(o){let r=0===(s=o[0])?12:20;const a=R.readUint32(o,r);r+=4,a>=1e6&&(t.foundLargeTimescale=!0);let l=0===s?R.readUint32(o,r):0;const d=R.findBox(i,["mdia","hdlr"])[0];if(d){const r=R.bin2str(d.subarray(8,12));let s={soun:"audio",vide:"video",clcp:"caption"}[r]||r;if(s){let r,o=R.findBox(i,["mdia","minf","stbl","stsd"]);if(o.length){let i=o[0];r=R.bin2str(i.subarray(12,16));const d=P.parseStsd(i);let h;if("caption"===s){let e=Object.assign({id:n,type:s,timescale:a,duration:l,isTimingTrack:!1,sequenceNumber:0,captionSamples:[]},d);t.caption=e,h=e}else{let i=Object.assign({id:n,type:s,timescale:a,duration:l,isTimingTrack:!0,trakOffset:e.offset,trakSize:e.boxSize,sequenceNumber:0,samples:[],fragmentDuration:0},d);"video"===s?(t.video=i,t.videoCodec=i.codec):(t.audio=i,t.audioCodec=i.codec),h=i}t.tracksById[n]=h}}}}}}),t}static parseStsd(e){let t,i,r;const s=e.subarray(8);let a,n=R.bin2str(s.subarray(4,8)),o=null,l=null;"enca"===n?l=(o=R.findBox(s,["enca"])[0]).subarray(28):"encv"===n&&(l=(o=R.findBox(s,["encv"])[0]).subarray(78)),t=!!l,i=0,l&&R.findBox(l,["sinf"]).forEach(e=>{let t=R.findBox(e,["schm"])[0];if(t){let r=R.bin2str(t.subarray(4,8));if("cbcs"===r||"cenc"===r){let t=R.findBox(e,["frma"])[0];t&&(n=R.bin2str(t));let r=R.findBox(e,["schi","tenc"])[0];r&&(i=r[7])}}});let d=s.subarray(86);switch(n){case"mp4a":r="mp4a.40.5";break;case"ac-3":case"ec-3":r=n;break;case"avc1":case"avc3":r=n+".640028";break;case"hvc1":case"hev1":let e=R.findBox(d,["hvcC"])[0];r=(a=P.parseHvcC(e))?P.hvcCToCodecString(n,a):n+".2.4.H150.B0";break;case"dvh1":case"dvhe":let t=R.findBox(d,["dvcC"])[0];r=(a=P.parseDvcC(t))?P.dvcCToCodecString(n,a):n+".05.01";break;case"c608":r=n;break;case"vp09":let i=R.findBox(d,["vpcC"])[0];a=P.parseVpcC(i),r=P.vpcCToCodecString(n,a);break;default:r=n}return{codec:r,encrypted:t,defaultPerSampleIVSize:i}}static has32BitTfdts(e){let t=!1;return R.findBox(e,["moof","traf","tfdt"]).forEach(e=>{0===e[0]&&(t=!0)}),t}static getStartDtsTs(e,t){let i,r=R.findBox(t,["moof","traf"]),s=Number.MAX_SAFE_INTEGER;return r.map((function(t){return R.findBox(t,["tfhd"]).forEach(r=>{const n=R.readUint32(r,4),o=e.tracksById[n];let l,d;if(!o)return;if(!o.isTimingTrack)return 1/0;l=o.timescale||9e4;let h=R.findBox(t,["tfdt"]).map((function(e){var t,i;return t=e[0],i=R.readUint32(e,4),1===t&&(i>L&&a.b.warn("Value larger than can be represented by float for upper 32 bits "+i)(),i*=Math.pow(2,32),i+=R.readUint32(e,8)),i}));d=h.length>0?h[0]:1/0,isFinite(d)&&d/l<s&&(s=d/l,i={baseTime:d,timescale:l})})})),i}static offsetStartDTS(e,t,i,r){R.findBox(t,["moof","traf"]).map((function(t){return R.findBox(t,["tfhd"]).map((function(s){const n=R.readUint32(s,4),o=e.tracksById[n];if(!o)return;var l=o.timescale||9e4;let d="caption"===o.type?0:r;R.findBox(t,["tfdt"]).map((function(e){var t=e[0];const r=o.type;if(0===t){let t=R.readUint32(e,4)-Math.round(i.baseTime*l/i.timescale);"video"===r&&t<0&&(a.b.warn(`video tdft would have gone negative by ${t/l} seconds`)(),t=0),t+=Math.round(d*l),t=Math.max(t,0),R.writeUint32(e,4,t)}else{let t=R.readUint32(e,4);t>L&&a.b.error("baseMediaDecodeTime larger than can be represented by float for upper 32 bits "+t)();let s=t;s*=Math.pow(2,32),s+=R.readUint32(e,8),s-=Math.round(i.baseTime*l/i.timescale),"video"===r&&s<0&&(a.b.warn(`video tdft would have gone negative by ${s/l} seconds`)(),s=0),s+=Math.round(d*l),s=Math.max(s,0);const n=Math.floor(s/(C+1)),o=Math.floor(s%(C+1));R.writeUint32(e,4,n),R.writeUint32(e,8,o)}}))}))}))}static writeStartDTS(e,t,i){R.findBox(t,["moof","traf"]).map((function(t){return R.findBox(t,["tfhd"]).map((function(r){let s=R.readUint32(r,4),n=e.tracksById[s];if(!n)return;let o=n.timescale||9e4,l=Math.round(i*o)/o;Math.abs(l-i)>.01&&a.b.warn(`[iframes] large rounding error when adjusting timestamps, startDTS: ${i}, roundedStartDTS: ${l}`)(),R.findBox(t,["tfdt"]).map((function(e){if(0===e[0])R.writeUint32(e,4,l*o);else{let t=l*o;t=Math.max(t,0);const i=Math.floor(t/(C+1)),r=Math.floor(t%(C+1));R.writeUint32(e,4,i),R.writeUint32(e,8,r)}}))}))}))}static parseSAIO(e){let t=0,i=0,r=e[0];i+=4,0!=(1&R.readUint32(e,0))&&(i+=8);let s=16777215&R.readUint32(e,i);return 1===s?(i+=4,t=R.readUint32(e,i),1===r&&(i+=4,t*=Math.pow(2,32),t+=R.readUint32(e,i))):a.b.error("saio entry count error, count is: "+s)(),t}static parseSAIZ(e){let t=0,i=0;return i+=4,0!=(1&R.readUint32(e,0))&&(i+=8),t=e[i],i++,i+=4,0===t&&(t=e[i]),t}static parseSubsample(e,t){let i={subsamples:[]},r=0;for(e&&(i.iv=t.subarray(0,e),r+=e),r+=2;r+6<=t.byteLength;){let e=R.readUint16(t,r);r+=2;let s=R.readUint32(t,r);r+=4,i.subsamples.push([e,s])}return i}static isSEIMessage(e,t){return e?39===t||40===t:6===t}static parseCLCPSample(e,t,i){let r=0,s=[],a=0;for(;r<i;){let i=t+r,o=R.readUint32(e,i);i+=4;let l=R.bin2str(e.subarray(i,i+4));if(i+=4,"cdat"!==l)break;{let t=o-8;var n=e.subarray(i,i+t);a+=t,s.push(n),r+=o}}return{cdatList:s,cdatTotalSize:a}}static parseSamples(e,t,i,r,s,n){let o,l=i.timescale,d=i.id,h=e,c=0,u=!1;R.findBoxWithOffset(t,0,["moof"]).map((function(e){var f=e.data,g=e.offset;R.findBox(f,["traf"]).map((function(e){let f=R.findBox(e,["tfdt"]).map((function(e){var t,i;return t=e[0],i=R.readUint32(e,4),1===t&&(i*=Math.pow(2,32),i+=R.readUint32(e,8)),i/l}))[0];return void 0!==f&&(h=f),R.findBox(e,["tfhd"]).map((function(f){let p=R.readUint32(f,4),m=16777215&R.readUint32(f,0),y=0,v=0!=(2&m),b=0,S=0!=(8&m),T=0,E=0!=(16&m),_=0,I=0!=(32&m),w=0,A=8;if(p===d){if(0!=(1&m)){y=R.readUint32(f,A),A+=4;let e=R.readUint32(f,A);A+=4,0!==e&&a.b.info("tfhd baseDataOffset has 64-bit value. Caption should be turned off")()}if(v&&(b=R.readUint32(f,A),A+=4),S&&(T=R.readUint32(f,A),A+=4),E&&(_=R.readUint32(f,A),A+=4),I&&(w=R.readUint32(f,A),A+=4),"video"===i.type){let r=0,s=0;R.findBox(e,["saio"]).map((function(e){r=P.parseSAIO(e)})),R.findBox(e,["saiz"]).map((function(e){s=P.parseSAIZ(e)})),r&&s&&(o=P.parseSubsample(i.defaultPerSampleIVSize,t.subarray(r,r+s))),u=P.isHEVCFlavor(i.codec)}R.findBox(e,["trun"]).map((function(e){let a=e[0],d=16777215&R.readUint32(e,0),f=0!=(1&d),p=0,m=0!=(4&d),y=0!=(256&d),v=0,b=0!=(512&d),S=0,E=0!=(1024&d),I=0!=(2048&d),w=0,A=R.readUint32(e,4),k=8;f&&(p=R.readUint32(e,k),k+=4),m&&(k+=4);let C=p+g;for(let d=0;d<A&&(n<0||c<n);d++){if(y?(v=R.readUint32(e,k),k+=4):v=T,b?(S=R.readUint32(e,k),k+=4):S=_,E&&(k+=4),I&&(w=0===a?R.readUint32(e,k):R.readSint32(e,k),k+=4),"video"===i.type){if(Object(D.c)(r))i.samples.push({data:t.subarray(C,C+S),size:S,duration:r*l,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:2,isNonSync:0,paddingValue:0},subsamples:o?o.subsamples:[],iv:o?o.iv:void 0});else if(i.fragmentDuration+=v,s){let e=0;for(;e<S;){let r=R.readUint32(t,C),s=31&t[C+=4];if(i.seiSamples||(i.seiSamples=[]),P.isSEIMessage(u,s)){var L=t.subarray(C,C+r);i.seiSamples.push({pts:h+w/l,type:s,data:L,sampleOffset:C,naluSize:r})}C+=r,e+=r+4}}}else if("audio"===i.type)i.fragmentDuration+=v;else if("caption"===i.type){let{cdatList:e,cdatTotalSize:r}=P.parseCLCPSample(t,C,S);if(C+=S,e.length){let t;if(1===e.length)t=new Uint8Array(e[0]);else if(e.length>1){let i=0;t=new Uint8Array(r);for(const r of e)t.set(r,i),i+=r.length}i.captionSamples.push({type:3,pts:h,bytes:t})}}c++,h+=v/l}}))}}))}))}))}static parseEmsg(e){let t,i,r,s,n,o,l="",d="",h=0;if(0===e[0]){for(;"\0"!==R.bin2str(e.subarray(h,h+1));)l+=R.bin2str(e.subarray(h,h+1)),h+=1;for(l+=R.bin2str(e.subarray(h,h+1)),h+=1;"\0"!==R.bin2str(e.subarray(h,h+1));)d+=R.bin2str(e.subarray(h,h+1)),h+=1;d+=R.bin2str(e.subarray(h,h+1)),h+=1,t=R.readUint32(e,12),i=R.readUint32(e,16),s=R.readUint32(e,20),n=R.readUint32(e,24),h=28}else{h+=4,t=R.readUint32(e,h),h+=4;let i=R.readUint32(e,h);h+=4;let o=R.readUint32(e,h);for(h+=4,r=Math.pow(2,32)*i+o,Number.isSafeInteger(r)||(r=Number.MAX_SAFE_INTEGER,a.b.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")()),s=R.readUint32(e,h),h+=4,n=R.readUint32(e,h),h+=4;"\0"!==R.bin2str(e.subarray(h,h+1));)l+=R.bin2str(e.subarray(h,h+1)),h+=1;for(l+=R.bin2str(e.subarray(h,h+1)),h+=1;"\0"!==R.bin2str(e.subarray(h,h+1));)d+=R.bin2str(e.subarray(h,h+1)),h+=1;d+=R.bin2str(e.subarray(h,h+1)),h+=1}return{schemeIdUri:l,value:d,timeScale:t,presentationTime:r,presentationTimeDelta:i,eventDuration:s,id:n,payload:o=e.subarray(h,e.byteLength)}}static extractID3PayloadCreateID3Track(e,t,i){const r=new l(e.payload);let s,n=new Uint8Array(e.payload),o=n.byteLength,d=0,h=0;if(s=Object(D.c)(e.presentationTime)?e.presentationTime/e.timeScale:t+e.presentationTimeDelta/e.timeScale,!Object(D.c)(s))return void a.b.error("No pts found in emsg info when extracting ID3 payload")();let c=e.eventDuration,u=n.subarray(0,10),f=R.bin2str(u.subarray(h,h+3));h+=3,"ID3"!==f&&a.b.error("No ID3 tag found when extracting ID3 payload")(),h+=2;let g=n.subarray(h,h+1),p=(g[0],64&g[0]),m=16&g[0];if(h+=1,l.readSynchSafeUint32(n.subarray(h,h+4)),h+=4,p){let e=l.readSynchSafeUint32(n.subarray(h,h+4));h+=4,h+=e}for(;h+2<o;){let e="";e+=R.bin2str(n.subarray(h,h+4)),h+=4;let t=l.readSynchSafeUint32(n.subarray(h,h+4));h+=4;let o=s+d*c,u={data:n,pts:o,dts:o,decryptdata:void 0,frames:r.frames};i.id3Samples.push(u),h+=t,d++,m&&("DI3"!==R.bin2str(n.subarray(h,h+3))&&a.b.error("End should be DI3 if footer present in extracting ID3 payload")(),h+=3,h+=7)}h+2===o&&0!==R.readUint16(n,h)&&a.b.warn("Padding should be 0 when extracting ID3 payload")()}append(e,t,i,s,a,n,o){let l=this.initData,d=0,h=0,c=!1,u=!1;void 0===l&&(this.resetInitSegment(e,0),l=this.initData);let f,g=this.initPtsTs;if(g||(f=P.getStartDtsTs(l,e),this.initPtsTs=g={baseTime:f.baseTime-Math.round(t*f.timescale),timescale:f.timescale},this.logger.info(`initPtsTs: ${g.baseTime}/${g.timescale}, sec: ${g.baseTime/g.timescale}, startDtsTs: ${f.baseTime}/${f.timescale} timeOffset: ${t}`)(),this.observer.trigger(r.b.INIT_PTS_FOUND,{initPTS90k:9e4*g.baseTime/g.timescale})),l.foundLargeTimescale&&P.has32BitTfdts(e)&&!o&&(e=k.remuxOverflowSegment(e)),o){let t=this._videoTrack.timescale;o=Math.ceil(o*t)/t,P.writeStartDTS(l,e,n)}else P.offsetStartDTS(l,e,g,this.audioPrimingDelay);f=P.getStartDtsTs(l,e);let p=R.findBox(e,["emsg"]);if(l.video&&l.video.encrypted&&(R.findBox(e,["moof","traf"]).find((function(e){return Boolean(R.findBox(e,["senc"])[0]||R.findBox(e,["saiz"])[0]&&R.findBox(e,["saio"])[0])}))||this.logger.warn("Missing subsample information for encrypted content codec="+l.videoCodec)()),o){let t=(f.baseTime+this.audioPrimingDelay*f.timescale)/f.timescale;if(this._videoTrack&&this._audioTrack&&!this._silentAudioTrack){let e=w.getTrack(this.observer,this._audioTrack.id,this._audioTrack.codec,2);if(!e)throw"unable to create silent audio track for codec "+this._audioTrack.codec;this._silentAudioTrack=Object.assign(Object.assign({},e),{sequenceNumber:0});let t=_.a.initSegment([this._videoTrack,this._silentAudioTrack]);this.remuxedInitDataTrack={type:"audiovideo",container:"video/mp4",codec:this._silentAudioTrack.config.codec+","+this._videoTrack.codec,initSegment:t};const i={track:this.remuxedInitDataTrack};this.observer.trigger(r.b.FRAG_PARSING_INIT_SEGMENT,i)}P.parseSamples(t,e,this._videoTrack,o,!1,1),this.mp4Remuxer.remuxIFrame(t,this._videoTrack,this._silentAudioTrack,o,this.remuxedInitDataTrack),this._videoTrack.samples=[]}else if(p&&p.length>0){let i=(f.baseTime-this.audioPrimingDelay*f.timescale)/f.timescale;i=Math.max(0,i);let r=p.map(e=>{let t=P.parseEmsg(e);return"https://aomedia.org/emsg/ID3\0"!==t.schemeIdUri||this._id3Track||(this._id3Track={id3Samples:[],inputTimescale:9e4}),t});this._id3Track&&r.map(e=>{P.extractID3PayloadCreateID3Track(e,t,this._id3Track)}),this.mp4Remuxer.remuxEmsg(!!l.audio,!!l.video,this._id3Track,i,e,this.remuxedInitDataTrack),this._id3Track&&(this._id3Track.id3Samples=[])}else{let t=(f.baseTime-this.audioPrimingDelay*f.timescale)/f.timescale;t=Math.max(0,t),this._videoTrack&&(P.parseSamples(t,e,this._videoTrack,void 0,this.trySEICaptions,-1),d=this._videoTrack.fragmentDuration/this._videoTrack.timescale,c=!0,this._videoTrack.fragmentDuration=0,this.trySEICaptions?(P.extractSEICaptionsFromNALu(this._videoTrack.seiSamples,this._captionTrack),this._videoTrack.seiSamples=[]):this._captionTrack&&P.parseSamples(t,e,this._captionTrack,void 0,!1,Number.MAX_SAFE_INTEGER)),this._audioTrack&&(P.parseSamples(t,e,this._audioTrack,void 0,!1,-1),h=this._audioTrack.fragmentDuration/this._audioTrack.timescale,u=!0,this._audioTrack.fragmentDuration=0),this.mp4Remuxer.remuxRawData(h,u,d,c,this._captionTrack,t,e,this.remuxedInitDataTrack)}}static extractSEICaptionsFromNALu(e,t){if(e){for(let c=0;c<e.length;++c){let u=e[c],f=u.pts,g=0;g++;for(var i=0,r=0,s=!1,a=0;!s&&g<u.data.length;){i=0;do{if(g>=u.data.length)break;i+=a=u.data[g++]}while(255===a);r=0;do{if(g>=u.data.length)break;r+=a=u.data[g++]}while(255===a);let e=u.data.length-g;if(4===i&&g<u.data.length){if(s=!0,181===u.data[g++]){var n=R.readUint16(u.data,g);if(g+=2,49===n){var o=R.readUint32(u.data,g);if(g+=4,1195456820===o&&3===u.data[g++]){var l=u.data[g++];g++;var d=31&l,h=[];if(64&l)for(let e=0;e<d;e++){let e=u.data[g++];if(e===(252&e)){let t=3&e;if(0===t||1===t){let e=u.data[g++],t=u.data[g++];h.push(e),h.push(t)}}else g+=2}h.length>0&&t.captionSamples.push({type:3,pts:f,bytes:h})}}}}else if(r<e)g+=r;else if(r>e)break}}return t}}}var M=P,x=class{constructor(e){this.data=e,this._bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}get bytesAvailable(){return this._bytesAvailable}loadWord(){var e=this.data,t=this._bytesAvailable,i=e.byteLength-t,r=new Uint8Array(4),s=Math.min(4,t);if(0===s)throw new Error("no bytes available");r.set(e.subarray(i,i+s)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*s,this._bytesAvailable-=s}skipBits(e){var t;this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,e-=(t=e>>3)>>3,this._bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){var t=Math.min(this.bitsAvailable,e),i=this.word>>>32-t;return e>32&&a.b.error("Cannot read more than 32 bits at a time")(),this.bitsAvailable-=t,this.bitsAvailable>0?this.word<<=t:this._bytesAvailable>0&&this.loadWord(),(t=e-t)>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){var e=this.skipLZ();return this.readBits(e+1)-1}readEG(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){var t,i=8,r=8;for(t=0;t<e;t++)0!==r&&(r=(i+this.readEG()+256)%256),i=0===r?i:r}readSPS(){var e,t,i,r,s,a,n,o=0,l=0,d=0,h=0,c=this.readUByte.bind(this),u=this.readBits.bind(this),f=this.readUEG.bind(this),g=this.readBoolean.bind(this),p=this.skipBits.bind(this),m=this.skipEG.bind(this),y=this.skipUEG.bind(this),v=this.skipScalingList.bind(this);if(c(),e=c(),u(5),p(3),c(),y(),100===e||110===e||122===e||244===e||44===e||83===e||86===e||118===e||128===e){var b=f();if(3===b&&p(1),y(),y(),p(1),g())for(a=3!==b?8:12,n=0;n<a;n++)g()&&v(n<6?16:64)}y();var S=f();if(0===S)f();else if(1===S)for(p(1),m(),m(),t=f(),n=0;n<t;n++)m();y(),p(1),i=f(),r=f(),0===(s=u(1))&&p(1),p(1),g()&&(o=f(),l=f(),d=f(),h=f());let T=[1,1];if(g()&&g())switch(c()){case 1:T=[1,1];break;case 2:T=[12,11];break;case 3:T=[10,11];break;case 4:T=[16,11];break;case 5:T=[40,33];break;case 6:T=[24,11];break;case 7:T=[20,11];break;case 8:T=[32,11];break;case 9:T=[80,33];break;case 10:T=[18,11];break;case 11:T=[15,11];break;case 12:T=[64,33];break;case 13:T=[160,99];break;case 14:T=[4,3];break;case 15:T=[3,2];break;case 16:T=[2,1];break;case 255:T=[c()<<8|c(),c()<<8|c()]}return{width:Math.ceil(16*(i+1)-2*o-2*l),height:(2-s)*(r+1)*16-(s?2:4)*(d+h),pixelRatio:T}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}},O=class{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}},N=class extends g{constructor(e,t,i,r){super(e,t),this.typeSupported=i;const s=navigator.userAgent;this.isSafari=r&&r.indexOf("Apple")>-1&&s&&!s.match("CriOS"),this.currentInitTrack=void 0}resetTimeStamp(e){this._initPTS=this._initDTS=e}resetInitSegment(){this.currentInitTrack=void 0,this._silentAudioTrack=void 0}remuxEsTracks(e,t,i,s,n,o,l,d,h,c){var u;let f,g=void 0===h?n:h;if(!this.currentInitTrack){if(e&&e.config.codec&&(this._audioTrackInfo={id:e.info.id,codec:e.config.codec,channelCount:e.config.channelCount}),t&&c&&this._audioTrackInfo){let e=w.getTrack(this.observer,this._audioTrackInfo.id,this._audioTrackInfo.codec,this._audioTrackInfo.channelCount);e&&(this._silentAudioTrack=Object.assign(Object.assign({},e),{info:Object.assign(Object.assign({},e.info),{inputTimescale:9e4}),parsingData:{len:0,sequenceNumber:0,esSamples:[]}}),f=w.getSegment(this._silentAudioTrack,t.parsingData.sequenceNumber,g*this._silentAudioTrack.info.timescale,c),t.parsingData.sequenceNumber++)}else this._silentAudioTrack=void 0;this.updateInitPTSDTS(t,e,n),this.generateIS(this._silentAudioTrack?this._silentAudioTrack:e,t)}if(this.currentInitTrack){let i,s,h;if(t&&c&&this._silentAudioTrack&&!f&&(f=w.getSegment(this._silentAudioTrack,t.parsingData.sequenceNumber,Math.round((g+this.config.audioPrimingDelay)*this._silentAudioTrack.info.timescale),c)),e&&e.parsingData.esSamples.length){if(Object(D.c)(e.info.timescale)||(a.b.warn("regenerate InitSegment as audio detected")(),this.updateInitPTSDTS(t,e,n),this.generateIS(e,t)),i=this.remuxAudio(e,g,o,l,d),t&&t.parsingData.esSamples.length){let r;i&&(r=i.endPTS-i.startPTS),Object(D.c)(t.info.timescale)||(a.b.warn("regenerate InitSegment as video detected")(),this.updateInitPTSDTS(t,e,n),this.generateIS(e,t)),s=this.remuxVideo(t,g,o,r,c)}}else t&&t.parsingData.esSamples.length&&(s=this.remuxVideo(t,g,o,void 0,c)),s&&e&&e.config.codec&&(i=this.remuxEmptyAudio(e,g,o,l,s,d));f?h={data1:s.data1,data2:f,startDTS:s.startDTS,startPTS:s.startPTS,type:"audiovideo",track:this.currentInitTrack}:s&&i?h={data1:s.data1,data2:i.data1,startDTS:Math.min(s.startDTS,i.startDTS),startPTS:Math.min(s.startPTS,i.startPTS),endDTS:Math.max(s.endDTS,i.endDTS),endPTS:Math.max(s.endPTS,i.endPTS),type:"audiovideo",track:this.currentInitTrack}:s?h={data1:s.data1,startDTS:s.startDTS,startPTS:s.startPTS,endDTS:s.endDTS,endPTS:s.endPTS,type:"video",track:this.currentInitTrack}:i&&(h={data1:i.data1,startDTS:i.startDTS,startPTS:i.startPTS,endDTS:i.endDTS,endPTS:i.endPTS,type:"audio",track:this.currentInitTrack}),this.observer.trigger(r.b.FRAG_PARSING_DATA,h)}else a.b.error("failed to generate IS")();(null===(u=null==i?void 0:i.id3Samples)||void 0===u?void 0:u.length)&&this.remuxID3(i,g),s&&s.captionSamples.length&&this.remuxText(s,g),this.observer.trigger(r.b.FRAG_PARSED)}updateInitPTSDTS(e,t,i){let a=1/0,n=1/0,o=e?e.parsingData.esSamples:[],l=t?t.parsingData.esSamples:[];if(!Object(D.c)(this._initPTS)){if(t&&l.length&&(a=n=l[0].pts-t.info.inputTimescale*i),e&&o.length){const t=e.info.inputTimescale;e.info.timescale=t,a=Math.min(a,o[0].pts-t*i),n=Math.min(n,o[0].dts-t*i),this.observer.trigger(r.b.INIT_PTS_FOUND,{initPTS90k:a})}if(Object(D.c)(a)&&Object(D.c)(n))this._initPTS=a,this._initDTS=n;else{let e={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!1,reason:"invalid initPTS or initDTS"};this.observer.trigger(r.b.INTERNAL_ERROR,e)}}}generateIS(e,t){const i=this.observer,a=t?t.parsingData.esSamples:[],n=this.typeSupported;let o,l="audio/mp4";if(e&&t&&a.length){const i=t.info.inputTimescale;t.info.timescale=i,e.info.timescale=e.config.samplerate;const r=_.a.initSegment([t,e]);o={type:"audiovideo",container:"video/mp4",codec:`${t.config.codec},${e.config.codec}`,initSegment:r}}else if(e){switch(e.info.timescale=e.config.samplerate,e.config.segmentCodec){case"mp3":n.mpeg?(l="audio/mpeg",e.config.codec=""):n.mp3&&(e.config.codec="mp3")}const t="mp3"===e.config.segmentCodec&&n.mpeg?new Uint8Array:_.a.initSegment([e]);o={type:"audio",container:l,codec:e.config.codec,initSegment:t}}else if(t&&a.length){const e=t.info.inputTimescale;t.info.timescale=e;const i=_.a.initSegment([t]);o={type:"video",container:"video/mp4",codec:t.config.codec,initSegment:i}}if(o){this.currentInitTrack=o;let e={track:o};i.trigger(r.b.FRAG_PARSING_INIT_SEGMENT,e)}else{let e={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!1,reason:"no audio/video samples found"};i.trigger(r.b.INTERNAL_ERROR,e)}}remuxVideo(e,t,i,n,o){var l,d,h,c,u,f,g,p=8,m=e.info.inputTimescale,y=e.parsingData.esSamples,v=[],b=y.length,S=this._PTSNormalize,T=this._initDTS,E=e.info.encrypted;let I;I=i?this.nextAvcDts:t*m,y.forEach((function(e){e.pts=S(e.pts-T,I),e.dts=S(e.dts-T,I)})),y.sort((function(e,t){const i=e.dts-t.dts,r=e.pts-t.pts;return i||r||e.id-t.id}));let w=y.reduce((e,t)=>Math.max(Math.min(e,t.pts-t.dts),-18e3),0);if(w<0){a.b.warn(`PTS < DTS detected in video samples, shifting DTS by ${Math.round(w/90)} ms to overcome this issue`)();for(let e=0;e<y.length;e++)y[e].dts+=w}let R=y[0];u=Math.max(R.dts,0),c=Math.max(R.pts,0),Object(D.c)(o)&&(u=t*m,c=t*m);let A=Math.round((u-I)/90);i&&A&&(u=I,y[0].dts=u,c=Math.max(c-A,I),y[0].pts=c,a.b.info(`Video/PTS/DTS adjusted: ${Math.round(c/90)}/${Math.round(u/90)},delta:${A} ms`)()),R=y[y.length-1],g=Math.max(R.dts,0),f=Math.max(R.pts,0,g),Object(D.c)(o)&&(g=t*m,f=t*m);const k=this.isSafari;k&&(l=Math.round((g-u)/(y.length-1)));let C=0,L=0;for(let e=0;e<b;e++){let t=y[e],i=t.units,r=i.length,s=0;for(let e=0;e<r;e++)s+=i[e].data.length;L+=s,C+=r,t.length=s,t.dts=k?u+e*l:Math.max(t.dts,u),t.pts=Math.max(t.pts,t.dts)}let P=L+4*C+8;try{d=new Uint8Array(P)}catch(e){let t,i={type:s.g.MUX_ERROR,details:s.d.REMUX_ALLOC_ERROR,fatal:!1,bytes:P,reason:"fail allocating video mdat "+P,response:s.f.InternalError};return i.level=t,void this.observer.trigger(r.b.INTERNAL_ERROR,i)}let M=new DataView(d.buffer);M.setUint32(0,P),d.set(_.a.types.mdat,4);for(let e=0;e<b;e++){let t,i=y[e],r=i.units,s=0,a=[],h=0;for(let e=0,t=r.length;e<t;e++){let t=r[e],i=t.data,n=t.data.byteLength;if(M.setUint32(p,n),p+=4,d.set(i,p),p+=n,s+=4+n,E)if(n<=48||1!==t.type&&5!==t.type)h+=4+n;else{let e=n-32;e%16==0&&(e-=16),a.push([h+36,e]),h=n-32-e}}if(h>0&&a.push([h,0]),k)t=Math.max(0,l*Math.round((i.pts-i.dts)/l));else{if(e<b-1)l=y[e+1].dts-i.dts;else{let t=this.config,r=i.dts-y[e>0?e-1:e].dts;if(t.stretchShortVideoTrack){let e=t.maxBufferHole,s=t.maxSeekHole,a=Math.floor(Math.min(e,s)*m),o=(n?c+n*m:this.nextAudioPts)-i.pts;o>a?(l=o-r)<0&&(l=r):l=r}else l=r}t=Math.round(i.pts-i.dts)}Object(D.c)(o)&&(t=0,l=o*m),v.push({size:s,duration:l,cts:t,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:i.key?2:1,isNonSync:i.key?0:1,paddingValue:0},decryptdata:i.decryptdata,subsamples:a})}this.nextAvcDts=g+l;let x=e.parsingData.dropped;if(e.parsingData.dropped=0,v.length&&navigator.userAgent.toLowerCase().indexOf("chrome")>-1){let e=v[0].flags;e.dependsOn=2,e.isNonSync=0}let O={sequenceNumber:e.parsingData.sequenceNumber++,id:e.info.id,type:e.type,encrypted:e.info.encrypted,samples:v,defaultPerSampleIVSize:0};h=_.a.moof(u+this.config.audioPrimingDelay*m,O),e.parsingData.esSamples=[];let N=new Uint8Array(h.byteLength+d.byteLength);return N.set(h),N.set(d,h.byteLength),{data1:N,startPTS:c/m,endPTS:(f+l)/m,startDTS:u/m,endDTS:this.nextAvcDts/m,type:"video",dropped:x}}remuxAudio(e,t,i,n,o){const l=e.info.inputTimescale,h=l/e.info.timescale,c=("aac"===e.config.segmentCodec?1024:"mp3"===e.config.segmentCodec?1152:1536)*h,u=this._PTSNormalize,f=this._initDTS,g="mp3"===e.config.segmentCodec&&this.typeSupported.mpeg,p=e.info.encrypted;var m,y,v,b,S,T,E,D,I,w,R,A,k,C=g?0:8,L=[],P=[];let M=new d;if(P=e.parsingData.esSamples,k=this.nextAudioPts,(i=i||P.length&&k&&(n&&Math.abs(t-k/l)<.1||Math.abs(P[0].pts-k-f)<20*c))||(k=t*l),P.forEach((function(e){e.pts=e.dts=u(e.pts-f,k)})),P.sort((function(e,t){return e.pts-t.pts})),n&&"aac"===e.config.segmentCodec)for(let t=0,i=k;t<P.length;){var x,N=P[t];x=(I=N.pts)-i;const r=Math.abs(1e3*x/l);if(x<=-c)a.b.warn(`Dropping 1 audio frame @ ${(i/l).toFixed(3)}s due to ${r} ms overlap.`)(),P.splice(t,1),e.parsingData.len-=N.unit.length;else if(x>=c&&r<1e4&&i){var F=Math.round(x/c);a.b.warn(`Injecting ${F} audio frame @ ${(i/l).toFixed(3)}s due to ${Math.round(1e3*x/l)} ms gap.`)();for(var B=0;B<F;B++)A=Math.max(i,0),(R=O.getSilentFrame(e.config.codec,e.config.channelCount))||(a.b.warn("Unable to get silent frame for given audio codec; duplicating last frame instead.")(),R=N.unit.subarray(0)),P.splice(t,0,{unit:R,pts:A,dts:A,decryptdata:o}),e.parsingData.len+=R.length,i+=c,t+=1;N.pts=N.dts=i,i+=c,t+=1}else Math.abs(x),i+=c,N.pts=N.dts=0===t?k:P[t-1].pts+c,t+=1}for(let t=0,n=P.length;t<n;t++){if(v=(m=P[t]).unit,I=m.pts,w=m.dts,void 0!==D)y.duration=Math.round((w-D)/h);else{let t=Math.round(1e3*(I-k)/l),n=0;if(i&&"aac"===e.config.segmentCodec&&t){if(t>0&&t<1e4)(n=Math.round((I-k)/c))>0&&((R=O.getSilentFrame(e.config.codec,e.config.channelCount))||(R=v.subarray(0)),e.parsingData.len+=n*R.length);else if(t<-12){e.parsingData.len-=v.byteLength;continue}I=w=k}if(T=Math.max(0,I),E=Math.max(0,w),!(e.parsingData.len>0))return;{let t=g?e.parsingData.len:e.parsingData.len+8;try{b=new Uint8Array(t)}catch(e){let i,a={type:s.g.MUX_ERROR,details:s.d.REMUX_ALLOC_ERROR,fatal:!1,bytes:t,reason:"fail allocating audio mdat "+t,response:s.f.InternalError};return a.level=i,void this.observer.trigger(r.b.INTERNAL_ERROR,a)}g||(new DataView(b.buffer).setUint32(0,t),b.set(_.a.types.mdat,4))}for(let t=0;t<n;t++)A=I-(n-t)*c,(R=O.getSilentFrame(e.config.codec,e.config.channelCount))||(a.b.warn("Unable to get silent frame for given audio codec; duplicating this frame instead.")(),R=v.subarray(0)),b.set(R,C),C+=R.byteLength,y={size:R.byteLength,cts:0,duration:1024,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,paddingValue:0,isNonSync:0},decryptdata:m.decryptdata,subsamples:p?[[R.byteLength,0]]:[]},L.push(y)}b.set(v,C);let n=v.byteLength;C+=n;let o=[];if(p)if("ec3"===e.config.segmentCodec){let e=0;for(;e<v.byteLength;){let t=2*(M.bsReadAndUpdate(v,{byteOffset:e+2,usedBits:5},11)+1);e+=t;let i=Math.min(t,16);o.push([i,t-i])}}else{let e=Math.min(n,16);o.push([e,n-e])}y={size:n,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,paddingValue:0,isNonSync:0},decryptdata:m.decryptdata,subsamples:o},L.push(y),D=w}var U=0,$=L.length;if($>=2&&(U=L[$-2].duration,y.duration=U),$){if(this.nextAudioPts=I+h*U,e.parsingData.len=0,g)S=new Uint8Array;else{let t={sequenceNumber:e.parsingData.sequenceNumber++,id:e.info.id,type:e.type,encrypted:e.info.encrypted,samples:L,defaultPerSampleIVSize:0};S=_.a.moof((E+this.config.audioPrimingDelay*l)/h,t)}let t=new Uint8Array(S.byteLength+b.byteLength);return t.set(S),t.set(b,S.byteLength),e.parsingData.esSamples=[],{data1:t,startPTS:T/l,endPTS:this.nextAudioPts/l,startDTS:E/l,endDTS:(w+h*U)/l,type:"audio"}}return null}remuxEmptyAudio(e,t,i,r,s,n){let o=e.info.inputTimescale,l=o/(e.config.samplerate?e.config.samplerate:o),d=this.nextAudioPts,h=(void 0!==d?d:s.startDTS*o)+this._initDTS,c=s.endDTS*o+this._initDTS,u=1024*l,f=Math.ceil((c-h)/u),g=O.getSilentFrame(e.config.codec,e.config.channelCount);if(a.b.warn("remux empty Audio")(),!g)return void a.b.error("Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec!")();let p=[];for(var m=0;m<f;m++){var y=h+m*u;p.push({unit:g,pts:y,dts:y,decryptdata:n}),e.parsingData.len+=g.length}return e.parsingData.esSamples=p,this.remuxAudio(e,t,i,r,n)}remuxID3(e,t){var i,s=e.id3Samples.length;const a=e.inputTimescale,n=this._initPTS,o=this._initDTS;if(s){for(var l=0;l<s;l++)(i=e.id3Samples[l]).pts=(i.pts-n)/a,i.dts=(i.dts-o)/a;this.observer.trigger(r.b.FRAG_PARSING_METADATA,{samples:e.id3Samples})}e.id3Samples=[]}remuxText(e,t){e.captionSamples.sort((function(e,t){return e.pts-t.pts}));var i,s=e.captionSamples.length;const a=e.inputTimescale,n=this._initPTS;if(s){for(var o=0;o<s;o++)(i=e.captionSamples[o]).pts=(i.pts-n)/a;this.observer.trigger(r.b.FRAG_PARSING_USERDATA,{samples:e.captionSamples})}e.captionSamples=[]}_PTSNormalize(e,t){var i;if(void 0===t)return e;for(i=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=i;return e}};t.a=class{constructor(e,t,i,r){this.observer=e,this.typeSupported=t,this.config=i,this.vendor=r,this.logger=new a.a,this.logger.enable(i.debug,i.debugLevel)}destroy(){var e=this.demuxer;e&&e.destroy()}push(e,t,i,n,o,u,g,p,m,T,_,D){var I=this.demuxer;i=new Uint8Array(i);const w=new Uint8Array(e);if(!I||(o||u)&&!this.probeFn(w)){const{observer:e,typeSupported:t,config:i}=this,n=[{demux:M,remux:k},{demux:class extends f{constructor(e,t,i,r,s){super(e,t,i,r,s)}static probe(e){return e.length>=564&&71===e[0]&&71===e[188]&&71===e[376]}resetInitSegment(e,t,i){this.pmtParsed=!1,this._pmtId=-1;const r={id:-1,inputTimescale:9e4,timescale:NaN,duration:0,encrypted:i&&i.isEncrypted,decryptdata:i},s={len:0,sequenceNumber:0};this._avcContext={info:Object.assign({},r),parsingData:Object.assign(Object.assign({},s),{esSamples:new Array,dropped:0}),config:{},container:"video/mp2t",type:"video"},this._audioContext={info:Object.assign({},r),parsingData:Object.assign(Object.assign({},s),{esSamples:new Array}),container:"video/mp2t",type:"audio"},this._id3Track={id:-1,inputTimescale:9e4,id3Samples:[]},this._txtTrack={inputTimescale:9e4,captionSamples:[]},this._duration=t,this._initSegment=e}append(e,t,i,a,n,o,l){var d,h,c,u,f,g=!1;this.contiguous=i;var p=this.pmtParsed,m=this._avcContext,y=this._audioContext,v=this._id3Track,b=m.info.id,S=y.info.id,T=v.id,E=this._pmtId,_=m.pesData,D=y.pesData,I=v.pesData;if(this.iframeMode=void 0!==l,this._initSegment&&this._initSegment.byteLength>0){let t=new Uint8Array(this._initSegment.byteLength+e.byteLength);t.set(this._initSegment),t.set(e,this._initSegment.byteLength),this._initSegment=void 0,e=t}let w,R,A=e.length;for(A-=A%188,d=0;d<A;d+=188){if(71!==e[d]){let e={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!1,reason:"TS packet did not start with 0x47"};return void this.observer.trigger(r.b.INTERNAL_ERROR,e)}if(h=!!(64&e[d+1]),c=((31&e[d+1])<<8)+e[d+2],(48&e[d+3])>>4>1){if((u=d+5+e[d+4])===d+188)continue}else u=d+4;switch(c){case b:h&&(_&&(f=this._parsePES(_))&&this._parseAVCPES(f,!1),_={data:[],size:0,decryptdata:n}),_&&(_.data.push(e.subarray(u,d+188)),_.size+=d+188-u);break;case S:if(h&&!this.iframeMode){if(D&&(f=this._parsePES(D)))switch(y.segmentCodec){case"aac":this._parseAACPES(f);break;case"mp3":this._parseMPEGPES(f);break;case"ac3":case"ec3":this._parseDolbyPES(f)}D={data:[],size:0,decryptdata:n}}D&&(D.data.push(e.subarray(u,d+188)),D.size+=d+188-u);break;case T:h&&(I&&(f=this._parsePES(I))&&v.id3Samples.push(f),I={data:[],size:0}),I&&(I.data.push(e.subarray(u,d+188)),I.size+=d+188-u);break;case 0:h&&(u+=e[u]+1),E=this._pmtId=this._parsePAT(e,u);break;case E:h&&(u+=e[u]+1);let t=this._parsePMT(e,u,this.typeSupported);(b=t.avcId)>0&&(m.info.id=b,m.info.encrypted=t.videoEncrypted),(S=t.audioId)>0&&(y.info.id=S,y.segmentCodec=t.audioSegmentCodec,y.info.encrypted=t.audioEncrypted),(T=t.id3Id)>0&&(v.id=T),g&&!p&&(g=!1,d=-188),p=this.pmtParsed=!0;break;case 17:case 8191:break;default:g=!0}}if(_&&(f=this._parsePES(_))?(this._parseAVCPES(f,!0),m.pesData=void 0):m.pesData=_,D&&(f=this._parsePES(D))){switch(y.segmentCodec){case"aac":this._parseAACPES(f);break;case"mp3":this._parseMPEGPES(f);break;case"ac3":case"ec3":this._parseDolbyPES(f)}y.pesData=void 0}else D&&D.size&&this.logger.warn("last AAC PES packet truncated,might overlap between fragments")(),y.pesData=D;I&&(f=this._parsePES(I))?(v.id3Samples.push(f),v.pesData=void 0):v.pesData=I,y.config&&y.segmentCodec&&(w={type:"audio",info:y.info,config:y.config,parsingData:y.parsingData});let k=m.config;var C;"string"==typeof(C=k).codec&&Array.isArray(C.sps)&&Array.isArray(C.pps)&&"number"==typeof C.width&&"number"==typeof C.height&&Array.isArray(C.pixelRatio)&&(R={type:"video",info:m.info,config:k,parsingData:m.parsingData}),this.esRemuxer.remuxEsTracks(w,R,v,this._txtTrack,t,i,a,n,o,l)}destroy(){this._duration=0}_parsePAT(e,t){return(31&e[t+10])<<8|e[t+11]}_parsePMT(e,t,i){var r,s;let a={audioId:-1,avcId:-1,id3Id:-1,audioEncrypted:!1,videoEncrypted:!1};for(r=t+3+((15&e[t+1])<<8|e[t+2])-4,t+=12+((15&e[t+10])<<8|e[t+11]);t<r;){switch(s=(31&e[t+1])<<8|e[t+2],e[t]){case 207:a.audioEncrypted=!0;case 15:-1===a.audioId&&(a.audioId=s,a.audioSegmentCodec="aac");break;case 21:-1===a.id3Id&&(a.id3Id=s);break;case 219:a.videoEncrypted=!0;case 27:-1===a.avcId&&(a.avcId=s);break;case 3:case 4:!0!==i.mpeg&&!0!==i.mp3?this.logger.warn("MPEG audio found, not supported in this browser for now")():-1===a.audioId&&(a.audioId=s,a.audioSegmentCodec="mp3");break;case 193:a.audioEncrypted=!0;case 129:!0!==i.ac3?this.logger.warn("AC-3 audio found, not supported in this browser for now")():-1===a.audioId&&(a.audioId=s,a.audioSegmentCodec="ac3");break;case 194:a.audioEncrypted=!0;case 135:!0!==i.ec3?this.logger.warn("EC-3 audio found, not supported in this browser for now")():-1===a.audioId&&(a.audioId=s,a.audioSegmentCodec="ec3");break;case 36:this.logger.warn("HEVC stream type found, not supported for now")();break;default:this.logger.warn("unkown stream type:"+e[t])()}t+=5+((15&e[t+3])<<8|e[t+4])}return a}_parsePES(e){var t,i,r,s,a,n,o=0,l=e.data,d=e.decryptdata;let h=NaN,c=NaN;if(e&&0!==e.size){for(;l[0].length<19&&l.length>1;){let e=new Uint8Array(l[0].length+l[1].length);e.set(l[0]),e.set(l[1],l[0].length),l[0]=e,l.splice(1,1)}if(1===((t=l[0])[0]<<16)+(t[1]<<8)+t[2]){if((r=(t[4]<<8)+t[5])&&r>e.size-6)return;192&(i=t[7])&&((h=536870912*(14&t[9])+4194304*(255&t[10])+16384*(254&t[11])+128*(255&t[12])+(254&t[13])/2)>4294967295&&(h-=8589934592),64&i?((c=536870912*(14&t[14])+4194304*(255&t[15])+16384*(254&t[16])+128*(255&t[17])+(254&t[18])/2)>4294967295&&(c-=8589934592),h-c>54e5&&(this.logger.warn(Math.round((h-c)/9e4)+"s delta between PTS and DTS, align them")(),h=c)):c=h),n=(s=t[8])+9,e.size-=n,a=new Uint8Array(e.size);for(let e=0,i=l.length;e<i;e++){let i=(t=l[e]).byteLength;if(n){if(n>i){n-=i;continue}t=t.subarray(n),i-=n,n=0}a.set(t,o),o+=i}return r&&(r-=s+3),{data:a,pts:h,dts:c,len:r,decryptdata:d}}}}pushAccesUnit(e,t){let i=e.avcSample;if(i&&i.units.length&&i.frame){const r=e.parsingData.esSamples,s=r.length;!this.config.forceKeyFrameOnDiscontinuity||!0===i.key||e.config.sps&&(s||this.contiguous)?(i.id=s,i.decryptdata=t,e.info.encrypted&&i.units.forEach(e=>{if(e.data.byteLength>48)switch(e.type){case 1:case 5:e.data=this.discardEPB(e.data)}}),r.push(i)):e.parsingData.dropped++}i&&i.debug.length}_parseAVCPES(e,t){if(!e.data)throw"invalid pes data";var i,r,s,a=this._avcContext,n=this._parseAVCNALu(e.data),o=a.avcSample,l=e.decryptdata;e.data=void 0,n.forEach(t=>{switch(t.type){case 1:if(o&&!this.iframeMode){r=!0,o.frame=!0;let e=t.data;if(e.length>4){let t=new x(e).readSliceType();2!==t&&4!==t&&7!==t&&9!==t||(o.key=!0)}}break;case 5:r=!0,o&&(o||(o=a.avcSample=this._createAVCSample(!0,e.pts,e.dts,"")),o.key=!0,o.frame=!0);break;case 6:r=!0,(i=new x(this.discardEPB(t.data))).readUByte();for(var n=0,d=0,h=!1,c=0;!h&&i.bytesAvailable>1;){n=0;do{n+=c=i.readUByte()}while(255===c);d=0;do{d+=c=i.readUByte()}while(255===c);if(4===n&&0!==i.bytesAvailable){if(h=!0,181===i.readUByte()&&49===i.readUShort()&&1195456820===i.readUInt()&&3===i.readUByte()){var u=i.readUByte(),f=31&u,g=[u,i.readUByte()];for(s=0;s<f;s++)g.push(i.readUByte()),g.push(i.readUByte()),g.push(i.readUByte());this._insertSampleInOrder(this._txtTrack.captionSamples,{type:3,pts:e.pts,bytes:g})}}else if(d<i.bytesAvailable)for(s=0;s<d;s++)i.readUByte()}break;case 7:if(r=!0,!a.config.sps){var p=(i=new x(t.data)).readSPS();a.config.width=p.width,a.config.height=p.height,a.config.pixelRatio=p.pixelRatio,a.config.sps=[t.data],a.info.duration=this._duration;var m=t.data.subarray(1,4),y="avc1.";for(s=0;s<3;s++){var v=m[s].toString(16);v.length<2&&(v="0"+v),y+=v}a.config.codec=y}break;case 8:r=!0,a.config.pps||(a.config.pps=[t.data]);break;case 9:r=!1,o&&this.pushAccesUnit(a,l),o=a.avcSample=this._createAVCSample(!1,e.pts,e.dts,"");break;case 12:r=!1;break;default:r=!1,o&&(o.debug+="unknown NAL "+t.type+" ")}o&&r&&o.units.push(t)}),t&&o&&(this.pushAccesUnit(a,l),a.avcSample=void 0)}_createAVCSample(e,t,i,r){return{id:NaN,key:e,pts:t,dts:i,units:new Array,debug:r}}_insertSampleInOrder(e,t){var i=e.length;if(i>0){if(t.pts>=e[i-1].pts)e.push(t);else for(var r=i-1;r>=0;r--)if(t.pts<e[r].pts){e.splice(r,0,t);break}}else e.push(t)}_getLastNalUnit(){let e,t=this._avcContext,i=t.avcSample;if(!i||0===i.units.length){let e=t.parsingData.esSamples;i=e[e.length-1]}if(i){let t=i.units;e=t[t.length-1]}return e}_parseAVCNALu(e){var t,i,r,s,a=0,n=e.byteLength,o=this._avcContext,l=o.naluState||0,d=l,h=[],c=-1;for(-1===l&&(c=0,s=31&e[0],l=0,a=1);a<n;)if(t=e[a++],l)if(1!==l)if(t)if(1===t){if(c>=0)r={data:e.subarray(c,a-l-1),type:s},h.push(r);else{let t=this._getLastNalUnit();if(t&&(d&&a<=4-d&&t.state&&(t.data=t.data.subarray(0,t.data.byteLength-d)),(i=a-l-1)>0)){let r=new Uint8Array(t.data.byteLength+i);r.set(t.data,0),r.set(e.subarray(0,i),t.data.byteLength),t.data=r}}a<n?(c=a,s=31&e[a],l=0):l=-1}else l=0;else l=3;else l=t?0:2;else l=t?0:1;if(c>=0&&l>=0&&(r={data:e.subarray(c,n),type:s,state:l},h.push(r)),0===h.length){let t=this._getLastNalUnit();if(t){let i=new Uint8Array(t.data.byteLength+e.byteLength);i.set(t.data,0),i.set(e,t.data.byteLength),t.data=i}}return o.naluState=l,h}discardEPB(e){for(var t,i,r=e.byteLength,s=[],a=1;a<r-2;)0===e[a]&&0===e[a+1]&&3===e[a+2]?(s.push(a+2),a+=2):a++;if(0===s.length)return e;t=r-s.length,i=new Uint8Array(t);var n=0;for(a=0;a<t;n++,a++)n===s[0]&&(n++,s.shift()),i[a]=e[n];return i}_parseAACPES(e){var t,i,a,n,o,l,d,h,c=this._audioContext,u=e.data,f=e.pts,g=c.audioOverFlow,p=c.audioLastPTS,m=e.decryptdata;if(g){var y=new Uint8Array(g.byteLength+u.byteLength);y.set(g,0),y.set(u,g.byteLength),u=y}for(n=0,d=u.length;n<d-1&&(255!==u[n]||240!=(240&u[n+1]));n++);if(n){var v,b;n<d-1?(v="AAC PES did not start with ADTS header,offset:"+n,b=!1):(v="no ADTS header found in AAC PES",b=!0),this.logger.warn("parsing error:"+v)();let e={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:b,reason:v};if(this.observer.trigger(r.b.INTERNAL_ERROR,e),b)return}if(!c.config){let e=S(this.observer,u,n);if(!e)throw"unable to parse adts header";c.config=e}if(a=0,i=9216e4/c.config.samplerate,g&&p){var T=p+i;Math.abs(T-f)>1&&(f=T)}for(;n+5<d&&(o=1&u[n+1]?7:9,t=(3&u[n+3])<<11|u[n+4]<<3|(224&u[n+5])>>>5,(t-=o)>0&&n+o+t<=d);)for(l=f+a*i,h={unit:u.subarray(n+o,n+o+t),pts:l,dts:l,decryptdata:m},c.parsingData.esSamples.push(h),c.parsingData.len+=t,n+=t+o,a++;n<d-1&&(255!==u[n]||240!=(240&u[n+1]));n++);g=n<d?u.subarray(n,d):void 0,c.audioOverFlow=g,c.audioLastPTS=l}_parseMPEGPES(e){"mp3"===this._audioContext.segmentCodec&&E.parse(this._audioContext.parsingData,e.data,0,e.pts)}_parseDolbyPES(e){let t=this._audioContext,i=e.data,a=e.pts,n=e.decryptdata,o=0,l=0,d=t.audioOverFlow,u=t.audioLastPTS;if(!t.config){let e;if("ac3"===t.segmentCodec?e=v(this.observer,i,l):"ec3"===t.segmentCodec&&(e=c(this.observer,i,l)),!e)throw"unable to parse dolby header";t.config=e}if("ac3"!==t.config.segmentCodec&&"ec3"!==t.config.segmentCodec)throw"unexpected config type";const f=1536/t.config.samplerate*t.info.inputTimescale;if(d){var g=new Uint8Array(d.byteLength+i.byteLength);g.set(d,0),g.set(i,d.byteLength),i=g}let p=i.length;if(d&&u){var m=u+f;Math.abs(m-a)>1&&(a=m)}let y=0;for(;l+y<=p;){if(11!==i[l]||119!==i[l+1]){let e={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid dolby audio magic"};return void this.observer.trigger(r.b.INTERNAL_ERROR,e)}"ac3"===t.segmentCodec?y=b(this.observer,i,l):"ec3"===t.segmentCodec&&(y=h(this.observer,i,l));let e=a+o*f;t.audioLastPTS=e;let d={unit:i.subarray(l,l+y),pts:e,dts:e,decryptdata:n};t.parsingData.esSamples.push(d),t.info.duration=this._duration,t.parsingData.len+=y,l+=y,o++}d=l<p?i.subarray(l,p):void 0,t.audioOverFlow=d}},remux:N},{demux:class extends f{resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e){let t=new l(e),i=t.length;return!(!t.hasTimeStamp||11!==e[i]||119!==e[i+1]||16!==(new d).bsReadAndUpdate(e,{byteOffset:i+5,usedBits:0},5))}append(e,t,i,r,s){const a=new l(e),n=90*a.timeStamp,o=e.length;let d=0,u=a.length;if(this.audioConfig||(this.audioConfig=c(this.observer,e,u)),!this.audioConfig)throw"failed to parse ec-3 config";if(!this.audioTrack){let e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,decryptdata:s},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}const f=y(this.audioConfig,this.audioTrack.info.inputTimescale);for("zec3"===a.audioType&&(this.audioTrack.info.encrypted=!0);u<o;){let t=h(this.observer,e,u),i=n+d*f,r={unit:e.subarray(u,u+t),pts:i,dts:i,decryptdata:s};this.audioTrack.parsingData.esSamples.push(r),this.audioTrack.parsingData.len+=t,u+=t,d++}this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:n,dts:n,data:a.payload,frames:a.frames}],inputTimescale:this.audioTrack.info.inputTimescale},void 0,t,i,r,s)}},remux:N},{demux:class extends f{resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e){const t=new l(e),i=t.length;return!!(t.hasTimeStamp&&11===e[i]&&119===e[i+1]&&(new d).bsReadAndUpdate(e,{byteOffset:i+5,usedBits:0},5)<16)}append(e,t,i,a,n){let o=new l(e),d=90*o.timeStamp,h=e.byteLength,c=0,u=o.length;if(this.audioConfig||(this.audioConfig=v(this.observer,e,u)),!this.audioConfig)throw"failed to parse ac3 config";if(!this.audioTrack){let e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,decryptdata:n},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}const f=y(this.audioConfig,this.audioTrack.info.inputTimescale);for("zac3"===o.audioType&&(this.audioTrack.info.encrypted=!0);u<h;){if(l.isHeader(e,u)&&(u+=new l(e.subarray(u)).length),11!==e[u]||119!==e[u+1]){let e={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ac-3 magic"};return void this.observer.trigger(r.b.INTERNAL_ERROR,e)}let t=b(this.observer,e,u),i=d+c*f,a={unit:e.subarray(u,u+t),pts:i,dts:i,decryptdata:n};this.audioTrack.parsingData.esSamples.push(a),this.audioTrack.parsingData.len+=t,u+=t,c++}this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:d,dts:d,data:o.payload,frames:o.frames}],inputTimescale:this.audioTrack.info.inputTimescale},void 0,t,i,a,n)}},remux:N},{demux:class extends f{resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e){let t,i;for(t=new l(e).length,i=Math.min(e.length-1,t+100);t<i;t++)if(255===e[t]&&240==(246&e[t+1]))return!0;return!1}append(e,t,i,r,s){const a=new l(e,this.logger);let n,o,d,h,c,u,f,g,p=a.hasTimeStamp?90*a.timeStamp:9e4*t;a.hasTimeStamp||this.logger.info("missing id3 timestamp at timeOffset "+t.toFixed(3))();let m=void 0,y=void 0,v=void 0;for(a.length&&(v=a.payload,a.frames.length&&(y=a.frames),this.logger.info(`[id3] init id3 tag pts=${p} frames=${y.length}`)(),m={id3Samples:[{pts:p,dts:p,data:v,frames:y}],inputTimescale:9e4}),h=a.length,f=e.length;h<f-1&&(255!==e[h]||240!=(246&e[h+1]));h++);if(!this.audioConfig&&(this.audioConfig=S(this.observer,e,h),!this.audioConfig))throw"failed to parse adts config";if(!this.audioTrack){let e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,decryptdata:s},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}for("zaac"!==a.audioType&&"zach"!==a.audioType&&"zacp"!==a.audioType||(this.audioTrack.info.encrypted=!0),d=0,o=9216e4/this.audioConfig.samplerate;h+5<f&&(c=1&e[h+1]?7:9,n=(3&e[h+3])<<11|e[h+4]<<3|(224&e[h+5])>>>5,(n-=c)>0&&h+c+n<=f);)for(u=p+d*o,g={unit:e.subarray(h+c,h+c+n),pts:u,dts:u,decryptdata:s},this.audioTrack.parsingData.esSamples.push(g),this.audioTrack.parsingData.len+=n,h+=n+c,d++;h<f-1;h++){if(l.isHeader(e,h)){let t=new l(e.subarray(h));if(t.length>0){h+=t.length;let e=t.hasTimeStamp?90*t.timeStamp:p;m.id3Samples.push({pts:e,dts:e,data:t.payload,frames:t.frames})}else this.logger.error("[id3] invalid length "+f)()}if(255===e[h]&&240==(246&e[h+1]))break}this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,m,void 0,t,i,r,s)}},remux:N},{demux:class extends f{resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e){let t,i,r=new l(e);if(r.hasTimeStamp)for(t=r.length,i=Math.min(e.length-1,t+100);t<i;t++)if(E.probe(e,t))return a.b.warn("MPEG Audio sync word found !")(),!0;return!1}append(e,t,i,r,s){const a=new l(e),n=90*a.timeStamp;let o,d;for(o=a.length,d=e.length;o<d-1&&(255!==e[o]||224!=(224&e[o+1])||0==(6&e[o+1]));o++);if(this.audioConfig||(this.audioConfig=E.getAudioConfig(e,a.length)),!this.audioConfig)throw"unable to parse mp3 header";if(!this.audioTrack){let e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,decryptdata:s},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}E.parse(this.audioTrack.parsingData,e,a.length,n),this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:n,dts:n,data:a.payload,frames:a.frames}],inputTimescale:9e4},void 0,t,i,r)}},remux:N}];for(let r of n){const{probe:s}=r.demux;if(s(w)){this.remuxer=new r.remux(e,i,t,this.vendor),I=new r.demux(e,this.remuxer,i,t,this.logger),this.probeFn=s;break}}if(!I){let t={type:s.g.MEDIA_ERROR,details:s.d.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"};return void e.trigger(r.b.INTERNAL_ERROR,t)}this.demuxer=I}const R=this.remuxer;let A=!this.lastDecryptData||t&&"NONE"!==t.method&&this.lastDecryptData.uri!==t.uri;this.lastDecryptData=t,(o||u||A)&&(I.resetInitSegment(i,p,t,o),R.resetInitSegment()),o&&(I.resetTimeStamp(T),R.resetTimeStamp(T)),I.append(w,n,g,m,t,_,D)}}}),(function(e,t,i){"use strict";i.d(t,"a",(function(){return h}));class r{constructor(e,t){this.subtle=e,this.iv=t}decrypt(e,t){const{iv:i,subtle:r}=this;return r.decrypt({name:"AES-CBC",iv:i},t,e)}}class s{constructor(e,t){this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC",length:null},!1,["encrypt","decrypt"])}}class a{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=Math.floor(t.byteLength/4),r=new Uint32Array(i);for(let e=0;e<i;e++)r[e]=t.getUint32(4*e);return r}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,r=i[0],s=i[1],a=i[2],n=i[3],o=this.invSubMix,l=o[0],d=o[1],h=o[2],c=o[3],u=new Uint32Array(256);let f=0,g=0,p=0;for(p=0;p<256;p++)u[p]=p<128?p<<1:p<<1^283;for(p=0;p<256;p++){let i=g^g<<1^g<<2^g<<3^g<<4;i=i>>>8^255&i^99,e[f]=i,t[i]=f;const o=u[f],p=u[o],m=u[p];let y=257*u[i]^16843008*i;r[f]=y<<24|y>>>8,s[f]=y<<16|y>>>16,a[f]=y<<8|y>>>24,n[f]=y,y=16843009*m^65537*p^257*o^16843008*f,l[i]=y<<24|y>>>8,d[i]=y<<16|y>>>16,h[i]=y<<8|y>>>24,c[i]=y,f?(f=o^u[u[u[m^o]]],g^=u[u[g]]):f=g=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,r=0;for(;r<t.length&&i;)i=t[r]===this.key[r],r++;if(i)return;this.key=t;let s=this.keySize=t.length;if(4!==s&&6!==s&&8!==s)throw new Error("Invalid aes key size="+s);const a=this.ksRows=4*(s+6+1);let n,o;const l=this.keySchedule=new Uint32Array(a),d=this.invKeySchedule=new Uint32Array(a),h=this.sBox,c=this.rcon,u=this.invSubMix,f=u[0],g=u[1],p=u[2],m=u[3];let y,v;for(n=0;n<a;n++)n<s?y=l[n]=t[n]:(v=y,n%s==0?(v=h[(v=v<<8|v>>>24)>>>24]<<24|h[v>>>16&255]<<16|h[v>>>8&255]<<8|h[255&v],v^=c[n/s|0]<<24):s>6&&n%s==4&&(v=h[v>>>24]<<24|h[v>>>16&255]<<16|h[v>>>8&255]<<8|h[255&v]),l[n]=y=(l[n-s]^v)>>>0);for(o=0;o<a;o++)n=a-o,v=3&o?l[n]:l[n-4],d[o]=o<4||n<=4?v:f[h[v>>>24]]^g[h[v>>>16&255]]^p[h[v>>>8&255]]^m[h[255&v]],d[o]=d[o]>>>0}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,i){const r=this.keySize+6,s=this.invKeySchedule,a=this.invSBox,n=this.invSubMix,o=n[0],l=n[1],d=n[2],h=n[3],c=this.uint8ArrayToUint32Array_(i);let u=c[0],f=c[1],g=c[2],p=c[3];const m=new Int32Array(e),y=new Int32Array(m.length);let v,b,S,T,E,_,D,I,w,R,A,k;var C,L;const P=this.networkToHostOrderSwap;for(;t<m.length;){for(w=P(m[t]),R=P(m[t+1]),A=P(m[t+2]),k=P(m[t+3]),E=w^s[0],_=k^s[1],D=A^s[2],I=R^s[3],C=4,L=1;L<r;L++)v=o[E>>>24]^l[_>>16&255]^d[D>>8&255]^h[255&I]^s[C],b=o[_>>>24]^l[D>>16&255]^d[I>>8&255]^h[255&E]^s[C+1],S=o[D>>>24]^l[I>>16&255]^d[E>>8&255]^h[255&_]^s[C+2],T=o[I>>>24]^l[E>>16&255]^d[_>>8&255]^h[255&D]^s[C+3],E=v,_=b,D=S,I=T,C+=4;v=a[E>>>24]<<24^a[_>>16&255]<<16^a[D>>8&255]<<8^a[255&I]^s[C],b=a[_>>>24]<<24^a[D>>16&255]<<16^a[I>>8&255]<<8^a[255&E]^s[C+1],S=a[D>>>24]<<24^a[I>>16&255]<<16^a[E>>8&255]<<8^a[255&_]^s[C+2],T=a[I>>>24]<<24^a[E>>16&255]<<16^a[_>>8&255]<<8^a[255&D]^s[C+3],C+=3,y[t]=P(v^u),y[t+1]=P(T^f),y[t+2]=P(S^g),y[t+3]=P(b^p),u=w,f=R,g=A,p=k,t+=4}return y.buffer}destroy(){this.key=void 0,this.keySize=void 0,this.ksRows=void 0,this.sBox=void 0,this.invSBox=void 0,this.subMix=void 0,this.invSubMix=void 0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.rcon=void 0}}var n=i(0),o=i(1),l=i(3);class d{constructor(e,t){this.observer=e,this.config=t,this.logEnabled=!0;try{const e=crypto||self.crypto;this.subtle=e.subtle||e.webkitSubtle}catch(e){l.b.error(e)()}this.disableWebCrypto=!this.subtle}isSync(){return this.disableWebCrypto&&this.config.enableSoftwareAES}decrypt(e,t,i,n,o){if(this.config.enableSoftwareAES&&(this.disableWebCrypto||n)){this.logEnabled&&(this.logEnabled=!1),this.decryptor||(this.decryptor=new a);const{decryptor:r}=this;r.expandKey(t);let s=this.removePaddingIfValid(r.decrypt(e,0,i));return o(s),Promise.resolve()}{this.logEnabled&&(this.logEnabled=!1);const a=this.subtle;return this.key!==t&&(this.key=t,this.fastAesKey=new s(a,t)),this.fastAesKey.expandKey().then(s=>new r(a,i).decrypt(e,s).then(e=>{try{o(e)}catch(e){l.b.error(e)()}}).catch(r=>{this.onWebCryptoError(r,e,t,i,o)})).catch(r=>{this.onWebCryptoError(r,e,t,i,o)})}}removePaddingIfValid(e){const t=new Uint8Array(e),i=t[e.byteLength-1],r=e.byteLength-1;let s=0;if(i>=1&&i<=16)for(let e=r;e>r-i&&t[e]===i;e--)s++;return s===i?e=e.slice(0,r-i+1):l.b.info(`JS AES: Incorrect padding=${i}, returning original buffer, sz: ${e.byteLength}`)(),e}onWebCryptoError(e,t,i,r,s){if(this.config.enableSoftwareAES){this.disableWebCrypto=!0,this.logEnabled=!0;let e=this.decrypt(t,i,r,!0,s);"function"==typeof(null==e?void 0:e.catch)?e.catch(e=>{l.b.error("decrypt promise error: "+e.message)()}):l.b.error("decrypt doesn't return a promise")()}else{l.b.error("decrypting error : "+e.message)();let t={type:n.g.MEDIA_ERROR,details:n.d.FRAG_DECRYPT_ERROR,fatal:!0,reason:e.message};this.observer.trigger(o.b.INTERNAL_ERROR,t)}}destroy(){this.decryptor&&(this.decryptor.destroy(),this.decryptor=void 0)}}class h{constructor(e,t){this.observer=e,this.config=t}destroy(){this.decryptor&&this.decryptor.destroy()}decrypt(e,t,i,r){if(e.byteLength>0&&t&&t.key&&t.iv&&"AES-128"===t.method){null==this.decryptor&&(this.decryptor=new d(this.observer,this.config));try{performance.now()}catch(e){Date.now()}return this.decryptor.decrypt(e,t.key.buffer,t.iv.buffer,i,e=>{try{performance.now()}catch(e){Date.now()}r&&r(e)})}}}}),(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r={"&amp;":"&","&lt;":"<","&gt;":">","&lrm;":"","&rlm;":"","&nbsp;":""},s={c:"span",i:"i",b:"b",u:"u",ruby:"ruby",rt:"rt",v:"span",lang:"span"},a={v:"title",lang:"lang"},n={rt:"ruby"},o={"text-combine-upright":"-webkit-text-combine:horizontal; text-orientation: mixed;"};class l{static parseTimeStamp(e){function t(e){const[t,i,r,s]=e.map(e=>e?parseInt(""+e):0);return 3600*t+60*i+r+s/1e3}const i=/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/.exec(e);return i?i[3]?t([i[1],i[2],i[3].substring(1),i[4]]):parseInt(i[1])>59?t([i[1],i[2],null,i[4]]):t([null,i[1],i[2],i[4]]):null}static parseContent(e,t,i){let d=t.text;function h(){if(!d)return null;const e=/^([^<]*)(<[^>]+>?)?/.exec(d);return t=e[1]?e[1]:e[2],d=d.substr(t.length),t;var t}function c(e){return r[e]}function u(e,t){return!n[t.dataset.localName]||n[t.dataset.localName]===e.dataset.localName}function f(t,r,n){const l=s[t];if(!l)return null;const d=e.document.createElement(l);d.dataset.localName=l;const h=a[t];if(h&&n&&(d[h]=n.trim()),r)if(i[r]){const e=(function(e){let t="";for(const i in e)t+=o[i]?o[i]:i+":"+e[i]+";";return t})(i[r]);d.setAttribute("style",e)}else console.info(`WebVTT: parseContent: Style referenced, but no style defined for '${r}'!`);return d}const g=e.document.createElement("div"),p=[];let m,y,v=g;for(;null!==(m=h());)if("<"!==m[0])v.appendChild(e.document.createTextNode(m.replace(/&(amp|lt|gt|lrm|rlm|nbsp);/g,c)));else{if("/"===m[1]){p.length&&p[p.length-1]===m.substr(2).replace(">","")&&(p.pop(),v=v.parentNode);continue}const t=l.parseTimeStamp(m.substr(1,m.length-2));let i;if(t){i=e.document.createProcessingInstruction("timestamp",t.toString()),v.appendChild(i);continue}if(!(y=/^<([^.\s/0-9>]+)(\.[^\s\\>]+)?([^>\\]+)?(\\?)>?$/.exec(m)))continue;if(!(i=f(y[1],y[2],y[3])))continue;if(!u(v,i))continue;y[2],p.push(y[1]),v.appendChild(i),v=i}return g}}t.default=l}),(function(e,t,i){"use strict";t.a={hexDump:function(e){var t,i="";for(t=0;t<e.length;t++){var r=e[t].toString(16);r.length<2&&(r="0"+r),i+=r}return i}}}),(function(e,t,i){"use strict";var r=this&&this.__decorate||function(e,t,i,r){var s,a=arguments.length,n=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(n=(a<3?s(n):a>3?s(t,i,n):s(t,i))||n);return a>3&&n&&Object.defineProperty(t,i,n),n};Object.defineProperty(t,"__esModule",{value:!0});const s=i(18),a=i(15);let n=class{constructor(e,t,i){this._id="",this._pauseOnExit=!1,this._region=null,this._vertical="",this._snapToLines=!0,this._line="auto",this._lineAlign="start",this._position=50,this._positionAlign="center",this._size=50,this._align="center",this.hasBeenReset=!1,this._startTime=e,this._endTime=t,this._text=i}get id(){return this._id}set id(e){this._id=""+e}get pauseOnExit(){return this._pauseOnExit}set pauseOnExit(e){this._pauseOnExit=!!e}get startTime(){return this._startTime}set startTime(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number: "+e);this._startTime=e,this.hasBeenReset=!0}get endTime(){return this._endTime}set endTime(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number: "+e);this._endTime=e,this.hasBeenReset=!0}get text(){return this._text}set text(e){this._text=""+e,this.hasBeenReset=!0}get region(){return this._region}set region(e){this._region=e,this.hasBeenReset=!0}get vertical(){return this._vertical}set vertical(e){if(!s.isValidDirectionSetting(e))throw new SyntaxError("An invalid or illegal string was specified for vertical: "+e);this._vertical=e,this.hasBeenReset=!0}get snapToLines(){return this._snapToLines}set snapToLines(e){this._snapToLines=!!e,this.hasBeenReset=!0}get line(){return this._line}set line(e){if(!s.isValidLineAndPositionSetting(e))throw new SyntaxError("An invalid number or illegal string was specified for line: "+e);this._line=e,this.hasBeenReset=!0}get lineAlign(){return this._lineAlign}set lineAlign(e){if(!s.isValidLineAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for lineAlign: "+e);this._lineAlign=e,this.hasBeenReset=!0}get position(){return this._position}set position(e){if(!s.isValidLineAndPositionSetting(e))throw new Error("Position must be between 0 and 100 or auto: "+e);this._position=e,this.hasBeenReset=!0}get positionAlign(){return this._positionAlign}set positionAlign(e){if(!s.isValidPositionAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for positionAlign: "+e);this._positionAlign=e,this.hasBeenReset=!0}get size(){return this._size}set size(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100: "+e);this._size=e,this.hasBeenReset=!0}get align(){return this._align}set align(e){if(!s.isValidAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for align: "+e);this._align=e,this.hasBeenReset=!0}getCueAsHTML(){return a.default.parseContent(window,this,{})}static create(e){if(!e.hasOwnProperty("startTime")||!e.hasOwnProperty("endTime")||!e.hasOwnProperty("text"))throw new Error("You must at least have start time, end time, and text.");const t=new this(e.startTime,e.endTime,e.text);return Object.keys(e).forEach(i=>{t.hasOwnProperty(i)&&(t[i]=e[i])}),t}static fromJSON(e){return this.create(JSON.parse(e))}toJSON(){const e={};return Object.keys(this).forEach(t=>{this.hasOwnProperty(t)&&"getCueAsHTML"!==t&&"hasBeenReset"!==t&&"displayState"!==t&&(e[t]=this[t])}),e}};n=r([function(e){let t=e;return"undefined"!=typeof window&&null!=window.VTTCue&&((t=window.VTTCue).create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON),t}],n),t.VTTCue=n}),(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isValidPercentValue=function(e){return"number"==typeof e&&e>=0&&e<=100},t.isValidAlignSetting=function(e){return"string"==typeof e&&["start","center","end","left","right","middle"].includes(e)},t.isValidDirectionSetting=function(e){return"string"==typeof e&&["","rl","lr"].includes(e)},t.isValidLineAndPositionSetting=function(e){return"number"==typeof e||"auto"===e},t.isValidLineAlignSetting=function(e){return"string"==typeof e&&["start","center","end"].includes(e)},t.isValidPositionAlignSetting=function(e){return"string"==typeof e&&["line-left","center","line-right","auto","left","start","middle","end","right"].includes(e)},t.isValidScrollSetting=function(e){return["","up"].includes(e)}}),(function(e,t,i){"use strict";var r=Object.getOwnPropertyDescriptors||function(e){for(var t=Object.keys(e),i={},r=0;r<t.length;r++)i[t[r]]=Object.getOwnPropertyDescriptor(e,t[r]);return i},s=/%[sdj%]/g;t.format=function(e){if(!y(e)){for(var t=[],i=0;i<arguments.length;i++)t.push(o(arguments[i]));return t.join(" ")}i=1;for(var r=arguments,a=r.length,n=String(e).replace(s,(function(e){if("%%"===e)return"%";if(i>=a)return e;switch(e){case"%s":return String(r[i++]);case"%d":return Number(r[i++]);case"%j":try{return JSON.stringify(r[i++])}catch(e){return"[Circular]"}default:return e}})),l=r[i];i<a;l=r[++i])p(l)||!S(l)?n+=" "+l:n+=" "+o(l);return n},t.deprecate=function(e,i){if("undefined"!=typeof process&&!0===process.noDeprecation)return e;if("undefined"==typeof process)return function(){return t.deprecate(e,i).apply(this,arguments)};var r=!1;return function(){if(!r){if(process.throwDeprecation)throw new Error(i);process.traceDeprecation?console.trace(i):console.error(i),r=!0}return e.apply(this,arguments)}};var a,n={};function o(e,i){var r={seen:[],stylize:d};return arguments.length>=3&&(r.depth=arguments[2]),arguments.length>=4&&(r.colors=arguments[3]),g(i)?r.showHidden=i:i&&t._extend(r,i),v(r.showHidden)&&(r.showHidden=!1),v(r.depth)&&(r.depth=2),v(r.colors)&&(r.colors=!1),v(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=l),h(r,e,r.depth)}function l(e,t){var i=o.styles[t];return i?"["+o.colors[i][0]+"m"+e+"["+o.colors[i][1]+"m":e}function d(e,t){return e}function h(e,i,r){if(e.customInspect&&i&&_(i.inspect)&&i.inspect!==t.inspect&&(!i.constructor||i.constructor.prototype!==i)){var s=i.inspect(r,e);return y(s)||(s=h(e,s,r)),s}var a=(function(e,t){if(v(t))return e.stylize("undefined","undefined");if(y(t)){var i="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(i,"string")}return m(t)?e.stylize(""+t,"number"):g(t)?e.stylize(""+t,"boolean"):p(t)?e.stylize("null","null"):void 0})(e,i);if(a)return a;var n,o=Object.keys(i),l=(n={},o.forEach((function(e,t){n[e]=!0})),n);if(e.showHidden&&(o=Object.getOwnPropertyNames(i)),E(i)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return c(i);if(0===o.length){if(_(i)){var d=i.name?": "+i.name:"";return e.stylize("[Function"+d+"]","special")}if(b(i))return e.stylize(RegExp.prototype.toString.call(i),"regexp");if(T(i))return e.stylize(Date.prototype.toString.call(i),"date");if(E(i))return c(i)}var S,D="",I=!1,w=["{","}"];return f(i)&&(I=!0,w=["[","]"]),_(i)&&(D=" [Function"+(i.name?": "+i.name:"")+"]"),b(i)&&(D=" "+RegExp.prototype.toString.call(i)),T(i)&&(D=" "+Date.prototype.toUTCString.call(i)),E(i)&&(D=" "+c(i)),0!==o.length||I&&0!=i.length?r<0?b(i)?e.stylize(RegExp.prototype.toString.call(i),"regexp"):e.stylize("[Object]","special"):(e.seen.push(i),S=I?(function(e,t,i,r,s){for(var a=[],n=0,o=t.length;n<o;++n)R(t,String(n))?a.push(u(e,t,i,r,String(n),!0)):a.push("");return s.forEach((function(s){s.match(/^\d+$/)||a.push(u(e,t,i,r,s,!0))})),a})(e,i,r,l,o):o.map((function(t){return u(e,i,r,l,t,I)})),e.seen.pop(),(function(e,t,i){return e.reduce((function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60?i[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+i[1]:i[0]+t+" "+e.join(", ")+" "+i[1]})(S,D,w)):w[0]+D+w[1]}function c(e){return"["+Error.prototype.toString.call(e)+"]"}function u(e,t,i,r,s,a){var n,o,l;if((l=Object.getOwnPropertyDescriptor(t,s)||{value:t[s]}).get?o=l.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):l.set&&(o=e.stylize("[Setter]","special")),R(r,s)||(n="["+s+"]"),o||(e.seen.indexOf(l.value)<0?(o=p(i)?h(e,l.value,null):h(e,l.value,i-1)).indexOf("\n")>-1&&(o=a?o.split("\n").map((function(e){return"  "+e})).join("\n").substr(2):"\n"+o.split("\n").map((function(e){return"   "+e})).join("\n")):o=e.stylize("[Circular]","special")),v(n)){if(a&&s.match(/^\d+$/))return o;(n=JSON.stringify(""+s)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(n=n.substr(1,n.length-2),n=e.stylize(n,"name")):(n=n.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),n=e.stylize(n,"string"))}return n+": "+o}function f(e){return Array.isArray(e)}function g(e){return"boolean"==typeof e}function p(e){return null===e}function m(e){return"number"==typeof e}function y(e){return"string"==typeof e}function v(e){return void 0===e}function b(e){return S(e)&&"[object RegExp]"===D(e)}function S(e){return"object"==typeof e&&null!==e}function T(e){return S(e)&&"[object Date]"===D(e)}function E(e){return S(e)&&("[object Error]"===D(e)||e instanceof Error)}function _(e){return"function"==typeof e}function D(e){return Object.prototype.toString.call(e)}function I(e){return e<10?"0"+e.toString(10):e.toString(10)}t.debuglog=function(e){if(v(a)&&(a=process.env.NODE_DEBUG||""),e=e.toUpperCase(),!n[e])if(new RegExp("\\b"+e+"\\b","i").test(a)){var i=process.pid;n[e]=function(){var r=t.format.apply(t,arguments);console.error("%s %d: %s",e,i,r)}}else n[e]=function(){};return n[e]},t.inspect=o,o.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},o.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},t.isArray=f,t.isBoolean=g,t.isNull=p,t.isNullOrUndefined=function(e){return null==e},t.isNumber=m,t.isString=y,t.isSymbol=function(e){return"symbol"==typeof e},t.isUndefined=v,t.isRegExp=b,t.isObject=S,t.isDate=T,t.isError=E,t.isFunction=_,t.isPrimitive=function(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e},t.isBuffer=i(20);var w=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function R(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.log=function(){var e,i;console.log("%s - %s",(i=[I((e=new Date).getHours()),I(e.getMinutes()),I(e.getSeconds())].join(":"),[e.getDate(),w[e.getMonth()],i].join(" ")),t.format.apply(t,arguments))},t.inherits=i(21),t._extend=function(e,t){if(!t||!S(t))return e;for(var i=Object.keys(t),r=i.length;r--;)e[i[r]]=t[i[r]];return e};var A="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function k(e,t){if(!e){var i=new Error("Promise was rejected with a falsy value");i.reason=e,e=i}return t(e)}t.promisify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');if(A&&e[A]){var t;if("function"!=typeof(t=e[A]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(t,A,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}function t(){for(var t,i,r=new Promise((function(e,r){t=e,i=r})),s=[],a=0;a<arguments.length;a++)s.push(arguments[a]);s.push((function(e,r){e?i(e):t(r)}));try{e.apply(this,s)}catch(e){i(e)}return r}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),A&&Object.defineProperty(t,A,{value:t,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(t,r(e))},t.promisify.custom=A,t.callbackify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');function t(){for(var t=[],i=0;i<arguments.length;i++)t.push(arguments[i]);var r=t.pop();if("function"!=typeof r)throw new TypeError("The last argument must be of type Function");var s=this,a=function(){return r.apply(s,arguments)};e.apply(this,t).then((function(e){process.nextTick(a,null,e)}),(function(e){process.nextTick(k,e,a)}))}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),Object.defineProperties(t,r(e)),t}}),(function(e,t,i){"use strict";e.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}}),(function(e,t,i){"use strict";"function"==typeof Object.create?e.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:e.exports=function(e,t){e.super_=t;var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e}}),(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=i(17);t.VTTCue=r.VTTCue;const s=i(23);t.VTTRegion=s.VTTRegion;const a=i(15);class n extends Error{constructor(e,t){super(),this.name="ParsingError",this.code="number"==typeof e?e:e.code,t?this.message=t:e instanceof n&&(this.message=e.message)}}t.ParsingError=n,n.Errors={BadSignature:new n(0,"Malformed WebVTT signature."),BadTimeStamp:new n(1,"Malformed time stamp.")};class o{constructor(){this.values={}}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,i){return"object"==typeof t&&"string"==typeof i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let r=0;r<i.length;++r)if(t===i[r]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(t.match(/^([\d]{1,3})(\.[\d]*)?%$/))try{const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}catch(e){return!1}return!1}}class l{constructor(e,t,i){this.window=e,this.state="INITIAL",this.styleCollector="",this.buffer="",this.decoder=t||new TextDecoder("utf8"),this.regionList=[],this.onStylesParsedCallback=i,this._styles={}}static StringDecoder(){return{decode:e=>{if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}}reportOrThrowError(e){if(!(e instanceof n&&"function"==typeof this.onparsingerror))throw e;this.onparsingerror(e)}parseOptions(e,t,i,r){const s=r?e.split(r):[e];for(const e of s){if("string"!=typeof e)continue;const r=e.split(i);2===r.length&&t(r[0],r[1])}}parseCue(e,t,i){const r=e,s=()=>{const t=a.default.parseTimeStamp(e);if(null===t)throw new n(n.Errors.BadTimeStamp,"Malformed timestamp: "+r);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t},l=()=>{e=e.replace(/^\s+/,"")};if(l(),t.startTime=s(),l(),"--\x3e"!==e.substr(0,3))throw new n(n.Errors.BadTimeStamp,"Malformed time stamp (time stamps must be separated by '--\x3e'): "+r);e=e.substr(3),l(),t.endTime=s(),l(),((e,t)=>{const r=new o;this.parseOptions(e,(e,t)=>{let s,a;switch(e){case"region":for(let s=i.length-1;s>=0;s--)if(i[s].id===t){r.set(e,i[s].region);break}break;case"vertical":r.alt(e,t,["rl","lr"]);break;case"line":a=(s=t.split(","))[0],r.integer(e,a),r.percent(e,a)&&r.set("snapToLines",!1),r.alt(e,a,["auto"]),2===s.length&&r.alt("lineAlign",s[1],["start","center","end"]);break;case"position":if(s=t.split(","),r.percent(e,s[0]),2===s.length){let e=["line-left","line-right","center","auto","left","start","middle","end","right"];r.alt("positionAlign",s[1],e)}break;case"size":r.percent(e,t);break;case"align":let n=["start","center","end","left","right","middle"];r.alt(e,t,n)}},/:/,/\s/),t.region=r.get("region",null),t.vertical=r.get("vertical",""),t.line=r.get("line",void 0===t.line?"auto":t.line),t.lineAlign=r.get("lineAlign","start"),t.snapToLines=r.get("snapToLines",!0),t.size=r.get("size",100);let s=r.get("align","center");t.align="middle"===s?"center":s,t.position=r.get("position","auto");let a=r.get("positionAlign",{start:"start",left:"start",center:"center",right:"end",end:"end"},t.align);t.positionAlign={start:"start","line-left":"start",left:"start",center:"center",middle:"center","line-right":"end",right:"end",end:"end"}[a]})(e,t)}parseRegion(e){const t=new o;if(this.parseOptions(e,(e,i)=>{switch(e){case"id":t.set(e,i);break;case"width":t.percent(e,i);break;case"lines":t.integer(e,i);break;case"regionanchor":case"viewportanchor":{const r=i.split(",");if(2!==r.length)break;const s=new o;if(s.percent("x",r[0]),s.percent("y",r[1]),!s.has("x")||!s.has("y"))break;t.set(e+"X",s.get("x")),t.set(e+"Y",s.get("y"));break}case"scroll":t.alt(e,i,["up"])}},/=/,/\s/),t.has("id")){const e=new s.VTTRegion;e.width=t.get("width",100),e.lines=t.get("lines",3),e.regionAnchorX=t.get("regionanchorX",0),e.regionAnchorY=t.get("regionanchorY",100),e.viewportAnchorX=t.get("viewportanchorX",0),e.viewportAnchorY=t.get("viewportanchorY",100),e.scroll=t.get("scroll",""),this.onregion&&this.onregion(e),this.regionList.push({id:t.get("id"),region:e})}}parseStyle(e){const t=e=>{const t={},i=e.split(";");for(let e=0;e<i.length;e++)if(i[e].includes(":")){const r=i[e].split(":",2),s=r[0].trim(),a=r[1].trim();""!==s&&""!==a&&(t[s]=a)}return t},i=e.split("}");i.pop();for(const e of i){let i=null,r=null;const s=e.split("{");s[0]&&(i=s[0].trim()),s[1]&&(r=t(s[1])),i&&r&&(this._styles[i]=r)}this.onStylesParsedCallback&&this.onStylesParsedCallback(this._styles)}parseHeader(e){this.parseOptions(e,(function(e,t){switch(e){case"Region":this.parseRegion(t)}}),/:/)}parse(e){e&&(this.buffer+=this.decoder.decode(e,{stream:!0}));const t=()=>{const e=this.buffer;let t=0;const i=(e,t)=>{const i={start:-1,length:-1};if("\r"===e[t])i.start=t,i.length=1;else if("\n"===e[t])i.start=t,i.length=1;else if("<"===e[t]&&t+1<e.length&&"b"===e[t+1]&&t+2<e.length&&"r"===e[t+2]){let r=t+2;for(;r<e.length&&">"!==e[r++];);i.start=t,i.length=r-t}return i};let r={start:e.length,length:0};for(;t<e.length;){const s=i(e,t);if(s.length>0){r=s;break}++t}const s=e.substr(0,r.start);return this.buffer=e.substr(r.start+r.length),s};try{let i;if("INITIAL"===this.state){if(!/\r\n|\n/.test(this.buffer))return this;i=t();const e=/^()?WEBVTT([ \t].*)?$/.exec(i);if(!e||!e[0])throw new n(n.Errors.BadSignature);this.state="HEADER"}let s=!1;for(;this.buffer;){if(!/\r\n|\n/.test(this.buffer))return this;switch(s?s=!1:i=t(),this.state){case"HEADER":i.includes(":")?this.parseHeader(i):i||(this.state="ID");continue;case"NOTE":i||(this.state="ID");continue;case"STYLE":i?this.styleCollector+=i:(this.parseStyle(this.styleCollector),this.state="ID",this.styleCollector="");continue;case"ID":if(/^NOTE($|[ \t])/.test(i)){this.state="NOTE";break}if(/^STYLE($|[ \t])/.test(i)){this.state="STYLE";break}if(!i)continue;if(this.cue=new r.VTTCue(0,0,""),this.state="CUE",!i.includes("--\x3e")){this.cue.id=i;continue}case"CUE":try{this.parseCue(i,this.cue,this.regionList)}catch(e){this.reportOrThrowError(e),this.cue=null,this.state="BADCUE";continue}this.state="CUETEXT";continue;case"CUETEXT":{const e=i.includes("--\x3e");if(!i||e){s=!0,this.oncue&&this.oncue(this.cue),this.cue=null,this.state="ID";continue}this.cue.text&&(this.cue.text+="\n"),this.cue.text+=i;continue}case"BADCUE":i||(this.state="ID");continue}}}catch(e){this.reportOrThrowError(e),"CUETEXT"===this.state&&this.cue&&this.oncue&&this.oncue(this.cue),this.cue=null,this.state="INITIAL"===this.state?"BADWEBVTT":"BADCUE"}return this}flush(){try{if(this.buffer+=this.decoder.decode(),(this.cue||"HEADER"===this.state)&&(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state)throw new n(n.Errors.BadSignature)}catch(e){this.reportOrThrowError(e)}return this.onflush&&this.onflush(),this}styles(){return this._styles}}t.default=l,t.WebVTTParser=l}),(function(e,t,i){"use strict";var r=this&&this.__decorate||function(e,t,i,r){var s,a=arguments.length,n=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(n=(a<3?s(n):a>3?s(t,i,n):s(t,i))||n);return a>3&&n&&Object.defineProperty(t,i,n),n};Object.defineProperty(t,"__esModule",{value:!0});const s=i(18);let a=class{constructor(){this._id="",this._lines=3,this._regionAnchorX=0,this._regionAnchorY=100,this._scroll="",this._viewportAnchorX=0,this._viewportAnchorY=100,this._width=100}get id(){return this._id}set id(e){if("string"!=typeof e)throw new Error("ID must be a string.");this._id=e}get lines(){return this._lines}set lines(e){if("number"!=typeof e)throw new TypeError("Lines must be set to a number.");this._lines=e}get regionAnchorX(){return this._regionAnchorX}set regionAnchorX(e){if(!s.isValidPercentValue(e))throw new TypeError("RegionAnchorX must be between 0 and 100.");this._regionAnchorX=e}get regionAnchorY(){return this._regionAnchorY}set regionAnchorY(e){if(!s.isValidPercentValue(e))throw new TypeError("RegionAnchorY must be between 0 and 100.");this._regionAnchorY=e}get scroll(){return this._scroll}set scroll(e){if("string"==typeof e){const t=e.toLowerCase();if(s.isValidScrollSetting(t))return void(this._scroll=t)}throw new SyntaxError("An invalid or illegal string was specified.")}get viewportAnchorX(){return this._viewportAnchorX}set viewportAnchorX(e){if(!s.isValidPercentValue(e))throw new TypeError("ViewportAnchorX must be between 0 and 100.");this._viewportAnchorX=e}get viewportAnchorY(){return this._viewportAnchorY}set viewportAnchorY(e){if(!s.isValidPercentValue(e))throw new TypeError("ViewportAnchorY must be between 0 and 100.");this._viewportAnchorY=e}get width(){return this._width}set width(e){if(!s.isValidPercentValue(e))throw new TypeError("Width must be between 0 and 100.");this._lines=e}toJSON(){const e={};return Object.keys(this).forEach(t=>{this.hasOwnProperty(t)&&(e[t]=this[t])}),e}static create(e){const t=new this;return Object.keys(e).forEach(i=>{t.hasOwnProperty(i)&&(t[i]=e[i])}),t}static fromJSON(e){return this.create(JSON.parse(e))}};a=r([function(e){let t=e;return"undefined"!=typeof window&&null!=window.VTTRegion&&((t=window.VTTRegion).create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON),t}],a),t.VTTRegion=a}),(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=i(17);t.VTTCue=r.VTTCue;const s=i(15),a=[/^(::cue\()(\..*)(\))/,/^(::cue\()(#.*)(\))/,/^(::cue\()(c|i|b|u|ruby|rt|v|lang)(\))/],n=[[1470,1470],[1472,1472],[1475,1475],[1478,1478],[1488,1514],[1520,1524],[1544,1544],[1547,1547],[1549,1549],[1563,1563],[1566,1610],[1645,1647],[1649,1749],[1765,1766],[1774,1775],[1786,1805],[1807,1808],[1810,1839],[1869,1957],[1969,1969],[1984,2026],[2036,2037],[2042,2042],[2048,2069],[2074,2074],[2084,2084],[2088,2088],[2096,2110],[2112,2136],[2142,2142],[2208,2208],[2210,2220],[8207,8207],[64285,64285],[64287,64296],[64298,64310],[64312,64316],[64318,64318],[64320,64321],[64323,64324],[64326,64449],[64467,64829],[64848,64911],[64914,64967],[65008,65020],[65136,65140],[65142,65276],[67584,67589],[67592,67592],[67594,67637],[67639,67640],[67644,67644],[67647,67669],[67671,67679],[67840,67867],[67872,67897],[67903,67903],[67968,68023],[68030,68031],[68096,68096],[68112,68115],[68117,68119],[68121,68147],[68160,68167],[68176,68184],[68192,68223],[68352,68405],[68416,68437],[68440,68466],[68472,68479],[68608,68680],[126464,126467],[126469,126495],[126497,126498],[126500,126500],[126503,126503],[126505,126514],[126516,126519],[126521,126521],[126523,126523],[126530,126530],[126535,126535],[126537,126537],[126539,126539],[126541,126543],[126545,126546],[126548,126548],[126551,126551],[126553,126553],[126555,126555],[126557,126557],[126559,126559],[126561,126562],[126564,126564],[126567,126570],[126572,126578],[126580,126583],[126585,126588],[126590,126590],[126592,126601],[126603,126619],[126625,126627],[126629,126633],[126635,126651],[1114109,1114109]];class o{applyStyles(e,t){t=t||this.div;for(const i in e)e.hasOwnProperty(i)&&(t.style[i]=e[i])}formatStyle(e,t){return 0===e?"0":e+t}}t.StyleBox=o;class l extends o{constructor(e,t,i,r,a){super(),this.cue=t;let n={textAlign:{start:"left","line-left":"left",left:"left",center:"center",middle:"center","line-right":"right",right:"right",end:"right"}[t.positionAlign]||t.align,whiteSpace:"pre-line",position:"absolute"};n.direction=this.determineBidi(this.cueDiv),n.writingMode=this.directionSettingToWritingMode(t.vertical),n.unicodeBidi="plaintext",this.div=e.document.createElement("div"),this.applyStyles(n),n={backgroundColor:r.backgroundColor,display:"inline-block"},this.parseOpacity(n.backgroundColor)&&(n.padding="5px",n.borderRadius="5px"),this.backgroundDiv=e.document.createElement("div"),this.applyStyles(n,this.backgroundDiv),(n={color:i.color,backgroundColor:i.backgroundColor,textShadow:i.textShadow,fontSize:i.fontSize,fontFamily:i.fontFamily,position:"relative",left:"0",right:"0",top:"0",bottom:"0",display:"inline-block",textOrientation:"upright"}).writingMode=this.directionSettingToWritingMode(t.vertical),n.unicodeBidi="plaintext",this.cueDiv=s.default.parseContent(e,t,a),this.applyStyles(n,this.cueDiv),this.backgroundDiv.appendChild(this.cueDiv),this.div.appendChild(this.backgroundDiv);let o=0;if("number"==typeof t.position){let e=t.positionAlign||t.align;if(e)switch(e){case"start":case"left":o=t.position;break;case"center":case"middle":o=t.position-t.size/2;break;case"end":case"right":o=t.position-t.size}}""===t.vertical?this.applyStyles({left:this.formatStyle(o,"%"),width:this.formatStyle(t.size,"%")}):this.applyStyles({top:this.formatStyle(o,"%"),height:this.formatStyle(t.size,"%")})}determineBidi(e){let t,i=[],r="";if(!e||!e.childNodes)return"ltr";function s(e,t){for(let i=t.childNodes.length-1;i>=0;i--)e.push(t.childNodes[i])}function a(e){if(!e||!e.length)return null;let t=e.pop(),i=t.textContent||t.innerText;if(i){const t=/^.*(\n|\r)/.exec(i);return t?(e.length=0,t[0]):i}return"ruby"===t.tagName?a(e):t.childNodes?(s(e,t),a(e)):void 0}function o(e,t){for(const i of t)if(e>=i[0]&&e<=i[1])return!0;return!1}for(s(i,e);r=a(i);)for(let e=0;e<r.length;e++)if(o(t=r.charCodeAt(e),n))return"rtl";return"ltr"}parseOpacity(e){if(!e||"string"!=typeof e)return null;const t=(e=e.replace(/ /g,"").replace("rgba(","").replace(")","")).split(",");return t&&t.length>=4?t[3]:null}directionSettingToWritingMode(e){return""===e?"horizontal-tb":"lr"===e?"vertical-lr":"vertical-rl"}move(e){this.applyStyles({top:this.formatStyle(e.top,"px"),bottom:this.formatStyle(e.bottom,"px"),left:this.formatStyle(e.left,"px"),right:this.formatStyle(e.right,"px"),height:this.formatStyle(e.height,"px"),width:this.formatStyle(e.width,"px")})}}t.CueStyleBox=l;class d{constructor(e){var t;let i,r,s,a,n,o;if(e instanceof l&&e.cue?(t=e.cue)&&""!==t.vertical?this.property="width":this.property="height":e instanceof d&&(this.property=e.property||"height"),e instanceof l&&e.div){s=e.div.offsetHeight,a=e.div.offsetWidth,n=e.div.offsetTop;const t=e.div.firstChild;if(i=(o=t?t.getBoundingClientRect():e.div.getBoundingClientRect())&&o[this.property]||null,t&&t.firstChild){const e=t.firstChild;e&&"string"==typeof e.textContent&&(r=i/this.calculateNewLines(e.textContent))}}else e instanceof d&&(o=e);this.left=o.left,this.right=o.right,this.top=o.top||n,this.height=o.height||s,this.bottom=o.bottom||n+(o.height||s),this.width=o.width||a,this.lineHeight=null!==i?i:o.lineHeight,this.singleLineHeight=null!==r?r:o.singleLineHeight,this.singleLineHeight||(this.singleLineHeight=41)}calculateNewLines(e){let t=1;for(let i=0;i<e.length;i++)"\n"===e[i]&&t++;return t}move(e,t){switch(t=void 0!==t?t:this.singleLineHeight,e){case"+x":this.left+=t,this.right+=t;break;case"-x":this.left-=t,this.right-=t;break;case"+y":this.top+=t,this.bottom+=t;break;case"-y":this.top-=t,this.bottom-=t}}overlaps(e){return this.left<e.right&&this.right>e.left&&this.top<e.bottom&&this.bottom>e.top}overlapsAny(e){for(const t of e)if(this.overlaps(t))return!0;return!1}within(e){return this.top>=e.top&&this.bottom<=e.bottom&&this.left>=e.left&&this.right<=e.right}moveIfOutOfBounds(e,t){switch(t){case"+x":this.left<e.left&&(this.left=e.left,this.right=this.left+this.width);break;case"-x":this.right>e.right&&(this.right=e.right,this.left=this.right-this.width);break;case"+y":this.top<e.top&&(this.top=e.top,this.bottom=this.top+this.height);break;case"-y":this.bottom>e.bottom&&(this.bottom=e.bottom,this.top=this.bottom-this.height)}}toCSSCompatValues(e){return{top:this.top-e.top,bottom:e.bottom-this.bottom,left:this.left-e.left,right:e.right-this.right,height:this.height,width:this.width}}static getSimpleBoxPosition(e){let t=null;e instanceof o&&e.div?t=e.div:e instanceof HTMLElement&&(t=e);let i=t.offsetHeight||0,r=t.offsetWidth||0,s=t.offsetTop||0,a=s+i,n=t.getBoundingClientRect();const{left:l,right:d}=n;return n.top&&(s=n.top),n.height&&(i=n.height),n.width&&(r=n.width),n.bottom&&(a=n.bottom),{left:l,right:d,top:s,height:i,bottom:a,width:r}}static getBoxPosition(e,t){if(e&&e.length>0){let i=0,r=e[0][t];for(let s=0;s<e.length;s++)t in["top","right"]?e[s][t]>r&&(i=s,r=e[s][t]):t in["bottom","left"]&&e[s][t]<r&&(i=s,r=e[s][t]);return e[i]}return null}static moveToMinimumDistancePlacement(e,t,i){"height"===e.property?"+y"===t?(e.top=i.topMostBoxPosition.bottom+0,e.bottom=e.top+e.height):"-y"===t&&(e.bottom=i.bottomMostBoxPosition.top-0,e.top=e.bottom-e.height):"width"===e.property&&("+x"===t?(e.left=i.rightMostBoxPosition.right+0,e.right=e.left+e.width):"-x"===t&&(e.right=i.leftMostBoxPosition.left-0,e.left=e.right-e.width))}static moveBoxToLinePosition(e,t,i){const r=e.cue;let s,a=new d(e),n=(function(e){if("number"==typeof e.line&&(e.snapToLines||e.line>=0&&e.line<=100))return e.line;if(!e.track||!e.track.textTrackList||!e.track.textTrackList.mediaElement)return-1;let t=0;const i=e.track,r=i.textTrackList;for(let e=0;e<r.length&&r[e]!==i;e++)"showing"===r[e].mode&&t++;return-1*++t})(r),o=[];if(r.snapToLines){let e=0;switch(r.vertical){case"":o=["+y","-y"],s="height";break;case"rl":o=["+x","-x"],s="width";break;case"lr":o=["-x","+x"],s="width"}const i=a.lineHeight,l=t[s]+i,d=o[0];if(n<0){let s=0;switch(r.vertical){case"":s=t.height-i-.05*t.height;break;case"rl":case"lr":s=-t.width+i+.05*t.width}e=s,o=o.reverse()}else{switch(r.vertical){case"":e=i*Math.round(n);break;case"rl":e=t.width-i*Math.round(n);break;case"lr":e=i*Math.round(n)}Math.abs(e)>l&&(e=e<0?-1:1,e*=Math.ceil(l/i)*i)}a.move(d,e)}else{const i=""===r.vertical?t.height:t.width,s=a.lineHeight/i*100;switch(r.lineAlign){case"center":n-=s/2;break;case"end":n-=s}switch(r.vertical){case"":e.applyStyles({top:e.formatStyle(n,"%")});break;case"rl":e.applyStyles({right:e.formatStyle(n,"%")});break;case"lr":e.applyStyles({left:e.formatStyle(n,"%")})}o=["+y","-y","+x","-x"],"+y"===r.axis?o=["+y","-y","+x","-x"]:"-y"===r.axis&&(o=["-y","+y","+x","-x"]),a=new d(e)}const l=(function(e,r){let s;for(let a=0;a<r.length;a++){e.moveIfOutOfBounds(t,r[a]);let n=0,o=!1;for(;e.overlapsAny(i)&&!(n>9);)o?e.move(r[a]):(i&&i.length>0&&(s||(s={topMostBoxPosition:d.getBoxPosition(i,"top"),bottomMostBoxPosition:d.getBoxPosition(i,"bottom"),leftMostBoxPosition:d.getBoxPosition(i,"left"),rightMostBoxPosition:d.getBoxPosition(i,"right")}),d.moveToMinimumDistancePlacement(e,r[a],s)),o=!0),n++}return e})(a,o);e.move(l.toCSSCompatValues(t))}}t.BoxPosition=d;class h{constructor(e,t,i=!0){if(!e)return null;this.window=e,this.overlay=t,this.loggingEnabled=i,this.foregroundStyleOptions={fontFamily:"Helvetica",fontSize:"36px",color:"rgba(255, 255, 255, 1)",textShadow:"",backgroundColor:"rgba(0, 0, 0, 0)"},this.backgroundStyleOptions={backgroundColor:"rgba(0, 0, 0, 0.5)"},this.globalStyleCollection={};const r=e.document.createElement("div");r.style.position="absolute",r.style.left="0",r.style.right="0",r.style.top="0",r.style.bottom="0",r.style.margin="1.5%",this.paddedOverlay=r,t.appendChild(this.paddedOverlay),this.initSubtitleCSS()}initSubtitleCSS(){const e=[new r.VTTCue(0,0,"String to init CSS - Won't be visible to user")];this.paddedOverlay.style.opacity="0",this.processCues(e),this.processCues([]),this.paddedOverlay.style.opacity="1"}convertCueToDOMTree(e){return e?s.default.parseContent(this.window,e,this.globalStyleCollection):null}setStyles(e){function t(e,t,i){for(const r in t)t.hasOwnProperty(r)&&(!0===i&&void 0!==e[r]||!1===i)&&(e[r]=t[r])}for(const i in e){let r=!1,s=null;"::cue"===i?(s=this.foregroundStyleOptions,r=!0):"::-webkit-media-text-track-display"===i&&(s=this.backgroundStyleOptions,r=!0);const n=e[i];if(!0===r)t(s,n,r);else for(let e=0;e<a.length;e++){const s=a[e].exec(i);if(s&&4===s.length){const e=s[2],i={};t(i,n,r),this.globalStyleCollection[e]=i}}}this.initSubtitleCSS(),this.loggingEnabled&&(console.log("WebVTTRenderer setStyles foregroundStyleOptions: "+JSON.stringify(this.foregroundStyleOptions)),console.log("WebVTTRenderer setStyles backgroundStyleOptions: "+JSON.stringify(this.backgroundStyleOptions)),console.log("WebVTTRenderer setStyles globalStyleCollection: "+JSON.stringify(this.globalStyleCollection)))}processCues(e){if(!e)return;for(;this.paddedOverlay.firstChild;)this.paddedOverlay.removeChild(this.paddedOverlay.firstChild);if(!(function(e){for(let t=0;t<e.length;t++)if(e[t].hasBeenReset||!e[t].displayState)return!0;return!1})(e)){for(let t=0;t<e.length;t++)this.paddedOverlay.appendChild(e[t].displayState);return}const t=[],i=d.getSimpleBoxPosition(this.paddedOverlay);e.length>1&&(e=(function(e){const t=[];let i=0;for(let r=0;r<e.length;r++){let s=e[r];if("number"!=typeof s.line)return e;i+=s.line,t.push(s)}return(i/=e.length)>50?(t.forEach((function(e){e.axis="-y"})),t.sort((e,t)=>t.line-e.line)):(t.forEach((function(e){e.axis="+y"})),t.sort((e,t)=>e.line-t.line)),t})(e));for(let r=0;r<e.length;r++){let s=e[r],a=new l(this.window,s,this.foregroundStyleOptions,this.backgroundStyleOptions,this.globalStyleCollection);this.paddedOverlay.appendChild(a.div),d.moveBoxToLinePosition(a,i,t),s.displayState=a.div,t.push(d.getSimpleBoxPosition(a))}}setSize(e,t){e&&(this.overlay.style.width=e+"px"),t&&(this.overlay.style.height=t+"px")}getOverlay(){return this.overlay}}t.default=h,t.WebVTTRenderer=h}),(function(e,t,i){"use strict";function r(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=e,i.c=t,i.i=function(e){return e},i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},i.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i.oe=function(e){throw console.error(e),e};var r=i(i.s=ENTRY_MODULE);return r.default||r}var s="[\\.|\\-|\\+|\\w|/|@]+",a="\\(\\s*(/\\*.*?\\*/)?\\s*.*?("+s+").*?\\)";function n(e){return(e+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function o(e,t,r){var o={};o[r]=[];var l=t.toString(),d=l.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/);if(!d)return o;for(var h,c=d[1],u=new RegExp("(\\\\n|\\W)"+n(c)+a,"g");h=u.exec(l);)"dll-reference"!==h[3]&&o[r].push(h[3]);for(u=new RegExp("\\("+n(c)+'\\("(dll-reference\\s('+s+'))"\\)\\)'+a,"g");h=u.exec(l);)e[h[2]]||(o[r].push(h[1]),e[h[2]]=i(h[1]).m),o[h[2]]=o[h[2]]||[],o[h[2]].push(h[4]);for(var f,g=Object.keys(o),p=0;p<g.length;p++)for(var m=0;m<o[g[p]].length;m++)f=o[g[p]][m],isNaN(1*f)||(o[g[p]][m]=1*o[g[p]][m]);return o}function l(e){return Object.keys(e).reduce((function(t,i){return t||e[i].length>0}),!1)}e.exports=function(e,t){t=t||{};var s={main:i.m},a=t.all?{main:Object.keys(s.main)}:(function(e,t){for(var i={main:[t]},r={main:[]},s={main:{}};l(i);)for(var a=Object.keys(i),n=0;n<a.length;n++){var d=a[n],h=i[d].pop();if(s[d]=s[d]||{},!s[d][h]&&e[d][h]){s[d][h]=!0,r[d]=r[d]||[],r[d].push(h);for(var c=o(e,e[d][h],d),u=Object.keys(c),f=0;f<u.length;f++)i[u[f]]=i[u[f]]||[],i[u[f]]=i[u[f]].concat(c[u[f]])}}return r})(s,e),n="";Object.keys(a).filter((function(e){return"main"!==e})).forEach((function(e){for(var t=0;a[e][t];)t++;a[e].push(t),s[e][t]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",n=n+"var "+e+" = ("+r.toString().replace("ENTRY_MODULE",JSON.stringify(t))+")({"+a[e].map((function(t){return JSON.stringify(t)+": "+s[e][t].toString()})).join(",")+"});\n"})),n=n+"new (("+r.toString().replace("ENTRY_MODULE",JSON.stringify(e))+")({"+a.main.map((function(e){return JSON.stringify(e)+": "+s.main[e].toString()})).join(",")+"}))(self);";var d=new window.Blob([n],{type:"text/javascript"});if(t.bare)return d;var h=(window.URL||window.webkitURL||window.mozURL||window.msURL).createObjectURL(d),c=new window.Worker(h);return c.objectURL=h,c}}),(function(e,t,i){"use strict";i.r(t);var r=i(13),s=i(1),a=i(11),n=i(8),o=i(3),l=i(5);t.default=function(e){var t=new a.EventEmitter;t.trigger=function(e,i){t.emit(e,e,i)},t.off=(e,i)=>t.removeListener(e,i);const i=(t,i,r)=>e.postMessage({event:t,data:i},r);e.addEventListener("message",(function({data:s}){switch(s.cmd){case"init":let a=JSON.parse(s.config);e.demuxer=new r.a(t,s.typeSupported,a,s.vendor);try{o.b.enable(!0===a.debug,a.debugLevel),o.b.setStreamAndSessionIDs(s.options.sessionID,s.options.streamID)}catch(e){console.warn("demuxerWorker: unable to enable logs")}i(n.a.INIT,null);break;case"demux":e.demuxer.push(s.data,s.decryptdata,s.initSegment,s.timeOffset,s.discontinuity,s.trackSwitch,s.contiguous,s.duration,s.accurateTimeOffset,s.defaultInitPTS,s.iframeMediaStart,s.iframeDuration)}})),t.on(s.b.FRAG_DECRYPTED,i),t.on(s.b.FRAG_PARSING_INIT_SEGMENT,i),t.on(s.b.FRAG_PARSED,i),t.on(s.b.FRAG_PARSING_USERDATA,i),t.on(s.b.FRAG_PARSING_CAPTIONDATA,i),t.on(s.b.INIT_PTS_FOUND,i),t.on(s.b.FRAG_PARSING_DATA,(e,t)=>{const r=new l.a;t.data1&&r.add(t.data1.buffer),t.data2&&r.add(t.data2.buffer),i(e,t,r.transfer)}),t.on(s.b.FRAG_PARSING_METADATA,(t,i)=>{const r=new l.a;if(i.samples)for(const e of i.samples)if(e.data&&r.add(e.data.buffer),e.frames)for(const t of e.frames)t.data&&"string"!=typeof t.data&&r.add(t.data.buffer);e.postMessage({event:t,data:i},r.transfer)}),t.on(s.b.INTERNAL_ERROR,(t,i)=>{e.postMessage({event:t,data:i})})}}),(function(e,t,i){"use strict";i.r(t);var r=i(14),s=i(1),a=i(11),n=i(3);t.default=function(e){const t=new a.EventEmitter;t.trigger=(e,i)=>{t.emit(e,e,i)},t.off=(e,i)=>t.removeListener(e,i);const i=(t,i,r)=>{r?e.postMessage({event:t,fragObjId:i,data:r},[r]):e.postMessage({event:t,data:r})},o=t=>{e.decryptor.decrypt(t.fragPayload,t.decryptdata,t.forceJSCrypto,e=>{i("segment-decrypted",t.fragObjId,e)}).catch(e=>{this.logger.error("Promise error: "+e.message)()})};e.addEventListener("message",({data:s})=>{switch(s.cmd){case"init":const a=JSON.parse(s.config);e.decryptor=new r.a(t,a);try{n.b.enable(!0===a.debug,a.debugLevel)}catch(e){console.warn("SegmentDecryptorWorker: unable to enable logs")}i("init",null);break;case"segment-decrypt":o(s)}}),t.on(s.b.ERROR,(t,i)=>{e.postMessage({event:t,data:i})})}}),(function(e,t,i){"use strict";i.r(t);var r=i(1),s=i(0),a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};function n(e,t){function i(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}function o(){for(var e=0,t=0,i=arguments.length;t<i;t++)e+=arguments[t].length;var r=Array(e),s=0;for(t=0;t<i;t++)for(var a=arguments[t],n=0,o=a.length;n<o;n++,s++)r[s]=a[n];return r}function l(e){return"function"==typeof e}function d(e){var t=e((function(e){Error.call(e),e.name=e.constructor.name,e.stack=(new Error).stack}));return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var h=d((function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}})),c=(function(){function e(e){this.initialTeardown=e,this.closed=!1,this._singleParent=null,this._parents=null,this._teardowns=null}var t;return e.prototype.unsubscribe=function(){var e;if(!this.closed){this.closed=!0;var t=this._singleParent,i=void 0;if(t)this._singleParent=null,t.remove(this);else if(i=this._parents){this._parents=null;for(var r=0,s=i;r<s.length;r++)s[r].remove(this)}var a=this.initialTeardown;if(l(a))try{a()}catch(t){e=t instanceof h?t.errors:[t]}var n=this._teardowns;if(this._teardowns=null,n)for(var d=0,c=n;d<c.length;d++){var u=c[d];try{"function"==typeof u?u():u.unsubscribe()}catch(t){e=null!=e?e:[],t instanceof h?e=o(e,t.errors):e.push(t)}}if(e)throw new h(e)}},e.prototype.add=function(t){var i;if(t&&t!==this)if(this.closed)"function"==typeof t?t():t.unsubscribe();else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}this._teardowns=null!==(i=this._teardowns)&&void 0!==i?i:[],this._teardowns.push(t)}},e.prototype._hasParent=function(e){var t;return this._singleParent===e||(null===(t=this._parents)||void 0===t?void 0:t.includes(e))||!1},e.prototype._addParent=function(e){var t,i=this._singleParent;i?(this._parents=[i,e],this._singleParent=null):(t=this._parents)?t.push(e):this._singleParent=e},e.prototype._removeParent=function(e){var t,i=this._singleParent;if(i)i===e&&(this._singleParent=null);else if(t=this._parents){var r=t.indexOf(e);r>=0&&t.splice(r,1)}},e.prototype.remove=function(t){var i=this._teardowns;if(i){var r=i.indexOf(t);r>=0&&i.splice(r,1)}t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e})();function u(e){return e instanceof c||e&&"closed"in e&&"function"==typeof e.remove&&"function"==typeof e.add&&"function"==typeof e.unsubscribe}var f={setInterval:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=f.delegate;return((null==i?void 0:i.setInterval)||setInterval).apply(void 0,e)},clearInterval:function(e){var t=f.delegate;return((null==t?void 0:t.clearInterval)||clearInterval)(e)},delegate:void 0},g=(function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.scheduler=t,r.work=i,r.pending=!1,r}return n(t,e),t.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var i=this.id,r=this.scheduler;return null!=i&&(this.id=this.recycleAsyncId(r,i,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(r,this.id,t),this},t.prototype.requestAsyncId=function(e,t,i){return void 0===i&&(i=0),f.setInterval(e.flush.bind(e,this),i)},t.prototype.recycleAsyncId=function(e,t,i){if(void 0===i&&(i=0),null!=i&&this.delay===i&&!1===this.pending)return t;f.clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var i=this._execute(e,t);if(i)return i;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var i=!1,r=void 0;try{this.work(e)}catch(e){i=!0,r=!!e&&e||new Error(e)}if(i)return this.unsubscribe(),r},t.prototype.unsubscribe=function(){if(!this.closed){var t=this.id,i=this.scheduler,r=i.actions,s=r.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==s&&r.splice(s,1),null!=t&&(this.id=this.recycleAsyncId(i,t,null)),this.delay=null,e.prototype.unsubscribe.call(this)}},t})(function(e){function t(t,i){return e.call(this)||this}return n(t,e),t.prototype.schedule=function(e,t){return void 0===t&&(t=0),this},t}(c)),p={now:function(){return(p.delegate||Date).now()},delegate:void 0},m=(function(){function e(t,i){void 0===i&&(i=e.now),this.SchedulerAction=t,this.now=i}return e.prototype.schedule=function(e,t,i){return void 0===t&&(t=0),new this.SchedulerAction(this,e).schedule(i,t)},e.now=p.now,e})(),y=new(function(e){function t(t,i){void 0===i&&(i=m.now);var r=e.call(this,t,i)||this;return r.actions=[],r.active=!1,r.scheduled=void 0,r}return n(t,e),t.prototype.flush=function(e){var t=this.actions;if(this.active)t.push(e);else{var i;this.active=!0;do{if(i=e.execute(e.state,e.delay))break}while(e=t.shift());if(this.active=!1,i){for(;e=t.shift();)e.unsubscribe();throw i}}},t}(m))(g),v=y;function b(e){return e instanceof Date&&!isNaN(e)}function S(e,t){if(function(e){return e&&"function"==typeof e.lift}(e))return e.lift(t);throw new TypeError("Unable to lift unknown Observable type")}var T=!1,E=!1,_={quietBadConfig:!1,Promise:void 0,set useDeprecatedSynchronousErrorHandling(e){if(!this.quietBadConfig)if(e){var t=new Error;console.warn("DEPRECATED! RxJS was set to use deprecated synchronous error handling behavior by code at: \n"+t.stack)}else T&&console.log("RxJS: Back to a better error behavior. Thank you. <3");T=e},get useDeprecatedSynchronousErrorHandling(){return T},set useDeprecatedNextContext(e){if(!this.quietBadConfig)if(e){var t=new Error;console.warn("DEPRECATED! RxJS was set to use deprecated next context. This will result in deoptimizations when creating any new subscription. \n"+t.stack)}else E&&console.log("RxJS: back to more optimized subscription creation. Thank you. <3");E=e},get useDeprecatedNextContext(){return E}};function D(e){setTimeout((function(){throw e}),0)}var I={closed:!0,next:function(e){},error:function(e){if(_.useDeprecatedSynchronousErrorHandling)throw e;D(e)},complete:function(){}},w=(function(e){function t(i,r,s){var a=e.call(this)||this;switch(a.syncErrorValue=null,a.syncErrorThrown=!1,a.syncErrorThrowable=!1,a.isStopped=!1,arguments.length){case 0:a.destination=I;break;case 1:if(!i){a.destination=I;break}if("object"==typeof i){i instanceof t?(a.syncErrorThrowable=i.syncErrorThrowable,a.destination=i,i.add(a)):(a.syncErrorThrowable=!0,a.destination=new R(a,i));break}default:a.syncErrorThrowable=!0,a.destination=new R(a,i,r,s)}return a}return n(t,e),t.create=function(e,i,r){var s=new t(e,i,r);return s.syncErrorThrowable=!1,s},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this))},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},t})(c),R=(function(e){function t(t,i,r,s){var a,n=e.call(this)||this;if(n._parentSubscriber=t,l(i))a=i;else if(i){var o;a=i.next,r=i.error,s=i.complete,i!==I&&(_.useDeprecatedNextContext?(o=Object.create(i)).unsubscribe=n.unsubscribe.bind(n):o=i,a=a&&a.bind(o),r=r&&r.bind(o),s=s&&s.bind(o),u(i)&&i.add(n.unsubscribe.bind(n)))}return n._next=a,n._error=r,n._complete=s,n}return n(t,e),t.prototype.next=function(e){if(!this.isStopped&&this._next)try{this._next(e)}catch(e){this._throw(e)}},t.prototype.error=function(e){if(!this.isStopped)if(this._error){try{this._error(e)}catch(e){return void this._throw(e)}this.unsubscribe()}else this._throw(e)},t.prototype._throw=function(e){if(this.unsubscribe(),_.useDeprecatedSynchronousErrorHandling){var t=this._parentSubscriber;if(null==t||!t.syncErrorThrowable)throw e;t.syncErrorValue=e,t.syncErrorThrown=!0}else D(e)},t.prototype.complete=function(){if(!this.isStopped){if(this._complete)try{this._complete()}catch(e){return void this._throw(e)}this.unsubscribe()}},t.prototype.unsubscribe=function(){if(!this.closed){var t=this._parentSubscriber;this._parentSubscriber=null,t.unsubscribe(),e.prototype.unsubscribe.call(this)}},t})(w);function A(e){return e&&"function"==typeof e.next&&"function"==typeof e.error&&"function"==typeof e.complete}var k=(function(e){function t(t){var i=e.call(this)||this;return i.destination=t,i}return n(t,e),t})(w),C="function"==typeof Symbol&&Symbol.observable||"@@observable";function L(e){return e}function P(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return M(e)}function M(e){return 0===e.length?L:1===e.length?e[0]:function(t){return e.reduce((function(e,t){return t(e)}),t)}}var x=(function(){function e(e){e&&(this._subscribe=e)}return e.prototype.lift=function(t){var i=new e;return i.source=this,i.operator=t,i},e.prototype.subscribe=function(e,t,i){var r=this.operator,s=(function(e,t,i){if(e){if((r=e)instanceof w||A(r)&&u(r))return e;if(A(e))return new k(e)}var r;return e||t||i?new w(e,t,i):new w(I)})(e,t,i);if(r?s.add(r.call(s,this.source)):s.add(this.source||_.useDeprecatedSynchronousErrorHandling&&!s.syncErrorThrowable?this._subscribe(s):this._trySubscribe(s)),_.useDeprecatedSynchronousErrorHandling&&s.syncErrorThrowable&&(s.syncErrorThrowable=!1,s.syncErrorThrown))throw s.syncErrorValue;return s},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){_.useDeprecatedSynchronousErrorHandling?(e.syncErrorThrown=!0,e.syncErrorValue=t):(function(e){for(;e;){var t=e,i=t.closed,r=t.destination,s=t.isStopped;if(i||s)return!1;e=r&&r instanceof w?r:null}return!0})(e)?e.error(t):console.warn(t)}},e.prototype.forEach=function(e,t){var i=this;return new(t=O(t))((function(t,r){var s;s=i.subscribe((function(t){try{e(t)}catch(e){r(e),s&&s.unsubscribe()}}),r,t)}))},e.prototype._subscribe=function(e){var t=this.source;return t&&t.subscribe(e)},e.prototype[C]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 0===e.length?this:M(e)(this)},e.prototype.toPromise=function(e){var t=this;return new(e=O(e))((function(e,i){var r;t.subscribe((function(e){return r=e}),(function(e){return i(e)}),(function(){return e(r)}))}))},e.create=function(t){return new e(t)},e})();function O(e){if(e||(e=_.Promise||Promise),!e)throw new Error("no Promise impl found");return e}var N=function(e){return function(t){for(var i=0,r=e.length;i<r&&!t.closed;i++)t.next(e[i]);t.complete()}},F="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator",B=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function U(e){return!!e&&"function"!=typeof e.subscribe&&"function"==typeof e.then}function $(e){return null!==e&&"object"==typeof e}function V(e){return function(t){(function(e,t){var i,r,s,a,n,o,l;return n=this,void 0,l=function(){var n,o;return (function(e,t){var i,r,s,a,n={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(a){return function(o){return (function(a){if(i)throw new TypeError("Generator is already executing.");for(;n;)try{if(i=1,r&&(s=2&a[0]?r.return:a[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,a[1])).done)return s;switch(r=0,s&&(a=[2&a[0],s.value]),a[0]){case 0:case 1:s=a;break;case 4:return n.label++,{value:a[1],done:!1};case 5:n.label++,r=a[1],a=[0];continue;case 7:a=n.ops.pop(),n.trys.pop();continue;default:if(!(s=(s=n.trys).length>0&&s[s.length-1])&&(6===a[0]||2===a[0])){n=0;continue}if(3===a[0]&&(!s||a[1]>s[0]&&a[1]<s[3])){n.label=a[1];break}if(6===a[0]&&n.label<s[1]){n.label=s[1],s=a;break}if(s&&n.label<s[2]){n.label=s[2],n.ops.push(a);break}s[2]&&n.ops.pop(),n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e],r=0}finally{i=s=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}})([a,o])}}})(this,(function(l){switch(l.label){case 0:l.trys.push([0,5,6,11]),i=(function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,i=e[Symbol.asyncIterator];return i?i.call(e):(e=(function(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")})(e),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(i){t[i]=e[i]&&function(t){return new Promise((function(r,s){!(function(e,t,i,r){Promise.resolve(r).then((function(t){e({value:t,done:i})}),t)})(r,s,(t=e[i](t)).done,t.value)}))}}})(e),l.label=1;case 1:return[4,i.next()];case 2:if((r=l.sent()).done)return[3,4];n=r.value,t.next(n),l.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return o=l.sent(),s={error:o},[3,11];case 6:return l.trys.push([6,,9,10]),r&&!r.done&&(a=i.return)?[4,a.call(i)]:[3,8];case 7:l.sent(),l.label=8;case 8:return[3,10];case 9:if(s)throw s.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}}))},new((o=void 0)||(o=Promise))((function(e,t){function i(e){try{s(l.next(e))}catch(e){t(e)}}function r(e){try{s(l.throw(e))}catch(e){t(e)}}function s(t){var s;t.done?e(t.value):(s=t.value,s instanceof o?s:new o((function(e){e(s)}))).then(i,r)}s((l=l.apply(n,[])).next())}))})(e,t).catch((function(e){return t.error(e)}))}}var G=function(e){if(e&&"function"==typeof e[C])return r=e,function(e){var t=r[C]();if("function"!=typeof t.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return t.subscribe(e)};if(B(e))return N(e);if(U(e))return i=e,function(e){return i.then((function(t){e.closed||(e.next(t),e.complete())}),(function(t){return e.error(t)})).then(null,D),e};if(e&&"function"==typeof e[F])return t=e,function(e){for(var i=t[F]();;){var r=void 0;try{r=i.next()}catch(t){return void e.error(t)}if(r.done){e.complete();break}if(e.next(r.value),e.closed)break}return"function"==typeof i.return&&e.add((function(){i.return&&i.return()})),e};if(Symbol&&Symbol.asyncIterator&&e&&"function"==typeof e[Symbol.asyncIterator])return V(e);var t,i,r,s=$(e)?"an invalid object":"'"+e+"'";throw new TypeError("You provided "+s+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")};function H(e,t){return new x((function(i){var r=new c,s=0;return r.add(t.schedule((function(){s!==e.length?(i.next(e[s++]),i.closed||r.add(this.schedule())):i.complete()}))),r}))}function K(e,t){return t?(function(e,t){if(null!=e){if(function(e){return e&&"function"==typeof e[C]}(e))return (function(e,t){return new x((function(i){var r=new c;return r.add(t.schedule((function(){var s=e[C]();r.add(s.subscribe({next:function(e){r.add(t.schedule((function(){return i.next(e)})))},error:function(e){r.add(t.schedule((function(){return i.error(e)})))},complete:function(){r.add(t.schedule((function(){return i.complete()})))}}))}))),r}))})(e,t);if(U(e))return (function(e,t){return new x((function(i){var r=new c;return r.add(t.schedule((function(){return e.then((function(e){r.add(t.schedule((function(){i.next(e),r.add(t.schedule((function(){return i.complete()})))})))}),(function(e){r.add(t.schedule((function(){return i.error(e)})))}))}))),r}))})(e,t);if(B(e))return H(e,t);if(function(e){return e&&"function"==typeof e[F]}(e)||"string"==typeof e)return (function(e,t){if(!e)throw new Error("Iterable cannot be null");return new x((function(i){var r,s=new c;return s.add((function(){r&&"function"==typeof r.return&&r.return()})),s.add(t.schedule((function(){r=e[F](),s.add(t.schedule((function(){if(!i.closed){var e,t;try{var s=r.next();e=s.value,t=s.done}catch(e){return void i.error(e)}t?i.complete():(i.next(e),this.schedule())}})))}))),s}))})(e,t);if(Symbol&&Symbol.asyncIterator&&"function"==typeof e[Symbol.asyncIterator])return (function(e,t){if(!e)throw new Error("Iterable cannot be null");return new x((function(i){var r=new c;return r.add(t.schedule((function(){var s=e[Symbol.asyncIterator]();r.add(t.schedule((function(){var e=this;s.next().then((function(t){t.done?i.complete():(i.next(t.value),e.schedule())}))})))}))),r}))})(e,t)}throw new TypeError((null!==e&&typeof e||e)+" is not observable")})(e,t):e instanceof x?e:new x(G(e))}var j=d((function(e){return function(t){void 0===t&&(t=null),e(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=t}}));function W(e,t){return function(i){var r,s,a=void 0,n=void 0,o=null;if(t=null!=t?t:y,b(e)?s=e:"number"==typeof e?a=e:(s=e.first,a=e.each,n=e.with,t=e.scheduler||y,o=null!==(r=e.meta)&&void 0!==r?r:null),n=null!=n?n:q,null==s&&null==a)throw new TypeError("No timeout provided.");return S(i,(function(e){var i,r,l=this,d=new c,h=null,u=null,f=0,g=function(e){d.add(h=t.schedule((function(){var e,t={meta:o,lastValue:u,seen:f};try{e=K(n(t))}catch(e){return void l.error(e)}i.unsubscribe(),d.add(e.subscribe(l))}),e))};return d.add(i=e.subscribe({next:function(e){null==h||h.unsubscribe(),h=null,f++,u=e,null!=a&&a>0&&g(a),l.next(e)},error:function(e){return l.error(e)},complete:function(){return l.complete()}})),r=null!=s?"number"==typeof s?s:+s-t.now():a,g(r),d}))}}function q(e){throw new j(e)}function z(e){return e&&"function"==typeof e.schedule}function X(e,t,i){void 0===e&&(e=0);var r=-1;return null!=t&&(z(t)?i=t:r=t),z(i)||(i=v),new x((function(t){var s=Math.max(0,b(e)?+e-i.now():e);return i.schedule(Q,s,{counter:0,period:r,subscriber:t})}))}function Q(e){var t=e.period,i=e.subscriber,r=e.counter++;if(i.next(r),!i.closed){if(t<0)return i.complete();this.schedule(e,t)}}var Y=d((function(e){return function(){e(this),this.message="object unsubscribed"}})),J=(function(e){function t(t,i){var r=e.call(this)||this;return r.subject=t,r.subscriber=i,r.closed=!1,r}return n(t,e),t.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var e=this.subject,t=e.observers;if(this.subject=null,t&&0!==t.length&&!e.isStopped&&!e.closed){var i=t.indexOf(this.subscriber);-1!==i&&t.splice(i,1)}}},t})(c),Z=(function(e){function t(){var t=e.call(this)||this;return t.observers=[],t.closed=!1,t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return n(t,e),t.prototype.lift=function(e){var t=new ee(this,this);return t.operator=e,t},t.prototype.next=function(e){if(this.closed)throw new Y;if(!this.isStopped)for(var t=this.observers,i=t.length,r=t.slice(),s=0;s<i;s++)r[s].next(e)},t.prototype.error=function(e){if(this.closed)throw new Y;this.hasError=!0,this.thrownError=e,this.isStopped=!0;for(var t=this.observers,i=t.length,r=t.slice(),s=0;s<i;s++)r[s].error(e);this.observers.length=0},t.prototype.complete=function(){if(this.closed)throw new Y;this.isStopped=!0;for(var e=this.observers,t=e.length,i=e.slice(),r=0;r<t;r++)i[r].complete();this.observers.length=0},t.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},t.prototype._trySubscribe=function(t){if(this.closed)throw new Y;return e.prototype._trySubscribe.call(this,t)},t.prototype._subscribe=function(e){if(this.closed)throw new Y;return this.hasError?(e.error(this.thrownError),c.EMPTY):this.isStopped?(e.complete(),c.EMPTY):(this.observers.push(e),new J(this,e))},t.prototype.asObservable=function(){var e=new x;return e.source=this,e},t.create=function(e,t){return new ee(e,t)},t})(x),ee=(function(e){function t(t,i){var r=e.call(this)||this;return r.destination=t,r.source=i,r}return n(t,e),t.prototype.next=function(e){var t=this.destination;t&&t.next&&t.next(e)},t.prototype.error=function(e){var t=this.destination;t&&t.error&&this.destination.error(e)},t.prototype.complete=function(){var e=this.destination;e&&e.complete&&this.destination.complete()},t.prototype._subscribe=function(e){return this.source?this.source.subscribe(e):c.EMPTY},t})(Z),te=(function(e){function t(t){var i=e.call(this)||this;return i._value=t,i}return n(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(t){var i=e.prototype._subscribe.call(this,t);return i&&!i.closed&&t.next(this._value),i},t.prototype.getValue=function(){if(this.hasError)throw this.thrownError;if(this.closed)throw new Y;return this._value},t.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},t})(Z),ie=new x((function(e){return e.complete()}));function re(e){return new x((function(t){var i;try{i=e()}catch(e){return void t.error(e)}return K(i).subscribe(t)}))}function se(e){return function(t){return S(t,(function(t){var i,r,s=this,a=new c,n=!1,o=function(){if(!r){r=new Z;var t=void 0;try{t=e(r)}catch(e){return s.error(e),null}a.add(t.subscribe({next:function(){i?l():n=!0},error:function(e){return s.error(e)},complete:function(){return s.complete()}}))}return r},l=function(){i=t.subscribe({next:function(e){return s.next(e)},error:function(e){var t=o();t&&t.next(e)},complete:function(){return s.complete()}}),n?(i.unsubscribe(),i=null,n=!1,l()):a.add(i)};return l(),a}))}}function ae(e,t){return function(i){if("function"!=typeof e)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return S(i,new ne(e,t))}}var ne=(function(){function e(e,t){this.project=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new oe(e,this.project,this.thisArg))},e})(),oe=(function(e){function t(t,i,r){var s=e.call(this,t)||this;return s.project=i,s.count=0,s.thisArg=r||s,s}return n(t,e),t.prototype._next=function(e){var t;try{t=this.project.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t})(w),le=(function(e){function t(t){var i=e.call(this)||this;return i.parent=t,i}return n(t,e),t.prototype._next=function(e){this.parent.notifyNext(e)},t.prototype._error=function(e){this.parent.notifyError(e),this.unsubscribe()},t.prototype._complete=function(){this.parent.notifyComplete(),this.unsubscribe()},t})(w),de=(function(e){function t(t,i,r){var s=e.call(this)||this;return s.parent=t,s.outerValue=i,s.outerIndex=r,s}return n(t,e),t.prototype._next=function(e){this.parent.notifyNext(this.outerValue,e,this.outerIndex,this)},t.prototype._error=function(e){this.parent.notifyError(e),this.unsubscribe()},t.prototype._complete=function(){this.parent.notifyComplete(this),this.unsubscribe()},t})(w),he=(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(){this.destination.complete()},t})(w),ce=(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.notifyNext=function(e,t,i,r){this.destination.next(t)},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(e){this.destination.complete()},t})(w);function ue(e,t){if(!t.closed)return e instanceof x?e.subscribe(t):G(e)(t)}function fe(e,t,i){return void 0===i&&(i=1/0),"function"==typeof t?function(r){return r.pipe(fe((function(i,r){return K(e(i,r)).pipe(ae((function(e,s){return t(i,e,r,s)})))}),i))}:("number"==typeof t&&(i=t),function(t){return S(t,new ge(e,i))})}var ge=(function(){function e(e,t){void 0===t&&(t=1/0),this.project=e,this.concurrent=t}return e.prototype.call=function(e,t){return t.subscribe(new pe(e,this.project,this.concurrent))},e})(),pe=(function(e){function t(t,i,r){void 0===r&&(r=1/0);var s=e.call(this,t)||this;return s.destination=t,s.project=i,s.concurrent=r,s.hasCompleted=!1,s.buffer=[],s.active=0,s.index=0,s}return n(t,e),t.prototype._next=function(e){if(this.active<this.concurrent){var t=void 0,i=this.index++;try{t=this.project(e,i)}catch(e){return void this.destination.error(e)}this.active++;var r=new le(this);this.destination.add(r),ue(t,r)}else this.buffer.push(e)},t.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&this.destination.complete(),this.unsubscribe()},t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyComplete=function(){var e=this.buffer;this.active--,e.length>0?this._next(e.shift()):0===this.active&&this.hasCompleted&&this.destination.complete()},t})(he),me=d((function(e){return function(){e(this),this.message="argument out of range"}}));function ye(e){if(isNaN(e))throw new TypeError("'count' is not a number");if(e<0)throw new me;return function(t){return 0===e?ie:S(t,new ve(e))}}var ve=(function(){function e(e){this.count=e}return e.prototype.call=function(e,t){return t.subscribe(new be(e,this.count))},e})(),be=(function(e){function t(t,i){var r=e.call(this,t)||this;return r.count=i,r._valueCount=0,r}return n(t,e),t.prototype._next=function(e){var t=this.count,i=++this._valueCount;i<=t&&(this.destination.next(e),i===t&&(this.destination.complete(),this.unsubscribe()))},t})(w);function Se(e){return function(t){return S(t,(function(t){var i,r=this,s=new c,a=null,n=!1;return a=t.subscribe(new Te(r,(function(o){!(function(s){try{i=K(e(s,Se(e)(t)))}catch(s){return void r.error(s)}})(o),i&&(a?(a.unsubscribe(),a=null,s.add(i.subscribe(r))):n=!0)}))),n?(a.unsubscribe(),a=null,s.add(i.subscribe(r))):s.add(a),s}))}}var Te=(function(e){function t(t,i){var r=e.call(this,t)||this;return r.onError=i,r}return n(t,e),t.prototype._error=function(e){this.onError(e),this.unsubscribe()},t})(w);function Ee(e,t){return function(i){return S(i,new _e(e,t))}}var _e=(function(){function e(e,t){this.predicate=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new De(e,this.predicate,this.thisArg))},e})(),De=(function(e){function t(t,i,r){var s=e.call(this,t)||this;return s.predicate=i,s.thisArg=r,s.count=0,s}return n(t,e),t.prototype._next=function(e){var t;try{t=this.predicate.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}t&&this.destination.next(e)},t})(w);function Ie(e,t){return"function"==typeof t?function(i){return i.pipe(Ie((function(i,r){return K(e(i,r)).pipe(ae((function(e,s){return t(i,e,r,s)})))})))}:function(t){return S(t,new we(e))}}var we=(function(){function e(e){this.project=e}return e.prototype.call=function(e,t){return t.subscribe(new Re(e,this.project))},e})(),Re=(function(e){function t(t,i){var r=e.call(this,t)||this;return r.destination=t,r.project=i,r.index=0,r}return n(t,e),t.prototype._next=function(e){var t,i=this.index++;try{t=this.project(e,i)}catch(e){return void this.destination.error(e)}var r=this.innerSubscription;r&&r.unsubscribe();var s=new le(this);this.destination.add(s),this.innerSubscription=s,ue(t,s)},t.prototype._complete=function(){var t=this.innerSubscription;t&&!t.closed||e.prototype._complete.call(this),this.innerSubscription=void 0,this.unsubscribe()},t.prototype.notifyComplete=function(){this.innerSubscription=void 0,this.isStopped&&e.prototype._complete.call(this)},t.prototype.notifyNext=function(e){this.destination.next(e)},t})(he),Ae=i(3),ke=i(2);class Ce extends Error{constructor(e,t){super(e),this.code=t}}class Le{constructor(e){this.logger=e,this.onprogress$=new te(ie),null!=e||(this.logger=Ae.b)}_relateServerInstanceInfoToRequest(e){this.context.collectServerInstanceInfo&&(this.context.serverInstanceInfo={},this.context.collectServerInstanceInfo.forEach(t=>{let i=e.getResponseHeader(t);i&&(this.context.serverInstanceInfo[t]=i)}))}load(e,t){this.context=e,this.config=t,this.stats={retry:0,trequest:performance.now(),tfirst:0,loaded:0};let i=re(()=>(this.stats.trequest=performance.now(),this.stats.tfirst=0,this.stats.loaded=0,this.loadInternal()));return Object(ke.c)(t.maxLoadTimeMs)&&t.maxLoadTimeMs>0&&(i=i.pipe(W(t.maxLoadTimeMs))),i.pipe(ye(1),Se(e=>{throw e instanceof j&&this.logger.warn("[QE Critical] timeout while loading url type: "+this.type)(),e}),(function(e,t){return i=>i.pipe(se(i=>i.pipe(fe((i,r)=>{if(!e.autoRetry||!(i instanceof Ce||i instanceof j))throw i;let s,a=!0;if(i instanceof Ce?(a=!(i.code>=400&&i.code<499),s=e.errorRetry):s=e.timeoutRetry,a&&r<s.maxNumRetry)return t&&(t.retry=r+1),X(Math.min(Math.pow(2,r)*s.retryDelayMs,s.maxRetryDelayMs));throw i}))))})(t,this.stats))}onProgress(){return this.onprogress$.pipe(Ee(e=>null!=e),Ie(e=>e))}loadsuccess(e,t){let i=this.context,r=performance.now();const{tfirst:s}=this.stats;let a,n,o=Math.max(s,r),l=r,d=n="arraybuffer"===i.responseType?(a=e.response).byteLength:(a=e.responseText).length,h=n,c=e.getResponseHeader("Content-Type"),u={url:e.responseURL,data:a,len:n,contentLen:t};this._relateServerInstanceInfoToRequest(e);const{cached:f,cdnServer:g}=this.stats;return{response:u,stats:Object.assign(Object.assign({},this.stats),{tfirst:s,tload:o,tdataack:l,loaded:d,total:h,contentType:null!=c?c:null,cdnServer:null!=g?g:null,cached:!0===f})}}loaderror(e,t){return new Ce(t,e)}}var Pe=/^((?:[^\/;?#]+:)?)(\/\/[^\/\;?#]*)?(.*?)??(;.*?)?(\?.*?)?(#.*?)?$/,Me=/^([^\/;?#]*)(.*)$/,xe=/(?:\/|^)\.(?=\/)/g,Oe=/(?:\/|^)\.\.\/(?!\.\.\/).*?(?=\/)/g;const Ne={buildAbsoluteURL:function(e,t,i){if(i=i||{},e=e.trim(),!(t=t.trim())){if(!i.alwaysNormalize)return e;var r=Ne.parseURL(e);if(!r)throw new Error("Error trying to parse base URL.");return r.path=Ne.normalizePath(r.path),Ne.buildURLFromParts(r)}var s=Ne.parseURL(t);if(!s)throw new Error("Error trying to parse relative URL.");if(s.scheme)return i.alwaysNormalize?(s.path=Ne.normalizePath(s.path),Ne.buildURLFromParts(s)):t;var a=Ne.parseURL(e);if(!a)throw new Error("Error trying to parse base URL.");if(!a.netLoc&&a.path&&"/"!==a.path[0]){var n=Me.exec(a.path);a.netLoc=n[1],a.path=n[2]}a.netLoc&&!a.path&&(a.path="/");var o={scheme:a.scheme,netLoc:s.netLoc,path:null,params:s.params,query:s.query,fragment:s.fragment};if(!s.netLoc&&(o.netLoc=a.netLoc,"/"!==s.path[0]))if(s.path){i.inheritQuery&&(s.query||(o.query=a.query));var l=a.path,d=l.substring(0,l.lastIndexOf("/")+1)+s.path;o.path=Ne.normalizePath(d)}else o.path=a.path,s.params||(o.params=a.params,s.query||(o.query=a.query));return null===o.path&&(o.path=i.alwaysNormalize?Ne.normalizePath(s.path):s.path),Ne.buildURLFromParts(o)},parseURL:function(e){var t=Pe.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(xe,"");e.length!==(e=e.replace(Oe,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment},getHostName:function(e){var t;return e?t=(t=(t=e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0]).split(":")[0]).split("?")[0]:t}};var Fe=Ne;function Be(e,t){return new x(t?function(i){return t.schedule((function(){i.error("function"==typeof e?e():e)}))}:function(t){return t.error("function"==typeof e?e():e)})}function Ue(e,t){return t?H(e,t):new x(N(e))}function $e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=e[e.length-1];return z(i)?(e.pop(),H(e,i)):Ue(e)}function Ve(e){return void 0===e&&(e=1/0),fe(L,e)}function Ge(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=1/0,r=void 0,s=e[e.length-1];return z(s)?(r=e.pop(),e.length>1&&"number"==typeof e[e.length-1]&&(i=e.pop())):"number"==typeof s&&(i=e.pop()),!r&&1===e.length&&e[0]instanceof x?e[0]:Ve(i)(Ue(e,r))}var He=Array.isArray||function(e){return e&&"number"==typeof e.length};function Ke(e,t,i,r){return l(i)&&(r=i,i=void 0),r?Ke(e,t,i).pipe(ae((function(e){return He(e)?r.apply(void 0,e):r(e)}))):new x((function(r){!(function e(t,i,r,s,a){var n;if(function(e){return e&&"function"==typeof e.addEventListener&&"function"==typeof e.removeEventListener}(t)){var o=t;t.addEventListener(i,r,a),n=function(){return o.removeEventListener(i,r,a)}}else if(function(e){return e&&"function"==typeof e.on&&"function"==typeof e.off}(t)){var l=t;t.on(i,r),n=function(){return l.off(i,r)}}else if(function(e){return e&&"function"==typeof e.addListener&&"function"==typeof e.removeListener}(t)){var d=t;t.addListener(i,r),n=function(){return d.removeListener(i,r)}}else{if(!t||!t.length)throw new TypeError("Invalid event target");for(var h=0,c=t.length;h<c;h++)e(t[h],i,r,s,a)}s.add(n)})(e,t,(function(e){arguments.length>1?r.next(Array.prototype.slice.call(arguments)):r.next(e)}),r,i)}))}function je(){}function We(e,t,i){return function(r){return S(r,new qe(e,t,i))}}var qe=(function(){function e(e,t,i){this.nextOrObserver=e,this.error=t,this.complete=i}return e.prototype.call=function(e,t){return t.subscribe(new ze(e,this.nextOrObserver,this.error,this.complete))},e})(),ze=(function(e){function t(t,i,r,s){var a=e.call(this,t)||this;return a._tapNext=je,a._tapError=je,a._tapComplete=je,a._tapError=r||je,a._tapComplete=s||je,l(i)?(a._context=a,a._tapNext=i):i&&(a._context=i,a._tapNext=i.next||je,a._tapError=i.error||je,a._tapComplete=i.complete||je),a}return n(t,e),t.prototype._next=function(e){try{this._tapNext.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.next(e)},t.prototype._error=function(e){try{this._tapError.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.error(e)},t.prototype._complete=function(){try{this._tapComplete.call(this._context)}catch(e){return void this.destination.error(e)}return this.destination.complete()},t})(w);function Xe(e){return function(t){return S(t,new Qe(e))}}var Qe=(function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){var i=new Ye(e),r=ue(this.notifier,new le(i));return r&&!i.notifierHasNotified?(i.add(r),t.subscribe(i)):i},e})(),Ye=(function(e){function t(t){var i=e.call(this,t)||this;return i.notifierHasNotified=!1,i}return n(t,e),t.prototype.notifyNext=function(){this.notifierHasNotified=!0,this.complete()},t.prototype.notifyComplete=function(){},t})(he);class Je{constructor(e,t){this.target=e,this._this=t}eventWithOptions(e,t,i,r=this._this){let s=Ke(this.target,e,t);return this.target instanceof ko&&(s=s.pipe(ae(([e,t])=>t))),i&&(r&&(i=i.bind(r)),s=s.pipe(We(i))),s}event(e,t,i=this._this){return this.eventWithOptions(e,void 0,t,i)}listen(e,t,i,r=this._this){return this.event(e,i,r).pipe(Xe(t)).subscribe()}}function Ze(e,t){return new Je(e,t)}function et(){return function(e){return S(e,new it)}}var tt,it=(function(){function e(){}return e.prototype.call=function(e,t){t._refCount++;var i=new rt(e,t),r=t.subscribe(i);return i.closed||(i.connection=t.connect()),r},e})(),rt=(function(e){function t(t,i){var r=e.call(this,t)||this;return r.connectable=i,r.connection=null,r}return n(t,e),t.prototype.unsubscribe=function(){if(!this.closed){var t=this.connectable;if(!t)return void(this.connection=null);this.connectable=null;var i=t._refCount;if(i<=0)return void(this.connection=null);if(t._refCount=i-1,i>1)return void(this.connection=null);var r=this.connection,s=t._connection;this.connection=null,!s||r&&s!==r||s.unsubscribe(),e.prototype.unsubscribe.call(this)}},t})(w),st={operator:{value:null},_refCount:{value:0,writable:!0},_subject:{value:null,writable:!0},_connection:{value:null,writable:!0},_subscribe:{value:(tt=(function(e){function t(t,i){var r=e.call(this)||this;return r.source=t,r.subjectFactory=i,r._refCount=0,r._isComplete=!1,r}return n(t,e),t.prototype._subscribe=function(e){return this.getSubject().subscribe(e)},t.prototype.getSubject=function(){var e=this._subject;return e&&!e.isStopped||(this._subject=this.subjectFactory()),this._subject},t.prototype.connect=function(){var e=this._connection;return e||(this._isComplete=!1,(e=this._connection=new c).add(this.source.subscribe(new at(this.getSubject(),this))),e.closed&&(this._connection=null,e=c.EMPTY)),e},t.prototype.refCount=function(){return et()(this)},t})(x).prototype)._subscribe},_isComplete:{value:tt._isComplete,writable:!0},getSubject:{value:tt.getSubject},connect:{value:tt.connect},refCount:{value:tt.refCount}},at=(function(e){function t(t,i){var r=e.call(this)||this;return r.destination=t,r.connectable=i,r}return n(t,e),t.prototype._error=function(t){this._teardown(),e.prototype._error.call(this,t)},t.prototype._complete=function(){this.connectable._isComplete=!0,this._teardown(),e.prototype._complete.call(this)},t.prototype._teardown=function(){var e=this.connectable;if(e){this.connectable=null;var t=e._connection;e._refCount=0,e._subject=null,e._connection=null,t&&t.unsubscribe()}},t.prototype.unsubscribe=function(){this.closed||(this._teardown(),e.prototype.unsubscribe.call(this))},t})(w);function nt(){return new Z}function ot(){return function(e){return et()((t=nt,function(e){var i;i="function"==typeof t?t:function(){return t};var r=Object.create(e,st);return r.source=e,r.subjectFactory=i,r})(e));var t}}function lt(e,t,i){return void 0===i&&(i=1/0),"function"==typeof t?fe((function(){return e}),t,i):("number"==typeof t&&(i=t),fe((function(){return e}),i))}function dt(e){return function(t){return S(t,new ht(e))}}var ht=(function(){function e(e){this.callback=e}return e.prototype.call=function(e,t){var i=t.subscribe(e);return i.add(this.callback),i},e})();i(19);const ct=$e(void 0);function ut(e,t,i=1){return e.pipe(Ee(t),ye(i))}function ft(e){return t=>t.pipe(se(t=>t.pipe(fe(e))))}var gt=class extends Le{constructor(e,t){super(t),e&&e.xhrSetup&&(this.xhrSetup=e.xhrSetup)}get xhrReq(){return this.request}overrideMimeType(e){this.request&&typeof this.request.overrideMimeType==typeof Function?this.request.overrideMimeType(e):this.mimeType=e}responseXML(){let e=null;return this.request&&this.request.responseXML&&(e=this.request.responseXML),e}loadInternal(){var e,t=this.context;"undefined"!=typeof XDomainRequest?e=this.request=new XDomainRequest:(e=this.request=new XMLHttpRequest,this.mimeType&&typeof this.request.overrideMimeType==typeof Function&&this.request.overrideMimeType(this.mimeType));const i=this.xhrSetup;let r=t.method?t.method:"GET";try{if(i)try{i(e,t.url)}catch(s){e.open(r,t.url,!0),i(e,t.url)}e.readyState||e.open(r,t.url,!0)}catch(t){return Be(()=>new Ce(t.message,e.status))}t.sessionID&&e.setRequestHeader("X-Playback-Session-Id",t.sessionID),t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.responseType=t.responseType;let s=Ze(e),a=ie,n=s.event("readystatechange").pipe(ot());this.config.maxTimeToFirstByteMs>0&&Object(ke.c)(this.config.maxTimeToFirstByteMs)&&(a=ut(n,e=>e.currentTarget.readyState>=2).pipe(W(this.config.maxTimeToFirstByteMs),lt(ie)));let o=s.event("progress").pipe(fe(e=>{this.loadprogress(e);let t=e.currentTarget;return 3===t.readyState?$e({stats:Object.assign({},this.stats),xhrReq:t}):ie}),ot());return this.onprogress$.next(o),Ge(a,o.pipe(lt(ie)),n.pipe(Ie(e=>this.readystatechange(e))),re(()=>("POST"===r&&t.payload?e.send(this.context.payload):e.send(),ie))).pipe(ye(1),dt(()=>{e.abort(),this.onprogress$.next(null)}))}getByteRangeLength(e){let t=/([0-9]+)\-([0-9]+)\/([0-9]+)/.exec(e);return t?parseInt(t[2])-parseInt(t[1])+1:void 0}getContentLength(e){let t,i=e.getResponseHeader("Content-Encoding"),r=e.getResponseHeader("Transfer-Encoding"),s=!i||i&&"identity"===i.toLowerCase(),a=!r||r&&"identity"===r.toLowerCase();return s&&a&&(t=this.getByteRangeLength(e.getResponseHeader("Content-Range")),Object(ke.c)(t)||(t=parseInt(e.getResponseHeader("Content-Length")))),t}readystatechange(e){var t=e.currentTarget,i=t.readyState,r=this.stats,s=this.config;if(i>=2&&(0===r.tfirst&&(r.tfirst=Math.max(performance.now(),r.trequest)),s.reportCDNServer&&(r.cdnServer=t.getResponseHeader("CDN-Server")),4===i)){let e=t.status;if(e>=200&&e<300)return $e(this.loadsuccess(t,this.config.forceContentLenCheckIfNoHeader?this.getContentLength(t):void 0));throw this.loaderror(e,t.statusText)}return ie}loadprogress(e){var t=e.currentTarget,i=this.stats;3===t.readyState&&(i.loaded=e.loaded,e.lengthComputable&&(i.total=e.total))}get type(){var e;return null===(e=this.context)||void 0===e?void 0:e.type}},pt=i(5),mt=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.value=null,t.hasNext=!1,t.hasCompleted=!1,t}return n(t,e),t.prototype._subscribe=function(t){return this.hasError?(t.error(this.thrownError),c.EMPTY):this.hasCompleted&&this.hasNext?(t.next(this.value),t.complete(),c.EMPTY):e.prototype._subscribe.call(this,t)},t.prototype.next=function(e){this.hasCompleted||(this.value=e,this.hasNext=!0)},t.prototype.error=function(t){this.hasCompleted||e.prototype.error.call(this,t)},t.prototype.complete=function(){this.hasCompleted=!0,this.hasNext&&e.prototype.next.call(this,this.value),e.prototype.complete.call(this)},t})(Z),yt=class extends Le{constructor(e){super(e.logger),this.onResolve$=new mt,this.hls=e,this._loader=void 0}resolve(e){this.onResolve$.next(e),this.onResolve$.complete()}loadInternal(){let e=this.context.url;return Ge(ut(Ze(this.hls).event(r.b.UNRESOLVED_URI_LOADED),t=>t.uri===e).pipe(Ie(e=>(this.resolve(e.response),ie))),re(()=>{let t={uri:e,userAgent:navigator.userAgent};return this.hls.trigger(r.b.UNRESOLVED_URI_LOADING,t),this.onResolve$})).pipe(ye(1),Ie(e=>this.handleExternalResponse(e)),W(this.config.maxTimeToFirstByteMs))}handleExternalResponse(e){let t=this.stats,i=this.context;0===t.tfirst&&(t.tfirst=Math.max(performance.now(),t.trequest));let r=e.status||200;if(r>=200&&r<300)return $e(this.loadsuccess({responseURL:i.url,response:e.data,get responseText(){return pt.b.utf8arrayToStr(new Uint8Array(this.response))},getResponseHeader:()=>{},status:r}));{let t;switch(r){case 300:case 302:case 303:case 305:t=e.uri}if(t)return this.redirectRequest(t);throw this.loaderror(r,"Unable to load custom url")}}redirectRequest(e){let t=this.stats,i=this.config;this._loader=new gt(this.hls.config);let r=Object.assign({},this.context),s=Object.assign({},this.config);if(r.url=e,s.maxLoadTimeMs=i.maxLoadTimeMs-(performance.now()-t.trequest),s.maxTimeToFirstByteMs=i.maxTimeToFirstByteMs-(performance.now()-t.trequest),s.maxTimeToFirstByteMs<=0||s.maxLoadTimeMs<=0)throw new j;let a=this._loader.onProgress().pipe(ae(e=>(this.stats.loaded=e.stats.loaded,t.total&&(this.stats.total=e.stats.total),{stats:this.stats,xhrReq:this.xhrReq})),ot());return this.onprogress$.next(a),Ge(this._loader.load(r,s),a.pipe(lt(ie))).pipe(ye(1),ae(e=>(e.stats.trequest=this.stats.trequest,this.stats=e.stats,e)))}get xhrReq(){return this._loader?this._loader.xhrReq:void 0}static isCustomUrl(e){let t=Ne.parseURL(e);return"http:"!==t.scheme&&"https:"!==t.scheme}overrideMimeType(e){}responseXML(){}get type(){return this.context?this.context.type:""}},vt=i(9);const bt={avc1:"video/mp4",avc3:"video/mp4",dvav:"video/mp4",dva1:"video/mp4",hev1:"video/mp4",hvc1:"video/mp4",dvh1:"video/mp4",dvhe:"video/mp4"};var St={mp4a:"audio/mp4","ac-3":"audio/mp4","ec-3":"audio/mp4"};function Tt(e){let t=pt.b.strToUtf8array(e).subarray(0,16),i=new Uint8Array(16);return i.set(t,16-t.length),i}var Et=function(e,t,i){let r={videoCapabilities:new Array,audioCapabilities:new Array};return e&&e.forEach((function(e){let t=e.split(".")[0].trim();t in bt&&r.videoCapabilities.push({contentType:bt[t]+";codecs="+e,robustness:i&&i.videoRobustnessLevel?i.videoRobustnessLevel:""})})),t&&t.forEach((function(e){let t=e.split(".")[0].trim();t in St&&r.audioCapabilities.push({contentType:St[t]+";codecs="+e,robustness:i&&i.audioRobustnessLevel?i.audioRobustnessLevel:""})})),r},_t=function(e){let t=function(e,t,i){let r=e[t];e[t]=e[i],e[i]=r};t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)},Dt=function(e){let t=e.split(":"),i=null;if("data"===t[0]&&2===t.length){let e=t[1].split(";"),r=e[e.length-1].split(",");if(2===r.length){let t="base64"===r[0],s=r[1];t?(e.splice(-1,1),i=vt.a.base64Decode(s)):i=Tt(s)}}return i},It=function(e){let t={kids:e.map(vt.a.base64UrlEncode)};return pt.b.strToUtf8array(JSON.stringify(t))},wt={id:"playready",systemStringPrefix:"com.microsoft.playready",keyFormatString:"com.microsoft.playready",securityLevels:{SL2000:0,SL3000:1}},Rt={id:"widevine",systemStringPrefix:"com.widevine.alpha",keyFormatString:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",securityLevels:{WIDEVINE_SOFTWARE:0,WIDEVINE_HARDWARE:1}};const At={NONE:"","AES-128":"","ISO-23001-7":"","SAMPLE-AES":"","SAMPLE-AES-CTR":""};let kt={};class Ct{constructor(e,t,i,r,s){if(this.method=e,this.uri=t,this.iv=i,this.format=r,this.formatversions=s,this.isEncrypted=this.method&&"NONE"!==this.method,this.formatversions&&0!==this.formatversions.length||(this.formatversions=[1]),this.key=null,this.keyId=null,this.expiryPosition=1/0,!this.isEncrypted)return;let a=Dt(this.uri);if(a)switch(r){case wt.keyFormatString:{this.pssh=a;let e=new Uint16Array(a.buffer,a.byteOffset,a.byteLength/2);var n,o=String.fromCharCode.apply(null,e),l=o.substring(o.indexOf("<"),o.length),d=(new DOMParser).parseFromString(l,"text/xml").getElementsByTagName("KID")[0];if(d)if(n=d.childNodes[0]?d.childNodes[0].nodeValue:d.getAttribute("VALUE")){let e=vt.a.base64Decode(n).subarray(0,16);_t(e),this.keyId=e}break}case Rt.keyFormatString:this.pssh=a,a.length>=22&&(this.keyId=a.subarray(a.length-22,a.length-6));break;default:{let e=a.subarray(0,16);if(16!==e.length){let t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}if(!this.keyId||16!==this.keyId.byteLength){let e=kt[this.uri];if(!e){let t=Object.keys(kt).length%Number.MAX_SAFE_INTEGER;e=new Uint8Array(16),new DataView(e.buffer,12,4).setUint32(0,t),kt[this.uri]=e}this.keyId=e}}static clearKeyUriToKeyIdMap(){kt={}}}var Lt=Ct;const Pt={afr:"af",aka:"ak",amh:"am",ara:"ar",arg:"an",asm:"as",ava:"av",ave:"ae",aym:"ay",aze:"az",bam:"bm",bel:"be",ben:"bn",bih:"bh",bod:"bo",bos:"bs",bre:"br",bul:"bg",cat:"ca",ces:"cs",cha:"ch",che:"ce",chu:"cu",chv:"cv",cor:"kw",cos:"co",cre:"cr",cym:"cy",dan:"da",deu:"de",div:"dv",dzo:"dz",ell:"el",eng:"en",epo:"eo",est:"et",eus:"eu",ewe:"ee",fao:"fo",fas:"fa",fin:"fi",fra:"fr",fry:"fy",ful:"ff",gla:"gd",gle:"ga",glg:"gl",glv:"gv",grn:"gn",guj:"gu",hat:"ht",heb:"he",her:"hz",hin:"hi",hmo:"ho",hrv:"hr",hun:"hu",hye:"hy",ibo:"ig",ido:"io",iii:"ii",iku:"iu",ile:"ie",ina:"ia",ind:"id",isl:"is",ita:"it",jav:"jv",jpn:"ja",kal:"kl",kan:"kn",kas:"ks",kat:"ka",kau:"kr",kaz:"kk",khm:"km",kik:"ki",kin:"rw",kir:"ky",kom:"kv",kon:"kg",kor:"ko",kua:"kj",kur:"ku",lao:"lo",lat:"la",lav:"lv",lim:"li",lit:"lt",ltz:"lb",lub:"lu",lug:"lg",mah:"mh",mal:"ml",mar:"mr",mkd:"mk",mlg:"mg",mlt:"mt",mol:"mo",mon:"mn",mri:"mi",msa:"ms",mya:"my",nav:"nv",nbl:"nr",nde:"nd",ndo:"ng",nep:"ne",nld:"nl",nno:"nn",nob:"nb",nya:"ny",oci:"oc",oji:"oj",ori:"or",orm:"om",oss:"os",pan:"pa",pli:"pi",pol:"pl",por:"pt",pus:"ps",que:"qu",roh:"rm",ron:"ro",run:"rn",rus:"ru",san:"sa",sin:"si",slk:"sk",slv:"sl",sme:"se",snd:"sd",som:"so",spa:"es",sqi:"sq",srd:"sc",srp:"sr",sun:"su",swa:"sw",swe:"sv",tah:"ty",tam:"ta",tat:"tt",tel:"te",tgk:"tg",tgl:"tl",tha:"th",tir:"ti",ton:"to",tuk:"tk",tur:"tr",uig:"ug",ukr:"uk",urd:"ur",uzb:"uz",ven:"ve",vie:"vi",wln:"wa",yid:"yi",zha:"za",zho:"zh"},Mt={isLanguageCode:function(e){return e in Pt},shortenLanguageCode:function(e){let t;if(e){let i=e.indexOf("-"),r=i>=0?e.slice(0,i):e;Mt.isLanguageCode(r)&&(t=Pt[r]),t||(t=r),i>0&&(t+="-"+e.slice(i+1))}return t}};var xt=Mt;function Ot(e,t){return Object(ke.c)(e)?e.toFixed(t):""+e}class Nt{constructor(e){this._url=null,this._byteRange=null,this.inheritQuery=e,this.tagList=new Array,this.iframe=!1}get seqNum(){return Object(ke.c)(this.sn)?this.sn:NaN}static getStartEndString(e){return`[${Ot(e.startDTS||e.start,3)},${Ot(e.endPTS||e.start+e.duration,3)}]`}equals(e){return e.sn===this.sn&&e.level===this.level}get url(){return!this._url&&this.relurl&&(this._url=Ne.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0,inheritQuery:this.inheritQuery})),this._url}set url(e){this._url=e}get programDateTime(){return!this._programDateTime&&this.rawProgramDateTime&&(this._programDateTime=new Date(Date.parse(this.rawProgramDateTime))),this._programDateTime}get byteRange(){if(!this._byteRange){let e=new Array(2);if(this.rawByteRange){const t=this.rawByteRange.split("@",2);if(1===t.length){const t=this.lastByteRangeEndOffset;e[0]=t||0}else e[0]=parseInt(t[1]);e[1]=parseInt(t[0])+e[0]}this._byteRange=e}return this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get decryptdata(){return this._decryptdata||(this._decryptdata=this.fragmentDecryptdataFromLevelkey(this.levelkey,this.sn)),this._decryptdata}set decryptdata(e){this._decryptdata=e}static createInitializationVector(e){for(var t=new Uint8Array(16),i=12;i<16;i++)t[i]=e>>8*(15-i)&255;return t}fragmentDecryptdataFromLevelkey(e,t){var i=e;if(e&&e.method&&e.uri&&!e.iv&&(!e.format||"identity"===e.format)){let r=Nt.createInitializationVector(t);i=new Lt(e.method,e.uri,r,e.format,e.formatversions)}return i}get rangeString(){return this.start>=0&&this.duration>=0?`${this.start.toFixed(2)}-${(this.start+this.duration).toFixed(2)}`:"N/A"}get fragTag(){return`sn/cc/level: ${this.sn}/${this.cc}/${this.level}`}}var Ft=Nt;const Bt="canplay",Ut="desiredratechange",$t="pause",Vt="playing",Gt="ended",Ht="mediaerror",Kt="playbackinfo",jt="bufferappended",Wt="seeked",qt="manifestparsed",zt="manifestloaded",Xt="fragloading",Qt="fragloaded",Yt="fragbuffered",Jt="variantend",Zt="segmentkeyloaded",ei="levelloaded",ti="levelloaderror",ii="levelschanged",ri="levelswitched",si="bufferstalled",ai="mediaenginestalled",ni="nwerror",oi="spcrequested",li="spcreceived",di="spcsubmitted",hi="spccreated",ci="ckcrequested",ui="ckcreceived",fi="ckcsubmitted",gi="ckcprocessed",pi="keyaborted",mi="spcerror",yi="ckcerror",vi=6101,bi=["PlayTimeWC","PlayTime","PlayType","StallCount","MediaEngineStallCount","InitTime","PauseTime","StallTime","LastPause","LastStall","LastMediaEngineStall","MediaEngineStallTime","ADT","SegmentProcessTime","SegmentParseTime","PlaylistADT","MaxPlaylistDT","MasterPlaylistADT","NwErrCount","PlayerErrCount","FatalNwErrCount","FatalPlayerErrCount","GroupViFrDr","GroupViFrDrEvtCount","SparseViFrDr","SparseViFrDrEvtCount","AvgVideoBitrate","AvgAudioBitrate","TWOBR","PerceivedTWOBR","NetTWOBR","PlayerTWIBR","PlayerTWIABR","TWBitRk","SwCnt","NetBytes","TargetDur","VariantList","PlaylistMimeType","SegmentMimeType","MediaRequestsSent","Rate","ReWd","ReHt","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],Si=["EventCounter","PInterval","PlayTimeWC","PlayTime","PlayType","StallCount","MediaEngineStallCount","InitTime","PauseTime","StallTime","MediaEngineStallTime","ADT","SegmentProcessTime","SegmentParseTime","PlaylistADT","MaxPlaylistDT","MasterPlaylistADT","NwErrCount","PlayerErrCount","FatalNwErrCount","FatalPlayerErrCount","GroupViFrDr","GroupViFrDrEvtCount","SparseViFrDr","SparseViFrDrEvtCount","AvgVideoBitrate","AvgAudioBitrate","TWOBR","PerceivedTWOBR","NetTWOBR","PlayerTWIBR","PlayerTWIABR","TWBitRk","SwCnt","NetBytes","TargetDur","VariantList","MediaRequestsSent","Rate","ReWd","ReHt","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo","MedianBufferAppendLatency","MaxBufferAppendLatency","MedianBufferAppendSize","MaxBufferAppendSize","MedianSeekLatency","MaxSeekLatency","MedianPlayLatency","MaxPlayLatency"],Ti=["MediaDur","BitRnk","Codecs","PlayTime","PlayType","LastLikelyToKeepUp","LastSwitch","LastResume","StallDetectionTime","StallType","BufferLength","NwErrTime","NwErrCode","LaSwDir","TargetDur","PlayerIABR","PlayerIBR","Rate","OBRLast","OBRMean","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],Ei=["KeyFormat","CDMVersion","SPCRequestTime","SPCCreationTime","CKCResponseTime","CKCProcessTime","KeyDeliveryTime","CurrentMediaTime","KeyInitTime","KeyErrorType","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],_i=["EventCounter","PlayType","PlayerIABR","PlayerIBR","MediaDur","BitRnk","Codecs","StartupTime","PlaylistADT","TargetDur","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],Di=["Rate","PlayType","StNPT","StartupTime","PlayerIABR","PlayerIBR","BitRnk","MediaDur","Codecs","LastPause","LastStall","LastMediaEngineStall","RateChangePlayTime","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],Ii=["ErrCode","ErrReason","ErrIsFatal","PlayerErrCount","ErrDomain","PlayType","BitRnk","MediaDur","PlayTime","PlayTimeWC","PlayerIABR","PlayerIBR","LastStall","LastMediaEngineStall","LastLikelyToKeepUp","LastSwitch","LastResume","VideoQltyIndex","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],wi=["MediaDur","BitRnk","Codecs","PlayTime","PlayType","LastLikelyToKeepUp","LastSwitch","LastResume","StallDetectionTime","StallType","BufferLength","LaSwDir","TargetDur","PlayerIABR","PlayerIBR","Rate","OBRLast","OBRMean","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],Ri=["FrBitRnk","ToBitRnk","TimeToBitrate","MediaDur","Rate","PlayType","SwFail","PlayerIBR","PlayerIABR","LastPlayerIBR","LastPlayerIABR","PlayTime","PlayTimeLastSW","BadSw","ReWd","ReHt","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],Ai=["Rate","PlayType","VarAvgBitrate","VarPeakBitrate","VarBitRk","VarSTTime","VarEndTime","VarPlayTime","VarPlayTimeWC","IFR","ODR","ReWd","ReHt","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],ki=["ErrCode","ErrReason","ErrIsFatal","NwErrCount","ErrDomain","PlayTime","PlayTimeWC","LastResume","BitRnk","PlayType","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],Ci="rtcStateInit",Li="rtcStatePause",Pi="rtcStatePlay",Mi="rtcStateStall",xi="rtcStateMediaEngineStall",Oi="rtcStateStop",Ni=[6106,6103,6108,6202,6107,vi],Fi=["aapl","akam","llnw"],Bi={avc1:1,avc3:1,hvc1:{SDR:2,HLG:10,PQ:11},hev1:{SDR:2,HLG:10,PQ:11},vp09:{SDR:3,HLG:14,PQ:13},dvh1:{PQ:12}};function Ui(e,t,i){return void 0===t&&(t=ie),void 0===i&&(i=ie),re((function(){return e()?t:i}))}function $i(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){var i=e[0];if(He(i))return Vi(i,null);if($(i)&&Object.getPrototypeOf(i)===Object.prototype){var r=Object.keys(i);return Vi(r.map((function(e){return i[e]})),r)}}if("function"==typeof e[e.length-1]){var s=e.pop();return Vi(e=1===e.length&&He(e[0])?e[0]:e,null).pipe(ae((function(e){return s.apply(void 0,e)})))}return Vi(e,null)}function Vi(e,t){return new x((function(i){var r=e.length;if(0!==r)for(var s=new Array(r),a=0,n=0,o=function(o){var l=K(e[o]),d=!1;i.add(l.subscribe({next:function(e){d||(d=!0,n++),s[o]=e},error:function(e){return i.error(e)},complete:function(){++a!==r&&d||(n===r&&i.next(t?t.reduce((function(e,t,i){return e[t]=s[i],e}),{}):s),i.complete())}}))},l=0;l<r;l++)o(l);else i.complete()}))}var Gi;!(function(e){e.NONE="NONE",e.GET_REQUEST_INFO="GET_REQUEST_INFO",e.GET_CHALLENGE="GET_CHALLENGE",e.GET_KEY_RESPONSE="GET_KEY_RESPONSE",e.PROCESS_LICENSE="PROCESS_LICENSE"})(Gi||(Gi={}));class Hi{constructor(e,t,i){this.session=e,this.onkeystatuseschange=t,this.onkeymessage=i,this.isClosing$=new te(!1),this.closed$=new te(!1);let r=Ze(this.session);r.listen("keystatuseschange",this.isClosing$.pipe(Ee(e=>!0===e)),this.onkeystatuseschange),r.listen("message",this.closed$.pipe(Ee(e=>!0===e)),this.onkeymessage)}get isClosing(){return this.isClosing$.value}get isClosed(){return this.closed$.value}destroy(){this.isClosing$.next(!0);let e=this.session;return K(e.remove().catch(e=>{Ae.b.error("Could not remove session: "+e.message)()}).then(()=>e.close()).catch(e=>{Ae.b.error("Could not close session: "+e.message)()})).pipe(We(()=>{this.isClosing$.next(!1),this.closed$.next(!0)}),dt(()=>{this.isClosing$.next(!1),this.closed$.next(!0)}))}}class Ki{constructor(e,t=null){this.decryptdata=e,this._requestState$=new te(Gi.NONE),this.destroy$=new Z,this.currentObservable=null,this.session=null,this.oldSessions=[],this.session=t}get requestState(){return this._requestState$.value}get onKeyRequestState$(){return this._requestState$}destroy(){this.destroy$.next()}abort(){this.requestState!==Gi.NONE&&this.error(new Yr("Aborted",this.decryptdata.uri,0,!0,jr.Abort))}setKeyRequestState(e){this.currentObservable&&this.error(new Yr(`Unexpected state transition ${this.requestState}->${e}`,this.decryptdata.uri,0,!0,jr.InvalidState)),this._requestState$.next(e);let t=new mt;return e===Gi.NONE?(t.complete(),this.currentObservable=null):this.currentObservable=t,t}resolveState(e,t){if(this.currentObservable)if(e===this.requestState)if(t instanceof Error)this.error(t);else{let e=this.currentObservable;this.currentObservable=null,e.next(t),e.complete()}else this.error(new Yr(`Unexpected state ${this.requestState} != ${e}`,this.decryptdata.uri,0,!0,jr.InvalidState))}error(e){if(this.currentObservable){let t=this.currentObservable;this.currentObservable=null,t.error(e)}this.setKeyRequestState(Gi.NONE)}}function ji(e){return function(t){return S(t,new Wi(e))}}var Wi=(function(){function e(e){this.value=e}return e.prototype.call=function(e,t){return t.subscribe(new qi(e,this.value))},e})(),qi=(function(e){function t(t,i){var r=e.call(this,t)||this;return r.value=i,r}return n(t,e),t.prototype._next=function(e){this.destination.next(this.value)},t})(w);class zi extends Error{constructor(e,t,i,r){super(e),this.keyuri=t,this.code=i,this.keysystemstring=r,this.name="KeySystemError"}}class Xi{constructor(e,t,i,r){var s;this.hls=e,this.mediaKeys=t,this.systemString=i,this.useSingleKeySession=r,this.destroy$=new Z,this.setCert=!1,this.certificate$=new te(null),this._keyStatusChange$=new Z,this.logger=e.logger,this.shouldDestroyMediaKeys=!1,this.itemId=(null===(s=e.loadingItem)||void 0===s?void 0:s.itemId)||"",this.sessions=[],this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={},this.onkeystatuseschange=this.handleKeyStatusesChange.bind(this),this.onkeymessage=this.handleKeyMessage.bind(this)}get keyStatusChange$(){return this._keyStatusChange$}destroy(){this.isDestroying=!0,this.destroy$.next();for(let e of Object.values(this.keyIdToKeyInfo))this._abortKeyRequest(e);let e=this.sessions.map(e=>e.destroy()),t=Ui(()=>0===e.length,ct,$i(e)).pipe(ji(void 0),dt(()=>{this.mediaKeys=void 0,this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={}}));return Lt.clearKeyUriToKeyIdMap(),t}setServerCertificate(e=null){return this.needsCert?(e&&this.certificate$.next(e),ut(this.certificate$,e=>null!=e).pipe(W(1e4)).pipe(Ie(e=>this.setCert?$e(!0):!this.setCertSubject||this.setCertSubject.isStopped?(this.setCertSubject=new mt,K(this.mediaKeys.setServerCertificate(e)).pipe(We(e=>{let t=void 0===e||e;this.setCert=t,this.setCertSubject.next(t),this.setCertSubject.complete()}),Se(e=>(this.logger.error("Failed setServerCertificate")(),this.setCert=!1,this.setCertSubject.error(e),ct)),Ie(()=>this.setCertSubject))):this.setCertSubject),Se(e=>{throw this.logger.error("[Keys] setServerCertificate err="+e.message)(),e}))):$e(!0)}ensureKeyContext(e){let t=e.uri;this.keyUriToKeyInfo[t]||(this.keyUriToKeyInfo[t]=new Ki(e));let i=this.keyUriToKeyInfo[t];if(i.session)return i;if(this.useSingleKeySession&&this.sessions.length>0)return i.session=this.sessions[0].session,i;let r=this.mediaKeys.createSession();return r?this.sessions.push(new Hi(r,this.onkeystatuseschange,this.onkeymessage)):this.logger.error(this.systemString+" FAIL: could not create MediaKeysSession")(),i.session=r,i}startKeyRequest(e){let t=e.uri,i=this.ensureKeyContext(e);if(!i.session)return Be(()=>new zi("Could not create key session",e.uri,0,this.systemString));let r=pt.b.utf8arrayToStr(e.keyId);return this.keyIdToKeyInfo[r]=i,this.logger.info(`[QE Critical] [Keys] ${this.systemString} startKeyRequest uri=${this.hls.redactUrl(t)} state=${i.requestState}`)(),$i([this.getKeyRequestInfo(i),this.setServerCertificate()]).pipe(ae(e=>e[0]),Ie(e=>(this.hls.eventReporter.notifyKeySessionEvent(di,{keyuri:t,keyFormat:this.systemString}),this.generateLicenseChallenge(i,e).pipe(Se(e=>{throw this.logger.error(`[Keys] ${this.systemString} generateLicenseChallenge Failed ${e.message} uri=${this.hls.redactUrl(t)}`)(),this.hls.eventReporter.notifyKeySessionEvent(mi,{keyuri:t}),e})))),Ie(e=>(this.logger.info(`[QE Critical] [Keys] ${this.systemString} challenge created uri=${this.hls.redactUrl(t)}`)(),this.hls.eventReporter.notifyKeySessionEvent(hi,{keyuri:t,cdmVersion:this.cdmVersion}),this.getKeyRequestResponse(i,e))),Ie(e=>(this.logger.info(`[QE Critical] [Keys] ${this.systemString} onKeyResponseParsed uri=${this.hls.redactUrl(t)}`)(),this.hls.eventReporter.notifyKeySessionEvent(fi,{keyuri:t}),this.handleParsedKeyResponse(i,e).pipe(Se(e=>{throw this.hls.eventReporter.notifyKeySessionEvent(yi,{keyuri:t}),e})))),ae(()=>(this.logger.info(`[QE Critical] [Keys] ${this.systemString} New usable key: keyuri=${this.hls.redactUrl(t)} CDMVersion=${this.cdmVersion}`)(),this.hls.eventReporter.notifyKeySessionEvent(gi,{keyuri:t}),i.setKeyRequestState(Gi.NONE),this.removeSessions(i.decryptdata,!1).subscribe(),e)),Se(e=>{throw this.handleKeyExchangeError(i),e}),dt(()=>{this._abortKeyRequest(i)}))}_abortKeyRequest(e){if(e){let t=e.decryptdata.uri;e.requestState!==Gi.NONE&&(this.logger.warn("[Keys] Aborting key "+this.hls.redactUrl(t))(),this.isDestroying||this.useSingleKeySession||this.removeSessions(e.decryptdata,!0).subscribe(),this.hls&&this.hls.eventReporter&&this.hls.eventReporter.notifyKeySessionEvent(pi,{keyuri:t})),e.abort()}}handleKeyExchangeError(e){}updateItemId(e){this.itemId=e}removeKey(e){return this.removeKeyInternal(e)}removeKeyInternal(e){this.logger.info("[Keys] removing key "+this.hls.redactUrl(e.uri))();let t=this.keyUriToKeyInfo[e.uri];if(t&&t.session){let i=t.session;t.abort(),t.destroy();let r=pt.b.utf8arrayToStr(e.keyId);return this.keyIdToKeyInfo[r]=void 0,this.keyUriToKeyInfo[e.uri]=void 0,this.removeSession(i)}}removeSessions(e,t){let i=this.keyUriToKeyInfo[e.uri];if(i){let r=i.oldSessions.map(e=>this.removeSession(e));return i.oldSessions=[],Ui(()=>0===r.length,ct,$i(r)).pipe(Ie(()=>t?this.removeKeyInternal(e):ct))}return ct}removeSession(e){var t=this.sessions.findIndex(t=>t.session===e);let i=this.sessions[t];return t>-1&&this.sessions.splice(t,1),this.sessionIdToKeyUri[e.sessionId]=void 0,i?i.destroy():ct}getKeyRequestInfo(e){let t=e.decryptdata,i=t.uri,s=e.setKeyRequestState(Gi.GET_REQUEST_INFO);return this.hls.trigger(r.b.KEY_REQUEST_STARTED,{keyuri:i,decryptdata:t,timestamp:Date.now()}),s}setKeyRequestInfo(e,t){let i=this.keyUriToKeyInfo[e];i?i.resolveState(Gi.GET_REQUEST_INFO,t):this.logger.error("Unexpected key requested "+this.hls.redactUrl(e))()}sanitizeRequest(e){return e}generateLicenseChallengeInternal(e,t,i){let r,s=e.decryptdata,a=e.session,n=s.uri,o=s.keyId,l=e.setKeyRequestState(Gi.GET_CHALLENGE);if(a.generateRequestPromise)r=K(a.generateRequestPromise).pipe(Ie(()=>this.generateRequestInitialized(e,"usable"===i)));else{let i=this.generateInitData(o,s,t);a.generateRequestPromise=a.generateRequest(i.initDataType,i.initData),r=K(a.generateRequestPromise).pipe(We(()=>{this.sessionIdToKeyUri[a.sessionId]=n}),Se(t=>{throw this.logger.error(`${this.systemString} FAIL: generateRequest fail keyuri=${this.hls.redactUrl(e.decryptdata.uri)} message=${t.message}`)(),new zi(t.message,e.decryptdata.uri,0,this.systemString)}))}return $i([l,r]).pipe(ae(e=>new Uint8Array(e[0])))}generateLicenseChallenge(e,t){let i,r,s=e.decryptdata,a=e.session,n=s.uri,o=s.keyId;if(this.logger.info(`[QE Critical] [Keys] ${this.systemString} generateLicenseChallenge uri=${this.hls.redactUrl(n)}`)(),t=this.sanitizeRequest(t),e.requestInfo=t,this.itemId=this.hls.inGaplessMode?this.hls.loadingItem.itemId:this.itemId,this.sessionId=this.sessionId||t&&t.sessionId||this.itemId,this.systemString===wt.systemStringPrefix){let e=new Uint8Array(o);_t(e),i=a.keyStatuses.get(e)}else i=a.keyStatuses.get(o);switch(i){case"status-pending":case"usable":case"expired":case void 0:r=this.generateLicenseChallengeInternal(e,t,i);break;default:r=Be(()=>new zi("Bad internal state state="+i,n,0,this.systemString))}return r}setParsedResponse(e,t){this.keyUriToKeyInfo[e].resolveState(Gi.GET_KEY_RESPONSE,t)}handleKeyStatusesChange(e){e.target.keyStatuses.forEach((e,t)=>{let i=new Uint8Array(t);this.systemString===wt.systemStringPrefix&&_t(i);let r=pt.b.utf8arrayToStr(i),s=this.keyIdToKeyInfo[r];this.handleKeyStatusForKey(e,s)})}handleKeyStatusForKey(e,t){if(!t)return;let i=t.decryptdata.uri;switch(e){case"internal-error":this.logger.error(`[Keys] ${this.systemString} internal-error for keyuri=${this.hls.redactUrl(i)}`)(),this._signalError(t,new Yr("Got internal error from key system",i,0,!1,jr.InternalError));break;case"usable":t.requestState===Gi.PROCESS_LICENSE&&t.resolveState(Gi.PROCESS_LICENSE,void 0);break;case"output-restricted":this.logger.error(`[Keys] ${this.systemString} output-restricted for keyuri=${this.hls.redactUrl(i)}`)(),t.session&&this.removeSession(t.session).pipe(Xe(this.destroy$)).subscribe(),this._signalError(t,new Yr("output-restricted",i,0,!1,jr.OutputRestricted));break;default:this.logger.info(`[Keys] key status uri=${this.hls.redactUrl(i)} ${e}`)()}}_signalRenewal(e){this._keyStatusChange$.next({decryptdata:e.decryptdata,status:"needs-renewal"})}_signalError(e,t){this._keyStatusChange$.next({decryptdata:e.decryptdata,status:"error",error:t}),e.error(t)}}const Qi=["clearkey","fairplaystreaming","playready","widevine"],Yi={initDataTypes:["keyids","cenc"]};function Ji(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){if(!He(e[0]))return K(e[0]);e=e[0]}return S(Ue(e,void 0),new Zi)}var Zi=(function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new er(e))},e})(),er=(function(e){function t(t){var i=e.call(this,t)||this;return i.hasFirst=!1,i.observables=[],i.subscriptions=[],i}return n(t,e),t.prototype._next=function(e){this.observables.push(e)},t.prototype._complete=function(){var e=this.observables,t=e.length;if(0===t)this.destination.complete();else{for(var i=0;i<t&&!this.hasFirst;i++){var r=ue(e[i],new de(this,null,i));this.subscriptions&&this.subscriptions.push(r),this.add(r)}this.observables=null}},t.prototype.notifyNext=function(e,t,i){if(!this.hasFirst){this.hasFirst=!0;for(var r=0;r<this.subscriptions.length;r++)if(r!==i){var s=this.subscriptions[r];s.unsubscribe(),this.remove(s)}this.subscriptions=null}this.destination.next(t)},t.prototype.notifyComplete=function(t){this.hasFirst=!0,e.prototype.notifyComplete.call(this,t)},t.prototype.notifyError=function(t){this.hasFirst=!0,e.prototype.notifyError.call(this,t)},t})(ce);const tr={initDataTypes:["cenc"]},ir=new Uint8Array([148,206,134,251,7,255,79,67,173,184,147,210,250,150,140,162]);var rr;!(function(e){e[e.CENC=1667591779]="CENC",e[e.CBCS=1667392371]="CBCS"})(rr||(rr={}));class sr extends Xi{constructor(e,t,i,r){super(e,t,i,r),this._hasSetRenewal=!1}static get systemId(){return ir}static get requestAccessConfig(){return tr}get needsCert(){return!0}sanitizeRequest(e){return{assetId:e&&e.assetId?new Uint8Array(e.assetId):void 0,ssc:e&&e.ssc?new Uint8Array(e.ssc):void 0,sessionId:e&&e.sessionId?e.sessionId:void 0}}handleParsedKeyResponse(e,t){let i=e.decryptdata.uri,r=t.statusCode,s=t.ckc&&0!==t.ckc.byteLength?t.ckc:t.license&&0!==t.license.byteLength?t.license:void 0;if(0===r&&!s)return Be(()=>new Yr("License request resulted in HTTP Error",i,t.statusCode,!0,jr.HttpError));if(0!==r)return Be(()=>new Yr("License server responded with error",i,t.statusCode,!1,jr.LicenseServerError));if(!s)return Be(()=>new Yr("License server responded with invalid license",i,t.statusCode,!1,jr.LicenseServerError));let a=t.renewalDate,n=new Date,o=a>n?a.getTime()-n.getTime():0;if(o>0){let t=!1;this.useSingleKeySession?this._hasSetRenewal||(this._hasSetRenewal=!0,t=!0,X(o).pipe(We(()=>{let e=Object.values(this.keyUriToKeyInfo)[0];this._signalRenewal(e)}),dt(()=>{this._hasSetRenewal=!1}),Xe(this.destroy$)).subscribe()):(t=!0,X(o).pipe(We(()=>this._signalRenewal(e)),Xe(Ji(this.destroy$,e.destroy$,ut(e.onKeyRequestState$,e=>e===Gi.GET_REQUEST_INFO)))).subscribe()),t&&this.logger.info(`[Keys] ${this.systemString} Scheduling renewal in ${o} ms`)()}let l=this.makeProcessLicenseRequestMessage(e,s,o),d=e.session,h=K(d.update(l)).pipe(We(()=>{let t=e.decryptdata.keyId,i=d.keyStatuses.get(t);this.handleKeyStatusForKey(i,e)}),Se(t=>{let i=new zi(t.message,e.decryptdata.uri,0,this.systemString);throw e.error(i),i}));return $i([e.setKeyRequestState(Gi.PROCESS_LICENSE),h]).pipe(ji(void 0))}makeKeyRequests(e){let t=[];for(let i of e){let e=i.decryptdata,r=i.requestInfo,s=e.keyId;t.push({keyId:s,assetId:r?r.assetId:void 0,ssc:r?r.ssc:void 0,versionList:e.formatversions})}return t}getSchemeAndFlags(e){let t="ISO-23001-7"===e.method?rr.CENC:rr.CBCS,i=0;return this.hls.playingItem.secureStop&&(i|=1),{scheme:t,flags:i}}generateInitData(e,t,i){let{scheme:r,flags:s}=this.getSchemeAndFlags(t),a=this.makeKeyRequests([{decryptdata:t,requestInfo:i}]);return{initData:this.makeFpsKeySystemInitData(r,s,a),initDataType:"cenc"}}generateRequestInitialized(e,t){let i=this.makeKeyRequestMessage(e,t);return i?K(e.session.update(i)).pipe(We(()=>{e.requestInfo=void 0}),Se(t=>{throw this.logger.error(`[Keys] ${this.systemString} FAIL: generateRequestInitialized keyuri=${this.hls.redactUrl(e.decryptdata.uri)} message=${t.message}`)(),new zi(t.message,e.decryptdata.uri,0,this.systemString)})):Be(()=>new Yr("Unable to generate request using existing keySession",e.decryptdata.uri,0,!0,jr.InvalidState))}getKeyRequestResponse(e,t){let i=e.decryptdata.uri,s=e.setKeyRequestState(Gi.GET_KEY_RESPONSE);return this.hls.trigger(r.b.LICENSE_CHALLENGE_CREATED,{keyuri:i,licenseChallenge:t,keysystem:this.systemString}),s}resolveSPCPromise(e,t){e.resolveState(Gi.GET_CHALLENGE,t)}}var ar=i(4);const nr={SessionId:"AirPlayPlaybackSessionID",APIProvider:"APIProviderID",MovieID:"PlaybackSessionID",SecureStopSPC:"SecureStopSPC",SessionLifespanSPC:"SessionLifespanSPC"},or=1668442994,lr=1667982195,dr=1667592820,hr=1936745331,cr=1919837559,ur=1919710053,fr=1936946288,gr=1667525993,pr="EC396D13-FB13-4993-9D0D-71518ACF3D6F",mr="F19BF03B-7470-41A4-9655-86D078307D59";function yr(e,t,i){if(i+4>e.byteLength)return;let r=t.getUint32(i);if((i+=4)+r>e.byteLength)return;let s=e.slice(i,i+r);return{pos:i+=r,data:s}}function vr(e){let t={},i=new DataView(e.buffer),r=4;var s=i.getUint32(r);r+=4;for(let a=0;a<s&&r<e.byteLength&&!(r+16>e.byteLength);++a){let s=e.slice(r,r+16);if((r+=16)+4>e.byteLength)break;let a=yr(e,i,r);if(!a)break;r=a.pos,t[pt.b.utf8arrayToStr(s)]=a.data}return t}function br(e,t,i,r){let s=r?r.byteLength:0;return t.setUint32(i,s),s&&e.set(r,i+4),i+(4+s)}function Sr(e){let t=4;for(let i of e)t+=28+(i.assetId?i.assetId.byteLength:0)+(i.ssc?i.ssc.byteLength:0)+(i.versionList?4*i.versionList.length:0);return t}function Tr(e,t,i,r){t.setUint32(i,r.length),i+=4;for(let s of r)if(e.set(s.keyId,i),i=br(e,t,i=br(e,t,i+=16,s.assetId),s.ssc),t.setUint32(i,s.versionList?s.versionList.length:0),i+=4,s.versionList)for(let e of s.versionList)t.setUint32(i,e),i+=4;return i}class Er extends sr{constructor(e,t,i){super(e,t,i,void 0===e.config.useMultipleKeySessions||!e.config.useMultipleKeySessions)}makeProcessLicenseRequestMessage(e,t,i){let r=new Uint8Array(t);return (function(e){let t=0;for(let i of e)t+=24+i.ckc.byteLength;let i=0,r=new Uint8Array(8+t),s=new DataView(r.buffer);s.setUint32(0,lr),s.setUint32(4,e.length),i+=8;for(let t of e)r.set(t.keyId,i),i+=16,s.setUint32(i,t.expirySec),i=br(r,s,i+=4,t.ckc);return r})([{keyId:e.decryptdata.keyId,expirySec:i/1e3,ckc:r}])}makeFpsKeySystemInitData(e,t,i){let r=(function(e,t,i,r){let s=Sr(r),a=0,n=new Uint8Array(8+s),o=new DataView(n.buffer);return o.setUint32(a,e),o.setUint32(a+4,1<<24|16777215&i),a=Tr(n,o,a+=8,r),n})(e,0,t,i);return ar.a.pssh(Er.systemId,[],r)}makeKeyRequestMessage(e){return (function(e){let t=Sr(e),i=0,r=new Uint8Array(4+t),s=new DataView(r.buffer);return s.setUint32(0,or),i=Tr(r,s,i+=4,e),r})([{keyId:e.decryptdata.keyId,assetId:e.requestInfo?e.requestInfo.assetId:void 0,ssc:e.requestInfo?e.requestInfo.ssc:void 0,versionList:e.decryptdata.formatversions}])}handleKeyMessage(e){if(e.message.byteLength<4)return void this.logger.error("Unexpected message")();let t=new Uint8Array(e.message),i=new DataView(e.message),r=i.getUint32(0);if(this.isDestroying&&r!==ur)this.logger.warn("In the middle of destroying, ignore command: "+r.toString(16))();else switch(r){case dr:this.logger.warn("Certificate not set!")();break;case cr:{let e=vr(t);for(let t in e)if(e.hasOwnProperty(t)){let e=this.keyIdToKeyInfo[t];this._signalRenewal(e)}break}case hr:{let e=vr(t);for(let t in e)if(e.hasOwnProperty(t)){let i=this.keyIdToKeyInfo[t],r=e[t];this.resolveSPCPromise(i,r)}break}case ur:this._handleLicenseRelease(t);break;case gr:{let e=yr(t,i,4);if(e){let t=this.cdmVersion=pt.b.utf8arrayToStr(e.data);this.logger.info(`[Keys] ${this.systemString} CDM Version :  ${t}`)()}break}}}_handleLicenseRelease(e){let t={},i=new DataView(e.buffer);switch(i.getUint32(4)){case fr:{if(!nr){this.logger.error("No secure stop keys defined")();break}t[nr.SessionId]=this.sessionId;let r=8;if(r+4>e.byteLength)break;t[nr.APIProvider]=i.getUint32(r)===rr.CENC?pr:mr;let s=yr(e,i,r+=4);if(!s)break;if(r=s.pos,t[nr.MovieID]=pt.b.utf8arrayToStr(s.data),!(s=yr(e,i,r)))break;if(r=s.pos,t[nr.SecureStopSPC]=s.data,!(s=yr(e,i,r)))break;r=s.pos,t[nr.SessionLifespanSPC]=s.data;break}}this.hls.trigger(r.b.LICENSE_RELEASED,{keysystem:this.systemString,itemId:this.itemId,releaseRecord:t})}}var _r=Er;const Dr={fpsd:pt.b.strToUtf8array("fpsd"),fpsi:pt.b.strToUtf8array("fpsi"),fpsk:pt.b.strToUtf8array("fpsk"),fkri:pt.b.strToUtf8array("fkri"),fkai:pt.b.strToUtf8array("fkai"),fkcx:pt.b.strToUtf8array("fkcx"),fkvl:pt.b.strToUtf8array("fkvl")};function Ir(e,t,i,r){let s=[Dr.fpsk],a=ar.a.box(Dr.fkri,new Uint8Array([0,0,0,0]),e);if(s.push(a),t&&t.byteLength&&s.push(ar.a.box(Dr.fkai,t)),i&&i.byteLength&&s.push(ar.a.box(Dr.fkcx,i)),r&&r.length){let e=new Uint8Array(4*r.length),t=0;for(let i of r)ar.a.set32(i,e,t),t+=4;s.push(ar.a.box(Dr.fkvl,e))}return ar.a.box.apply(null,s)}var wr={id:"fairplaystreaming",systemStringPrefix:"com.apple.fps",keyFormatString:"com.apple.streamingkeydelivery",securityLevels:{AppleBaseline:0,AppleMain:1,Main:1,Baseline:0}},Rr={initDataTypes:["cenc"]};const Ar=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);class kr extends Xi{constructor(e,t,i){super(e,t,i,!1),this.hls=e,this.shouldDestroyMediaKeys=!0}static get systemId(){return Ar}static get requestAccessConfig(){return Rr}get needsCert(){return!1}generateInitData(e,t){let i=t.pssh;return{initData:ar.a.pssh(kr.systemId,[],i),initDataType:"cenc"}}removeKey(e){return super.removeSessions(e,!0)}ensureKeyContext(e){let t=e.uri,i=this.keyUriToKeyInfo[t];return(null==i?void 0:i.session)&&(i.oldSessions.push(i.session),i.session=null),super.ensureKeyContext(e)}getKeyRequestResponse(e,t){let i=e.decryptdata.uri,s=e.setKeyRequestState(Gi.GET_KEY_RESPONSE);return this.hls.trigger(r.b.LICENSE_CHALLENGE_CREATED,{keyuri:i,licenseChallenge:t,keysystem:this.systemString,keyId:e.decryptdata.keyId}),s}generateRequestInitialized(e){e.decryptdata.uri;let t=e.licenseChallenge;return e.requestInfo=void 0,e.resolveState(Gi.GET_CHALLENGE,t),ct}handleParsedKeyResponse(e,t){let i=e.decryptdata.uri;if(0!==t.statusCode)return Be(()=>new Yr("License server responded with error",i,t.statusCode,!1,jr.LicenseServerError));if(!t.license||!t.license.byteLength)return Be(()=>new Yr("License server responded with invalid license",i,t.statusCode,!1,jr.LicenseServerError));if(t.renewalDate){let i=t.renewalDate,r=new Date,s=i>r?i.getTime()-r.getTime():0;s>0&&X(s).pipe(We(()=>{this._signalRenewal(e)}),Xe(Ji(e.destroy$,this.destroy$))).subscribe()}return $i([e.setKeyRequestState(Gi.PROCESS_LICENSE),K(e.session.update(t.license)).pipe(We(()=>{e.resolveState(Gi.PROCESS_LICENSE,void 0)}),Se(t=>{this.logger.error(`${this.systemString} FAIL: Failed to update with key response message=${t.message}`)();let i=new zi(t.message,e.decryptdata.uri,0,this.systemString);throw e.error(i),i}))]).pipe(ji(void 0))}handleKeyMessage(e){if(this.isDestroying)return void this.logger.warn("In the middle of destroying, ignore key message")();var t=new DOMParser;let i="utf16"===this.hls.config.playReadyMessageFormat?new Uint16Array(e.message.buffer||e.message):new Uint8Array(e.message.buffer||e.message),r=String.fromCharCode.apply(null,i),s=t.parseFromString(r,"application/xml").getElementsByTagName("PlayReadyKeyMessage")[0];if(!s||"LicenseAcquisition"!==s.getAttribute("type"))return void this.logger.warn(this.systemString+" unrecognized message ignore it")();let a=t.parseFromString(r,"application/xml").getElementsByTagName("Challenge")[0];if(!a||"base64encoded"!==a.getAttribute("encoding")||0===a.childNodes.length)return void this.logger.error(this.systemString+" wrong challenge format or empty challenge")();let n=vt.a.base64Decode(a.childNodes[0].nodeValue),o=pt.b.utf8arrayToStr(n),l=t.parseFromString(o,"application/xml").getElementsByTagName("KID")[0];var d;d=l.childNodes[0]?l.childNodes[0].nodeValue:l.getAttribute("VALUE");let h=vt.a.base64Decode(d).subarray(0,16);_t(h);let c=this.keyIdToKeyInfo[pt.b.utf8arrayToStr(h)];c.decryptdata.uri,c.licenseChallenge=n,c.resolveState(Gi.GET_CHALLENGE,n)}}var Cr=kr;const Lr={initDataTypes:["cenc","keyids"]},Pr=new Uint8Array([237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237]),Mr={clearkey:{id:"clearkey",systemStringPrefix:"org.w3.clearkey",keyFormatString:"org.w3.clearkey",securityLevels:{NONE:0}},fairplaystreaming:wr,playready:wt,widevine:Rt},xr={clearkey:[["org.w3.clearkey",class extends Xi{constructor(e,t,i){super(e,t,i,!1)}static get requestAccessConfig(){return Yi}get needsCert(){return!1}getKeyRequestResponse(e,t){let i=e.decryptdata.uri;return Jr.fetchKeyHTTP(this.hls,i,e.decryptdata,this.hls.config.keyLoadingDefaultTimeout).pipe(ae(e=>({response:this.parseResponse(t,e.decryptdata.key)})))}parseResponse(e,t){var i={kty:"oct",kid:vt.a.base64UrlEncode(e),k:vt.a.base64UrlEncode(t)};return pt.b.strToUtf8array(JSON.stringify({keys:[i]}))}handleParsedKeyResponse(e,t){let i=t.response;return $i([e.setKeyRequestState(Gi.PROCESS_LICENSE),K(e.session.update(i)).pipe(We(()=>{let t=e.decryptdata.keyId,i=e.session.keyStatuses.get(t);this.handleKeyStatusForKey(i,e)}),Se(t=>{this.logger.error(`${this.systemString} FAIL: Failed to update with key response message=${t.message}`)();let i=new zi(t.message,e.decryptdata.uri,t.code,this.systemString);throw e.error(i),i}))]).pipe(ji(void 0))}generateInitData(e){return{initData:It([e]),initDataType:"keyids"}}generateRequestInitialized(){return ct}sanitizeRequest(e){return e}handleKeyMessage(e){if(this.isDestroying)return void this.logger.warn("In the middle of destroying, ignore key message")();if("license-request"!==e.messageType)return;let t=new Uint8Array(e.message),i=JSON.parse(pt.b.utf8arrayToStr(t).trim());if(1!==i.kids.length)return;let r=vt.a.base64Decode(i.kids[0]),s=pt.b.utf8arrayToStr(r),a=this.keyIdToKeyInfo[s];a&&a.resolveState(Gi.GET_CHALLENGE,r)}}]],fairplaystreaming:[["com.apple.fps.3_0",class extends sr{constructor(e,t,i){super(e,t,i,!1),this.sessions=[],this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={}}static get needsCert(){return!0}handleKeyExchangeError(e){this.removeKey(e.decryptdata).subscribe()}makeFpsKeySystemInitData(e,t,i){return (function(e,t,i){let r=[Dr.fpsd,(function(e,t){let i=new Uint8Array(4);return ar.a.set32(e,i,0),ar.a.box(Dr.fpsi,new Uint8Array([0,t>>16&255,t>>8&255,255&t]),i)})(e,t)];for(let e of i)r.push(Ir(e.keyId,e.assetId,e.ssc,e.versionList));let s=ar.a.box.apply(null,r);return ar.a.pssh(sr.systemId,null,s)})(e,t,i)}makeKeyRequestMessage(e,t){if(t)return pt.b.strToUtf8array("renew")}makeProcessLicenseRequestMessage(e,t,i){let r=JSON.stringify([{keyID:vt.a.base64Encode(e.decryptdata.keyId),payload:vt.a.base64Encode(new Uint8Array(t))}]);return pt.b.strToUtf8array(r)}handleKeyMessage(e){let t,i=e.target,r=i.sessionId,s=e.messageType,a=this.sessionIdToKeyUri[r];if(a)t=this.keyUriToKeyInfo[a];else for(let e of Object.values(this.keyUriToKeyInfo))e&&e.session===i&&(t=e);if(t)switch(s){case"license-request":{let i=new Uint8Array(e.message),r=pt.b.utf8arrayToStr(i);try{JSON.parse(r).forEach(e=>{let t,i=vt.a.base64DecodeToStr(e.keyID),r=vt.a.base64Decode(e.payload);t=this.keyIdToKeyInfo[i],this.resolveSPCPromise(t,r)})}catch(e){this.logger.warn("[Keys] got unexpected license-request format")(),this.resolveSPCPromise(t,i)}break}case"license-renewal":{let i=new Uint8Array(e.message);this.resolveSPCPromise(t,i);break}case"license-release":this._handleLicenseRelease(i);break;default:this.logger.error("[Keys] Unexpected messageType "+s)()}else this.logger.warn("[Keys] No key associated with session")()}_handleLicenseRelease(e){e.update(pt.b.strToUtf8array("acknowledged")).catch(e=>{this.logger.error("Promise error: "+e.message)()})}}],["com.apple.fps",_r]],playready:[["com.microsoft.playready.recommendation",Cr]],widevine:[["com.widevine.alpha",class extends Xi{constructor(e,t,i){super(e,t,i,!1),this.hls=e,this.shouldDestroyMediaKeys=!0}static get systemId(){return Pr}static get requestAccessConfig(){return Lr}get needsCert(){return!0}removeKey(e){return super.removeSessions(e,!0)}ensureKeyContext(e){let t=e.uri,i=this.keyUriToKeyInfo[t];return(null==i?void 0:i.session)&&(i.oldSessions.push(i.session),i.session=null),super.ensureKeyContext(e)}getKeyRequestResponse(e,t){let i=e.decryptdata.uri,s=e.setKeyRequestState(Gi.GET_KEY_RESPONSE);return this.hls.trigger(r.b.LICENSE_CHALLENGE_CREATED,{keyuri:i,licenseChallenge:t,keysystem:this.systemString,keyId:e.decryptdata.keyId}),s}handleParsedKeyResponse(e,t){e.licenseChallenge=void 0;let i=e.decryptdata.uri;if(0!==t.statusCode)return Be(()=>new Yr("License server responded with error",i,t.statusCode,!1,jr.LicenseServerError));if(!t.license||!t.license.byteLength)return Be(()=>new Yr("License server responded with invalid license",i,t.statusCode,!1,jr.LicenseServerError));if(t.renewalDate){let i=t.renewalDate,r=new Date,s=i>r?i.getTime()-r.getTime():0;s>0&&X(s).pipe(We(()=>{this._signalRenewal(e)}),Xe(Ji(e.destroy$,this.destroy$))).subscribe()}return $i([e.setKeyRequestState(Gi.PROCESS_LICENSE),K(e.session.update(t.license)).pipe(We(()=>{let t=e.decryptdata.keyId,i=e.session.keyStatuses.get(t);this.handleKeyStatusForKey(i,e)}),Se(t=>{this.logger.error(`${this.systemString} FAIL: Failed to update with key response code=${t.code} message=${t.message}`)();let i=new zi(t.message,e.decryptdata.uri,t.code,this.systemString);throw e.error(i),i}))]).pipe(ji(void 0))}generateInitData(e,t){return{initData:t.pssh,initDataType:"cenc"}}generateRequestInitialized(e){e.decryptdata.uri;let t=e.licenseChallenge;return e.requestInfo=void 0,e.resolveState(Gi.GET_CHALLENGE,t),ct}handleKeyMessage(e){if(this.isDestroying)return void this.logger.warn("In the middle of destroying, ignore key message")();let t=e.target,i=null,r=null;if(t.sessionId in this.sessionIdToKeyUri)i=this.sessionIdToKeyUri[t.sessionId],r=this.keyUriToKeyInfo[i];else for(let[e,s]of Object.entries(this.keyUriToKeyInfo))if(s.session===t){i=e,r=s;break}if(r)switch(e.messageType){case"license-request":{let t=new Uint8Array(e.message);r.resolveState(Gi.GET_CHALLENGE,t);break}}else this.logger.error(this.systemString+" empty keyuri and keyInfo")()}}]]},Or=wr.id;class Nr{static createMediaKeys(e,t,i,r,s){let a=Nr.idToMediaKeysInfoMap[e];if(!a){Ae.b.info(`[Keys] ${e} requesting key system access`)();let n=Et(t,i,s),o=new mt;Nr.requestKeySystemAccess(e,n,r).pipe(Ie((function(t){return Nr.idToMediaKeysInfoMap[e].keySystemAccess=t,Ae.b.info(`[Keys] ${e} creating CDM`)(),K(t.createMediaKeys())})),We(t=>{Ae.b.info(`[Keys] ${e} created CDM`)(),o.next(t),o.complete()}),Se(t=>(Ae.b.error(`[Keys] FAIL: could not initialize ${e} key system: ${t.message}`)(),o.error(new zi("could not initialize key system: "+t.message,void 0,0,e)),ie)),Xe(Nr.destroy$)).subscribe(),a=Nr.idToMediaKeysInfoMap[e]={mediaKeys$:o,keySystemAccess:null}}return a.mediaKeys$}static destroyMediaKeys(){Nr.destroy$.next(),Nr.idToMediaKeysInfoMap={}}static getKeySystemIdForDecryptData(e){let t;if(e){t=Or;let i=e.format;for(let e of Qi){let r=Mr[e];if((null==r?void 0:r.keyFormatString)===i){t=e;break}}}if(!t)throw Error("No matching key system");return t}static requestKeySystemAccess(e,t,i){if("undefined"==typeof navigator||void 0===navigator.requestMediaKeySystemAccess)return Be(()=>new zi("navigator undefined",void 0,0,e));let r=xr[e],s=Be(()=>new zi("no key systems to try",void 0,0,e));for(let e of r){let r=e[0],n=e[1],o=(a=i)&&"object"==typeof a?i:n.requestAccessConfig,l=[Object.assign({},o,t)];s=s.pipe(Se(()=>Nr.requestKeySystemInternal(r,l)))}var a;return s}static requestKeySystemInternal(e,t){return re(()=>K(navigator.requestMediaKeySystemAccess(e,t)))}static make(e,t,i){var r;let s,a=null===(r=Nr.idToMediaKeysInfoMap[e])||void 0===r?void 0:r.keySystemAccess;if(!a)throw new zi("No keySystemAccess for "+e,void 0,0,e);let n=Mr[e].systemStringPrefix;for(let t of xr[e])if(t[0]===a.keySystem){s=t[1];break}if(!s)throw new zi("No constructor associated with "+e,void 0,0,n);return new s(t,i,n)}static get availableKeySystems(){return Object.keys(Mr)}static getKeySystemFormat(e){let t=Mr[e];return t?t.keyFormatString:""}static getKeySystemSecurityLevel(e){let t=Mr[e];return t?t.securityLevels:void 0}}function Fr(){return function(e){return S(e,new Br)}}Nr.idToMediaKeysInfoMap={},Nr.destroy$=new Z;var Br=(function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Ur(e))},e})(),Ur=(function(e){function t(t){var i=e.call(this,t)||this;return i.hasPrev=!1,i}return n(t,e),t.prototype._next=function(e){var t;this.hasPrev?t=[this.prev,e]:this.hasPrev=!0,this.prev=e,t&&this.destination.next(t)},t})(w);function $r(e,t){return"function"==typeof t?fe(e,t,1):fe(e,1)}const Vr=["avc1.42E01E"],Gr=["mp4a.40.2"];class Hr extends x{constructor(e,t){super(),this.hls=e,this.keyLoader=t,this.reset$=new Z,this.media$=new te(null),this.keyStatusChange$=new Z,this.logger=e.logger,this.protectionData={},this.keySystem=null,this.keySystemId=null}static warmupCDM(){return Nr.createMediaKeys(wr.id,Vr,Gr,void 0,void 0)}_subscribe(e){const t=Ze(this.hls,this);return e.add(Ge(t.event(r.b.MANIFEST_LOADING,this.onManifestLoading),t.event(r.b.MEDIA_ATTACHING,this.onMediaAttaching),t.event(r.b.MEDIA_DETACHING,this.onMediaDetaching)).subscribe()),!0===this.hls.config.warmupCdms&&e.add(Hr.warmupCDM().pipe(Se(e=>(this.handleKeySystemError(e),ie))).subscribe()),e.add(this.media$.pipe(Fr(),Ie(([e,t])=>{let i=this._mediaDetachAsync(e);return t&&(i=i.pipe(Ie(()=>this._mediaAttachAsync(t)))),i.pipe(Se(e=>(this.logger.warn("[Keys] onMediaAttach err:"+e.message)(),this.handleKeySystemError(e),ie)),Xe(this.reset$))})).subscribe()),e.add(()=>{let e=this.destroy();this.hls.destroyWG&&this.hls.destroyWG.do(e)}),super._subscribe(e)}destroy(){return this.resetKeySystem().pipe(Ie(()=>this._mediaDetachAsync(this.media$.value)))}resetKeySystem(){this.reset$.next(),this.keySystemId=null;let e=this.keySystem;return e?(this.keySystem=null,e.shouldDestroyMediaKeys&&Nr.destroyMediaKeys(),e.destroy()):ct}onManifestLoading(){this.hls.isPreloadingItem?this.logger.info("[gapless] don't reset in onManifestLoading")():this.resetKeySystem().subscribe()}onMediaAttaching(e){let t=e.media;this.media$.next(t)}onMediaDetaching(){this.media$.next(null)}_mediaAttachAsync(e){var t;if(this.keySystem)return ct;if(!0===(null===(t=this.hls.platformInfo)||void 0===t?void 0:t.requiresCDMAttachOnStart)){let e=this.hls.config.keySystemPreference?Nr.getKeySystemFormat(this.hls.config.keySystemPreference):wr.keyFormatString;return this.makeKeySystem(new Lt("NONE",null,null,e,[1])).pipe(ji(void 0))}return ct}_mediaDetachAsync(e){return e?this.hls.config.clearMediaKeysOnPromise?this.setMediaKeys(e,null):(this.logger.warn("[Keys] detaching MediaKeys without waiting")(),Ge(K(e.setMediaKeys(null)),ct)):ct}setMediaKeys(e,t){return e._isUpdating$||(e._isUpdating$=new te(!1)),e._isUpdating$.pipe(Ee(e=>!1===e),$r(()=>{if(!0===e._isUpdating$.value)return ie;if(e.mediaKeys===t)return ct;try{return e._isUpdating$.next(!0),K(e.setMediaKeys(t).then(()=>{e._isUpdating$.next(!1)}).catch(t=>{throw e._isUpdating$.next(!1),t}))}catch(t){throw e._isUpdating$.next(!1),t}}),ye(1),We(()=>{}),se(e=>e.pipe(fe((e,i)=>{if(this.logger.warn(`[Keys] setMediaKeys(${t} fail ${e.message})`)(),i<3)return X(100*i);throw e}))),ot())}ensureKeySystem(e){return re(()=>{if(!this.keySystem&&this.keySystemId){this.keySystem=Nr.make(this.keySystemId,this.hls,e),this.keySystem.keyStatusChange$.pipe(We(e=>{this.keyStatusChange$.next(e)}),Xe(this.reset$)).subscribe();let t=this.protectionData&&this.protectionData[this.keySystemId];if(t)return this.keySystem.setServerCertificate(t.certificate).pipe(ji(this.keySystem))}return $e(this.keySystem)})}makeKeySystem(e){return $i([this.media$.pipe(Ee(e=>null!=e),ye(1)),this.ensureMediaKeys(e)]).pipe(Ie(([e,t])=>this.setMediaKeys(e,t).pipe(Ie(()=>this.ensureKeySystem(t)))))}ensureMediaKeys(e){let t=Nr.getKeySystemIdForDecryptData(e);if(null==this.keySystemId)this.keySystemId=t;else if(this.keySystemId!==t)return Be(new Yr(`New key system string does not match existing ${t} !== ${this.keySystemId}`,e.uri,0,!1,jr.InternalError));return Nr.createMediaKeys(this.keySystemId,Vr,Gr,this.hls.platformInfo.keySystemConfig,this.hls.platformInfo.robustnessLevel)}requestKey(e){return this.makeKeySystem(e).pipe(Ie(t=>t.startKeyRequest(e)))}updateItemId(e){this.keySystem.updateItemId(e)}removeKey(e){return this.keySystem.removeKey(e)}onServerCertificateLoaded(e){let t=e.keysystem,i=e.certificate;return this.protectionData[t].certificate=i,this.keySystem&&this.keySystemId===t?this.keySystem.setServerCertificate(i).pipe(ji(void 0)):ct}get availableKeySystems(){return Nr.availableKeySystems}initialize(e){this.protectionData,this.protectionData={};for(let t of Nr.availableKeySystems){if(this.hls.config.keySystemPreference!==t){this.logger.warn(`[Keys] Key system ${t} is does not match preference ${this.hls.config.keySystemPreference}`)();continue}let i=e[t];if(!i)break;let a,n=i.certificate,o=i.serverCertUrl;this.protectionData[t]={licenseServerUrl:i.licenseServerUrl,serverCertUrl:o,certificate:n},n?a=$e({keysystem:t,certificate:n}):o&&(a=this.keyLoader.loadCertificate(o,t)),a&&a.pipe(Ie(e=>this.onServerCertificateLoaded(e)),Se(e=>{throw this.logger.error("[Keys] Error handling cert: "+e.message)(),this.hls.trigger(r.b.INTERNAL_ERROR,{type:s.g.NETWORK_ERROR,details:s.d.CERT_LOAD_ERROR,fatal:!1,url:o}),e}),Xe(this.reset$)).subscribe()}}generateRequest(e,t){this.keySystem&&this.keySystem.setKeyRequestInfo(e,t)}setLicenseResponse(e,t){this.keySystem&&this.keySystem.setParsedResponse(e,t)}handleKeySystemError(e){let t=new s.q(s.g.KEY_SYSTEM_ERROR,s.d.KEY_SYSTEM_GENERIC_ERROR,!0,e.message,void 0,void 0,void 0,void 0,void 0);this.hls.upgradeInternalErrorIfNecessary(t)}}var Kr,jr,Wr,qr,zr,Xr=Hr;!(function(e){e.MustRequestResponse="MustRequestResponse",e.WaitingForKeyResponse="WaitingForKeyResponse",e.GotKeyResponse="GotKeyResponse"})(Kr||(Kr={}));class Qr extends Error{constructor(e,t){super(e),this.message=e,this.keyuri=t,this.name="KeyRequestTimeoutError",this.keyuri=t}}!(function(e){e[e.InvalidState=0]="InvalidState",e[e.Abort=1]="Abort",e[e.OutputRestricted=2]="OutputRestricted",e[e.AlreadyFailedKey=3]="AlreadyFailedKey",e[e.HttpError=4]="HttpError",e[e.InternalError=5]="InternalError",e[e.LicenseServerError=6]="LicenseServerError",e[e.InsufficientCPC=7]="InsufficientCPC"})(jr||(jr={}));class Yr extends Error{constructor(e,t,i,r,s){super(e),this.message=e,this.keyuri=t,this.statusCode=i,this.isOkToRetry=r,this.keyErrorReason=s,this.name="KeyRequestError"}}class Jr{constructor(e){this.hls=e,this.reset$=new Z,this.destroy$=new Z,this.hls=e,this.logger=e.logger,this.keyUriToKeyInfo={},this.numberOfConsecutiveKeyErrors=0,this.activeDecryptData=[],this.pendingDecryptData=[],this.resetFn=this.reset.bind(this),this.hls.on(r.b.MEDIA_DETACHING,this.resetFn),this.isKeyCleanupSupported()&&(this.setupFn=this.setupListeners.bind(this),this.hls.on(r.b.MEDIA_ATTACHING,this.setupFn)),this.keySystemController=new Xr(e,this),this.keySystemController.pipe(Xe(this.destroy$)).subscribe(),this.keySystemController.keyStatusChange$.pipe(fe(e=>"needs-renewal"===e.status?this.getKeyFromDecryptData(e.decryptdata,void 0,!0).pipe(Se(t=>(this._triggerKeyError(e.decryptdata.uri,t),ie))):("error"===e.status&&this._triggerKeyError(e.decryptdata.uri,e.error),ie)),Se(e=>(this.logger.error("[Keys] keyStatusChange err:"+e.message)(),ie)),Xe(this.destroy$)).subscribe()}destroy(){this.destroy$.next(),this.reset(),this.hls&&(this.hls.off(r.b.MEDIA_DETACHING,this.resetFn),this.isKeyCleanupSupported()&&this.hls.off(r.b.MEDIA_ATTACHING,this.setupFn),this.hls=void 0)}reset(){this.media&&(this.media.removeEventListener("timeupdate",this.ontimeupdate),this.media=null),this.reset$.next(),this.keyUriToKeyInfo={},this.activeDecryptData=[],this.pendingDecryptData=[],this.numberOfConsecutiveKeyErrors=0}setupListeners(e,t){let i=this.media=t.media;i&&i.addEventListener("timeupdate",this.ontimeupdate.bind(this))}ontimeupdate(){if(!this.media)return;let e=this.media.currentTime;this.activeDecryptData.forEach(function(t,i,r){e>t.expiryPosition+this.hls.config.keyHoldTimeAfterExpiry/1e3&&(r.splice(i,1),this.keySystemController.removeKey(t).subscribe(),this.keyUriToKeyInfo[t.uri]=void 0)}.bind(this))}isKeyCleanupSupported(){return!0===this.hls.config.useMultipleKeySessions||"widevine"===this.hls.config.keySystemPreference||"playready"===this.hls.config.keySystemPreference}_handleKeyRequestResolve(e,t){let i=this.keyUriToKeyInfo[e];i?i.state=t:this.logger.warn("Missing info keyuri="+this.hls.redactUrl(e))()}_handleKeyError(e,t){let i,r=this.keyUriToKeyInfo[e];if(!r)return new Error("Key doesn't exist in system");if(this.logger.error(`[Keys] Key request error keyuri=${this.hls.redactUrl(e)} ${t.message}`)(),r.state=Kr.MustRequestResponse,t)if(t instanceof zi)i=new s.q(s.g.KEY_SYSTEM_ERROR,s.d.KEY_SYSTEM_GENERIC_ERROR,!0,t.message,{code:t.code,text:t.message},r.decryptdata,r.stats,r.levelIds,void 0);else if(t instanceof Qr||t instanceof j)i=new s.q(s.g.NETWORK_ERROR,s.d.KEY_LOAD_TIMEOUT,!1,t.message,s.f.CryptResponseReceivedSlowly,r.decryptdata,r.stats,r.levelIds,void 0);else if(t instanceof Yr){this.numberOfConsecutiveKeyErrors++;let e=!t.isOkToRetry&&this.numberOfConsecutiveKeyErrors>=this.hls.config.keyRetryCountOnError;r.stats.isOkToRetry=t.isOkToRetry,r.stats.statusCode=t.statusCode,i=new s.q(s.g.NETWORK_ERROR,s.d.KEY_LOAD_ERROR,e,t.message,{code:t.statusCode,text:t.message},r.decryptdata,r.stats,r.levelIds,t.keyErrorReason)}else i=new s.h(s.g.OTHER_ERROR,s.d.INTERNAL_EXCEPTION,!0,t.message);return i}_triggerKeyError(e,t){let i=this._handleKeyError(e,t);i&&this.hls.trigger(r.b.INTERNAL_ERROR,i)}getLevelIdsForKey(e){return this.keyUriToKeyInfo[e.uri]?this.keyUriToKeyInfo[e.uri].levelIds:new Set}getKeyFromDecryptData(e,t,i=!1){if(!e||!e.isEncrypted)return $e(e);let s=e.uri,a=this.keyUriToKeyInfo[s];if(a&&Object(ke.c)(t)&&a.levelIds.add(t),a&&!a.stats.isOkToRetry)return Be(this._handleKeyError(s,new Yr("Key has already resulted in failure",s,a.stats.statusCode,!1,jr.AlreadyFailedKey)));if(!a||i||a.state===Kr.MustRequestResponse){let i=!1;a?a.abort$.next():(i=!0,a=this.keyUriToKeyInfo[s]={state:Kr.WaitingForKeyResponse,decryptdata:e,stats:void 0,request:void 0,levelIds:new Set,abort$:new Z}),a.state=Kr.WaitingForKeyResponse,a.decryptdata=e,Object(ke.c)(t)&&a.levelIds.add(t);let n,o=performance.now();a.stats={trequest:o,tfirst:o,isOkToRetry:!0},i&&"AES-128"!==e.method&&this.pendingDecryptData.push(e);let l=e.method;switch(l){case"SAMPLE-AES":case"ISO-23001-7":case"SAMPLE-AES-CTR":n=this._fetchKeyEME(a,e);break;case"AES-128":n=this.fetchKeyHTTP(e.uri,e,void 0);break;default:a.request=Be(new Error("Unexpected METHOD attribute "+l))}const d=this.hls.config,h=this.hls.streamController.targetDuration;let c=Math.max(this.hls.config.keyLoadingMinTimeout,h>0?2e3*h:d.keyLoadingDefaultTimeout);return a.request=n.pipe(W(c),fe(t=>(this._handleKeyRequestResolve(s,e?Kr.GotKeyResponse:Kr.MustRequestResponse),this.numberOfConsecutiveKeyErrors=0,a.decryptdata.key=t.decryptdata.key,this.hls.trigger(r.b.KEY_LOADED,t),$e(t.decryptdata))),Se(e=>Be(this._handleKeyError(s,e))),ot(),dt(()=>{a.state===Kr.WaitingForKeyResponse&&(a.state=Kr.MustRequestResponse)}),Xe(Ge(a.abort$,this.reset$))),a.request}return a.state===Kr.GotKeyResponse?$e(a.decryptdata):a.request}updateExpiryPosition(e,t,i=1/0){this.pendingDecryptData.forEach(function(r,s,a){r.uri===e.uri&&(a.splice(s,1),this.activeDecryptData.forEach(e=>{let r=this.keyUriToKeyInfo[e.uri];return e.expiryPosition===1/0&&(this.hls.inGaplessMode||r.levelIds.has(t))&&(this.logger.log(`[Keys] Setting expiry for ${this.hls.redactUrl(e.uri)} to ${i}`),e.expiryPosition=i),e}),this.activeDecryptData.push(r))}.bind(this))}_fetchKeyEME(e,t){return this.keySystemController.requestKey(t).pipe(ae(t=>{let i=performance.now();return{timestamp:i,keyuri:t.uri,decryptdata:t,stats:{trequest:e.stats.trequest,tfirst:e.stats.tfirst,tload:i}}}))}fetchKeyHTTP(e,t,i){return Jr.fetchKeyHTTP(this.hls,e,t,i)}static fetchKeyHTTP(e,t,i,r){let s=e.config,a=yt.isCustomUrl(t)?new yt(e):new s.loader(s),n={type:"key",url:t,method:"GET",decryptdata:i,responseType:"arraybuffer"},o={maxLoadTimeMs:Object(ke.c)(r)?r:0,maxTimeToFirstByteMs:0,autoRetry:!1,timeoutRetry:null,errorRetry:null};return a.load(n,o).pipe(ae(({response:e,stats:t})=>(i.key=new Uint8Array(e.data),{decryptdata:i,keyuri:n.url,stats:{trequest:t.trequest,tfirst:t.tfirst,tload:t.tload},timestamp:performance.now()})),Se(e=>{throw e instanceof Ce?e=new Yr("Unable to load key",t,e.code,!0,jr.HttpError):e instanceof j&&(e=new Qr("Key load timed out",t)),e}))}loadCertificate(e,t){let i,r=this.hls.config,s=yt.isCustomUrl(e)?new yt(this.hls):void 0!==r.fLoader?new r.fLoader(r):new r.loader(r),a={type:"cert",url:e,responseType:"arraybuffer"};return i=yt.isCustomUrl(e)?r.fragLoadPolicy.customURL:r.fragLoadPolicy.default,s.load(a,i).pipe(ae(e=>({keysystem:t,certificate:e.response.data})))}}function Zr(e){return void 0!==e&&Object.values(zr).includes(e)}!(function(e){e.UNKNOWN="unkn",e.VIDEO="vide",e.AUDIO="soun",e.SUBTITLE="sbtl",e.CLOSEDCAPTION="clcp"})(Wr||(Wr={})),(function(e){e[e.NO=0]="NO",e[e.YES=1]="YES"})(qr||(qr={})),(function(e){e.None="NONE",e.Type0="TYPE-0",e.Type1="TYPE-1",e.Type2="TYPE-2"})(zr||(zr={}));function es(e){return e&&"id"in e}function ts(e){return e&&"bitrate"in e}class is{constructor(e,t,i){this.observer=e,this.mediaType=t,this.variantList=i||[]}destroy(){this.validVariantListInternal=void 0,this.variantListInternal=[],this.idToVariantListMap.clear(),this.idToPenaltyBoxExpiry.clear(),this.allowListFilters=[],this.denyListFilters=[],void 0!==this.penaltyBoxTimer&&(clearTimeout(this.penaltyBoxTimer),this.penaltyBoxTimer=void 0)}reset(){this.validVariantListInternal=void 0,this.variantListInternal=[],this.idToVariantListMap=new Map,this.idToPenaltyBoxExpiry=new Map,this.allowListFilters=[],this.denyListFilters=[{type:"Deny",filterFn:e=>this.isRemovedOrInPenaltyBox(e),expiry:Number.POSITIVE_INFINITY,preFilterCallback:null,postFilterCallback:null}],this.stopTimers()}clearAllDetails(){Ae.b.info(`[${this.mediaType}] clear all level/variant details`)(),this.variantListInternal.forEach(e=>{e.details=void 0})}stopTimers(){void 0!==this.penaltyBoxTimer&&(clearTimeout(this.penaltyBoxTimer),this.penaltyBoxTimer=void 0)}startTimers(){this.penaltyBoxTimer||this.setOrResetPenaltyBoxTimer(this.getMinExpiry())}getMediaType(){return this.mediaType}get variantList(){return this.variantListInternal}set variantList(e){this.reset(),this.variantListInternal=this.sortVariants(Array.from(e)),this.variantListInternal.forEach(e=>{this.idToVariantListMap.set(is.getUniqueId(e),e)})}get validVariantList(){return this.validVariantListInternal||(this.validVariantListInternal=[...this.variantListInternal],this.applyFilters(this.allowListFilters),this.applyFilters(this.denyListFilters)),this.validVariantListInternal}applyFilters(e){e.forEach(e=>{(!e.expiry||performance.now()<e.expiry)&&("function"==typeof e.preFilterCallback&&e.preFilterCallback(this.validVariantListInternal),this.validVariantListInternal=this.validVariantListInternal.filter(t=>"Allow"===e.type?e.filterFn(t):!e.filterFn(t)),"function"==typeof e.postFilterCallback&&e.postFilterCallback(this.validVariantListInternal))})}markValidListDirty(){this.validVariantListInternal=void 0}getVariantInfo(e){return this.idToVariantListMap.get(e)}getVariantInfoIfValid(e){let t=this.idToVariantListMap.get(e);if(void 0!==t&&this.isValidVariant(t))return t}getVariantListPosition(e){let t=this.validVariantList.findIndex(t=>is.getUniqueId(t)===e);return t>=0?t:void 0}isRemovedOrInPenaltyBox(e){let t=performance.now(),i=is.getUniqueId(e),r=this.idToPenaltyBoxExpiry.get(i);return void 0!==r&&t<r}isValidVariant(e){let t=performance.now();return this.denyListFilters.every(i=>{let r=t<(i.expiry||Number.POSITIVE_INFINITY),s=i.filterFn;return!r||!s(e)})&&this.allowListFilters.every(t=>t.filterFn(e))}addFilter(e){"Allow"===e.type?(this.allowListFilters.push(e),this.markValidListDirty()):"Deny"===e.type&&(this.denyListFilters.push(e),this.markValidListDirty(),void 0===this.penaltyBoxTimer&&this.setOrResetPenaltyBoxTimer(e.expiry))}moveAllMatchingHostsToPenaltyBoxOrRemovePermanently(e,t){let i=this.idToVariantListMap.get(e);if(void 0===i||void 0===i.url)return;let r=Ne.getHostName(i.url),s=performance.now()+12e4,a={type:"Deny",filterFn:t=>{let i=t.url;return is.getUniqueId(t)!==e&&void 0!==i&&Ne.getHostName(i)===r},expiry:t?Number.POSITIVE_INFINITY:s,preFilterCallback:null,postFilterCallback:null};this.addFilter(a)}addLevelToPenaltyBoxInternal(e,t){this.idToPenaltyBoxExpiry.has(e)&&Ae.b.warn(`add a variant ${e} to penalty box, current expiry: ${this.idToPenaltyBoxExpiry.get(e)}, now: ${performance.now()} new expiry: ${t}`)(),this.idToPenaltyBoxExpiry.set(e,t),this.markValidListDirty(),Ae.b.info(`variant ${e} in penalty box until ${t}`)(),void 0===this.penaltyBoxTimer&&this.setOrResetPenaltyBoxTimer(t)}addLevelToPenaltyBox(e){if(Ae.b.info(`addLevelToPenaltyBox(${e}) containsVariant=${this.idToVariantListMap.has(e)}`)(),!this.idToVariantListMap.has(e))return;let t=performance.now()+12e4;this.addLevelToPenaltyBoxInternal(e,t),this.triggerLevelChangeEvent(!1)}removeLevelPermanentlyInternal(e){this.idToPenaltyBoxExpiry.set(e,Number.POSITIVE_INFINITY),this.markValidListDirty(),Ae.b.info(`variant ${e} removed permanently`)()}removeLevelPermanently(e){this.idToVariantListMap.has(e)&&(this.removeLevelPermanentlyInternal(e),this.triggerLevelChangeEvent(!1))}removeAllMatchingHDCPLevelsPermanently(e){this.removeLevelPermanently(e)}getMinExpiry(){let e=Number.POSITIVE_INFINITY;return this.denyListFilters.forEach(t=>{let i=t.expiry||Number.POSITIVE_INFINITY;e=Math.min(e,i)}),this.idToPenaltyBoxExpiry.forEach(t=>{e=Math.min(e,t)}),e}handlePenaltyBoxTimer(){let e=performance.now(),t=!1;this.denyListFilters=this.denyListFilters.filter(i=>{let r=i.expiry||Number.POSITIVE_INFINITY,s=e<r;return t=t||!s,s}),this.idToPenaltyBoxExpiry.forEach((i,r,s)=>{e>=i&&(s.delete(r),Ae.b.info(`remove variant ${r} from penalty box`)(),t=!0)}),this.markValidListDirty(),this.setOrResetPenaltyBoxTimer(this.getMinExpiry()),t&&this.triggerLevelChangeEvent(!1)}setOrResetPenaltyBoxTimer(e){this.penaltyBoxTimer&&(clearTimeout(this.penaltyBoxTimer),this.penaltyBoxTimer=void 0);let t=performance.now();isFinite(e)&&(this.penaltyBoxTimer=setTimeout(this.handlePenaltyBoxTimer.bind(this),Math.max(0,Math.ceil(e-t))))}triggerLevelChangeEvent(e){if(this.observer&&this.mediaType===Wr.AUDIO){let e={audioTracks:this.validVariantList};this.observer.trigger(r.b.AUDIO_TRACKS_UPDATED,e)}}sortVariants(e){return e.sort((function(e,t){return ts(e)&&ts(t)?e.bitrate-t.bitrate:es(e)&&es(t)?e.id-t.id:1})),e}static getUniqueId(e){let t=NaN;return ts(e)?t=e.persistentId:es(e)&&(t=e.id),t}}var rs,ss,as,ns,os,ls,ds,hs=is,cs=class{constructor(e,...t){this.hls=e,this.destroyed=!1,this.hls=e,this.logger=e.logger,this.onEvent=this.onEvent.bind(this),this.handledEvents=t,this.registerListeners()}destroy(){this.destroyed=!0,this.unregisterListeners()}registerListeners(){for(const e of this.handledEvents)this.hls.on(e,this.onEvent)}unregisterListeners(){for(const e of this.handledEvents)this.hls.off(e,this.onEvent)}onEvent(e,t){if(this.destroyed)this.logger.warn("Event fired after event handler is destroyed! Event name: "+e)();else try{const i="on"+e.replace("hls",""),r=this[i];if("function"!=typeof r)throw new Error(`Event ${e} has no generic handler in this ${this.constructor.name} class (tried ${i})`);r.call(this,t)}catch(t){this.logger.error(`internal error happened while processing ${e}:${t.message} ${t.stack}`)();let i=new s.h(s.g.OTHER_ERROR,s.d.INTERNAL_EXCEPTION,!1,t.message);i.response=s.f.InternalError,i.event=e,i.err=t,this.hls.trigger(r.a.ERROR,i)}}},us=(function(e){function t(t,i,r){void 0===t&&(t=1/0),void 0===i&&(i=1/0),void 0===r&&(r=p);var s=e.call(this)||this;return s.timestampProvider=r,s._events=[],s._infiniteTimeWindow=!1,s._bufferSize=t<1?1:t,s._windowTime=i<1?1:i,i===1/0?(s._infiniteTimeWindow=!0,s.next=s.nextInfiniteTimeWindow):s.next=s.nextTimeWindow,s}return n(t,e),t.prototype.nextInfiniteTimeWindow=function(t){var i=this._events;i.push(t),i.length>this._bufferSize&&i.shift(),e.prototype.next.call(this,t)},t.prototype.nextTimeWindow=function(t){this._events.push({time:this._getNow(),value:t}),this._trimBufferThenGetEvents(),e.prototype.next.call(this,t)},t.prototype._subscribe=function(e){var t,i=this._infiniteTimeWindow,r=i?this._events:this._trimBufferThenGetEvents(),s=r.length;if(this.closed)throw new Y;if(this.isStopped||this.hasError?t=c.EMPTY:(this.observers.push(e),t=new J(this,e)),i)for(var a=0;a<s&&!e.closed;a++)e.next(r[a]);else for(a=0;a<s&&!e.closed;a++)e.next(r[a].value);return this.hasError?e.error(this.thrownError):this.isStopped&&e.complete(),t},t.prototype._getNow=function(){var e=this.timestampProvider;return e?e.now():p.now()},t.prototype._trimBufferThenGetEvents=function(){for(var e=this._getNow(),t=this._bufferSize,i=this._windowTime,r=this._events,s=r.length,a=0;a<s&&!(e-r[a].time<i);)a++;return s>t&&(a=Math.max(a,s-t)),a>0&&r.splice(0,a),r},t})(Z);function fs(e,t,i){var r;return r=e&&"object"==typeof e?e:{bufferSize:e,windowTime:t,refCount:!1,scheduler:i},function(e){return S(e,(a=(t=r).bufferSize,n=void 0===a?1/0:a,o=t.windowTime,l=void 0===o?1/0:o,d=t.refCount,h=t.scheduler,c=0,function(e){var t;c++,i?t=i.subscribe(this):(i=new us(n,l,h),t=i.subscribe(this),(s=e.subscribe({next:function(e){i.next(e)},error:function(e){var t=i;s=void 0,i=void 0,t.error(e)},complete:function(){s=void 0,i.complete()}})).closed&&(s=void 0)),this.add((function(){c--,t.unsubscribe(),d&&0===c&&s&&(s.unsubscribe(),s=void 0,i=void 0)}))}));var t,i,s,a,n,o,l,d,h,c}}!(function(e){e[e.SDR=0]="SDR",e[e.HDR=1]="HDR",e[e.HDR10=2]="HDR10",e[e.DolbyVision=3]="DolbyVision",e[e.HLG=4]="HLG"})(rs||(rs={})),(function(e){e[e.H264=16]="H264",e[e.HEVC=64]="HEVC",e[e.VP09=65]="VP09"})(ss||(ss={})),(function(e){e[e.DOVI=4]="DOVI",e[e.HEVC=3]="HEVC",e[e.VP09=2]="VP09",e[e.AVC=1]="AVC",e[e.UNKNOWN=0]="UNKNOWN"})(as||(as={})),(function(e){e[e.PQ=3]="PQ",e[e.HLG=2]="HLG",e[e.SDR=1]="SDR",e[e.UNKNOWN=0]="UNKNOWN"})(ns||(ns={})),(function(e){e[e.XHEAAC=7]="XHEAAC",e[e.FLAC=6]="FLAC",e[e.ALAC=5]="ALAC",e[e.EC3=4]="EC3",e[e.AC3=3]="AC3",e[e.AAC=2]="AAC",e[e.MP3=1]="MP3",e[e.UNKNOWN=0]="UNKNOWN"})(os||(os={})),(function(e){e[e.VALID=1]="VALID",e[e.INVALID=0]="INVALID"})(ls||(ls={}));class gs{constructor(...e){this.identifier=e}ensureSameIdentifierLength(e){if(this.identifier.length!==e.identifier.length)throw new Error(`Identifiers have non-matching lengths! (${this.identifier.length} vs ${e.identifier.length})`)}isGreaterThan(e){this.ensureSameIdentifierLength(e);for(let t=0;t<this.identifier.length;++t){if(this.identifier[t]<e.identifier[t])return!1;if(this.identifier[t]>e.identifier[t])return!0}return!1}isEqualTo(e){return this.ensureSameIdentifierLength(e),this.identifier.every((t,i)=>t===e.identifier[i])}}function ps(e,t,i){let r,s=t.length,a=i.length;if(s!==a){let e=t.filter(e=>!i.includes(e));r=`playlist has ${a} levels left, removed persistentIds:${JSON.stringify(e.map(e=>e.persistentId))}`}else r="no levels were removed";Ae.b.info(`Applied ${e} Filtering, ${r}`)()}function ms(e){return ke.b.isDolby(e)?as.DOVI:ke.b.isHEVC(e)?as.HEVC:ke.b.isVP09(e)?as.VP09:ke.b.isAVC(e)?as.AVC:as.UNKNOWN}function ys(e){return ke.b.isxHEAAC(e)?os.XHEAAC:ke.b.isFLAC(e)?os.FLAC:ke.b.isALAC(e)?os.ALAC:ke.b.isEC3(e)?os.EC3:ke.b.isAC3(e)?os.AC3:ke.b.isAAC(e)?os.AAC:ke.b.isMP3(e)?os.MP3:os.UNKNOWN}function vs(e,t,i,r,s){const{targetDuration:a,targetStartupMs:n}=i,{maxPlaylistLoadTimeMs:o}=r,{maxDuration:l,avgParseTimeMs:d,maxBufferCreationDelayMs:h,avgBufferTimeMs:c}=s,{avgBandwidth:u,avgLatencyMs:f}=t,g=Math.ceil(a/l);return e.bandwidth<=u&&(e.avgBandwidth||e.bandwidth)*a/u*1e3+o+h+(f+d+c)*g<=n}function bs(e,t,i,r,s,a){const n=(function(e,t,i){const r=(e,t,i)=>(e-t)*(e-i)<=0;return r(e,i.minValidBitrate,i.maxValidBitrate)&&r(t,i.minValidHeight,i.maxValidHeight)})(e.bitrate,e.height,t)?ls.VALID:ls.INVALID,o="PQ"===(l=e.videoRange)?ns.PQ:"HLG"===l?ns.HLG:"SDR"===l?ns.SDR:ns.UNKNOWN;var l;const{videoCodecRank:d,audioCodecRank:h}=(function(e){return{videoCodecRank:ms(e.videoCodec),audioCodecRank:ys(e.audioCodec)}})(e),c=e.bitrate<=t.maxPreferredBitrate?ls.VALID:ls.INVALID,u=e.audioChannelCount||1,f=i&&r&&s&&a&&!vs(e,i,r,s,a)?ls.INVALID:ls.VALID;return new gs(n,o,d,u,h,f,c,e.height)}function Ss(e,t,i,r,s){const a=e.score,n=t&&i&&r&&s&&!vs(e,t,i,r,s)?ls.INVALID:ls.VALID;return new gs(n,a)}function Ts(e){if(!e||!e.length)return;const t=e.sort((e,t)=>ms(t)-ms(e));return t&&t.length?t[0]:void 0}function Es(e){if(!e||!e.length)return;const t=e.sort((e,t)=>ys(t)-ys(e));return t&&t.length?t[0]:void 0}function _s(e,t){if(!e||!t||!t.length)return;let i=void 0;const r=t.filter(t=>t.groupId===e);if(r&&r.length){const e=r.sort((e,t)=>ke.b.getChannelCount(t.channels)-ke.b.getChannelCount(e.channels));e&&e.length&&(i=e[0].channels)}return i}function Ds(e,t,i){var r=function(i,r){return (function(i,r){let s=r?"audio":"video";e.has(i)||t.has(i)||(function(e,t){let i=MediaSource.isTypeSupported(`${e}/mp4;codecs=${t}`);return"mp4a.40.34"!==t||i||(i=MediaSource.isTypeSupported(e+"/mpeg")),i}(s,i)?e.add(i):t.add(i))})(i,r),t.has(i)};let s=!1;return i.audioCodecList&&(s=i.audioCodecList.some(e=>r(e,!0))),!s&&i.videoCodecList&&(s=i.videoCodecList.some(e=>r(e,!1))),!s}function Is(e,t){let i=Nr.getKeySystemSecurityLevel(t);return void 0!==e&&void 0!==i&&void 0!==i[e]}function ws(e,t){for(let i in e)if(e[i].type===t)return e[i];return{}}function Rs(e,t){return!Object(ke.c)(e)||!Object(ke.c)(t)||e<=t}function As(e){return e.every(e=>e.iframes)}function ks(e,t,i,r){let a=i?i.maxHdcpLevel:void 0,n=Array.from(e);(r.disableVideoCodecList.size>0||r.disableAudioCodecList.size>0)&&(n=(function(e,t,i){let r=e.filter((function(e){return!e.videoCodecList||e.videoCodecList.every(e=>{let i=ms(e);return!t.has(i)})}));return ps("Disable Codec Config",e,r=r.filter((function(e){return!(!e.iframes&&e.audioCodec&&e.audioCodecList)||e.audioCodecList.every(e=>{let t=ys(e);return!i.has(t)})}))),r})(n,r.disableVideoCodecList,r.disableAudioCodecList)),a&&Zr(a)&&(n=(function(e,t){let i=function(e){switch(e){case zr.None:return 0;case zr.Type0:return 1;case zr.Type1:return 2;case zr.Type2:return 3;default:return 4}},r=i(a),s=e.filter((function(e){let t=e.hdcpLevel;return!t||i(t)<=r}));return ps("HDCP",e,s),s})(n));let o=i?i.maxSecurityLevel:void 0,l=r?r.keySystemPreference:void 0;o&&l&&Is(o,l)&&(n=(function(e,t,i){let r=Nr.getKeySystemSecurityLevel(i),s=Nr.getKeySystemFormat(i),a=function(e){return Is(e,i)?r[e]:-1},n=a(t),o=e.filter(e=>{let t=e.allowedCPCMap&&e.allowedCPCMap.has(s)?e.allowedCPCMap.get(s):[],i=!0;for(let e of t)if(!(i=a(e)<=n))break;return i});return ps("Security Level",e,o),o})(n,o,l)),n.forEach(e=>{if(e.audioCodecList&&e.audioGroupId){let i=t.find(t=>t.groupId===e.audioGroupId),r=i?i.channels:void 0;r&&(e.audioChannelCount=parseInt(r))}});let d,h=!!r&&r.useMediaKeySystemAccessFilter&&l&&navigator&&"function"==typeof navigator.requestMediaKeySystemAccess,c=i?i.robustnessLevel:void 0;return(d=h?(function(e,t,i){let r=new Map,s=new Array;return e.forEach(e=>{let a=Array();!(function(e,t,s){let a,n=Et(t.videoCodecList,t.audioCodecList,i),o=JSON.stringify(n);r.has(o)?a=r.get(o):(a=Nr.requestKeySystemAccess(e,n,void 0).pipe(ae(()=>!0),Se(e=>(Ae.b.warn("Request key system error: "+e.message)(),$e(!1))),fs({bufferSize:1,refCount:!0})),r.set(o,a)),s.push(a)})(t,e,a);let n=$i(a).pipe(ae(t=>{if(void 0===t.find(e=>!1===e))return e}));s.push(n)}),$i(s).pipe(ae(e=>e.filter(e=>Boolean(e))))})(n,l,c).toPromise():Promise.resolve(n)).then(e=>{if(0===e.length||As(e))throw new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_INCOMPATIBLE_CODECS_ERROR,void 0,"no level with compatible codecs found in manifest",void 0);h&&ps("Key System Support",n,e);let a,o=navigator&&navigator.mediaCapabilities,l=!!r&&r.useMediaCapabilities&&o&&"function"==typeof o.decodingInfo;return l?a=(function(e,t){let i=navigator&&navigator.mediaCapabilities,r=new Array,s=new Set,a=new Set,n=new Map;function o(e,t,r,s,a){let o={type:"media-source"};s?o.video=(function(e,t){let i={contentType:"video/mp4;codecs="+e,width:t.width,height:t.height,bitrate:t.bandwidth||t.avgBandwidth,framerate:t.iframes?8:t.frameRate};if(t.videoRange)switch(t.videoRange){case"PQ":ke.b.isDolby(e)?(i.hdrMetadataType=ds.DoVi,i.colorGamut="rec2020"):(ke.b.isHEVC(e)||ke.b.isVP09(e))&&(i.hdrMetadataType=ds.HDR10,i.colorGamut="rec2020"),i.transferFunction="pq";break;case"HLG":i.colorGamut="rec2020",i.transferFunction="hlg"}return i})(r,e):o.audio=(function(e,t,i){let r={contentType:"audio/mp4;codecs="+e},s=_s(t.audioGroupId,i);if(s){let e=s.split("/"),t=e[0];r.channels=t,e.find(e=>"JOC"===e)&&(r.spatialRendering=!0)}return r})(r,e,t);let l,d=JSON.stringify(o);if(n.has(d))l=n.get(d);else{try{l=i.decodingInfo(o).then(e=>{let t=e.configuration||e.supportedConfiguration,i=t instanceof Object&&(!o.video||void 0===Object.keys(o.video).find(e=>!(e in t.video)))&&(!o.audio||void 0===Object.keys(o.audio).find(e=>!(e in t.audio))),r=e.supported&&(!s||e.powerEfficient)&&i;return r||Ae.b.warn(`Unsupported config ${e.supported}/${e.powerEfficient}/${i} ${JSON.stringify(o)} supportedConfig=${JSON.stringify(t)}`)(),r})}catch(e){l=Promise.reject(e)}n.set(d,l)}a.push(l)}function l(e){Ae.b.info("Unsupported level "+JSON.stringify(e,["avgBandwidth","audioCodecList","videoCodecList","videoRange","frameRate","width","height","iframes"]))()}for(let i of e){let e=Array();if(i.videoCodecList)for(let r of i.videoCodecList)o(i,t,r,!0,e);if(i.audioCodecList&&i.audioCodecList.length>0){const r=Es(i.audioCodecList);o(i,t,r,!1,e)}let n=Promise.all(e).then(e=>{if(void 0===e.find(e=>!1===e))return i;l(i)}).catch(e=>{if(Ae.b.warn("decodingInfo error: "+e.message)(),Ds(s,a,i))return i;l(i)});r.push(n)}return Promise.all(r).then(e=>e.filter(e=>Boolean(e)))})(e,t):(e=(function(e,t){let i=new Set,r=new Set,s=!MediaSource.isTypeSupported('audio/mp4; codecs="mp4a.40.2"; channels="-1"'),a=s&&!MediaSource.isTypeSupported('audio/mp4; codecs="mp4a.40.2"; channels="2"; features="INVALID"');Ae.b.info(`Platform support for channels: ${s}; features: ${a}`)();let n=e.filter((function(e){let n=!1;if(e.audioCodecList&&e.audioGroupId){const o=_s(e.audioGroupId,t);e.audioCodecList.length>0&&o&&(n=(function(e,t){let n=ke.b.isDolbyAtmos(e,t);if(a||s&&!n){!(function(e,t){let s=e+"/"+t;i.has(s)||r.has(s)||(function(e,t){let i,r,s=t.split("/"),a=parseInt(s[0]);s.length>1?(i=`audio/mp4;codecs="${e}";channels="${a}";features="${s[1]}"`,r=`audio/mp4;codecs="${e}";channels="8";features="${s[1]}"`):i=`audio/mp4;codecs="${e}";channels="${a}"`;let n=MediaSource.isTypeSupported(i);return!n&&r&&(n=MediaSource.isTypeSupported(r),Ae.b.info(`Using mimeCodecAlternate, isSupported: ${n}; mimeCodecAlternate: ${r}`)()),n}(e,t)?i.add(s):r.add(s))})(e,t);let s=e+"/"+t;return r.has(s)}return!!n})(Es(e.audioCodecList),o))}return!n}));return ps("Richest Audio Codec Selection",e,n),n})(e=(function(e){let t=new Set,i=new Set,r=e.filter(Ds.bind(null,t,i));return ps("Platform Supported Media Codec",e,r),r})(e),t),a=Promise.resolve(e)),a.then(e=>{if(0===e.length||As(e))throw new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_INCOMPATIBLE_CODECS_ERROR,void 0,"no level with compatible codecs found in manifest",void 0);if(0===(e=(function(e){const t=e.filter(e=>!e.iframes||!e.width||!e.height||e.width*e.height<=2488320);return ps("1080p iFrame",e,t),t})(e=(function(e,t){let i=e.filter(e=>{const{highestPlayablePeakBitRate:i,highestPlayableAverageBitRate:r,highestPlayableWidth:s,highestPlayableHeight:a,highestPlayableFrameRate:n}=(function(e,t){if(!t)return{highestPlayableAverageBitRate:void 0,highestPlayablePeakBitRate:void 0,highestPlayableWidth:void 0,highestPlayableHeight:void 0,highestPlayableFrameRate:void 0};let i=e.videoCodec,r=e.videoRange,s=t.videoDynamicRangeFormats,a=t.videoCodecs;return (function(e,t,i,r){if(!r&&!i)return{};let s,a,n=i?ws(i,t):{},o=r?ws(r,e):{};switch(e){case rs.SDR:s=n,a=o;break;default:s=o,a=n}let l=Object.assign({},s);return (function(e,t){Object.keys(t).forEach(i=>{e[i]||(e[i]=t[i])})})(l,a),l})(function(e,t){let i=rs.SDR;return"PQ"===e&&ke.b.isDolby(t)?i=rs.DolbyVision:"PQ"===e&&ke.b.isHEVC(t)?i=rs.HDR10:"HLG"===e&&-1!==t.indexOf("hvc1")&&(i=rs.HLG),i}(r,i),(function(e){let t=ss.H264;return ke.b.isHEVC(e)||ke.b.isDolby(e)?t=ss.HEVC:ke.b.isVP09(e)&&(t=ss.VP09),t})(i),a,s)})(e,t);return Rs(e.bandwidth,i)&&Rs(e.avgBandwidth,r)&&Rs(e.width,s)&&Rs(e.height,a)&&Rs(e.frameRate,n)});return ps("Highest Playable Platform Caps",e,i),i})(e,i))).length||As(e))throw new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_INCOMPATIBLE_CODECS_ERROR,void 0,"no level with compatible codecs found in manifest",void 0);let t=i?i.videoDynamicRangeFormats:void 0;l&&!t&&(t=[{type:rs.SDR},{type:rs.HDR},{type:rs.HDR10},{type:rs.DolbyVision},{type:rs.HLG}]);let{hdrLevels:r,sdrLevels:a}=(function(e,t){let i=new Array,r=new Array,s=(function(e){let t=!1,i=!1,r=!1;if(e&&e.length>0)for(let s=0;s<e.length;++s)switch(e[s].type){case rs.DolbyVision:t=!0;break;case rs.HDR10:i=!0;break;case rs.HLG:r=!0}return{doViSupported:t,hdr10Supported:i,hlgSupported:r}})(t),{doViSupported:a,hdr10Supported:n,hlgSupported:o}=s;return Ae.b.info(`Supported videoDynamicRangeFormats DoVi/HDR10/HLG: ${a}/${n}/${o}`)(),e.forEach(e=>{let t=e.videoRange,s=e.videoCodec;switch(t){case"PQ":s&&(a&&ke.b.isDolby(s)||n&&ke.b.isHEVC(s)||ke.b.isVP09(s))&&i.push(e);break;case"HLG":s&&o&&(ke.b.isHEVC(s)||ke.b.isVP09(s))&&i.push(e);break;default:r.push(e)}}),{hdrLevels:i,sdrLevels:r}})(e,t);if(0===r.length&&0===a.length||As(r)&&As(a))throw new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_INCOMPATIBLE_VIDEO_RANGE_ERROR,void 0,"level with compatible VIDEO-RANGE not found in manifest",void 0);return{hdrLevels:r,sdrLevels:a}})}).catch(e=>{throw e instanceof s.t&&(e.fatal=!0,e.response=s.f.IncompatibleAsset),e})}function Cs(e){return function(t){return S(t,(function(t){var i,r,s=this,a=new c,n=!1,o=!1,l=!1,d=function(){l=!1,i=t.subscribe({next:function(e){return s.next(e)},error:function(e){return s.error(e)},complete:function(){if(l=!0,o)s.complete();else{var t=(function(){if(!r){r=new Z;var t=void 0;try{t=e(r)}catch(e){return s.error(e),null}a.add(t.subscribe({next:function(){i?d():n=!0},error:function(e){return s.error(e)},complete:function(){o=!0,l&&s.complete()}}))}return r})();t&&t.next()}}}),n?(i.unsubscribe(),i=null,n=!1,d()):a.add(i)};return d(),a}))}}!(function(e){e.HDR10="smpteSt2086",e.DoVi="smpteSt2094-10",e.HDR10Plus="smpteSt2094-40"})(ds||(ds={}));var Ls=(function(){function e(e,t){this.predicate=e,this.inclusive=t}return e.prototype.call=function(e,t){return t.subscribe(new Ps(e,this.predicate,this.inclusive))},e})(),Ps=(function(e){function t(t,i,r){var s=e.call(this,t)||this;return s.predicate=i,s.inclusive=r,s.index=0,s}return n(t,e),t.prototype._next=function(e){var t,i=this.destination;try{t=this.predicate(e,this.index++)}catch(e){return void i.error(e)}this.nextOrComplete(e,t)},t.prototype.nextOrComplete=function(e,t){var i=this.destination;Boolean(t)?i.next(e):(this.inclusive&&i.next(e),i.complete())},t})(w);class Ms{static addReloadPolicy(e,t,i){return a=>{let n;return a.pipe(We(i=>{n=i;let r=t.getVariantInfo(e);Ms.updateChangedLevelCount(r,i)}),Cs(r=>r.pipe(fe(()=>{let r=t.getVariantInfo(e);return Ms.getReloadTimer(e,r,n,i(n))}))),fs({bufferSize:1,refCount:!0}),(r=e=>e.live,void 0===(s=!0)&&(s=!1),function(e){return S(e,new Ls(r,s))}))};var r,s}static getLiveRefreshInterval(e){return 1e3*(e.averagetargetduration?e.averagetargetduration:e.targetduration)}static needToRefreshLevel(e){let t=Ms.getLiveRefreshInterval(e),i=performance.now()-e.trequest;return e.live&&i>=t}static updateChangedLevelCount(e,t){let i=e.details;if((t.live||(null==i?void 0:i.live))&&(t.trequest!==(null==i?void 0:i.trequest)&&t.endSN===(null==i?void 0:i.endSN)?e.unchangedLevelCount++:e.unchangedLevelCount=0),e.unchangedLevelCount>=2)throw new s.s(!1,s.f.LivePlaylistUpdateError.text,s.f.LivePlaylistUpdateError.code,!1,"level",t.url,hs.getUniqueId(e))}static getReloadTimer(e,t,i,r){if(!i.live)return ie;let s=Ms.getLiveRefreshInterval(i);return t.unchangedLevelCount>0&&(s/=2,s=Math.max(s,5e3)),s-=performance.now()-i.trequest,s+=r,Ae.b.info("reloadInterval: "+s)(),s=Math.max(1e3,Math.round(s)),Ae.b.info(`level ${e} reload in ${s} ms`)(),X(s)}}var xs=Ms,Os=class extends cs{constructor(e,...t){super(e,...t),this.hls=e}loadPlaylist(e){return re(()=>{let t=e.details;return!t||t.live&&xs.needToRefreshLevel(t)||e.unchangedLevelCount>0?this.loadPlaylistInternal(e).pipe(ae(e=>(e.details.trequest=e.stats.trequest,e.details))):$e(t)})}};function Ns(e){return"PQ"===e.videoRange||"HLG"===e.videoRange}function Fs(e){return JSON.stringify(e,["persistentId","bitrate","bandwidth","avg-bandwidth","width","height","videoCodec","audioCodec","videoRange","iframes","frameRate","audioGroupId"])}var Bs=class extends hs{constructor(e,t,i,r){super(e,Wr.VIDEO),this.variantList=t,this.hdrMode=i,this.displaySize=r}reset(){super.reset(),this.compatibleVariants=new Set,this.addFilter({type:"Allow",filterFn:e=>Ns(e)===this.hdrMode,expiry:null,preFilterCallback:null,postFilterCallback:null}),this.addFilter({type:"Allow",filterFn:e=>0===this.compatibleVariants.size||this.compatibleVariants.has(hs.getUniqueId(e)),expiry:null,preFilterCallback:null,postFilterCallback:null}),this.addFilter({type:"Allow",filterFn:e=>this.isLevelSizeWithinTolerance(e),expiry:null,preFilterCallback:e=>{this.lowestBitrate=(e.find(e=>!e.iframes)||{}).bitrate},postFilterCallback:null})}set variantList(e){this.hasHDRLevels=e.some(e=>!e.iframes&&Ns(e)),this.hasIframeLevels=e.some(e=>e.iframes),this.hasScoreAvailable=e.every(e=>Object(ke.c)(e.score)&&e.score>=0),this.validCodecList=new Set,super.variantList=e;for(let t=0;t<e.length;t++){let i=e[t].videoCodecList;if(i)for(let e=0;e<i.length;e++)this.validCodecList.add(i[e])}}get variantList(){return super.variantList}removeAllMatchingHDCPLevelsPermanently(e){const t=this.idToVariantListMap.get(e);if(!t)return;let i=t.hdcpLevel,r={type:"Deny",filterFn:t=>{let r=hs.getUniqueId(t),s=t.hdcpLevel;return void 0===i&&r===e||void 0!==s&&s===i},expiry:Number.POSITIVE_INFINITY,preFilterCallback:null,postFilterCallback:null};this.addFilter(r),this.triggerLevelChangeEvent(!0)}updateDisplaySize(e){this.displaySize=e,this.markValidListDirty(),this.triggerLevelChangeEvent(!1)}getDisplaySize(){return this.displaySize}set hdrMode(e){if(!this.hasHDRLevels&&e)return Ae.b.warn("HDR Mode enabled, but detected no valid HDR levels, defaulting to SDR")(),void(this.hdrModeInternal=!1);this.hdrModeInternal!==e&&(this.clearStartingVariant(),this.hdrModeInternal=e,this.markValidListDirty())}get hdrMode(){return this.hdrModeInternal}getHighestCodecByFamily(e){let t=e.split(".")[0],i=new Set([...this.validCodecList].filter(e=>e.includes(t)));switch(t){case"avc1":case"avc3":i.forEach(t=>{let i=e.split("."),r=t.split(".");i[0]===r[0]&&r[1]>i[1]&&(e=t)});break;case"vp09":i.forEach(t=>{t>e&&(e=t)}),e=e.substring(0,13);break;case"hvc1":case"hev1":i.forEach(t=>{let i=e.split("."),r="H"===i[3].substring(0,1)?1:0,s=i[3].substring(1),a=t.split("."),n="H"===a[3].substring(0,1)?1:0,o=a[3].substring(1);i[0]===a[0]&&(a[1]>i[1]||a[2]>i[2]||n>r||o>s)&&(e=t)});break;case"dvhe":case"dvh1":i.forEach(t=>{let i=e.split("."),r=t.split(".");i[0]===r[0]&&(r[1]>i[1]||r[2]>i[2])&&(e=t)})}return e}clearStartingVariant(){Ae.b.info("setting startingId undefined")(),this.startingVariant=void 0,this.compatibleVariants=new Set,this.compatibleAudioGroups=new Set}set startingId(e){let t=this.getVariantInfoIfValid(e);if(!t)return void Ae.b.warn("Invalid starting variant selected "+e)();let{levels:i,audioGroups:r}=(function(e,t){let i=new Set;return{levels:e.filter((function(e){let r=(function(e,t){let i=!0;e.videoCodec&&t.videoCodec&&(i=ke.b.isCompatibleVideoCodec(e.videoCodec,t.videoCodec));let r=!1;e.videoRange&&t.videoRange?r=e.videoRange===t.videoRange:e.videoRange||t.videoRange||(r=!0);let s=!0;return e.audioCodec&&t.audioCodec&&(s=ke.b.isCompatibleAudioCodec(e.audioCodec,t.audioCodec)),s&&i&&r})(t,e);if(r){let t=e.audioGroupId;t&&i.add(t)}return r})),audioGroups:i}})(this.variantList,t);this.startingVariant=t,this.compatibleVariants=new Set(i.map(hs.getUniqueId)),this.compatibleAudioGroups=r,this.markValidListDirty()}get startingId(){return this.startingVariant?hs.getUniqueId(this.startingVariant):NaN}sortVariants(e){return this.hasScoreAvailable?e.sort((e,t)=>e.score-t.score||t.bitrate-e.bitrate):super.sortVariants(e)}triggerLevelChangeEvent(e){if(!this.observer)return;let t={requiresReset:e,levels:this.validVariantList};this.observer.trigger(r.b.LEVELS_CHANGED,t)}isLevelSizeWithinTolerance(e){return!this.displaySize||(t=e,i=this.displaySize,t.width<1.35*i.width&&t.height<1.35*i.height&&t.width*t.height<i.width*i.height*1.35)||e.bitrate===this.lowestBitrate;var t,i}};const Us={minValidBitrate:2e6,maxValidBitrate:5e6,maxPreferredBitrate:3e6,minValidHeight:480,maxValidHeight:720};class $s extends Os{constructor(e,t){super(e,r.b.PREFERRED_HOST_CHANGED),this.playlistLoader=t,this._levelInfo$=new te(void 0),this._manualLevel=-1,this._loadediframeLevelIds=[],this.dynamicRangeListener=this.onDynamicRangeQueryChange.bind(this)}destroy(){this.reset(),this.stopDynamicRangeQuery(),this._manualLevel=-1,this.variantManager&&this.variantManager.destroy(),super.destroy()}reset(){this.stopLoad(),this._loadediframeLevelIds=[]}resetLoadSource(){this._levelInfo$.next(void 0)}cleanupLevels(){let e=this.validLevels;e&&e.forEach(e=>{const t=e.details;t&&t.live&&(e.unchangedLevelCount=0)})}startLoad(){this.cleanupLevels()}stopLoad(){this.cleanupLevels()}isSameLevel(e,t){return void 0===e==(void 0===t)&&e.persistentId===t.persistentId}get displaySupportsHdr(){return this.startDynamicRangeQuery(),!this.dynamicRangeQuery||this.dynamicRangeQuery.matches}startDynamicRangeQuery(){if(!this.dynamicRangeQuery&&"function"==typeof matchMedia){let e=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");e.media!==t.media&&(this.dynamicRangeQuery=e,this.dynamicRangeQuery.addListener(this.dynamicRangeListener))}}stopDynamicRangeQuery(){this.dynamicRangeQuery&&(this.dynamicRangeQuery.removeListener(this.dynamicRangeListener),this.dynamicRangeQuery=null)}onDynamicRangeQueryChange(){this.logger.info("HDR display support changed = "+this.displaySupportsHdr)(),this.setHDRMode(this.displaySupportsHdr,!0)}setHDRMode(e,t){if(e!==this.variantManager.hdrMode)if(!e||this.variantManager.hasHDRLevels)try{if(this.stopLoad(),this.startLoad(),this.variantManager.hdrMode=e,this.chooseFirstLevel(),t){let e={requiresReset:!0,levels:this.validLevels};this.hls.trigger(r.b.LEVELS_CHANGED,e)}}catch(t){let i=new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_INCOMPATIBLE_VIDEO_RANGE_ERROR,!0,"No levels matching display hdrMode="+e,s.f.IncompatibleAsset);this.hls.trigger(r.b.INTERNAL_ERROR,i)}else this.logger.info("No hdr levels, not switching to hdr")();else this.logger.info("No change in hdr mode")()}setFirstLevelOnManager(e){let t=this.hls.config.targetStartupMs-(performance.now()-this.hls.tloadsource);this.hls.hasPlaybackEverStarted&&t<0&&(t=this.hls.config.targetStartupMs);let i=(function(e,t,i,r,s,a,n){let o;if(e&&0!==e.length&&!As(e)){if(Ae.b.info(`Choosing first variant level based on targetStartUpMs/targetDuration: ${null==s?void 0:s.targetStartupMs}/${null==s?void 0:s.targetDuration}`)(),Ae.b.info(`Bandwidth estimates bandWidth/latencyMs: ${null==r?void 0:r.avgBandwidth}/${null==r?void 0:r.avgLatencyMs}`)(),Ae.b.info("Playlist estimates playlistLoadTimeMs: undefined")(),Ae.b.info("frag estimates duration/bufferCreationMs/fragParseTimeMs/fragBufferTimeMs: undefined/undefined/undefined/undefined")(),o=i?(function(e,t,i,r,s){let a,n;for(let r=0;r<e.length;++r){let s,o=e[r];o.iframes||(s=Ss(o,t,i,void 0,void 0),(!a||s.isGreaterThan(n)||s.isEqualTo(n)&&o.bandwidth<a.bandwidth)&&(a=o,n=s))}return a})(e,r,s):(function(e,t,i,r,s,a){let n,o;for(let s=0;s<e.length;++s){var l,d=e[s];d.iframes||(l=bs(d,t,i,r,void 0,void 0),(!n||l.isGreaterThan(o)||l.isEqualTo(o)&&d.bitrate>n.bitrate)&&(n=d,o=l))}return n})(e,t,r,s))return o;Ae.b.warn("no valid first level found in levels")()}else Ae.b.warn("no non-iframe level found in levels")()})(e.validVariantList,Us,this.hls.hasScoreAvailable,this.hls.config.enableAdaptiveStartup?this.hls.bandwidthHistoryController.getEstimate():void 0,this.hls.config.enableAdaptiveStartup?{targetDuration:this.hls.bandwidthHistoryController.getFragEstimate().maxDuration,targetStartupMs:t,metricsOverride:this.hls.config.adaptiveStartupMetricsOverride}:void 0);if(!i)throw Error("No first level found");return e.startingId=i.persistentId,i}chooseFirstLevel(){if(!this.variantManager)throw Error("variantManager undefined");let e=this.setFirstLevelOnManager(this.variantManager);this.hls.preferredHostName=Ne.getHostName(e.url),this.hls.nextAutoLevel=this.variantManager.startingId,this.logger.info(`First level ${e.persistentId}: ${Fs(e)}`)();let t=this.variantManager.validVariantList.filter(e=>ko.hasAllowedHost(e.url,this.hls.preferredHostName)).length,i=this.variantManager.validVariantList.length-t;this.logger.info(`Primary/Backup levels: ${t}/${i}`)()}parseManifestLoadedData(e){const t=this.hls,i=/chrome|firefox/.test(navigator.userAgent.toLowerCase());let r=[],s=e.audioTracks,{audioMediaSelectionGroup:a,subtitleMediaSelectionGroup:n}=e,o=!1,l=!1,d=!1,h=t.platformInfo;for(let t=0;t<e.levels.length;++t){let s=e.levels[t];o=o||Boolean(s.videoCodec),i&&s.audioCodec&&-1!==s.audioCodec.indexOf("mp4a.40.34")&&(s.audioCodec=void 0),l=l||Boolean(s.audioCodec)||Boolean(s.audioGroupId),d=d||s.iframes,r.push(s)}return o&&l&&(r=r.filter(({videoCodec:e})=>Boolean(e))),this.logger.info(`playlist has ${r.length} levels, ${Fs(r)}`)(),ks(r,s,h,this.hls.config).then(t=>{let{hdrLevels:i,sdrLevels:r}=t,d=i.concat(r),h=this.hls.media,c="object"==typeof window&&window.devicePixelRatio?window.devicePixelRatio:1,u=this.hls.config.useViewportSizeForLevelCap&&h?{width:h.clientWidth*c,height:h.clientHeight*c}:void 0;this.logger.info(`valid levels: hdr=${i.length} sdr=${r.length} supportsHdr=${this.displaySupportsHdr}, displaySize=${u?JSON.stringify(u):null}`)();let f=new Bs(this.hls,d,this.displaySupportsHdr&&i.length>0,u);this.setFirstLevelOnManager(f);let g=f.compatibleAudioGroups,p=new Array,m=new Set,y=!1;s.forEach(e=>{g.has(e.groupId)&&(e.id=p.length,m.add(e.persistentID),p.push(e),y||(y=!!e.url))}),s=p;let v=new hs(this.hls,Wr.AUDIO,s),b=a?a.MediaSelectionGroupOptions:void 0;if(b){let e=new Array;b.forEach(t=>{m.has(t.MediaSelectionOptionsPersistentID)&&e.push(t)}),a.MediaSelectionGroupOptions=e}let S={levels:f,audioTracks:v,subtitleTracks:new hs(this.hls,Wr.SUBTITLE,e.subtitleTracks),isMediaPlaylist:e.isMediaPlaylist,audioCodecFound:l,videoCodecFound:o,altAudio:y,audioMediaSelectionGroup:a,subtitleMediaSelectionGroup:n},T=f.validVariantList||[];return this.logger.info(`[QE Critical] manifest loaded, ${T.length} valid levels found, levels ${Fs(T)}`)(),Promise.resolve(S)})}setVariantManager(e){this.reset(),this.variantManagerInternal=e,e.hdrMode=this.displaySupportsHdr&&e.hasHDRLevels,e.variantList.length>0&&this.chooseFirstLevel()}get variantManager(){return this.variantManagerInternal}get validLevels(){return this.variantManager&&this.variantManager.validVariantList||[]}get hasIframeLevels(){return!!this.variantManager&&this.variantManager.hasIframeLevels}get currentVariantId(){return this.level}set currentVariantId(e){this.nextLoadLevel=e}get levelInfo(){return this._levelInfo$.value}static isSwitchUp(e,t){let i=!1;return e&&t&&(i=e.bitrate<t.bitrate&&e.iframes===t.iframes),i}addToLoadedLevels(e){this._loadediframeLevelIds.push(e),this._loadediframeLevelIds.sort((function(e,t){return t-e}))}doesLevelMatchIframeMode(e){return e&&e.iframes===this.hls.iframeMode}getLevelWithPersistentId(e){let t,i;return!Object(ke.c)(e)||e<0?this.logger.warn("invalid levelID "+e)():this.variantManager&&(t=this.variantManager.getVariantInfoIfValid(e),i=this.variantManager.getVariantListPosition(e)),{levelInfo:t,levelListPosition:i}}containsFallbackVariant(e){return e=e||this.hls.preferredHostName,this.containsFallbackVariantForMode(this.hls.iframeMode,e)}containsFallbackVariantForMode(e,t){return this.validLevels.filter(i=>i&&i.iframes===e&&ko.hasAllowedHost(i.url,t)).length>1}isCurrentLevelNonSDR(){return this.levelInfo.videoRange&&"SDR"!==this.levelInfo.videoRange}lowestBitrateLevel(e){let t=this,i=e.find((function(e){return t.doesLevelMatchIframeMode(e)}));return void 0!==i?i.persistentId:void 0}getTrickPlayResumeLevel(e){let t=this.validLevels,i=this.hls.config.targetStartupMs,r=1;const s=this.hls.bandwidthHistoryController.getPlaylistEstimate(),a=this.hls.bandwidthHistoryController.getFragEstimate();let n=a.maxDuration,o=a.maxBufferCreationDelayMs,l=this.variantManager.getVariantListPosition(e);if(l){let e=t[l];e&&e.details&&(n=e.details.targetduration,r=Math.ceil(i/(1e3*n)))}let d=this.hls.bandwidthHistoryController.getEstimate();const h={avgLatencyMs:(null==d?void 0:d.avgLatencyMs)||0,avgBandwidth:this.hls.abrController.getAvgBandwidthEstimate()},c={targetDuration:n*r,targetStartupMs:i-500+o,metricsOverride:{maxValidHeight:0,maxValidBitrate:0,maxPreferredBitrate:0}};this.logger.info(`Revising trickplay resume level based on targetStartUpMs/targetDuration: ${c.targetStartupMs}/${c.targetDuration}`)(),this.logger.info(`Bandwidth estimates bandWidth/latencyMs: ${h.avgBandwidth}/${h.avgLatencyMs}`)(),this.logger.info("Playlist estimates playlistLoadTimeMs: "+(null==s?void 0:s.maxPlaylistLoadTimeMs))(),this.logger.info(`frag estimates duration/bufferCreationMs/fragParseTimeMs/fragBufferTimeMs: ${null==a?void 0:a.maxDuration}/${null==a?void 0:a.maxBufferCreationDelayMs}/${null==a?void 0:a.avgParseTimeMs}/${null==a?void 0:a.avgBufferTimeMs}`)();let u=(function(e){return e.filter(e=>!e.iframes&&(!e.width||!e.height||e.width*e.height<=2488320))})(t),f=e;u.length>0&&(f=u[0].persistentId);let g=u.filter(e=>vs(e,h,c,s,a));return this.logger.info(`Picking resume level from validLevels/regLevels/resumeLevels ${t.length}/${u.length}/${g.length}`)(),g.length>0&&(f=g[g.length-1].persistentId),this.logger.info(`Level at TP start/resume: ${e}/${f}`)(),f}get level(){var e;return null===(e=this.levelInfo)||void 0===e?void 0:e.persistentId}set level(e){const t=this.hls;if(!this.validLevels)return;let i=this.getLevelWithPersistentId(e).levelInfo;i&&this.doesLevelMatchIframeMode(i)?this.setLevelInternal(i):t.trigger(r.b.INTERNAL_ERROR,{type:s.g.OTHER_ERROR,details:s.d.LEVEL_SWITCH_ERROR,level:e,fatal:!1,reason:"invalid level idx, or level doesnt match iframe mode",response:s.f.CantSwitchInTime})}setLevelInternal(e){const t=this.hls;let i=!1,s=this.levelInfo;if(!1===this.isSameLevel(s,e)){let a=null==s?void 0:s.persistentId,n=null==s?void 0:s.bitrate,o=null==s?void 0:s.audioGroupId,l=null==s?void 0:s.subtitleGroupId;this.logger.info(`switching from ${a}:${n}:${o}:${l} to level ${e.persistentId}:${e.bitrate}:${e.audioGroupId}:${e.subtitleGroupId}`)(),i=$s.isSwitchUp(s,e),this._levelInfo$.next(e),t.trigger(r.b.LEVEL_SWITCHING,e)}i&&(this.logger.info(`Switching up to a new level: ${e.persistentId} attemptSafeNextLevelSwitch`)(),this.hls.streamController.attemptSafeNextLevelSwitch(s,e))}loadPlaylistInternal(e){return this.playlistLoader.loadLevel(e.url,e.persistentId).pipe(We(t=>{let i=this.variantManager.getVariantInfoIfValid(e.persistentId);void 0!==i&&i.iframes&&this.addToLoadedLevels(i.persistentId),this.hls.trigger(r.b.LEVEL_LOADED,t),this.hls.bandwidthHistoryController.samplePlayList(t.stats)}))}_attemptRetry(e,t){}get manualLevel(){return this._manualLevel}set manualLevel(e){this._manualLevel=e,void 0!==this._startLevel||this.hls.iframeMode||-1===e||(this._startLevel=e),-1!==e&&(this.level=e)}get firstLevel(){return this.variantManager?this.variantManager.startingId:NaN}get startLevel(){if(void 0===this._startLevel){let e=this.hls.config.startLevel;return void 0!==e?e:this.firstLevel}return this._startLevel}set startLevel(e){this._startLevel=e}levelIsExpired(e){let t=this.hls.media;return t&&t.readyState&&e.fragments.length>0&&e.live&&e.PTSKnown&&e.fragments[0].start+e.totalduration<t.currentTime}get nextLoadLevel(){if(-1!==this._manualLevel)return this._manualLevel;if(this.hls.iframeMode&&this._loadediframeLevelIds.length>0){let e=this.hls.nextAutoLevel,t=this._loadediframeLevelIds.find((function(t){return t<=e}));return void 0!==t?t:e}return this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,-1===this._manualLevel&&(this.hls.nextAutoLevel=e)}getLowerAutoLevel(e){let t;for(let i=e-1;i>=0;i--)if(this.doesLevelMatchIframeMode(this.validLevels[i])&&ko.hasAllowedHost(this.validLevels[i].url,this.hls.preferredHostName)){t=this.validLevels[i].persistentId;break}return t}setNextAutoVariant(e){this.hls.nextAutoLevel=e}getNextBestAutoVariant(e,t){if(!this.variantManager)return;if(t=t||this.hls.preferredHostName,!this.doesLevelMatchIframeMode(this.variantManager.getVariantInfo(e)))return this.logger.warn("getNextBestAutoVariant: non-matching i-frame mode, using current level")(),this.currentVariantId;let i=this.variantManager.getVariantListPosition(e),r=this.getLowerAutoLevel(i);if("number"!=typeof r)for(let e=i+1;e<this.validLevels.length;++e){let i=this.validLevels[e];if(this.doesLevelMatchIframeMode(i)&&ko.hasAllowedHost(i.url,t)){r=this.validLevels[e].persistentId;break}}return r}onPreferredHostChanged(e){if(e.mediaType===Wr.VIDEO||!Object(ke.c)(this.level)||0===this.variantManager.variantList.length)return;let t,i=this.variantManager.getVariantInfo(this.level);(t=this.variantManager.validVariantList.find(e=>e.bandwidth===i.bandwidth&&ko.hasAllowedHost(e.url,this.hls.preferredHostName)))&&(this.logger.warn("preemptively switching video host to "+this.hls.preferredHostName)(),this.level=t.persistentId)}resetAndLoadSDRLevels(){try{this.logger.info("Falling back to SDR")(),this.setHDRMode(!1,!0)}catch(e){return!1}return!0}}var Vs,Gs,Hs=$s;!(function(e){e[e.DoNothing=0]="DoNothing",e[e.SendEndCallback=1]="SendEndCallback",e[e.SendAlternateToPenaltyBox=2]="SendAlternateToPenaltyBox",e[e.RemoveAlternatePermanently=3]="RemoveAlternatePermanently",e[e.InsertDiscontinuity=4]="InsertDiscontinuity",e[e.RetryRequest=5]="RetryRequest",e[e.DefaultToSDR=6]="DefaultToSDR",e[e.AbortRequest=7]="AbortRequest",e[e.RemoveAllMatchingHDCPLevelsPermanently=8]="RemoveAllMatchingHDCPLevelsPermanently"})(Vs||(Vs={})),(function(e){e[e.MoveAllAlternatesMatchingHost=2]="MoveAllAlternatesMatchingHost"})(Gs||(Gs={}));var Ks=class extends cs{constructor(e){super(e,r.a.FRAG_LOADED),this.hls=e,this.consecutiveSendAlternateToPenaltyBox=new Map,this.consecutiveSendAlternateToPenaltyBox.set(Wr.VIDEO,{val:0}),this.consecutiveSendAlternateToPenaltyBox.set(Wr.AUDIO,{val:0}),this.consecutiveSendAlternateToPenaltyBox.set(Wr.SUBTITLE,{val:0})}destroy(){super.destroy()}_modifyErrorActionIfLastValidVariantInternal(e,t){switch(e){case Vs.SendAlternateToPenaltyBox:e=Vs.RetryRequest,401!==t&&403!==t&&407!==t&&t!==s.f.CorruptStream.code||(e=Vs.SendEndCallback);break;case Vs.RemoveAlternatePermanently:e=Vs.SendEndCallback}return e}_shouldFindAlternateHost(e){return this.hls.hasFallBack()&&0!=(e.errorActionFlags&Gs.MoveAllAlternatesMatchingHost)}_modifyActionForSwitchingHosts(e,t){let{errorAction:i,errorActionFlags:r}=e,s=this.hls.preferredHostName;if(this._shouldFindAlternateHost(e)){let e=this._findAlternateHost(t.variantManager,t.currentVariantId);s=(null==e?void 0:e.hostName)||s,this.logger.info("[errorHandling] candidate hostName="+s)(),s===this.hls.preferredHostName&&(r&=~Gs.MoveAllAlternatesMatchingHost)}return{errorAction:i,errorActionFlags:r,containsFallbackVariant:t.containsFallbackVariant(s)}}modifyErrorActionIfCurrentLevelIsLastValidLevel(e,t,i,r){let{errorAction:s,errorActionFlags:a,containsFallbackVariant:n}=this._modifyActionForSwitchingHosts(e,i),o=e.errorAction;if(!n){if(s=this._modifyErrorActionIfLastValidVariantInternal(s,t),r&&i instanceof Hs){let e=i.isCurrentLevelNonSDR(),t=this.hls.hasPlaybackEverStarted;r&&!t&&e&&(s=Vs.DefaultToSDR)}a=0,this.logger.info(`fallbackVariantAvailable ${n} changing action from ${o} to ${s}`)()}return{errorAction:s,errorActionFlags:a}}_modifyErrorActionIfCurrentLevelIsLastValidiFrameLevel(e,t){let{errorAction:i,errorActionFlags:r,containsFallbackVariant:s}=this._modifyActionForSwitchingHosts(e,t);return s||(i=Vs.AbortRequest,r=0),{errorAction:i,errorActionFlags:r}}_getActionForCommonNetworkError(e){let t,i;switch(e){case 500:case 502:case 503:case 504:case 404:case 409:case 401:case 403:case 407:case 0:case-12888:case-12884:t=Vs.SendAlternateToPenaltyBox,i=Gs.MoveAllAlternatesMatchingHost;break;case 410:t=Vs.RemoveAlternatePermanently,i=Gs.MoveAllAlternatesMatchingHost;break;default:t=Vs.SendAlternateToPenaltyBox,i=0}return{errorAction:t,errorActionFlags:i}}_findAlternateHost(e,t){let i,r,s=this.hls.preferredHostName,a=e.validVariantList,n=e.getVariantInfoIfValid(t);for(let e=0;e<a.length;e++){let t=a[e],o=Ne.getHostName(t.url);if(s!==o&&this.hls.isValidCDN(o)&&(ts(n)&&ts(t)&&n.bandwidth===t.bandwidth||es(n)&&es(t)&&n.persistentID===t.persistentID)){i=t,r=o;break}}return i?{hostName:r,candidateVariantId:hs.getUniqueId(i)}:null}_modifyActionOnTimeout(e,t,i){let{errorAction:r,errorActionFlags:a}=t;switch(e.details){case s.d.LEVEL_LOAD_TIMEOUT:case s.d.AUDIO_TRACK_LOAD_TIMEOUT:case s.d.SUBTITLE_TRACK_LOAD_TIMEOUT:case s.d.FRAG_LOAD_TIMEOUT:{let t=this._getMediaTypeFourCC(e),s=this.consecutiveSendAlternateToPenaltyBox.get(t);!i&&++s.val>=this.hls.config.maxNumAddLevelToPenaltyBox&&(this.logger.warn("Hit max consecutive penalty due to timeout count: "+e.details)(),r=Vs.SendEndCallback);break}}return{errorAction:r,errorActionFlags:a}}getActionForManifestError(e){let{errorAction:t,errorActionFlags:i}=this._getActionForCommonNetworkError(e.response.code);return t=this._modifyErrorActionIfLastValidVariantInternal(t),i=0,this.logger.info("Manifest error "+t)(),{errorAction:t,errorActionFlags:i}}getActionForPlaylistNetworkError(e,t,i){let r=e.response.code,a=e.details,n=this._getActionForCommonNetworkError(r);if(i)n.errorActionFlags&=~Gs.MoveAllAlternatesMatchingHost;else{let e=a===s.d.LEVEL_LOAD_ERROR||a===s.d.LEVEL_LOAD_TIMEOUT;n=this.hls.iframeMode?this._modifyErrorActionIfCurrentLevelIsLastValidiFrameLevel(n,t):this.modifyErrorActionIfCurrentLevelIsLastValidLevel(n,r,t,e)}return n=this._modifyActionOnTimeout(e,n,i),this.logger.info(`[${e.type}] Got playlist error ${r} ${e.message} ${JSON.stringify(n)}`)(),n}getActionForMediaFragNetworkError(e,t,i){var r;let s=e.response.code,a=e.frag,n=this._getActionForCommonNetworkError(s);if(i)n.errorActionFlags&=~Gs.MoveAllAlternatesMatchingHost;else if("main"===a.type&&this.hls.iframeMode)n=this._modifyErrorActionIfCurrentLevelIsLastValidiFrameLevel(n,t);else{let e="main"===a.type;n=this.modifyErrorActionIfCurrentLevelIsLastValidLevel(n,s,t,e)}return n=this._modifyActionOnTimeout(e,n,i),this.logger.info(`[${null===(r=e.frag)||void 0===r?void 0:r.type}] Got fragment error ${s} ${e.message} prefetch=${i} ${JSON.stringify(n)}`)(),n}getActionForCryptKeyNetworkError(e,t,i,r){let s,a=Boolean(!e.stats||e.stats.isOkToRetry),n=Boolean(e.keyErrorReason&&e.keyErrorReason===jr.OutputRestricted),o=Vs.DoNothing;return o=n?Vs.RemoveAllMatchingHDCPLevelsPermanently:a?i?Vs.SendAlternateToPenaltyBox:(s=this._getActionForCommonNetworkError(e.response.code)).errorAction:Vs.RemoveAlternatePermanently,t&&!r&&(o=this._modifyErrorActionIfLastValidVariantInternal(o)),this.logger.info(`[Keys] Got crypt key error isCurrentLevel=${t} isTimeout=${i} hasFallback=${r}, errorAction ${o}`)(),{errorAction:o,errorActionFlags:0}}getActionForSessionDataNetworkError(){return Vs.DoNothing}_handleMoveMatchingHostFlag(e,t,i){t.moveAllMatchingHostsToPenaltyBoxOrRemovePermanently(e,i);let s=this._findAlternateHost(t,e),a=this.hls.preferredHostName;if(this.hls.removeCDNFromWhiteList(a),s){let{candidateVariantId:e,hostName:i}=s;return this.logger.warn(`Backup host found, switching from ${a} to ${i}`)(),this.hls.preferredHostName=i,this.hls.trigger(r.a.PREFERRED_HOST_CHANGED,{mediaType:t.getMediaType()}),e}return NaN}handleNetworkError(e,t,i,r,a,n,o){let l,d=!0,h=i.details;switch(Object(ke.c)(r)||h===s.d.MANIFEST_LOAD_ERROR||this.logger.warn(`invalid variantId:${r}, could be ignoring error details:${h}`)(),e){case Vs.RemoveAlternatePermanently:case Vs.SendAlternateToPenaltyBox:{if(!Object(ke.c)(r))break;let i=n.getVariantInfoIfValid(r);if(!i){this.logger.warn(`handleNetworkError: ${r} not valid`)();break}let s,a=this._shouldFindAlternateHost({errorAction:e,errorActionFlags:t});!yt.isCustomUrl(i.url)&&a&&(s=this._handleMoveMatchingHostFlag(r,n,e===Vs.RemoveAlternatePermanently)),Object(ke.c)(s)||(s=o.getNextBestAutoVariant(r)),e===Vs.RemoveAlternatePermanently?n.removeLevelPermanently(r):n.addLevelToPenaltyBox(r),this.logger.info("setting nextAutoVariant to "+s)(),o.setNextAutoVariant(s),this.hls.iframeMode&&(o.manualLevel=s);break}case Vs.RemoveAllMatchingHDCPLevelsPermanently:Object(ke.c)(r)&&n.removeAllMatchingHDCPLevelsPermanently(r);break;case Vs.RetryRequest:a?l=a():d=!1;break;case Vs.AbortRequest:d=!1;break;case Vs.SendEndCallback:i.fatal=!0;break;case Vs.DefaultToSDR:if(!(d=o.resetAndLoadSDRLevels())){let e=new s.h(s.g.OTHER_ERROR,s.d.INTERNAL_EXCEPTION,!0,"no valid alternates found in fallback");e.response=s.f.NoValidAlternates,this.hls.upgradeInternalErrorIfNecessary(e),d=!0}break;case Vs.DoNothing:default:d=!1}return{errorHandled:d,retryPromise:l}}_getMediaTypeFourCC(e){let t,i;switch("frag"in e?i=e.frag.type:"loaderType"in e&&(i=e.loaderType),i){case"level":case"main":t=Wr.VIDEO;break;case"audioTrack":case"audio":t=Wr.AUDIO;break;case"subtitleTrack":case"subtitle":t=Wr.SUBTITLE;break;default:t=Wr.UNKNOWN}return t}onFragLoaded(e){let t=this._getMediaTypeFourCC(e);this.consecutiveSendAlternateToPenaltyBox.get(t).val=0}};function js(e,t){return!e.url||yt.isCustomUrl(e.url)?t.customURL:t.default}function Ws(e,t,i,r){return a=>a.pipe(se(a=>a.pipe(fe((a,n)=>(function(e,t,i,r,a,n){let o,l,d=NaN;if(!(e instanceof s.o))return Be(e);e instanceof s.m?(d=e.frag.level,o=a.getActionForMediaFragNetworkError(e,n,r),l=e.isTimeout):e instanceof s.s&&(d=e.variantId,l=e.isTimeout,o="manifest"===e.loaderType?a.getActionForManifestError(e):a.getActionForPlaylistNetworkError(e,n,r));let h=l?i.timeoutRetry:i.errorRetry;if((null==o?void 0:o.errorAction)===Vs.RetryRequest){if(t<h.maxNumRetry)return X(Math.min(h.maxRetryDelayMs,Math.pow(2,t)*h.retryDelayMs));e.fatal=!0}else o&&a.handleNetworkError(o.errorAction,o.errorActionFlags,e,d,void 0,n.variantManager,n);return Be(e)})(a,n,e,t,i,r)))))}const qs="com.apple.hls.other-tags",zs={"com.apple.hls.chapters":!0},Xs=-1;class Qs{constructor(e){this.hls=e,this.logger=e.logger}loadSessionData(e){let t=ct,i=(null==e?void 0:e.itemList)||[];for(let e of i){let i=e["DATA-ID"];if(e.URI&&zs[i]){let s=Fe.buildAbsoluteURL(this.hls.baseurl,e.URI,{alwaysNormalize:!0}),a="";e.VALUE=null,t=t.pipe(Ie(()=>this.loadSessionDataItemWithURL(s,i,a).pipe(Se(e=>(this.hls.trigger(r.b.INTERNAL_ERROR,e),ct)))))}}return this.hls.trigger(r.b.SESSION_DATA_LOADING,{sessionData:e}),t.pipe(We(()=>{if(!(function(e){if(!e.complete&&e.itemList){e.complete=!0;for(let t=0;t<e.itemList.length;++t){let i=e.itemList[t];if(zs[i["DATA-ID"]]&&!i.VALUE&&!i._STATUS){e.complete=!1;break}}e.complete}return e.complete})(e))throw new s.h(s.g.OTHER_ERROR,s.d.INTERNAL_EXCEPTION,!1,"Session data not complete after loading all items");this.hls.trigger(r.b.SESSION_DATA_COMPLETE,{})}),Se(e=>{throw this.hls.trigger(r.b.INTERNAL_ERROR,e),e}),dt(()=>{}))}loadSessionDataItemWithURL(e,t,i){let r,a=this.hls.config,n=yt.isCustomUrl(e)?new yt(this.hls):new a.loader(a);n.overrideMimeType("application/xml"),r={type:"session",url:e,id:t,responseType:i,sessionID:a.useHTTPPlaybackSessionId?this.hls.sessionID:void 0};let o=js({url:e},a.fragLoadPolicy);return n.load(r,o).pipe(ae(e=>{this.onLoadSuccess(t,e.response,n.responseXML())}),Se(e=>{if(e instanceof j)throw new s.p(s.d.SESSION_DATA_LOAD_ERROR,!1,e.message,0,!1);throw e instanceof Ce&&(e=new s.p(s.d.SESSION_DATA_LOAD_ERROR,!1,e.message,e.code,!1),this.onLoadError(t,e)),e}))}onLoadSuccess(e,t,i){let r,s=this.hls,a=t.data,n=null;if(Qs.stringIsXMLPlist(a)&&(n=i))r=Qs.convertPlisttoJSON(n),this.setSessionData(s.sessionData,e,"VALUE",r);else if(Qs.stringIsJSONPlist(a))try{r=JSON.parse(a),this.setSessionData(s.sessionData,e,"VALUE",r)}catch(t){this.setSessionData(s.sessionData,e,"VALUE",a),this.setSessionData(s.sessionData,e,"_STATUS",Xs)}else this.setSessionData(s.sessionData,e,"VALUE",a)}onLoadError(e,t){this.setSessionData(this.hls.sessionData,e,"_STATUS",t.response.code)}setSessionData(e,t,i,r){if(e.itemList){let s;for(s=0;s<e.itemList.length;++s){let a=e.itemList[s];if(a["DATA-ID"]===t){a[i]=r;break}}e.itemList.length}}static stringIsXMLPlist(e){const t=/[\s]*<\?xml/i;let i,r;return t.lastIndex=0,(i=t.exec(e))||(r=/[\s]*<plist/i.exec(e)),i||r}static stringIsJSONPlist(e){const t=/[\s]*[\{\[]/;return t.lastIndex=0,null!=t.exec(e)}static convertPlisttoJSON(e){var t=null,i=e.childNodes;if(i)if(e.tagName){if("plist"===e.tagName.toLowerCase()){t=[];for(let e=0;e<i.length;++e){let r=i[e];r.tagName&&t.push(Qs.convertPlisttoJSON(r))}1===t.length&&(t=t[0])}if("array"===e.tagName.toLowerCase()){t=[];for(let e=0;e<i.length;++e){let r=i[e];r.tagName&&t.push(Qs.convertPlisttoJSON(r))}}if("dict"===e.tagName.toLowerCase()){var r,s,a=0;t={};for(let e=0;e<i.length;e++)i[e].tagName&&(a%2==0?"key"===i[e].tagName.toLowerCase()&&(r=Qs.convertPlisttoJSON(i[e]),a++):(s=Qs.convertPlisttoJSON(i[e]),t[r]=s,r=null,s=null,a++));r&&(t[r]=s,r=null,s=null)}else"key"===e.tagName.toLowerCase()||"string"===e.tagName.toLowerCase()?t=i[0]?i[0].nodeValue:null:"integer"===e.tagName.toLowerCase()?t=i[0]?parseInt(i[0].nodeValue):0:"float"===e.tagName.toLowerCase()?t=i[0]?parseFloat(i[0].nodeValue):0:"date"===e.tagName.toLowerCase()?t=i[0]?new Date(i[0].nodeValue):null:"data"===e.tagName.toLowerCase()?t=i[0]?atob(i[0].nodeValue):null:"true"===e.tagName.toLowerCase()?t=!0:"false"===e.tagName.toLowerCase()&&(t=!1)}else if(0===i.length);else{t=[];for(let e=0;e<i.length;++e){let r=i[e];r.tagName&&t.push(Qs.convertPlisttoJSON(r))}1===t.length&&(t=t[0])}return t}}const Ys=/^(\d+)x(\d+)$/,Js=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;class Zs{constructor(e){this.validTags=e}isKey(e){return e in this.validTags}trySetValue(e,t,i){return!!this.isKey(e)&&(i[e]=this.parseFunc(t),!0)}}class ea{static parseTags(e){let t,i={};if(!e)return i;for(Js.lastIndex=0;null!==(t=Js.exec(e));){const e=t[1].toUpperCase(),r='"';let s=t[2];0===s.indexOf(r)&&s.lastIndexOf(r)===s.length-1&&(s=s.slice(1,-1));for(let t of ea.tagParsers)if(t.trySetValue(e,s,i))break}return i}}ea.tagParsers=[new class extends Zs{parseFunc(e){return e}}({NAME:"",TYPE:"",DEFAULT:"",AUTOSELECT:"",FORCED:"",LANGUAGE:"",URI:"",AUDIO:"","VIDEO-RANGE":"","CLOSED-CAPTIONS":"",CODECS:"",BYTERANGE:"","INSTREAM-ID":"","GROUP-ID":"",CHANNELS:"",CHARACTERISTICS:"",KEYFORMAT:"",KEYFORMATVERSIONS:"","DATA-ID":"",VALUE:"",METHOD:"","HDCP-LEVEL":"","ALLOWED-CPC":"",SUBTITLES:"",ID:"",CLASS:"","START-DATE":"","END-DATE":"","END-ON-NEXT":"","SCTE35-CMD":"","SCTE35-OUT":"","SCTE35-IN":""}),new class extends Zs{parseFunc(e){let t=parseInt(e);return t>Number.MAX_SAFE_INTEGER?1/0:t}}({BANDWIDTH:NaN,"AVERAGE-BANDWIDTH":NaN}),new class extends Zs{constructor(){super(...arguments),this.parseFunc=parseFloat}}({"TIME-OFFSET":NaN,"FRAME-RATE":NaN,SCORE:NaN,DURATION:NaN,"PLANNED-DURATION":NaN}),new class extends Zs{parseFunc(e){let t=(e||"0x").slice(2);t=(1&t.length?"0":"")+t;const i=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++){let r=parseInt(t.slice(2*e,2*e+2),16);if(!Object(ke.c)(r))return;i[e]=r}return i}}({IV:null}),new class extends Zs{parseFunc(e){const t=Ys.exec(e);let i;return null!==t&&(i={width:parseInt(t[1],10),height:parseInt(t[2],10)}),i}}({RESOLUTION:null})];const ta=/{\$(.*?)}/g,ia=/#EXTINF:(\d*(?:\.\d+)?)(?:,(.*))?|(?!#)(\S.+)|#EXT-X-BYTERANGE: *(.+)|#EXT-X-PROGRAM-DATE-TIME:(.+)|#EXT-X-BITRATE:(.+)|#EXT-X-DATERANGE:(.+)|#.*/g,ra=/(?:(?:#(EXTM3U))|(?:#EXT-X-(PLAYLIST-TYPE):(.+))|(?:#EXT-X-(MEDIA-SEQUENCE): *(\d+))|(?:#EXT-X-(TARGETDURATION): *(\d+))|(?:#EXT-X-(KEY):(.+))|(?:#EXT-X-(START):(.+))|(?:#EXT-X-(ENDLIST))|(?:#EXT-X-(DISCONTINUITY-SEQ)UENCE:(\d+))|(?:#EXT-X-(DIS)CONTINUITY))|(?:#EXT-X-(VERSION):(\d+))|(?:#EXT-X-(MAP):(.+))|(?:#EXT-X-(I-FRAMES)-ONLY)|(?:#EXT-X-(DEFINE):(.+))|(?:(#)(.*):(.*))|(?:(#)(.*))(?:.*)\r?\n?/,sa=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)|#EXT-X-I-FRAME-STREAM-INF:([^\r\n]+)|#EXT-X-DEFINE:([^\n\r]*)/g,aa=/#EXT-X-MEDIA:(.*)/g,na=/#EXT-X-SESSION-DATA[^:]*:(.*)/g,oa=/(NAME|VALUE)=\"(.*)\",(NAME|VALUE)=\"(.*)\"|(IMPORT)=\"(.*)\"/;let la=function(e,t,i){return Ne.buildAbsoluteURL(t,e,{alwaysNormalize:!0,inheritQuery:i})},da=function(e){return e?e.split(/\s*,\s*/):new Array},ha=function(e,t,i){if(void 0===e)return-1;let r=e.MediaSelectionGroupOptions,s=r.find((function(e){return e.MediaSelectionOptionsMediaType===t.mediaType&&e.MediaSelectionOptionsName===t.name&&e.MediaSelectionOptionsExtendedLanguageTag===t.lang}));return s||(s={MediaSelectionOptionsMediaType:t.mediaType,MediaSelectionOptionsExtendedLanguageTag:t.lang,MediaSelectionOptionsIsDefault:t.default,MediaSelectionOptionsName:t.name,MediaSelectionOptionsPersistentID:i,MediaSelectionOptionsTaggedMediaCharacteristics:t.characteristics},t.mediaType===Wr.SUBTITLE&&(s.MediaSelectionOptionsDisplaysNonForcedSubtitles=t.forced?qr.NO:qr.YES),i++,r.push(s)),t.persistentID=s.MediaSelectionOptionsPersistentID,i},ca=function(e){let t,i=e.split(".");return i.length>2?(t=i.shift()+".",t+=parseInt(i.shift()).toString(16),t+=("000"+parseInt(i.shift()).toString(16)).substr(-4)):t=e,t},ua=function(e){let t;try{t=JSON.parse(vt.a.base64DecodeToStr(e))}catch(i){Ae.b.error(`Error ${i} decoding metadata value: '${e}'`)(),t=e}return t},fa=function(e,t){let i,r=!1;return e&&t&&(i=e.replace(ta,(function(e){ta.lastIndex=0;let i=ta.exec(e)[1];if(i&&t.hasOwnProperty(i))return t[i];r=!0}))),{updatedString:i,error:r}};const ga=e=>"DATA-ID"in e;class pa{constructor(e,t,i){this.config=e,this.registerProgramDateTime=i,this._masterVariableList={},this.itemId=t}destroy(){this._masterVariableList={}}get query(){return this.inheritQuery}set query(e){this.inheritQuery=e}static isValidPlaylist(e){return 0===e.indexOf("#EXTM3U")}static isMediaPlaylist(e){return e.indexOf("#EXTINF:")>0||e.indexOf("#EXT-X-PLAYLIST-TYPE:")>0}_shouldSelectKeyTag(e,t){return"AES-128"===t||"NONE"===t||void 0===this.config||void 0===this.config.keySystemPreference||e===Nr.getKeySystemFormat(this.config.keySystemPreference)}_addDefaultClosedCaptionOption(e,t,i){let r={id:0,mediaType:Wr.CLOSEDCAPTION,inStreamID:"CC1",groupId:"cc",name:"English-CC",type:"CLOSED-CAPTIONS",default:!1,autoselect:!1,forced:!1,lang:"en",characteristics:["public.accessibility.transcribes-spoken-dialog","public.accessibility.describes-music-and-sound"],persistentID:i,unchangedLevelCount:0};e.push(r),ha(t,r,i)}optOutClosedCaption(e){let t=!1,i=!1;if(e)for(let r=0;r<e.length;++r){let s=e[r];if(s.videoCodec&&(i=!0,!0!==s.iframes&&s.closedcaption&&"none"===s.closedcaption.toLowerCase())){t=!0;break}}return!i||t}parseMasterPlaylistMedia(e,t,i){let r,a,n={MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.audible"],MediaSelectionGroupMediaType:Wr.AUDIO,MediaSelectionGroupOptions:[]},o={MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.legible"],MediaSelectionGroupMediaType:Wr.SUBTITLE,MediaSelectionGroupOptions:[]},l={videoTracks:[],audioTracks:[],subtitleTracks:[],audioMediaSelectionGroup:n,subtitleMediaSelectionGroup:o},d=0;for(aa.lastIndex=0;null!=(r=aa.exec(e));){let e=fa(r[1],this._masterVariableList);if(e.error){a=new s.t(s.g.MEDIA_ERROR,s.d.LEVEL_LOAD_ERROR,!0,"encountered undefined/not imported EXT-X-DEFINE property",s.f.FormatError);break}let h,c,u,f,g=ea.parseTags(e.updatedString),p=Wr.UNKNOWN,m=da(g.CHARACTERISTICS),y=g["GROUP-ID"],v=g.CHANNELS;switch(g.TYPE){case"VIDEO":p=Wr.VIDEO,c=l.videoTracks;break;case"AUDIO":p=Wr.AUDIO,c=l.audioTracks,u=n;let e=i.find((function(e){return e.audioGroupId===y}));f=e?e.audioCodecList:[];break;case"SUBTITLES":p=Wr.SUBTITLE,c=l.subtitleTracks,u=o;break;case"CLOSED-CAPTIONS":p=Wr.CLOSEDCAPTION,h=g["INSTREAM-ID"],c=l.subtitleTracks,u=o}let b={mediaType:p,groupId:y,channels:v,groupCodecList:f,name:g.NAME,type:g.TYPE,default:"YES"===g.DEFAULT,autoselect:"YES"===g.AUTOSELECT,forced:"YES"===g.FORCED,characteristics:m,persistentID:d,id:c?c.length:0,lang:xt.shortenLanguageCode(g.LANGUAGE),unchangedLevelCount:0};g.URI&&(b.url=la(g.URI,t,this.inheritQuery)),b.name||(b.name=b.lang,b.mediaType===Wr.CLOSEDCAPTION&&(b.name+=" CC")),b.mediaType===Wr.CLOSEDCAPTION&&h&&(b.inStreamID=h),c&&(b.id=c.length,c.push(b)),d=ha(u,b,d)}return 0!==l.subtitleTracks.length||this.optOutClosedCaption(i)||this._addDefaultClosedCaptionOption(l.subtitleTracks,o,d),{parsedMasterPlaylistMedia:l,playlistParsingError:a}}static parseSessionData(e,t){let i,r=[],s=new Set;for(na.lastIndex=0;null!=(i=na.exec(e));){let e,t=ea.parseTags(i[1]);t.LANGUAGE=xt.shortenLanguageCode(t.LANGUAGE),e=t.LANGUAGE?t["DATA-ID"]+"|"+t.LANGUAGE:void 0,ga(t)?e&&s.has(e)||(t["DATA-ID"]===qs&&(t.VALUE=ua(t.VALUE)),r.push(t),e&&s.add(e)):Ae.b.error(`Error processing DATA-ID ${t["DATA-ID"]} and LANGUAGE ${t.LANGUAGE}`)()}return{itemList:r,baseUrl:t}}parseLevelPlaylist(e,t,i,r,a){let n,o,l,d,h,c,u=0,f=0,g={type:"",version:0,url:i,initSegments:{},fragments:[],live:!0,startSN:0,endSN:0,iframesOnly:!1,targetduration:0,totalduration:0,averagetargetduration:0},p=new Ct("NONE",i,null,null,null),m=!1,y=!1,v=0,b=null,S=new Ft(this.inheritQuery),T=0,E={},_=!0,D=!0,I=Object(ke.c)(e)?e:0;ia.lastIndex=0;let w=()=>new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_PARSING_ERROR,!0,"Invalid key system preference for the playlist",s.f.IncompatibleAsset);for(;null!==(n=ia.exec(t));){const e=n[1];if(e){S.duration=parseFloat(e);const t=(" "+n[2]).slice(1);S.title=t||null,S.tagList.push(t?["INF",e,t]:["INF",e])}else if(n[3]){if(Object(ke.c)(S.duration)){const e=u++;if(S.type=a,S.start=f+I,S.levelkey=p,y&&!m){h=w();break}if(m=!1,y=!1,S.sn=e,S.level=r,S.cc=v,S.iframe=g.iframesOnly,S.baseurl=i,(d=fa((" "+n[3]).slice(1),E)).error){h=new s.t(s.g.MEDIA_ERROR,s.d.LEVEL_LOAD_ERROR,!0,"encountered undefined/not imported EXT-X-DEFINE property",s.f.FormatError);break}if(S.relurl=d.updatedString,S.bitrate=Object(ke.c)(S.byteRangeEndOffset)?8*(S.byteRangeEndOffset-S.byteRangeStartOffset)/S.duration:T,S.rawProgramDateTime?(this.registerProgramDateTime(S.rawProgramDateTime,S.start),l=null):l&&(S.rawProgramDateTime=l,S.tagList.push(["PROGRAM-DATE-TIME",S.rawProgramDateTime]),this.registerProgramDateTime(S.rawProgramDateTime,S.start),l=null),g.fragments.push(S),b=S,f+=S.duration,_||!g.initSegments[v]||D){if(g.iframesOnly&&S.byteRangeStartOffset>0&&!g.initSegments[v]&&!D){let e=new Ft(this.inheritQuery);if(e.url=S.url,e.rawByteRange=Math.min(S.byteRangeStartOffset,1316)+"@0",e.baseurl=i,e.level=r,e.type=a,e.sn="initSegment",e.cc=v,e.decryptdata=p,e.iframe=!0,y&&!m){h=w();break}m=!1,y=!1,g.initSegments[v]=e,Ae.b.info("generated implicit initSegment in cc "+v)()}else if(c){let e=Object.assign(new Ft(this.inheritQuery),c);e.cc=v,Ae.b.info(`assume initSegment from ${c.cc} in cc ${v}`)(),c=g.initSegments[v]=e}_=!1,D=!1}S=new Ft(this.inheritQuery)}}else if(n[4]){if(S.rawByteRange=(" "+n[4]).slice(1),b){const e=b.byteRangeEndOffset;e&&(S.lastByteRangeEndOffset=e)}}else if(n[5])S.rawProgramDateTime=(" "+n[5]).slice(1),S.tagList.push(["PROGRAM-DATE-TIME",S.rawProgramDateTime]);else if(n[6]){let e=parseInt(n[6]);Object(ke.c)(e)&&(T=1e3*e)}else if(n[7]){n[7];let e=ea.parseTags(n[7]);e.ID&&(g.daterangeTags||(g.daterangeTags={}),g.daterangeTags[e.ID]=e)}else{for(n=n[0].match(ra),o=1;o<n.length&&void 0===n[o];o++);let e=fa((" "+n[o+1]).slice(1),E),t=fa((" "+n[o+2]).slice(1),E);if(e.error||t.error){h=new s.t(s.g.MEDIA_ERROR,s.d.LEVEL_LOAD_ERROR,!0,"encountered undefined/not imported EXT-X-DEFINE property",s.f.FormatError);break}const d=e.updatedString,f=t.updatedString;switch(n[o]){case"#":S.tagList.push(f?[d,f]:[d]);break;case"PLAYLIST-TYPE":g.type=d.toUpperCase(),"VOD"===g.type&&(g.live=!1);break;case"MEDIA-SEQUENCE":0===g.fragments.length?u=g.startSN=parseInt(d):Ae.b.warn(`Ignore MEDIA-SEQUENCE:${d} tag. Must appear before first fragment.`)();break;case"TARGETDURATION":g.targetduration=parseFloat(d);break;case"VERSION":g.version=parseInt(d);break;case"EXTM3U":break;case"ENDLIST":g.live=!1;break;case"DIS":v++,S.tagList.push(["DIS"]),_=!0;break;case"DISCONTINUITY-SEQ":v=parseInt(d);break;case"KEY":let e=d;y=!0;let t=ea.parseTags(e),o=t.METHOD in At?t.METHOD:void 0,b=t.URI,T=t.IV?t.IV:null,I=t.KEYFORMAT,R=(t.KEYFORMATVERSIONS?t.KEYFORMATVERSIONS:"1").split("/").map(Number).filter(isFinite);if(o)if(!m&&this._shouldSelectKeyTag(I,o)){let e;e=b?Ne.buildAbsoluteURL(i,b,{alwaysNormalize:!0}):i,p=new Ct(o,e,T,I,R),b&&t.IV&&!T&&((h=new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_PARSING_ERROR,!0,"Invalid IV: "+t.IV,s.f.PlaylistErrorInvalidEntry)).url=i),m=!0}else Ae.b.warn(`[Keys] Not selecting EXT-X-KEY tag : ${e}, IsKeySystemSelected: ${m}`)();else Ae.b.warn("Invalid EXT-X-KEY tag: "+e)();break;case"START":let A=d,k=ea.parseTags(A)["TIME-OFFSET"];Object(ke.c)(k)&&(g.startTimeOffset=k);break;case"I-FRAMES":g.iframesOnly=!0;break;case"MAP":let C=ea.parseTags(d);if(S.relurl=C.URI,S.rawByteRange=C.BYTERANGE,S.baseurl=i,S.level=r,S.type=a,S.sn="initSegment",S.levelkey=p,y&&!m){h=w();break}m=!1,y=!1,S.rawProgramDateTime&&(l=S.rawProgramDateTime),c=S,D=!0,S=new Ft(this.inheritQuery);break;case"DEFINE":let L=oa.exec(d),P="NAME"===L[1]?L[2]:L[4],M="VALUE"===L[1]?L[2]:L[4],x=L[5],O=L[6];if(P||M||"IMPORT"!==x||!this._masterVariableList.hasOwnProperty(O)){if(!P||x||L[1]===L[3]||E.hasOwnProperty(P)){h=new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_PARSING_ERROR,!0,"IMPORT references variable not in master playlist and/or NAME",s.f.FormatError);break}E[P]=M}else E[O]=this._masterVariableList[O];break;default:Ae.b.warn("line parsed but not handled: "+n)()}}S.itemId=this.itemId}return(S=b)&&!S.relurl&&(g.fragments.pop(),f-=S.duration),!g.live&&S&&(S.isLastFragment=!0),g.totalduration=f,g.averagetargetduration=f/g.fragments.length,g.endSN=u-1,{levelDetails:g,playlistParsingError:h}}parseMasterPlaylist(e,t){let i,r,a,n,o=[],l=!0;for(sa.lastIndex=0;null!=(i=sa.exec(e));)if(i[4]){let e="NAME"===(i=oa.exec(i[4]))[1]?i[2]:i[4],t="VALUE"===i[1]?i[2]:i[4],r=i[5];if(!e||this._masterVariableList.hasOwnProperty(e)||r||i[1]===i[3]){n=new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_PARSING_ERROR,!0,"invalid EXT-X-DEFINE tag in manifest",s.f.FormatError);break}this._masterVariableList[e]=t}else{a=fa(i[1]||i[3],this._masterVariableList);let e=ea.parseTags(a.updatedString);if(r=fa(i[2]||e.URI,this._masterVariableList),a.error||r.error){n=new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_PARSING_ERROR,!0,"manifest encountered undefined/not imported EXT-X-DEFINE property",s.f.FormatError);break}if(void 0!==e.SCORE&&!Object(ke.c)(e.SCORE)||e.SCORE<0){n=new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_PARSING_ERROR,!0,"manifest encountered negative/non-number SCORE property",s.f.FormatError),l=!1;break}l&&void 0===e.SCORE&&(Ae.b.warn("SCORE attribute missing in one of the levels, defaulting to bandwidth selection")(),l=!1);let h=e.BANDWIDTH,c=e["AVERAGE-BANDWIDTH"],u=c||h,f={persistentId:(u||0)+o.length%1e3/1e3,attrs:e,url:la(r.updatedString,t,this.inheritQuery),name:e.NAME,audioGroupId:e.AUDIO,subtitleGroupId:e.SUBTITLES,iframes:!!i[3],bandwidth:h,avgBandwidth:c,bitrate:u,videoRange:e["VIDEO-RANGE"]?e["VIDEO-RANGE"]:"SDR",frameRate:e["FRAME-RATE"],unchangedLevelCount:0,allowedCPCMap:pa.parseAllowedCPC(e["ALLOWED-CPC"]),closedcaption:e["CLOSED-CAPTIONS"],levelCodec:e.CODECS,score:e.SCORE},g=e["HDCP-LEVEL"];Zr(g)?f.hdcpLevel=g:Ae.b.warn("Unrecognized HDCP-LEVEL "+g)();let p=e.RESOLUTION;if(p&&(f.width=p.width,f.height=p.height),e.CODECS){f.videoCodecList=new Array,f.audioCodecList=new Array;let t=e.CODECS.split(/[ ,]+/);var d=t.length;for(let e=0;e<d;e++){const i=t[e];switch(i.slice(0,4)){case"avc1":f.videoCodec=ca(i),f.videoCodecList.push(f.videoCodec);break;case"avc3":case"dvav":case"dva1":case"hev1":case"hvc1":case"dvh1":case"dvhe":case"vp09":f.videoCodec=i,f.videoCodecList.push(f.videoCodec);break;case"mp4a":case"ec-3":case"ac-3":f.audioCodec=i,f.audioCodecList.push(f.audioCodec);break;default:Ae.b.warn("Unrecognized codec "+i)(),f.audioCodec=i,f.audioCodecList.push(f.audioCodec)}}f.audioCodecList.length>1&&(f.audioCodec=Es(f.audioCodecList)),f.videoCodecList.length>1&&(f.videoCodec=Ts(f.videoCodecList))}o.push(f)}return{levels:o,playlistParsingError:n,scoreAvailable:l}}static parseAllowedCPC(e){if("string"!=typeof e)return;let t=new Map;return e.split(",").forEach(e=>{let i,r,s=e.split(":");if(2===s.length)i=s[0].trim(),r=s[1].trim();else{if(!(s.length>2))return;r=s[s.length-1].trim(),s.pop(),i=s.join(":")}if(t.has(i))return;let a=new Array;""!==r&&(a=r.split("/").map(e=>e.trim())),t.set(i,a)}),t}}var ma=pa,ya=class{constructor(e){this.hls=e,this.logger=e.logger}destroy(){this.hls=void 0}_trigger(e,t){this.hls&&this.hls.trigger&&this.hls.trigger(e,t)}loadManifest(e,t,i){return this.hls?(this.playlistParser=new ma(this.hls.config,i,this.registerProgramDateTime.bind(this)),this.playlistParser.query=Boolean(t.inheritQuery),re(()=>(this._trigger(r.b.MANIFEST_LOADING,{url:e}),this.load({url:e,type:"manifest"}))).pipe(ae(e=>{if(e.isMediaPlaylist){let t=this.handleMediaPlaylist(e.url,e.stats,e.responseStr,"manifest",0);return t.isInitialMediaPlaylist=!0,this.hls.updatePlaylistAttributes(t),{levels:[{persistentId:0,url:e.url,details:t,iframes:t.iframesOnly,bandwidth:void 0,bitrate:void 0,name:void 0,unchangedLevelCount:0,levelCodec:void 0}],audioTracks:[],url:e.url,stats:e.stats,isMediaPlaylist:!0}}return this.handleMasterPlaylist(e.url,e.stats,e.responseStr)}),Se(e=>{throw this._trigger(r.b.INTERNAL_ERROR,e),e}))):Be(()=>new Error("loadManifest called without hls object"))}loadLevel(e,t){return re(()=>(this._trigger(r.b.LEVEL_LOADING,{url:e,level:t}),this.load({url:e,type:"level",level:t}))).pipe(ae(e=>{if(!e.isMediaPlaylist)throw new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_PARSING_ERROR,!1,"",s.f.PlaylistErrorInvalidEntry);let i=this.handleMediaPlaylist(e.url,e.stats,e.responseStr,"level",t),{playlistType:r}=this.hls.updatePlaylistAttributes(i);return{details:i,level:t,id:0,stats:e.stats,playlistType:r,livePlaylistUpdateError:!1}}),Se(e=>{throw this._trigger(r.b.INTERNAL_ERROR,e),e}))}loadAudioTrack(e,t){return re(()=>(this._trigger(r.b.AUDIO_TRACK_LOADING,{url:e,id:t}),this.load({url:e,type:"audioTrack",id:t}))).pipe(ae(e=>{if(!e.isMediaPlaylist)throw new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_PARSING_ERROR,!1,"",s.f.PlaylistErrorInvalidEntry);return{details:this.handleMediaPlaylist(e.url,e.stats,e.responseStr,"audioTrack",t),id:t,stats:e.stats}}),Se(e=>{throw this._trigger(r.b.INTERNAL_ERROR,e),e}))}loadSubtitleTrack(e,t){return re(()=>(this._trigger(r.b.SUBTITLE_TRACK_LOADING,{url:e,id:t}),this.load({url:e,type:"subtitleTrack",id:t}))).pipe(ae(e=>{if(!e.isMediaPlaylist)throw new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_PARSING_ERROR,!1,"",s.f.PlaylistErrorInvalidEntry);return{details:this.handleMediaPlaylist(e.url,e.stats,e.responseStr,"subtitleTrack",t),id:t,stats:e.stats}}),Se(e=>{throw this._trigger(r.b.INTERNAL_ERROR,e),e}))}load(e){let t,i=e.url,r=this.hls.config;switch(e.type){case"manifest":t=js(e,r.manifestLoadPolicy);break;case"level":case"audioTrack":case"subtitleTrack":t=js(e,r.playlistLoadPolicy),this.logger.info(`[QE Critical] loading playlist for ${e.type} ${e.level||e.id}`)();break;default:return void this.logger.warn("Load for unexpected type "+e.type)()}let s=yt.isCustomUrl(i)?new yt(this.hls):void 0!==r.pLoader?new r.pLoader(r):new r.loader(r);return e.sessionID=r.useHTTPPlaybackSessionId?this.hls.sessionID:void 0,e.url=i,e.responseType="",Ge(s.load(e,t),s.onProgress().pipe(ye(1),Ie(t=>(this.loadprogress(e,t.xhrReq),ie)))).pipe(ye(1),ae(t=>this.loadsuccess(t.response,t.stats,e)),Se(t=>{throw t instanceof j?t=this.loadtimeout(e):t instanceof Ce&&(t=this.loaderror(t,e)),t}))}get parsedSessionData(){return this.sessionData}registerProgramDateTime(e,t){this.hls.registerProgramDateTime&&this.hls.registerProgramDateTime(e,t)}loadsuccess(e,t,i){var r=e.data,a=e.url,n=i.type,o=i.level;if(this.hls,this.playlistParser,this.logger.info(`[QE Critical] [Playlist]loadsuccess url/type/level ${this.hls.redactUrl(a)}, ${n}, ${o}`)(),void 0!==a&&0!==a.indexOf("data:")||(a=i.url),t.tload=performance.now(),!ma.isValidPlaylist(r))throw new s.t(s.g.NETWORK_ERROR,s.d.MANIFEST_PARSING_ERROR,!0,"no EXTM3U delimiter",s.f.PlaylistErrorMissingEXTM3U);return{isMediaPlaylist:ma.isMediaPlaylist(r),stats:t,responseStr:r,url:a}}handleMediaPlaylist(e,t,i,a,n){const o=this.playlistParser;this.hls;let l=isNaN(this.hls.loadingItem.startTime)?0:this.hls.loadingItem.startTime;this.logger.info("shift playlist by "+l)();let d="audioTrack"===a?"audio":"subtitleTrack"===a?"subtitle":"main",h=o.parseLevelPlaylist(l,i,e,n,d),c=h.levelDetails,u=h.playlistParsingError;if(u)throw u;if(c.daterangeTags){const e={daterangeTags:c.daterangeTags};this._trigger(r.b.DATERANGE_UPDATED,e)}if(c.tload=t.tload,c.targetduration)return c.trequest=t.trequest,this.hls.loadingItem.totalduration=c.totalduration,c;{let t=new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_PARSING_ERROR,!0,"invalid targetduration",s.f.PlaylistErrorBadTargetDuration);throw t.url=e,t}}handleMasterPlaylist(e,t,i){let r=this.playlistParser,a=r.parseMasterPlaylist(i,e),n=a.levels,o=a.playlistParsingError;if(this.hls.hasScoreAvailable=a.scoreAvailable,o)throw o;if(this.sessionData=ma.parseSessionData(i,e),this.hls.baseurl=e,n.length){let s=r.parseMasterPlaylistMedia(i,e,n),a=s.parsedMasterPlaylistMedia,o=s.playlistParsingError;if(o)throw o;let l=a.audioTracks,d=a.subtitleTracks,h=a.audioMediaSelectionGroup,c=a.subtitleMediaSelectionGroup,u=!1;if(l.length){let e=!1;l.forEach(t=>{t.url||(e=!0)}),!1===e&&n[0].audioCodec&&!n[0].audioGroupId&&(this.logger.info("audio codec signaled in quality level, but no embedded audio track signaled, create one")(),l.unshift({type:"main",name:"main"}))}return{levels:n,audioTracks:l,subtitleTracks:d,url:e,stats:t,audioMediaSelectionGroup:h,subtitleMediaSelectionGroup:c,isMediaPlaylist:u}}throw(o=new s.t(s.g.MEDIA_ERROR,s.d.MANIFEST_PARSING_ERROR,!0,"no level found in manifest",s.f.PlaylistErrorInvalidEntry)).url=e,o}loaderror(e,t){let i;switch(t.type){case"level":i=t.level;break;case"audioTrack":case"subtitleTrack":i=t.id}return new s.s(!1,e.message,e.code,!1,t.type,t.url,i)}loadtimeout(e){const t=s.f.PlaylistNotReceived;let i;switch(e.type){case"level":i=e.level;break;case"audioTrack":case"subtitleTrack":i=e.id}return new s.s(!1,t.text,t.code,!0,e.type,e.url,i)}loadprogress(e,t){let i=t.response;if(t&&200===t.status&&(""===t.responseType||"text"===t.responseType)&&i&&i.length>10){if(!ma.isValidPlaylist(i)){this.logger.error("[Playlist] response doesn't have #EXTM3U tag")();let t=new s.t(s.g.NETWORK_ERROR,s.d.MANIFEST_PARSING_ERROR,!0,"response doesnt have #EXTM3U tag",s.f.PlaylistErrorMissingEXTM3U);throw t.url=e.url,t}this.logger.info("deregister for further progress updates")()}}},va=i(11);class ba{constructor(e,t){this.hls=e,this.id=t,this.uriToDecryptingFragments={},this.logger=e.logger,this._onWorkerMessage=this._onWorkerMessage.bind(this),this._ensureHandlerFunc().catch(e=>{this.logger.error("Promise error: "+e.message)()})}_setupInlineHandler(e){return this.observer=new va.EventEmitter,this.observer.trigger=(e,t)=>{this.observer.emit(e,e,t)},this.observer.off=(e,t)=>this.observer.removeListener(e,t),this.decryptor=new e.SegmentDecryptorInline(this.observer,this.hls.config),e=>{var t;null===(t=this.decryptor.decrypt(e.data,e.frag.decryptdata,e.frag.iframe||"initSegment"===e.frag.sn,t=>this._onDecryptComplete(e,t)))||void 0===t||t.catch(e=>{this.logger.error("Promise error: "+e.message)()})}}_setupWorkerHandler(e){let t;try{(t=e.createDecryptorWorker()).addEventListener("message",this._onWorkerMessage),t.onerror=e=>{let t=new s.h(s.g.OTHER_ERROR,s.d.INTERNAL_EXCEPTION,!0,e.message+" ("+e.filename+":"+e.lineno+")");t.event="decryptorWorker",t.err={message:e.message+" ("+e.filename+":"+e.lineno+")"},this.hls.trigger(r.b.INTERNAL_ERROR,t)},t.postMessage({cmd:"init",id:this.id,config:JSON.stringify(this.hls.config)}),this.worker=t}catch(e){throw t&&URL.revokeObjectURL(t.objectURL),e}return e=>{const i=e.frag.url;if(this.uriToDecryptingFragments[i])return;this.uriToDecryptingFragments[i]=e;const r=e.data,{decryptdata:s}=e.frag,a=e.frag.iframe||"initSegment"===e.frag.sn;t.postMessage({cmd:"segment-decrypt",fragPayload:r,decryptdata:s,forceJSCrypto:a,fragObjId:i},[r])}}_genHandlerFunc(){return Promise.resolve().then(i.bind(null,29)).then(e=>{if(this.hls.config.enableWorker&&"undefined"!=typeof Worker)try{return this._setupWorkerHandler(e)}catch(e){this.logger.error("error while initializing SegmentDecryptorWorker, fallback on DecryptorInline")()}return this._setupInlineHandler(e)})}_ensureHandlerFunc(){return this.handlerPromise||(this.handlerPromise=this._genHandlerFunc()),this.handlerPromise}destroy(){return this.handlerPromise?this.handlerPromise.then(()=>this._destroy()):(this._destroy(),Promise.resolve())}_destroy(){this.handlerPromise=null;const{worker:e,decryptor:t,observer:i}=this;e&&(e.removeEventListener("message",this._onWorkerMessage),e.terminate(),this.worker=null),t&&(t.destroy(),this.decryptor=null),i&&(i.removeAllListeners(),this.observer=null)}decrypt(e,t,i,r){const{decryptdata:s}=t,a={frag:t,data:e,stats:i,onComplete:r};return this._ensureHandlerFunc().then(e=>{s.key?e(a):this.logger.error("Decrypt called on fragment without valid key")()})}_onDecryptComplete(e,t){e.onComplete&&e.onComplete({decryptedData:t,frag:e.frag,stats:e.stats,id:this.id})}_onWorkerMessage({data:e}){switch(e.event){case"init":URL.revokeObjectURL(this.worker.objectURL);break;case"segment-decrypted":if(!ba.isError(e)){const t=this.uriToDecryptingFragments[e.fragObjId];t&&t.onComplete&&(this._onDecryptComplete(t,e.data),delete this.uriToDecryptingFragments[e.fragObjId])}break;case r.b.ERROR:if(ba.isError(e)){let t=e.data;if(t&&t.details===s.d.FRAG_DECRYPT_ERROR){let i=new s.i(t.type,t.details,t.fatal,t.reason);this.hls.trigger(e.event,i)}}}}static isError(e){return e.data&&"details"in e.data}}var Sa=class{constructor(e){this.hls=e,this.logger=e.logger,this.serverInfoReported=!1}destroy(){this.hls=null}loadFragment(e){let t=e.type,i=this.hls.config;e.loaded=0;let a=e.loader=yt.isCustomUrl(e.url)?new yt(this.hls):void 0!==i.fLoader?new i.fLoader(i):new i.loader(i),n={url:e.url,frag:e,responseType:"arraybuffer",progressData:!1,type:t,sessionID:i.useHTTPPlaybackSessionId?this.hls.sessionID:void 0,collectServerInstanceInfo:this.serverInfoReported||"main"!==e.type||"number"!=typeof e.sn?void 0:i.fragLoadPolicy.default.reportHTTPResponseHeaders},o=e.byteRangeStartOffset,l=e.byteRangeEndOffset;Object(ke.c)(o)&&Object(ke.c)(l)&&(n.rangeStart=o,e.byteRange&&e.decryptdata&&"AES-128"===e.decryptdata.method&&("initSegment"===e.sn?l+=(l-o)%16?16-(l-o)%16:16:e.iframe&&(l+=(l-o)%16?16-(l-o)%16:16,o=o>=16?o-16:o,n.rangeStart=o,n.iframe=!0)),n.rangeEnd=l);let d=js(e,i.fragLoadPolicy);return re(()=>(this.hls.trigger(r.b.FRAG_LOADING,{frag:e}),Ge(a.load(n,d),a.onProgress().pipe(fe(e=>(this.loadprogress(e.stats,n),ie)))))).pipe(ye(1),Ie(e=>this.loadsuccess(e.response,e.stats,n)),Se(t=>{if(t instanceof j)throw new s.m(!1,s.f.NoResponseFromMediaRequest.text,s.f.NoResponseFromMediaRequest.code,!0,e);if(t instanceof Ce)throw new s.m(!1,t.message,t.code,!1,e);throw t}),dt(()=>{e.loader=null}))}loadsuccess(e,t,i){let r=e.data,s=i.frag;if(Object(ke.c)(e.contentLen)&&e.contentLen!==e.len){let t=`fragment is shorter than expected. content len ${e.contentLen} vs actual len ${e.len}`;return this.logger.error(t)(),Be(()=>new Ce(t,409))}return i.serverInstanceInfo&&(this.serverInfoReported=!0),s.decryptdata&&"AES-128"===s.decryptdata.method?(this.segmentDecryptor||(this.segmentDecryptor=new ba(this.hls,"main")),i.iframe&&i.rangeStart&&(s.decryptdata.iv=new Uint8Array(r.slice(0,16)),r=r.slice(16)),this.hls.keyLoader.getKeyFromDecryptData(s.decryptdata,void 0).pipe(Ie(e=>{s.decryptdata.key=e.key;let i=new mt;return this.segmentDecryptor.decrypt(r,s,t,e=>{i.next(e),i.complete()}).catch(e=>{this.logger.error("[frag] got decrypt err="+e.message)()}),i}),ae(e=>({payload:new Uint8Array(e.decryptedData),frag:e.frag,stats:e.stats})))):$e({payload:r,frag:s,stats:t,serverInfo:i.serverInstanceInfo})}loadprogress(e,t){let i=t.frag;i.loaded=e.loaded,this.hls.trigger(r.b.FRAG_LOAD_PROGRESS,{frag:i,stats:e})}},Ta=new x(je),Ea={};function _a(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=void 0,r=void 0,s=void 0;if(z(e[e.length-1])&&(r=e.pop()),"function"==typeof e[e.length-1]&&(i=e.pop()),1===e.length){var a=e[0];He(a)&&(e=a),$(a)&&Object.getPrototypeOf(a)===Object.prototype&&(e=(s=Object.keys(a)).map((function(e){return a[e]})))}return S(Ue(e,r),new Ia(i,s))}var Da,Ia=(function(){function e(e,t){this.resultSelector=e,this.keys=t}return e.prototype.call=function(e,t){return t.subscribe(new wa(e,this.resultSelector,this.keys))},e})(),wa=(function(e){function t(t,i,r){var s=e.call(this,t)||this;return s.resultSelector=i,s.keys=r,s.active=0,s.values=[],s.observables=[],s}return n(t,e),t.prototype._next=function(e){this.values.push(Ea),this.observables.push(e)},t.prototype._complete=function(){var e=this.observables,t=e.length;if(0===t)this.destination.complete();else{this.active=t,this.toRespond=t;for(var i=0;i<t;i++){var r=e[i];this.add(ue(r,new de(this,null,i)))}}},t.prototype.notifyComplete=function(){0==(this.active-=1)&&this.destination.complete()},t.prototype.notifyNext=function(e,t,i){var r=this.values,s=r[i],a=this.toRespond?s===Ea?--this.toRespond:this.toRespond:0;r[i]=t,0===a&&(this.resultSelector?this._tryResultSelector(r):this.destination.next(this.keys?this.keys.reduce((function(e,t,i){return e[t]=r[i],e}),{}):r.slice()))},t.prototype._tryResultSelector=function(e){var t;try{t=this.resultSelector.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t})(ce);!(function(e){e.NEXT="N",e.ERROR="E",e.COMPLETE="C"})(Da||(Da={})),(function(){function e(e,t,i){this.kind=e,this.value=t,this.error=i,this.hasValue="N"===e}e.prototype.observe=function(e){var t,i,r;switch(this.kind){case"N":null===(t=e.next)||void 0===t||t.call(e,this.value);break;case"E":null===(i=e.error)||void 0===i||i.call(e,this.error);break;case"C":null===(r=e.complete)||void 0===r||r.call(e)}},e.prototype.do=function(e,t,i){switch(this.kind){case"N":null==e||e(this.value);break;case"E":null==t||t(this.error);break;case"C":null==i||i()}},e.prototype.accept=function(e,t,i){return e&&"function"==typeof e.next?this.observe(e):this.do(e,t,i)},e.prototype.toObservable=function(){switch(this.kind){case"N":return $e(this.value);case"E":return Be(this.error);case"C":return ie}throw new Error("unexpected notification kind value")},e.createNext=function(t){return new e("N",t)},e.createError=function(t){return new e("E",void 0,t)},e.createComplete=function(){return e.completeNotification},e.completeNotification=new e("C")})();var Ra=Aa("C",void 0,void 0);function Aa(e,t,i){return{kind:e,value:t,error:i}}function ka(e,t){return void 0===t&&(t=0),function(i){return S(i,new Ca(e,t))}}var Ca=(function(){function e(e,t){void 0===t&&(t=0),this.scheduler=e,this.delay=t}return e.prototype.call=function(e,t){return t.subscribe(new La(e,this.scheduler,this.delay))},e})(),La=(function(e){function t(t,i,r){void 0===r&&(r=0);var s=e.call(this,t)||this;return s.scheduler=i,s.delay=r,s}return n(t,e),t.dispatch=function(e){!(function(e,t){var i,r,s;if("string"!=typeof e.kind)throw new TypeError('Invalid notification, missing "kind"');switch(e.kind){case"N":null===(i=t.next)||void 0===i||i.call(t,e.value);break;case"E":null===(r=t.error)||void 0===r||r.call(t,e.error);break;case"C":null===(s=t.complete)||void 0===s||s.call(t)}})(e.notification,e.destination),this.unsubscribe()},t.prototype.scheduleMessage=function(e){var i=this.destination;i.add(this.scheduler.schedule(t.dispatch,this.delay,{notification:e,destination:i}))},t.prototype._next=function(e){this.scheduleMessage(function(e){return Aa("N",e,void 0)}(e))},t.prototype._error=function(e){this.scheduleMessage(function(e){return Aa("E",void 0,e)}(e)),this.unsubscribe()},t.prototype._complete=function(){this.scheduleMessage(Ra),this.unsubscribe()},t})(w);function Pa(e){return function(t){return S(t,new Ma(e))}}var Ma=(function(){function e(e){this.total=e}return e.prototype.call=function(e,t){return t.subscribe(new xa(e,this.total))},e})(),xa=(function(e){function t(t,i){var r=e.call(this,t)||this;return r.total=i,r.count=0,r}return n(t,e),t.prototype._next=function(e){++this.count>this.total&&this.destination.next(e)},t})(w);const Oa={isBuffered:function(e,t){if(e){let i=e.buffered;for(let e=0;i&&e<i.length;e++)if(t>=i.start(e)&&t<=i.end(e))return!0}return!1},bufferInfo:function(e,t,i){if(e){var r=this.buffered(e);return this.bufferedInfo(r,t,i)}return{len:0,start:t,end:t,nextStart:void 0}},buffered:function(e){var t=[];if(e){var i,r=e.buffered;for(t=[],i=0;r&&i<r.length;i++)t.push({start:r.start(i),end:r.end(i)})}return t},subtitleBufferInfo:function(e,t,i){if(e){var r=this.bufferedCues(e);return this.bufferedInfo(r,t,i)}return{len:0,start:t,end:t,nextStart:void 0}},fragmentsBufferedInfo:function(e,t,i){const r=[];for(const t of e)r.push({start:t.start,end:t.start+t.duration});return this.bufferedInfo(r,t,i)},bufferedCues:function(e){var t,i=[];if(e)for(i=[],t=0;t<e.length;t++)i.push({start:e[t].startTime,end:e[t].endTime});return i},bufferedInfo:function(e,t,i){var r,s,a,n,o,l=[];for(e.sort((function(e,t){return e.start-t.start||t.end-e.end})),o=0;o<e.length;o++){var d=l.length;if(d){var h=l[d-1].end;e[o].start-h<i?e[o].end>h&&(l[d-1].end=e[o].end):l.push(e[o])}else l.push(e[o])}for(o=0,r=0,s=a=t;o<l.length;o++){var c=l[o].start,u=l[o].end;if(t+i>=c&&t<u)s=c,r=(a=u)-t;else if(t+i<c){n=c;break}}return{len:r,start:s,end:a,nextStart:n}},toRangeString:e=>`[${e.start.toFixed(3)},${e.end.toFixed(3)}]`,canContinuePlaybackWithoutGap(e,t,i,r,s){if("LIVE"!==r)return!0;if(!e||!s||!s.PTSKnown)return!1;let a=performance.now()+(s.tload-s.trequest);return s.fragments[0].start+(a-s.tload)/1e3<=Oa.bufferInfo(e,t,i).end}};var Na=Oa;const Fa={search:function(e,t){let i,r,s=0,a=(null==e?void 0:e.length)-1;for(;s<=a;){let n=t(r=e[i=(s+a)/2|0]);if(n>0)s=i+1;else{if(!(n<0))return r;a=i-1}}return null}};var Ba=Fa,Ua={findFragmentBySNAndBuffer:function(e,t,i=0,r=0,s=0){let a;const n=e?t[e.seqNum-t[0].seqNum+1]:null;return i<r?(i>r-s&&(s=0),a=n&&!this.fragmentWithinToleranceTest(i,s,n)?n:Ba.search(t,this.fragmentWithinToleranceTest.bind(null,i,s))):a=t[t.length-1],a},fragmentWithinToleranceTest:function(e,t,i){let r=Math.min(t,i.duration+(i.deltaPTS?i.deltaPTS:0));return i.start+i.duration-r<=e?1:i.start-r>e&&i.start?-1:0}};const $a={mergeDetails:function(e,t){var i,r=Math.max(e.startSN,t.startSN)-t.startSN,s=Math.min(e.endSN,t.endSN)-t.startSN,a=t.startSN-e.startSN,n=e.fragments,o=t.fragments,l=0;for(let e=r;e<=s;++e)if(n[a+e]&&o[e]){l=n[a+e].cc-o[e].cc;break}e.initSegments=e.initSegments||{},t.initSegments=t.initSegments||{};let d={};for(let r=0;r<o.length;r++){let s=n[a+r],h=o[r],c=h.cc+l;t.initSegments[h.cc]&&(d[c]=t.initSegments[h.cc],d[c].cc=c,e.initSegments[c]&&e.initSegments[c].level===d[c].level&&(d[c].data=e.initSegments[c].data)),h.cc=c,s&&Object(ke.c)(s.startPTS)&&(h.sn===s.sn?(h.start=h.startPTS=s.startPTS,h.endPTS=s.endPTS,h.duration=s.duration,h.backtracked=s.backtracked,h.dropped=s.dropped,i=h):Ae.b.warn(`mismatch in sn during merge newFrag.sn: ${h.sn} vs oldFrag.sn: ${s.sn}`)())}if(t.initSegments=d,i)$a.updateFragPTSDTS(t,i,i.startPTS,i.endPTS,i.startDTS,i.endDTS);else if(a>=0&&a<n.length){var h=n[a].start;for(let e=0;e<o.length;e++)o[e].start+=h}t.PTSKnown=r<=s&&Boolean(e.PTSKnown)},getExpiredFragmentsRange:function(e,t){if(e.startSN>=t.startSN)return{start:void 0,end:void 0};var i,r,s=Math.max(e.startSN,t.startSN)-t.startSN,a=Math.min(e.endSN,t.endSN)-t.startSN,n=t.startSN-e.startSN,o=e.fragments;return a<s&&o.length>0&&Object(ke.c)(s)&&s<o.length?(i=o[s].start,r=o[o.length-1].start+o[o.length-1].duration):n&&o.length>0&&Object(ke.c)(s)&&Object(ke.c)(n)&&s<o.length&&(i=o[s].start,r=o[s+n-1].start+o[s+n-1].duration),{start:i,end:r}},updateFragPTSDTS:function(e,t,i,r,s,a){if(Object(ke.c)(t.startPTS)){let e=Math.abs(t.startPTS-i);Object(ke.c)(t.deltaPTS)?t.deltaPTS=Math.max(e,t.deltaPTS):t.deltaPTS=e,i=Math.min(i,t.startPTS),r=Math.max(r,t.endPTS),s=Math.min(s,t.startDTS),a=Math.max(a,t.endDTS)}const n=i-t.start;t.start=t.startPTS=i,t.endPTS=r,t.startDTS=s,t.endDTS=a,t.duration=r-i;const o=t.sn;if(!e||o<e.startSN||o>e.endSN)return 0;let l=o-e.startSN,d=e.fragments,h=d[l];t!==h&&(Ae.b.warn(`frag may be copy input:${JSON.stringify(t,["level","id","sn","cc"])} details:${JSON.stringify(h,["level","id","sn","cc"])}`)(),h.start=t.start,h.endPTS=t.endPTS,h.startPTS=t.startPTS,h.startDTS=t.startDTS,h.endDTS=t.endDTS,h.duration=t.duration,h.deltaPTS=t.deltaPTS);for(let e=l;e>0;e--)$a.updatePTS(d,e,e-1);for(let e=l;e<d.length-1;e++)$a.updatePTS(d,e,e+1);return e.PTSKnown=!0,n},updatePTS:function(e,t,i){var r=e[t],s=e[i],a=s.startPTS;Object(ke.c)(a)?i>t?(r.duration=a-r.start,r.duration<0&&Ae.b.warn(`negative duration computed for frag ${r.sn},level ${r.level}, there should be some duration drift between playlist and fragment!`)()):(s.duration=r.start-a,s.duration<0&&Ae.b.warn(`negative duration computed for frag ${s.sn},level ${s.level}, there should be some duration drift between playlist and fragment!`)()):s.start=i>t?r.start+r.duration:Math.max(r.start-s.duration,0)}};var Va=$a,Ga=i(8),Ha=class extends cs{constructor(e,t,i,s,a,n){super(e,r.b.BUFFER_APPENDED,r.b.DESIRED_RATE_CHANGED),this.media=t,this.lowBufferThreshold=i,this.lowBufferWatchdogPeriod=s,this.highBufferWatchdogPeriod=a,this.seekWatchdogPeriod=n,this.listenerMap={seeking:this.onseeking.bind(this),seeked:this.onseeked.bind(this),timeupdate:this.ontimeupdate.bind(this),ended:this.onended.bind(this),playing:this.onplaying.bind(this)},this.seekOrWaitingForPlay=this.mediaSeekOrWaitingForPlay(),this.addListeners()}destroy(){this.removeListeners(),this.clearTimer(),this.media=null,this.listenerMap=null,super.destroy()}addListeners(){let e=this.media;if(e)for(let[t,i]of Object.entries(this.listenerMap))e.addEventListener(t,i)}removeListeners(){let e=this.media;if(e&&this.listenerMap)for(let[t,i]of Object.entries(this.listenerMap))e.removeEventListener(t,i)}mediaSeekOrWaitingForPlay(){let e=this.media;return e.seeking||e.paused||e.readyState<e.HAVE_FUTURE_DATA}set lastCurrentTime(e){this.tlastCurrentTime=performance.now(),this._lastCurrentTime=e,this.stop(),this.start()}get lastCurrentTime(){return this._lastCurrentTime}ontimeupdate(){if(!this.media)return;let e=this.media.currentTime;e<this.lastCurrentTime&&!this.media.seeking&&this.logger.warn(`[stall] timeupdate went backward but not seeking ${e} ${this.lastCurrentTime}`)(),this.lastCurrentTime!==e&&(this.lastCurrentTime=e)}onseeking(){let e=!this.seekOrWaitingForPlay||Math.abs(this.media.currentTime-this.lastCurrentTime)>=Number.EPSILON;this.seekOrWaitingForPlay=!0,this.updateSeekWatchdogStart(e),e?this.lastCurrentTime=this.media.currentTime:this.start()}onseeked(){this.updateSeekWatchdogStart(!0),this.lastCurrentTime=this.media.currentTime}onplaying(){this.seekOrWaitingForPlay=!1,this.tseekWatchdogStart=void 0,this.lastCurrentTime=this.media.currentTime}onended(){this.stop()}onDesiredRateChanged(e){const t=e.oldRate,i=e.newRate;t!==i&&(0===t?(this.seekOrWaitingForPlay=this.mediaSeekOrWaitingForPlay(),this.updateSeekWatchdogStart(!0),this.lastCurrentTime=this.media.currentTime):0===i&&this.stop())}onBufferAppended(){this.updateSeekWatchdogStart(),this.start()}onBufferFlushed(){this.start()}updateSeekWatchdogStart(e=!1){let t=this.media;(e||!isFinite(this.tseekWatchdogStart))&&this.seekOrWaitingForPlay&&t&&Na.isBuffered(t,t.currentTime)&&(this.tseekWatchdogStart=performance.now())}stop(){this.isStallNotified&&(this.hls.trigger(r.b.RESUME_FROM_STALL),this.isStallNotified=!1),this.clearTimer()}clearTimer(){this.stallMonitorTimer&&(clearTimeout(this.stallMonitorTimer),this.stallMonitorTimer=null)}get tstalled(){return this.seekOrWaitingForPlay?this.tseekWatchdogStart:this.tlastCurrentTime}start(){this.clearTimer();let e=this.media,t=e.currentTime;if(!e||0===this.hls.desiredRate||e.ended||0===e.buffered.length||e.seeking&&!Na.isBuffered(e,t)||void 0===this.tlastCurrentTime||t!==this.lastCurrentTime)return;let i=this.tstalled;if(!isFinite(i))return;let r,s=performance.now();r=this.seekOrWaitingForPlay?this.seekWatchdogPeriod:Na.bufferInfo(e,t,0).len<=this.lowBufferThreshold?this.lowBufferWatchdogPeriod:this.highBufferWatchdogPeriod;let a=Math.max(100,1e3*r-(s-i));this.stallMonitorTimer=setTimeout(this.checkForStall.bind(this),a)}checkForStall(){let e,t=performance.now(),i=this.media,s=i.currentTime;if(s===this.lastCurrentTime){let r=this.tstalled,a=t-r,n=Na.bufferInfo(i,s,0),o=n.len<=this.lowBufferThreshold,l=this.seekOrWaitingForPlay?Ga.b.Seek:o?Ga.b.LowBuffer:Ga.b.HighBuffer;(l===Ga.b.Seek&&a>=1e3*this.seekWatchdogPeriod||l===Ga.b.HighBuffer&&a>=1e3*this.highBufferWatchdogPeriod||l===Ga.b.LowBuffer&&a>=1e3*this.lowBufferWatchdogPeriod)&&(e={type:l,isLowBufferStall:o,bufferInfo:n,tstalled:r,stallDurationMs:a})}e?(this.logger.warn(`stall detected ${Math.round(e.stallDurationMs)}ms type:${e.type}`)(),this.hls.trigger(r.b.STALLED,e),this.isStallNotified=!0):this.start()}},Ka=function(e){for(var t="",i=e.length,r=0;r<i;r++)t+="["+e.start(r).toFixed(3)+","+e.end(r).toFixed(3)+"]";return t};function ja(e,t){void 0===t&&(t=v);var i=b(e)?+e-t.now():Math.abs(e);return function(e){return S(e,new Wa(i,t))}}var Wa=(function(){function e(e,t){this.delay=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new qa(e,this.delay,this.scheduler))},e})(),qa=(function(e){function t(t,i,r){var s=e.call(this,t)||this;return s.destination=t,s.delay=i,s.scheduler=r,s.queue=[],s.active=!1,s}return n(t,e),t.dispatch=function(e){for(var t=e.source,i=t.queue,r=e.scheduler,s=e.destination;i.length>0&&i[0].time-r.now()<=0;)s.next(i.shift().value);if(i.length>0){var a=Math.max(0,i[0].time-r.now());this.schedule(e,a)}else t.isStopped?(t.destination.complete(),t.active=!1):(this.unsubscribe(),t.active=!1)},t.prototype._schedule=function(e){this.active=!0;var i=this.destination;i.add(e.schedule(t.dispatch,this.delay,{source:this,destination:i,scheduler:e}))},t.prototype._next=function(e){var t=this.scheduler,i=new za(t.now()+this.delay,e);this.queue.push(i),!1===this.active&&this._schedule(t)},t.prototype._error=function(e){this.queue.length=0,this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){0===this.queue.length&&this.destination.complete(),this.unsubscribe()},t})(w),za=function(e,t){this.time=e,this.value=t};function Xa(e,t){var i=!1;return arguments.length>=2&&(i=!0),function(r){return S(r,new Qa(e,t,i))}}var Qa=(function(){function e(e,t,i){void 0===i&&(i=!1),this.accumulator=e,this.seed=t,this.hasSeed=i}return e.prototype.call=function(e,t){return t.subscribe(new Ya(e,this.accumulator,this.seed,this.hasSeed))},e})(),Ya=(function(e){function t(t,i,r,s){var a=e.call(this,t)||this;return a.accumulator=i,a._state=r,a._hasState=s,a.index=0,a}return n(t,e),t.prototype._next=function(e){var t=this.destination;if(this._hasState){var i=this.index++,r=void 0;try{r=this.accumulator(this._state,e,i)}catch(e){return void t.error(e)}this._state=r,t.next(r)}else this._state=e,this._hasState=!0,t.next(e)},t})(w);function Ja(e){if(isNaN(e))throw new TypeError("'count' is not a number");if(e<0)throw new me;return function(t){return 0===e?ie:S(t,new Za(e))}}var Za=(function(){function e(e){this.total=e}return e.prototype.call=function(e,t){return t.subscribe(new en(e,this.total))},e})(),en=(function(e){function t(t,i){var r=e.call(this,t)||this;return r.total=i,r.ring=new Array,r.count=0,r}return n(t,e),t.prototype._next=function(e){var t=this.ring,i=this.total,r=this.count++;t.length<i?t.push(e):t[r%i]=e},t.prototype._complete=function(){var e=this.destination,t=this.count;if(t>0)for(var i=this.count>=this.total?this.total:this.count,r=this.ring,s=0;s<i;s++){var a=t++%i;e.next(r[a])}e.complete()},t})(w),tn=(function(){function e(e){this.defaultValue=e}return e.prototype.call=function(e,t){return t.subscribe(new rn(e,this.defaultValue))},e})(),rn=(function(e){function t(t,i){var r=e.call(this,t)||this;return r.defaultValue=i,r.isEmpty=!0,r}return n(t,e),t.prototype._next=function(e){this.isEmpty=!1,this.destination.next(e)},t.prototype._complete=function(){this.isEmpty&&this.destination.next(this.defaultValue),this.destination.complete()},t})(w);function sn(e,t){return arguments.length>=2?function(i){return P(Xa(e,t),Ja(1),(void 0===(r=t)&&(r=null),function(e){return S(e,new tn(r))}))(i);var r}:function(t){return P(Xa((function(t,i,r){return e(t,i,r+1)})),Ja(1))(t)}}class an extends va.EventEmitter{trigger(e,t){this.emit(e,e,t)}}class nn{constructor(e,t){this.hls=e,this.logger=e.logger,this.id=t,this.typeSupported={mp4:MediaSource.isTypeSupported("video/mp4"),mpeg:MediaSource.isTypeSupported("audio/mpeg"),mp3:MediaSource.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:MediaSource.isTypeSupported('audio/mp4; codecs="ac-3"'),ec3:MediaSource.isTypeSupported('audio/mp4; codecs="ec-3"')},this.onWorkerMessage=this.onWorkerMessage.bind(this),this._ensureHandlerFunc().catch(e=>{this.logger.error("Promise error: "+e.message)()})}_setupInlineHandler(e){const t=this.observer=new an;t.trigger=(e,i)=>t.emit(e,e,i),t.off=(e,i)=>t.removeListener(e,i);const i=(e,t)=>this.onWorkerMessage({data:{event:e,data:t}});[r.b.FRAG_DECRYPTED,r.b.FRAG_PARSING_INIT_SEGMENT,r.b.FRAG_PARSING_DATA,r.b.FRAG_PARSED,r.b.INTERNAL_ERROR,r.b.FRAG_PARSING_METADATA,r.b.FRAG_PARSING_USERDATA,r.b.FRAG_PARSING_CAPTIONDATA,r.b.INIT_PTS_FOUND].forEach(e=>t.on(e,i));const s=this.demuxer=new e.DemuxerInline(t,this.typeSupported,this.hls.config,navigator.vendor);return s.push.bind(s)}_setupWorkerHandler(e){const{vendor:t}=navigator;let i;this.logger.info("demuxing in webworker")();try{(i=e.createDemuxerWorker()).addEventListener("message",this.onWorkerMessage),i.onerror=e=>{let t=new s.h(s.g.OTHER_ERROR,s.d.INTERNAL_EXCEPTION,!0,e.message+" ("+e.filename+":"+e.lineno+")");t.response=s.f.InternalError,t.event="demuxerWorker",t.err={message:e.message+" ("+e.filename+":"+e.lineno+")"},this.hls.trigger(r.b.INTERNAL_ERROR,t)},i.postMessage({cmd:"init",typeSupported:this.typeSupported,vendor:t,id:this.id,config:JSON.stringify(this.hls.config),options:{streamID:this.hls.streamID,sessionID:this.hls.sessionID}}),this.worker=i}catch(e){throw i&&URL.revokeObjectURL(i.objectURL),e}return(e,t,r,s,a,n,o,l,d,h,c,u)=>{e instanceof Uint8Array&&(e=e.buffer),i.postMessage({cmd:"demux",data:e,decryptdata:t,initSegment:r,timeOffset:s,discontinuity:a,trackSwitch:n,contiguous:o,duration:l,accurateTimeOffset:d,defaultInitPTS:h,iframeMediaStart:c,iframeDuration:u},[e])}}_genHandlerFunc(){return Promise.resolve().then(i.bind(null,29)).then(e=>{if(this.hls.config.enableWorker&&"undefined"!=typeof Worker)try{return this._setupWorkerHandler(e)}catch(e){this.logger.error("error while initializing DemuxerWorker, fallback on DemuxerInline")()}return this._setupInlineHandler(e)})}_ensureHandlerFunc(){return this.handlerPromise||(this.handlerPromise=this._genHandlerFunc()),this.handlerPromise}destroy(){return this.handlerPromise?this.handlerPromise.then(()=>{this._destroy()}).catch(e=>{this.logger.error("Promise error: "+e.message)()}):(this._destroy(),Promise.resolve())}_destroy(){this.handlerPromise=null;const{worker:e,demuxer:t,observer:i}=this;e&&(e.removeEventListener("message",this.onWorkerMessage),e.terminate(),this.worker=null),t&&(t.destroy(),this.demuxer=null),i&&(i.removeAllListeners(),this.observer=null)}push(e,t,i,r,s,a){var n;null===(n=this._ensureHandlerFunc().then(n=>{const o=void 0!==i.startDTS?i.startDTS:i.start,l=i.decryptdata,d=this.frag,h=!(d&&i.cc===d.cc),c=!(d&&i.level===d.level),u=d&&"number"==typeof d.sn&&i.sn===d.sn+1,f=!c&&u,g=void 0!==i.iframeMediaStart?i.iframeMediaStart:void 0,p=void 0!==i.iframeMediaDuration?i.iframeMediaDuration:void 0;this.frag=i,this.iframeMediaStart=g,this.accurateTimeOffset=s,n(e,l,t,o,h,c,f,r,s,a,g,p)}))||void 0===n||n.catch(e=>{this.logger.error("Promise error: "+e.message)()})}isValidFragParsingData(e,t,i,r,s){let a,n;Object(ke.c)(r)?(n=r,a=.01,isFinite(n)&&isFinite(s)&&(n+=s)):i?(n=void 0!==e.startDTS?e.startDTS:e.start,Math.abs(t.startDTS-n)>.5&&this.logger.warn(`Significant DTS drift vs playlist sn=${e.sn} startDTS=${t.startDTS} expectedDTS=${n}`)(),a=e.duration):this.logger.warn("accurateTimeOffset==false, bypass DTS check startDTS=="+t.startDTS)();const o=t.startPTS>=0&&t.startDTS>=0&&e.duration>0&&(!Object(ke.c)(t.endPTS)||t.endPTS>=t.startPTS)&&(!Object(ke.c)(t.endDTS)||t.endDTS>=t.startDTS)&&(!Object(ke.c)(n)||void 0!==a&&Math.abs(t.startDTS-n)<=a);if(!o){const i=Object(ke.c)(t.endPTS)?t.endPTS.toFixed(3):"undefined",r=Object(ke.c)(t.endDTS)?t.endDTS.toFixed(3):"undefined",o=void 0===n?"undefined":n.toFixed(3);this.logger.error(`${t.type}: ${e.type} frag ${e.sn} failed demuxer sanity check PTS:[${t.startPTS.toFixed(3)},${i}] DTS:[${t.startDTS.toFixed(3)},${r}] expectedStartDTS=${o} dur=${e.duration.toFixed(3)} iframe=${e.iframe} fudge=${a} audioPrimingDelay=${s}`)()}return o}onWorkerMessage({data:{event:e,data:t}}){const{hls:i,id:a,frag:n}=this;let o;if(t=Object.assign(Object.assign({},t),{id:a,frag:n}),nn.checkWorkerMessageType(t,e,Ga.a.INIT))this.worker&&URL.revokeObjectURL(this.worker.objectURL);else{if(nn.checkWorkerMessageType(t,e,r.b.FRAG_PARSING_DATA)){const{frag:i}=this;this.isValidFragParsingData(i,t,this.accurateTimeOffset,this.iframeMediaStart,this.hls.config.audioPrimingDelay)||Object(ke.c)(this.iframeMediaStart)||(e=r.b.INTERNAL_ERROR,o=new s.l(s.g.MEDIA_ERROR,s.d.FRAG_PARSING_ERROR,!1,"Failed demuxer sanity check",i))}else nn.checkWorkerMessageType(t,e,r.b.INTERNAL_ERROR)&&(t&&t.details===s.d.FRAG_PARSING_ERROR?o=new s.l(t.type,t.details,t.fatal,t.reason,this.frag):t&&t.details===s.d.REMUX_ALLOC_ERROR&&"bytes"in t&&(o=new s.r(t.type,t.details,t.fatal,t.reason,t.response,t.bytes,n)));o&&(o.demuxerId=this.id),i.trigger(e,o||t)}}static checkWorkerMessageType(e,t,i){return t===i}}var on,ln=nn;!(function(e){e.AlmostDryWaterLevel="AlmostDryWaterLevel",e.LowWaterLevel="LowWaterLevel",e.HighWaterLevel="HighWaterLevel"})(on||(on={}));class dn extends cs{constructor(e,t,i,s,a,n,o,l){super(e,r.b.DESIRED_RATE_CHANGED),this.media=t,this.getEstimatedWaterLevel=i,this.parent=s,this.almostDryWaterLevelSeconds=l,this._lastWaterLevel=0,this.onBufferChanged$=new Z,this._maxBufferSeconds=n,this._targetDuration=o,this.listenerMap={seeking:this.stopBufferMonitor.bind(this),seeked:this.startBufferMonitor.bind(this),playing:this.startBufferMonitor.bind(this)},this.addListeners()}destroy(){this.removeListeners(),this.stopBufferMonitor(),this.media=null,this.listenerMap=null,this.getEstimatedWaterLevel=null,super.destroy()}addListeners(){let e=this.media;if(e)for(let t of Object.keys(this.listenerMap)){let i=this.listenerMap[t];e.addEventListener(t,i)}}removeListeners(){let e=this.media;if(e&&this.listenerMap)for(let t of Object.keys(this.listenerMap)){let i=this.listenerMap[t];e.removeEventListener(t,i)}}set targetDuration(e){this._targetDuration!==e&&(this._targetDuration=e,this.startBufferMonitor())}get targetDuration(){return this._targetDuration}set maxBufferSeconds(e){this._maxBufferSeconds!==e&&(this._maxBufferSeconds=e,this.startBufferMonitor())}get maxBufferSeconds(){return this._maxBufferSeconds}notifyWaterLevelChanged(){let e=this._getHighestThresholdBelowWaterLevel(this._lastWaterLevel);e?this.checkBufferLevel(e.threshold):this.startBufferMonitor()}get highWaterLevelSeconds(){return Math.max(this.maxBufferSeconds-this.targetDuration,this.lowWaterLevelSeconds)}get lowWaterLevelSeconds(){return this.targetDuration}onDesiredRateChanged(e){const t=e.oldRate,i=e.newRate;t!==i&&(0===t?this.startBufferMonitor():0===i&&this.stopBufferMonitor())}stopBufferMonitor(){clearTimeout(this.bufferChangeTimer)}_getHighestThresholdBelowWaterLevel(e){return[{threshold:this.highWaterLevelSeconds,reason:on.HighWaterLevel},{threshold:this.lowWaterLevelSeconds,reason:on.LowWaterLevel},{threshold:this.almostDryWaterLevelSeconds,reason:on.AlmostDryWaterLevel}].find(({threshold:t})=>e>t)}_getLowestThresholdAboveWaterLevel(e){return[{threshold:this.almostDryWaterLevelSeconds,reason:on.AlmostDryWaterLevel},{threshold:this.lowWaterLevelSeconds,reason:on.LowWaterLevel},{threshold:this.highWaterLevelSeconds,reason:on.HighWaterLevel}].find(({threshold:t})=>e<=t)}startBufferMonitor(){let e=this.media;this.stopBufferMonitor();let t=this._lastWaterLevel=this.getEstimatedWaterLevel();if(!this.hls||!e||e.paused||e.seeking)return void this.logger.info("Not arming buffer monitor")();let i=this._getHighestThresholdBelowWaterLevel(t);if(!i)return void this.logger.info(`Not arming buffer monitor buffer:${t}s`)();let{threshold:r}=i,s=1e3*(t-r);this.bufferChangeTimer=setTimeout(this.checkBufferLevel.bind(this,r),s)}checkBufferLevel(e){let t=this._lastWaterLevel=this.getEstimatedWaterLevel();if(this.logger.info(`[QE Critical] bufferLenSec: ${t} parent: ${this.parent}`)(),t<=e){let{threshold:e,reason:i}=this._getLowestThresholdAboveWaterLevel(t);this.logger.info(`buffer fell below ${e} ${i}`)();const s={reason:i,parent:this.parent};this.hls.trigger(r.b.BUFFER_CHANGED,s)}this.startBufferMonitor()}}const hn={buffered:{length:0,start:e=>0,end:e=>0},getWaterLevel:(e,t)=>0,getBufferInfo:(e,t)=>({len:0,start:0,end:0,nextStart:0})};class cn extends x{constructor(e,t,i,r,s){super(),this.parent=e,this.realSourceBuffer=t,this.codec=i,this.fragTag=r,this.defaultMaxBufferHole=s,this.destroy$=new te(!1),this.ended=!1,this._bufferedSegments=[],this._totalBytes=0,this._maxTotalBytes=0,this._gotQuotaExceeded=!1}_subscribe(e){let t=Ze(this.realSourceBuffer);return e.add(t.event("updateend").pipe(We(()=>{this._updateBufferedSegments()})).subscribe()),e.add(t.event("error").pipe(We(()=>{})).subscribe()),super._subscribe(e)}get buffered(){return this.realSourceBuffer.buffered}getWaterLevel(e,t=this.defaultMaxBufferHole){return Na.bufferInfo(this.realSourceBuffer,e,t).len}getBufferInfo(e,t=this.defaultMaxBufferHole){return Na.bufferInfo(this.realSourceBuffer,e,t)}_handleUpdateEnd(e){if(-1!==e.indexOf("error"))throw new s.b(s.d.BUFFER_APPEND_ERROR,!1,"Got error during sourceBuffer operation",s.f.VideoDecoderBadDataErr,this.parent)}appendBuffer(e,t){this.ended=!1;try{this._inFlight=t,this.realSourceBuffer.appendBuffer(e)}catch(e){return this._inFlight=void 0,22!==e.code?Be(()=>new s.b(s.d.BUFFER_APPEND_ERROR,!1,e.message,s.f.VideoDecoderBadDataErr,this.parent)):(this._updateBufferedInfo(!0),Be(()=>new s.b(s.d.BUFFER_FULL_ERROR,!1,e.message,s.f.AllocationFailed,this.parent,this.maxTotalBytes)))}return this.waitForBufferUpdate().pipe(ae(e=>this._handleUpdateEnd(e)),ye(1),W(1e4),Se(e=>{throw e instanceof j&&(Ae.b.error(`[mse][${this.parent}] Got timeout error, abort append`)(),this.realSourceBuffer.abort()),e}))}remove(e,t){return t<=e?Be(()=>new s.u(s.d.INTERNAL_EXCEPTION,!1,"Invalid time range for remove",s.f.InternalError)):(this.realSourceBuffer.remove(e,t),this.waitForBufferUpdate().pipe(ae(e=>this._handleUpdateEnd(e)),ye(1)))}abort(){return this.realSourceBuffer.abort(),this.waitForBufferUpdate().pipe(ae(e=>this._handleUpdateEnd(e)),ye(1))}get updating(){return!!this.realSourceBuffer&&this.realSourceBuffer.updating}get onupdateend$(){return Ze(this.realSourceBuffer).event("updateend")}get timestampOffset(){return this.realSourceBuffer.timestampOffset}set timestampOffset(e){this.realSourceBuffer.timestampOffset=e}get gotQuotaExceeded(){return this._gotQuotaExceeded}get bufferedSegments(){return this._bufferedSegments}get totalBytes(){return this._totalBytes}get maxTotalBytes(){return this.gotQuotaExceeded?this._maxTotalBytes:1/0}waitForBufferUpdate(){return $e(this.realSourceBuffer.updating).pipe(Ie(e=>Ge(e?Ta:$e("noupdate: "+this.parent),Ke(this.realSourceBuffer,"updateend").pipe(ae(e=>"updateend: "+this.parent)),Ke(this.realSourceBuffer,"error").pipe(ae(e=>"error: "+this.parent)))),ye(1))}destroy(e){"open"===e&&this.abort(),this.destroy$.next(!0)}_updateBufferedSegments(){let e=this._inFlight;this._inFlight=void 0,e&&Object(ke.c)(e.startPTS)&&Object(ke.c)(e.endPTS)&&(this._bufferedSegments=cn.mergeToBuffer(this._bufferedSegments,e)),this._updateBufferedInfo()}_updateBufferedInfo(e=!1){let t=Na.buffered(this),i=this._bufferedSegments,r=0,s=[];e&&(this._gotQuotaExceeded=!0),i.forEach(e=>{if(e.startPTS>=e.endPTS)return;let i=t.find(t=>!(t.start>e.endPTS||t.end<=e.startPTS));if(i){let t=Math.max(i.start,e.startPTS),a=Math.min(i.end,e.endPTS);r+=e.bytes*(a-t)/(e.endPTS-e.startPTS),s.push(e)}}),this._totalBytes=r,this._bufferedSegments=s,this._totalBytes>this._maxTotalBytes&&(this._maxTotalBytes=this._totalBytes)}static mergeToBuffer(e,t){let i=Array.from(e);return i.forEach(e=>{let i=Math.max(t.startPTS,e.startPTS),r=Math.min(t.endPTS,e.endPTS);i>=r||(e.bytes=(1-(r-i)/(e.endPTS-e.startPTS))*e.bytes,e.startPTS<t.startPTS?e.endPTS=i:e.startPTS=r)}),i.push(t),(i=i.filter(e=>e.bytes>0)).sort((e,t)=>e.startPTS-t.startPTS),i}}class un extends x{constructor(e){super(),this.destroy$=new Z,this.name=e.name,this.context=e.initialContext,this.state$=new te(e.initialState),e.states?this.states=e.states:this.states={}}_subscribe(e){let t=null;return this.state$.pipe(Ie(e=>{if("function"!=typeof this.states[e])throw new Error(`[Machine ${this.name}] transtition to unknown state "${e}"`);return this.previousState=t,t=e,this.states[e].call(this,this.context)}),lt(Ta),dt(()=>this.destroy$.next())).subscribe(e)}transition(e,t){void 0!==t&&(this.context=t),this.state$.next(e)}get state(){return this.state$.value}}var fn;!(function(e){e.STOPPED="STOPPED",e.NEED_INIT="NEED_INIT",e.NEED_DATA="NEED_DATA",e.ENDED="ENDED",e.ERROR="ERROR"})(fn||(fn={}));class gn{}class pn extends un{constructor(e,t,i){var r;super(t),this.hls=e,this.sbid=i,this.config=e.config,this.logger=e.logger||Ae.b,this.maxBufferAheadSec=(null===(r=this.config)||void 0===r?void 0:r.maxBufferLength)||30,this.states=Object.assign({[fn.STOPPED]:this.in_STOPPED,[fn.NEED_INIT]:this.in_NEED_INIT,[fn.NEED_DATA]:this.in_NEED_DATA,[fn.ENDED]:this.in_ENDED,[fn.ERROR]:this.in_ERROR},this.states)}get logname(){return this.sbid?this.sbid:this.name}get variantController(){return this.context.variantController}get variantManager(){var e;return null===(e=this.variantController)||void 0===e?void 0:e.variantManager}transition(e,t){return super.transition(e,t)}upgradeInternalErrorAndDie(e){const{context:t,hls:i,logger:r}=this;let s=i.upgradeInternalError(e);return this.transition(fn.ERROR),r.error(`${this.constructor.name}: ${e.type}, ${e.details}, ${e.response}, switch to ${this.state} state ...`)(),s}_bufferDryCatchError(e){return this.logger.error("get an error in buffer dry promise")(),ct}_catchError(e){var t;let i,r=this.context.variantController.variantManager;if(i=e.message,this.hls.fatalErrorPosted)return this.transition(fn.ERROR),ie;if(this.logger.error(`[${this.logname}] default error handling: ${i}`)(),e instanceof s.o){if(e instanceof s.k||e instanceof s.j){const t=1e3*(this.context.targetDuration||1),i=1e3*this.estimateCurrentWaterLevel();if(this.hls.iframeMode)return X(100);if(this.hls.isLive||i>=t)return X(t);{let t=this.hls.networkErrorHandler.modifyErrorActionIfCurrentLevelIsLastValidLevel({errorAction:Vs.SendAlternateToPenaltyBox,errorActionFlags:0},401,this.variantController,"main"===this.sbid);this.hls.networkErrorHandler.handleNetworkError(t.errorAction,t.errorActionFlags,e,this.currentVariantId,void 0,this.variantManager,this.variantController)}}}else this.logger.error(`[${this.logname}] Unhandled exception`)(),e.fatal=!0;if(e.fatal||r.getVariantInfoIfValid(this.currentVariantId)||0===(null===(t=r.validVariantList)||void 0===t?void 0:t.length)&&(this.logger.error(`[${this.logname}] Got empty variant list`)(),e.fatal=!0),e.fatal){if(this.transition(fn.STOPPED),e.escalated===s.e.Upgraded)return ie;if(void 0===e.escalated&&this.hls.fatalErrorRequiresAction(e))return K(this.hls.bufferDryPromise).pipe(fe(()=>X(5e3)),Ie(()=>(this.logger.info("buffer has drained. report fatal error now.")(),this.upgradeInternalErrorAndDie(e))),Se(this._bufferDryCatchError.bind(this)),Xe(this.destroy$)).subscribe(),ct}return this.logger.warn(`[${this.logname}] default action abort current sequence: ${e.message}`)(),this.state!==fn.ERROR?(this.transition(this.state),ct):(this.logger.error("downgraded or non-fatal error in ERROR state")(),ie)}_addLoadPolicy(e,t,i){return e.pipe(Ws(t,i,this.hls.networkErrorHandler,this.context.variantController))}loadFragment(e,t){let i=js(e,this.config.fragLoadPolicy),s=re(()=>(e.autoLevel=-1===this.hls.manualLevel,this.logFragmentTiming(e,"loading"),this.hls.fragmentLoader.loadFragment(e).pipe(We(()=>this.logFragmentTiming(e,"loaded")),Se(e=>{throw this.hls.trigger(r.b.INTERNAL_ERROR,e),e}))));return this._addLoadPolicy(s,i,t)}loadPlaylist(e,t){let i=this.variantManager.getVariantInfoIfValid(e);if(!i)return Be(new Error("Invalid level requested "+e));if(!i.url)return Be(new Error("No url for variant "+e));let s=this.variantController.loadPlaylist(i).pipe(Se(e=>{throw this.hls.trigger(r.b.INTERNAL_ERROR,e),e})),a=js(i,this.config.playlistLoadPolicy);return t||(this.variantController.currentVariantId=e,s=s.pipe(xs.addReloadPolicy(e,this.variantManager,this.getLivePlaylistRefreshDelay.bind(this)))),s=this._addLoadPolicy(s,a,t),s.pipe(We(t=>{let i=this.variantManager.getVariantInfo(e);if(!i)throw Error("Loaded invalid level! "+e);{let r=i.details;(null==r?void 0:r.trequest)!==t.trequest&&(this.logger.info("[QE Critical] playlist loaded "+JSON.stringify({playlistType:this.name,id:e}))(),this._updateLevelDetails(i,t))}}))}setVariantAndLoad(e){return re(()=>(this.currentVariantId=e,this.variantController.currentVariantId=e,this.loadPlaylist(e,!1)))}logFragmentTiming(e,t){const{context:i,config:r,logger:s}=this;e&&r.enablePerformanceLogging&&s.info("[timing] "+JSON.stringify({t:performance.now(),name:this.sbid,level:e.level,sn:e.sn,cc:e.cc,stage:t,startPTS:e.startPTS,endPTS:e.endPTS}))()}}class mn extends gn{constructor(e,t,i){super(),this.parent=i,this.waitingForKey=new te(null),this.isFlushing=new te(!1),this.seekInfo$=new te(null),this.hasItemToEvict$=new te(!1),this.media$=new te(null),this.ended=!1,this.appendTimeouts=0,this.bufferController=e.bufferController,this.variantController=t,this.seekInfo$=new te(null)}get seekInfo(){return this.seekInfo$.value}set seekInfo(e){this.seekInfo===e||this.seekInfo&&e&&(function(e,t,i=Number.EPSILON){return e===t||Math.abs(e-t)<i})(this.seekInfo.seekToPos,e.seekToPos)&&(this.seekInfo.cc===e.cc||isNaN(this.seekInfo.cc)&&isNaN(e.cc))||this.seekInfo$.next(e)}get media(){return this.media$.value}}class yn extends pn{constructor(e,t,i){super(e,t,i)}_subscribe(e){const t=Ze(this.hls,this);return e.add(Ge(t.event(r.b.MEDIA_ATTACHING,this.onMediaAttaching),t.event(r.b.MEDIA_DETACHING,this.onMediaDetaching),t.event(r.b.INTERNAL_ERROR,this.onInternalError)).subscribe()),e.add(this.context.media$.pipe(Ie(e=>e?new x(()=>{let t=this.context.bufferMonitor=new dn(this.hls,e,()=>this.estimateCurrentWaterLevel(),this.sbid,this.config.maxBufferHole,this.maxBufferAheadSec,this.config.defaultTargetDuration,this.config.almostDryBufferSec);return()=>{t.destroy(),this.context.bufferMonitor=null}}):ie)).subscribe()),e.add(this.hls.bufferController.forceReset$.pipe(We(e=>{this.logger.info(`[${this.sbid}] forceReset state=${this.state} ccLoadInfo=${JSON.stringify(e)}`)(),this.transition(fn.STOPPED),this.handleResetLoad(e),this.fragPrevious=null,this.transition(fn.NEED_INIT)})).subscribe()),e.add(this.hls.seekInfoObs.pipe(We(e=>{try{this._handleSeekInfoChange(e)}catch(e){this.logger.error(`[${this.sbid}] got error handling seek info ${e.message}`)()}})).subscribe()),super._subscribe(e)}get media(){return this.context.media}get fragPrevious(){return this.context.fragPrevious}set fragPrevious(e){this.context.fragPrevious=e}get fragCurrent(){return this.context.fragCurrent}get bufferController(){return this.context.bufferController}get playbackPos(){return this.context.seekInfo?this.context.seekInfo.seekToPos:this.loadedmetadata?this.media.currentTime:this.context.nextLoadPosition}clearAllLevels(){this.variantManager.clearAllDetails()}get bufferedRangeSource(){var e;return(null===(e=this.bufferController.getSourceBufferContext(this.sbid))||void 0===e?void 0:e.sourceBuffer)||hn}getSourceBufferInfo(e,t=this.config.maxBufferHole){return Na.bufferInfo(this.bufferedRangeSource,e,t)}isBuffered(e,t=this.config.maxBufferHole){return Na.isBuffered(this.bufferedRangeSource,e)}get buffered(){return this.bufferedRangeSource.buffered}get highWaterLevel(){var e;return null===(e=this.context.bufferMonitor)||void 0===e?void 0:e.highWaterLevelSeconds}shouldCheckWaterLevel(){return!this.bufferController.isResetting}estimateCurrentWaterLevel(e=this.config.maxBufferHole){return Na.bufferInfo(this.bufferedRangeSource,this.playbackPos,e).len}handleMediaAttached(e){}onMediaAttaching(e){this.context.media$.next(e.media),this.handleMediaAttached(this.context.media)}handleMediaDetached(e){}onMediaDetaching(){this.media,this.context.media$.next(null),this.handleMediaDetached(!0)}in_STOPPED(){return Ta}in_ENDED(){return Ta}in_ERROR(){return Ta}in_NEED_INIT(){return Ta}in_NEED_DATA(){let e=ct.pipe(ka(y),Ie(()=>this.setVariantAndLoad(this.nextLoadVariantId)),fs({bufferSize:1,refCount:!0}));return Ge(e,e.pipe(ye(1),$r(e=>{this.context.targetDuration=e.targetduration;let t=this.estimateCurrentWaterLevel();return this.shouldCheckWaterLevel()&&t>this.highWaterLevel?this.handleHighWater():this.loadAndAppendMedia(this.currentVariantId,e).pipe(We(e=>{this.handleFragAppended(e)}),$r(e=>(this.context.fragPrevious=e,this._isEnded(e)&&this.transition(fn.ENDED),ct)))}),We(()=>{var e;const t=Math.min(this.targetDuration,(null===(e=this.fragPrevious)||void 0===e?void 0:e.duration)||1/0);0===this.hls.desiredRate&&this.estimateCurrentWaterLevel()>=t?this.transition(fn.STOPPED):this.nextLoadVariantId!==this.currentVariantId&&this.transition(fn.NEED_DATA)}),We(()=>this.checkAndUpdateLevelsIfNecessary()),Se(this._catchError.bind(this)),dt(()=>{this.context.stats=null,this.context.fragCurrent=null,this.context.fragCurrentState=null}),Cs(e=>e.pipe(ja(0))))).pipe(Se(this._catchError.bind(this)),dt(()=>{}))}handleHighWater(){let e=Ze(this.hls);return Ji(e.event(r.b.BUFFER_CHANGED).pipe(Ee(e=>e.parent===this.sbid)),e.event(r.b.DESIRED_RATE_CHANGED).pipe(Ee(e=>0===e.newRate))).pipe(ye(1))}loadAndAppendMedia(e,t){return this.bufferController.waitForBufferUpdate(this.sbid).pipe(We(e=>{}),Ee(()=>!this.context.hasItemToEvict$.value),$r(e=>{const i=this._getFragmentToLoad(t);if(!i)return this.logger.warn(`[${this.sbid}] No fragment found`)(),this._isEnded(this.fragPrevious)?(this.transition(fn.ENDED),ie):this.hls.isPreloadingItem?(this.transition(fn.NEED_DATA),ie):Be(()=>new s.k("No fragment found"));let a=this.fetchKey(i),n=t.initSegments[i.cc],o=re(()=>(this.context.fragCurrent=i,this.context.fragCurrentState="loading",!n||n.data?ct:this.loadFragment(n,!1).pipe(We(e=>{this.context.fragPrevious=n;let i=e.frag,s=performance.now(),a=Object.assign(Object.assign({},e.stats),{tparseStart:s,tparsed:s,tappendStart:s,tbuffered:s});t.initSegments[i.cc].data=e.payload,this.hls.trigger(r.b.FRAG_BUFFERED,{stats:a,frag:i,id:this.sbid})})))).pipe(We(()=>{this.logger.info(`[${this.sbid}] loaded initSegment ${null==n?void 0:n.fragTag}`)()}),$r(()=>$i(this.loadFragment(i,!1),X(0).pipe(We(()=>{this._ensureDemuxer()})))),$r(e=>{let i=e[0],r=this.context.demuxer,s=t.totalduration,a=this._hasAccurateTimeOffset(t);return this.context.stats=Object.assign(Object.assign({},i.stats),{tparseStart:NaN,tparsed:NaN,tappendStart:NaN,tbuffered:NaN}),this.context.fragCurrentState="parsing",this._parse(r,n,i.frag,i.payload,s,a)}),We(e=>{this.bufferController.checkGaplessCompatibility(e.id,e.track)||(this.logger.info("[gapless] not compatible with current playlist")(),this.hls.dequeueSourceInternal(s.n.InvalidFormat).pipe(We(()=>{this.logger.info("dequeue incompatible playlist done.")()}),Xe(this.destroy$)).subscribe())}),sn((e,t)=>{if(Object(Ga.c)(t))[t.data1,t.data2].forEach(i=>{let r={content:"data",frag:t.frag,type:t.type,data:i,track:t.track,resetNow:t.resetNow};e.push(r)});else{let i={content:"initSegment",frag:n||t.frag,type:t.track.type,data:t.track.initSegment,track:t.track};e.push(i)}return e},new Array),We(()=>{this.context.stats=Object.assign(Object.assign({},this.context.stats),{tparsed:performance.now()})}));return $i([$e(i),a,o])}),We(()=>{}),$r(e=>{if(!e)return $e(null);let[t,i,r]=e;if(i&&r&&t){this.context.fragCurrentState="appending";const e=r.map(e=>this.appendFragment(t,e));return this.logFragmentTiming(t,"appendstart"),(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Ve(1)($e.apply(void 0,e))})(...e).pipe(sn((e,t)=>t?{tstart:Object(ke.c)(e.tstart)?e.tstart:t.tstart,tend:t.tend}:e,{tstart:NaN,tend:NaN}),ae(e=>(this.context.stats=Object.assign(Object.assign({},this.context.stats),{tappendStart:e.tstart,tbuffered:e.tend}),this.logFragmentTiming(t,"appendend"),t)))}return this.logger.warn(`[${this.sbid}] unexpected state after parse ${t},${i},${r}`)(),$e(null)}),We(e=>{e&&(this.context.nextLoadPosition=e.endPTS||e.start+e.duration)}))}_ensureDemuxer(){this.context.demuxer||(this.context.demuxer=new ln(this.hls,this.sbid))}_destroyDemuxer(){this.context.demuxer&&(this.context.demuxer.destroy().catch(e=>{this.logger.error("Could not destroy demuxer: "+e.message)()}),this.context.demuxer=null)}_parse(e,t,i,s,a,n){let o=this._getInitPTS(i),l=Ze(this.hls);return Ge(l.event(r.b.FRAG_PARSING_INIT_SEGMENT),l.event(r.b.FRAG_PARSING_DATA),ut(l.event(r.b.INTERNAL_ERROR),e=>e.demuxerId===this.sbid).pipe(Ie(e=>Be(()=>e))),re(()=>{var r;return(null===(r=this.context)||void 0===r?void 0:r.stats)&&(this.context.stats.tparseStart=performance.now()),this.logFragmentTiming(i,"parsing"),e.push(s,null==t?void 0:t.data,i,a,n,o),ie})).pipe(Ee(e=>e.id===this.sbid),ae(e=>{var t,i,r,s;if(Object(Ga.c)(e)){let a=e.frag;if(Object(ke.c)(e.endPTS)||(e.endPTS=e.startPTS+a.duration,e.endDTS=e.startDTS+a.duration),a.iframeMediaStart){let e=a.iframeMediaStart;Object(ke.c)(e)&&a.iframeMediaDuration}this.logger.info(`[${this.sbid}] parsed ${e.type},PTS:[${null===(t=e.startPTS)||void 0===t?void 0:t.toFixed(3)},${null===(i=e.endPTS)||void 0===i?void 0:i.toFixed(3)}],DTS:[${null===(r=e.startDTS)||void 0===r?void 0:r.toFixed(3)}/${null===(s=e.endDTS)||void 0===s?void 0:s.toFixed(3)}],dropped:${e.dropped||0}`)()}return e}),ft((e,t)=>this._handleDemuxError(e)),Xe(ut(l.event(r.b.FRAG_PARSED),e=>e.id===this.sbid)))}checkAndUpdateLevelsIfNecessary(){}appendFragment(e,t){return"initSegment"===t.content?$e(null):t.data?this._appendFragment(t):$e(null)}_appendFragment(e){let{frag:t,type:i,data:r,content:a,track:n,resetNow:o}=e,l=t.startPTS,d=t.endPTS;return this.bufferController.appendBuffer(i,r,l,d,this.sbid,a,t,n,o).pipe(We(e=>{this.context.appendTimeouts=0}),ye(1),ft((e,i)=>{if(e instanceof s.b&&e.details===s.d.BUFFER_FULL_ERROR)return this.handleBufferFullError(e,i,t.level);if(e instanceof j)return this._handleAppendTimeout(i,t.level);throw e}))}fetchKey(e){const{context:t,hls:i,logger:r,config:a}=this,{variantController:n}=t,{decryptdata:o}=e;return o.uri!==t.waitingForKey.value&&t.waitingForKey.next(o.uri),i.keyLoader.getKeyFromDecryptData(e.decryptdata,e.level,!1).pipe(se(e=>e.pipe(fe((e,t)=>e instanceof s.q?this._handleKeyError(e,n.currentVariantId,t):Be(e)))),W(3e4),We(()=>{}),Se(t=>{if(r.error(`[${this.sbid}] got key error state=${this.state}`)(),t instanceof j){const t=i.keyLoader.getLevelIdsForKey(o),r=t.has(n.currentVariantId)&&!n.containsFallbackVariant(),a=new s.q(s.g.NETWORK_ERROR,s.d.KEY_LOAD_TIMEOUT,r,"Key load timed out",s.f.CryptResponseReceivedSlowly,e.decryptdata,{isOkToRetry:!r},t);return Be(()=>a)}return Be(()=>t)}),dt(()=>{t.waitingForKey.next(null)}),Xe(t.waitingForKey.pipe(Pa(1))))}_handleKeyError(e,t,i){const{context:r,hls:a,logger:n}=this,{variantController:o}=r;let l=new Array,d=!1;e.levelIds.forEach((function(e){e===t?d=!0:l.push(e)})),d?l.push(t):n.warn(`Other levels got key error keyuri=${a.redactUrl(e.decryptdata.uri)} levelIds=${JSON.stringify(l)}`)();let h=o.variantManager,c=!1;return l.forEach(i=>{let r=i===t,n=o.containsFallbackVariant(),{errorAction:l,errorActionFlags:d}=a.networkErrorHandler.getActionForCryptKeyNetworkError(e,r,e.details===s.d.KEY_LOAD_TIMEOUT,n);c=c||r&&l===Vs.RetryRequest,a.networkErrorHandler.handleNetworkError(l,d,e,i,void 0,h,o)}),(c=!e.fatal&&c)&&Object(ke.c)(i)?X(this.hls.config.keyLoadingRetryDelay*Math.min(i+1,5)):Be(()=>e)}handleBufferFullError(e,t,i){let r=this.media.currentTime;const s=this.isBuffered(r)&&this.isBuffered(r+.5),a=this.getSourceBufferInfo(r).len,n=this.sbid;if(s){let t=1e3*this.targetDuration,s=Vs.RetryRequest;if(1e3*a<t&&(this.context.variantController.containsFallbackVariant()?s=Vs.SendAlternateToPenaltyBox:(this.logger.warn(`${n} buffer too small to sustain playback @${r.toFixed(3)} buffered:${Ka(this.buffered)}`)(),s=Vs.SendEndCallback)),this.logger.info(`${n} handleBufferFullError errorAction:${s} ${t}ms`)(),s===Vs.RetryRequest)return X(t);this.hls.networkErrorHandler.handleNetworkError(s,0,e,i,void 0,this.context.variantController.variantManager,this.context.variantController)}else{if(this.media.buffered.length>0&&t<this.config.appendErrorMaxRetry)return this.logger.warn(n+" buffer full and not buffered. flush everything and retry")(),this.flushBuffer(0,Number.POSITIVE_INFINITY);e.fatal=!0}return Be(()=>e)}_handleAppendTimeout(e,t){let i=new s.u(s.d.BUFFER_APPEND_ERROR,!1,"Append timeout",s.f.InternalError),r={errorAction:Vs.SendAlternateToPenaltyBox,errorActionFlags:0},a=this.estimateCurrentWaterLevel(),n=a<this.context.bufferMonitor.almostDryWaterLevelSeconds,o=NaN;const l=this.config.appendErrorMaxRetry;return n&&++this.context.appendTimeouts>=l||e>=l?r.errorAction=Vs.SendEndCallback:o=1e3*a,this._defaultErrorHandling(i,r,t,o).pipe(We(()=>{this.bufferController.resetSourceBuffers({seekToPos:this.playbackPos,cc:NaN})}),Se(e=>{throw n&&!e.fatal&&this.bufferController.resetSourceBuffers({seekToPos:this.playbackPos,cc:NaN}),e}))}_defaultErrorHandling(e,t,i,r){if(t=this.hls.networkErrorHandler.modifyErrorActionIfCurrentLevelIsLastValidLevel(t,e.response.code,this.variantController,this.variantManager instanceof Bs),this.logger.warn(`[${this.sbid}] default error handling: ${e.message} action=${JSON.stringify(t)}`)(),t.errorAction===Vs.RetryRequest&&Object(ke.c)(r)&&r>=0)return X(r);{let{errorHandled:r}=this.hls.networkErrorHandler.handleNetworkError(t.errorAction,t.errorActionFlags,e,i,null,this.variantManager,this.variantController);r||(e.fatal=!0)}return Be(()=>e)}_handleDemuxError(e){var t;let i=this.currentVariantId;Object(ke.c)(null===(t=e.frag)||void 0===t?void 0:t.level)&&(i=e.frag.level);let r={errorAction:Vs.SendAlternateToPenaltyBox,errorActionFlags:Gs.MoveAllAlternatesMatchingHost};return e.response=s.f.CorruptStream,this._defaultErrorHandling(e,r,i,NaN)}onInternalError(e){this.logger.warn(`[${this.sbid}] got error, not doing anything ${e.message}`)(),e.fatal?this.upgradeInternalErrorAndDie(e).pipe(Xe(this.destroy$)).subscribe():e instanceof s.q&&this._handleKeyError(e,this.currentVariantId,NaN)}_handleKeyExpiryPosition(e){e.decryptdata&&e.decryptdata.isEncrypted&&this.hls.keyLoader.updateExpiryPosition(e.decryptdata,e.level,e.start)}}const vn={startFragmentInCC:function(e,t,i){let r=t-i.cc;if(0===r){let t=e[i.sn-e[0].sn-1];r=t&&t.cc===i.cc?-1:0}return r},endFragmentInCC:function(e,t,i){let r=t-i.cc;if(0===r){let t=e[i.sn-e[0].sn+1];r=t&&t.cc===i.cc?1:0}return r},findStartEndFragmentsInCC:function(e,t){let i,r;return(null==e?void 0:e.length)>0&&Object(ke.c)(t)&&(i=Ba.search(e,vn.startFragmentInCC.bind(null,e,t)),r=Ba.search(e,vn.endFragmentInCC.bind(null,e,t))),i&&!Object(ke.c)(i.cc)&&(i=void 0),r&&!Object(ke.c)(r.cc)&&(r=void 0),{startFrag:i,endFrag:r}},getTimeRangeDictForCC:function(e,t){var i,r;let s=vn.findStartEndFragmentsInCC(e,t);const{startFrag:a,endFrag:n}=s;return{start:null!==(i=a.startPTS)&&void 0!==i?i:a.start,end:null!==(r=n.endPTS)&&void 0!==r?r:n.start+n.duration}},getTimeRangeForCC:function(e,t){let i=vn.findStartEndFragmentsInCC(e,t);const{startFrag:r,endFrag:s}=i;let a=[];return r&&s&&(a=[r.startPTS?r.startPTS:r.start,s.endPTS?s.endPTS:s.start+s.duration]),a},snapToCCTimeRange:function(e,t,i){const r=vn.getTimeRangeForCC(t,i);return(null==r?void 0:r.length)?Math.min(r[1],Math.max(r[0],e)):e},getMinTimeForCC(e,t,i){if(!(null==e?void 0:e.length))return 0;let r=0;if(Object(ke.c)(i)&&e){const s=vn.getTimeRangeForCC(e,i);if(s){const e=vn.getTimeRangeForCC(t,i);r=(null==e?void 0:e.length)?Math.max(e[0],s[0]):s[0]}}return r},ccForTime(e,t,i){const r=Ba.search(e,Ua.fragmentWithinToleranceTest.bind(null,t,i));return null==r?void 0:r.cc}};var bn=vn;function Sn(e,t){const i=e.timeline;return{seconds:(e.seconds-i.rootTimeSeconds)/i.rate*t.rate+t.rootTimeSeconds,timeline:t}}class Tn{constructor(){this._timeline=null}get forward(){var e;return(null===(e=this.timeline)||void 0===e?void 0:e.rate)>0}get isStarted(){return Boolean(this.hostClock)}start(e){this.stopTime=null,this._timeline=Object.assign({},e);const t={rootTimeSeconds:performance.now()/1e3,rate:1};this.hostClock={timeline:t,getCurrentTime:()=>({seconds:performance.now()/1e3,timeline:t})}}stop(){this.isStarted&&(this.stopTime=this.getCurrentTime()),this.hostClock=null,this._timeline=null}get timeline(){return this._timeline}getCurrentTime(){return this.stopTime?this.stopTime:Sn(this.hostClock.getCurrentTime(),this.timeline)}}class En{constructor(e){this._timeline=e,this.lastTimeSeconds=e.rootTimeSeconds}get timeline(){return Object.assign({},this._timeline)}getCurrentTime(){return{seconds:this.lastTimeSeconds,timeline:Object.assign({},this._timeline)}}}class _n extends cs{constructor(e){super(e),this.iframeClock=new Tn,this.hasMore$=new te(!0),this.scaledFragments=[]}destroy(){this.stop()}resetScaledSegments(){let e=this.scaledFragments;for(let t=0;t<e.length;t++){let i=e[t];Object(ke.c)(i.iframeMediaStart)&&(i.iframeMediaStart=void 0,i.iframeMediaDuration=void 0)}this.scaledFragments=[]}get anchorFrag(){return this.scaledFragments.length?this.scaledFragments[0]:null}get lastFrag(){return this.scaledFragments.length?this.scaledFragments.slice(-1)[0]:null}get isStarted(){return Boolean(this.iframeClock.isStarted)}get iframeRate(){var e;return null!==(e=this.iframeClock.timeline.rate)&&void 0!==e?e:0}get iframeClockTimeSeconds(){return this.iframeClock.getCurrentTime().seconds}get mediaAppendClockTimeSeconds(){var e,t;return null!==(t=null===(e=this.mediaAppendClock)||void 0===e?void 0:e.getCurrentTime().seconds)&&void 0!==t?t:0}stop(){this.hasMore$.next(!0),this.iframeClock.stop(),this.mediaAppendClock=null,this.resetScaledSegments()}checkHasMore(){this.hasMore$.next(!0)}startClocksAndGetFirstFragment(e,t,i,r){this.logger.info(`[ifm] startClocksAndGetFirstFragment: rate(${i}), pos(${r})`)();let s,a=Fa.search(e,Ua.fragmentWithinToleranceTest.bind(null,r,1e-4));if(!a&&r>=e[e.length-1].start&&(this.logger.info("[ifm] startClocksAndGetFirstFragment: pick last frag, start="+e[e.length-1].start)(),a=e[e.length-1]),!a)return this.logger.error("[ifm] startClocksAndGetFirstFragment => no anchorFrag for time "+r)(),this.hasMore$.next(!1),null;if(i>1)s=Math.ceil(r);else{const i=bn.getMinTimeForCC(e,t,a.cc);s=Math.ceil(i)}return this.iframeClock.start({rootTimeSeconds:r,rate:i}),this.mediaAppendClock=new En({rootTimeSeconds:s,rate:1}),{frag:a,newMediaRootTime:s}}getNextFragment(e,t,i){const r=this.lastFrag,{iframeClock:s,mediaAppendClock:a}=this,n=s.timeline;a.lastTimeSeconds=t,this.logger.info(`[QE Critical] [iframes] picked frag params maxMediaTime: ${t}, ifmat: ${this.mediaAppendClock.timeline.rootTimeSeconds}, ifbt: ${this.iframeClock.timeline.rootTimeSeconds}`)();const o=s.forward?1:-1;let l,d=Math.max(0,Math.min(r.seqNum-e[0].seqNum+o,e.length-1));if(r.sn!==e[d].sn)do{l=e[d];const i=s.forward?l.start:l.start+l.duration;if(Sn({seconds:i,timeline:n},a.timeline).seconds>=t&&(s.forward&&i>=this.iframeClockTimeSeconds||!s.forward&&i<=this.iframeClockTimeSeconds))break;d+=o}while(d>0&&d<e.length);return l||(this.logger.error(`[ifm] getNextFragment(bufferEnd: ${t}, bufferLen: ${i}) => no more frags, but we should have found an end fragment, setting hasMore to false`)(),this.hasMore$.next(!1)),{frag:l}}nextFragment(e,t,i,r,s){let a,n;if(this.isStarted&&i!==this.iframeRate&&(n=this.iframeClock.getCurrentTime().seconds,this.stop()),this.isStarted){if(!(a=this.getNextFragment(e,r,s)))return;if(a.frag.cc!==this.anchorFrag.cc){this.logger.info(`[ifm] nextFragment iframeClockTime(${this.iframeClockTimeSeconds.toFixed(3)}) => found new disco, ${this.anchorFrag.cc} to ${a.frag.cc}`)();const r=this.iframeClock.getCurrentTime().seconds;this.stop(),a=this.startClocksAndGetFirstFragment(e,t,i,r)}}else if(!(a=this.startClocksAndGetFirstFragment(e,t,i,null!=n?n:r)))return;const{frag:o,newMediaRootTime:l}=a;this.handleNextFrag(e,o);const d=o.iframeMediaStart,h=o.iframeMediaStart+o.iframeMediaDuration;return this.logger.info(`[ifm] nextFragment iframeClockTime(${this.iframeClockTimeSeconds.toFixed(3)}) => picked frag: ${o.fragTag}, source range: ${o.rangeString}, media append times: ${d.toFixed(3)}-${h.toFixed(3)}${Object(ke.c)(l)?", newMediaRootTime: "+l.toFixed(3):""}`)(),a}handleNextFrag(e,t){const{mediaAppendClock:i,iframeClock:r}=this;this.iframeClockBounds=bn.getTimeRangeDictForCC(e,t.cc);const s=i.getCurrentTime().seconds,a=r.timeline.rate;t.iframeMediaStart=s,t.iframeMediaDuration=Math.max(t.duration/Math.abs(a),1/8),this.scaledFragments.push(t),this.isEndFrag(e,t)&&(this.logger.info(`[ifm] checkEOS(frag: ${t.sn}) => found end frag, setting hasMore to false`)(),this.hasMore$.next(!1))}get hasMore(){return this.hasMore$.value}handleWaitForMore(){if(!this.isStarted)return ct;const e=this.iframeClock.getCurrentTime(),t=e.seconds,i=e.timeline.rate,r=i>1?this.iframeClockBounds.end:this.iframeClockBounds.start,s=r-e.seconds,a=s/i;return this.logger.info(`[ifm] handleWaitForMore(): iframeClockTime: ${t}, edgeTime: ${r}, diff ${s} => wait: ${a}`)(),ut(this.hasMore$,e=>!0===e).pipe(We(()=>{this.logger.info(`[ifm] handleWaitForMore(): iframeClockTime: ${t} => hasMore became true while waiting`)()}))}isEndFrag(e,t){const i=e[0],r=e[e.length-1],s=this.iframeClock.forward;return!s&&(null==i?void 0:i.sn)===t.sn||s&&(null==r?void 0:r.sn)===t.sn}}class Dn extends yn{constructor(e){super(e,{name:"main",initialContext:new mn(e,e.levelController,"main"),initialState:fn.STOPPED},"main"),this._bufferedFrags=[],this.haveEnough$=new te(!1),this.playbackLikelyToKeepUp$=new te(!1),this.seekId$=new te(null),this.gaplessAllowed=!0,this.gotVariants$=new te(!1),this.nudgeSeeking=!1,this.firstPlaybackStarted=!1,this.pendingPlayPromises=[],this.startTargetDurationFactor=this.config&&this.config.startTargetDurationFactor?this.config.startTargetDurationFactor:1,this.iframeMachine=new _n(e),this.sessionDataLoader=new Qs(this.hls)}_subscribe(e){const t=Ze(this.hls,this);return e.add(Ge(t.event(r.b.MANIFEST_LOADING,this.onManifestLoading),t.event(r.b.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted),t.event(r.b.BUFFER_APPENDED,this.onBufferAppended),t.event(r.b.BUFFER_FLUSHED,this.onBufferFlushed),t.event(r.b.LEVELS_CHANGED,this.onLevelsChanged),t.event(r.b.BANDWIDTH_CHANGED,this.onBandwidthChanged),t.event(r.b.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching)).subscribe()),e.add(this.context.media$.pipe(Ie(e=>{if(!e)return ie;let t=Ze(e),i=Ze(this.hls,this);return Ge(t.event("seeking",this.onMediaSeeking.bind(this)),t.event("seeked",this.onMediaSeeked.bind(this)),t.event("ended",this.onMediaEnded.bind(this)),t.event("playing",this.onMediaPlaying.bind(this)),t.event("play",this.onMediaPlay.bind(this)),t.event("pause",this.onMediaPause.bind(this)),t.event("timeupdate",this.onMediaTimeUpdate.bind(this)),t.event("canplaythrough",this.onCanPlay.bind(this)),new x(()=>{let t=this.stallMonitor=new Ha(this.hls,e,.5,this.hls.config.lowBufferWatchdogPeriod,this.hls.config.highBufferWatchdogPeriod,this.hls.config.seekWatchdogPeriod);return()=>{t.destroy(),this.stallMonitor=null}}),i.event(r.b.STALLED).pipe(fe(e=>this.onStalled(e))))})).subscribe()),e.add(ut(this.playbackLikelyToKeepUp$,e=>!0===e).pipe(Ie(()=>this._loadSessionDataIfNecessary()),Se(()=>ie)).subscribe()),super._subscribe(e)}destroy(){this.onMediaDetaching(),this.destroy$.next()}get loadingItemStartTime(){return this.hls.loadingItem.startTime}get playingItemStartTime(){return this.hls.playingItem.startTime}get targetDuration(){var e;return(null===(e=this.context.bufferMonitor)||void 0===e?void 0:e.targetDuration)||this.context.targetDuration}get levels(){return this.hls.levels}get seekInfoObs(){return this.context.seekInfo$.pipe(Xe(this.destroy$))}startLoad(e){if(this.logger.info(`startLoad(${e})`)(),this.levels&&this.levels.length>0){let t=this.lastCurrentTime,i=this.hls;if(this.stopLoad(),this.config.useFirstLevelAtIncompatDiscontinuity&&!this.iframeMode&&(this.currentVariantId=-1),!this.context.startFragRequested){let e=i.startLevel;-1===e&&(e=this.hls.levelController.startLevel,this.bitrateTest=!0),(!this.currentVariantId||this.currentVariantId<0)&&(this.currentVariantId=i.nextLoadLevel=e),this.hls.isPreloadingItem&&(this.levelLastLoaded=this.currentVariantId,this.logger.info(`[gapless] preloading level: assume loadedmetadata ${this.loadedmetadata} levelLastLoaded ${this.levelLastLoaded}`)())}t>0&&-1===e&&(e=t),this.hls.isPreloadingItem||this.seek(e),this.state===fn.STOPPED&&this.transition(fn.NEED_DATA)}else this.forceStartLoad=!0;this.autoPausedRestartTime=void 0}stopLoad(){this.state!==fn.STOPPED&&(this.transition(fn.STOPPED),this._destroyDemuxer(),this.forceStartLoad=!1)}signalReadyForNextItem(e){X(0,y).pipe(We(()=>{this.logger.info(`[gapless] item fully appended @ ${e}; media.duration ${this.media.duration}s`)(),this.hls.trigger(r.b.READY_FOR_NEXT_ITEM,{duration:e})}),Xe(this.destroy$)).subscribe()}setVariantAndLoad(e){let t=super.setVariantAndLoad(e);return this.iframeMode||this.hls.matchAudioAndSubtitleGroups(e),t.pipe(We(e=>{let t=this.context.seekInfo;if(t&&!Object(ke.c)(t.cc)){let i=Object.assign(Object.assign({},t),{cc:bn.ccForTime(e.fragments,t.seekToPos,this.hls.config.maxFragLookUpTolerance)});this.logger.info(`[main] got details, updating seekInfo=${JSON.stringify(i)} #disco`)(),this.context.seekInfo=i}}))}in_NEED_INIT(){return this.gotVariants$.pipe(Ee(e=>e),We(()=>{this.transition(fn.NEED_DATA)}))}in_NEED_DATA(){return Ge(super.in_NEED_DATA(),X(0,100).pipe(We(()=>this._periodicNeedDataCheck()),Se(this._catchError.bind(this))))}checkAndUpdateLevelsIfNecessary(){let e=this.hls;const t=e.media,i=this.variantManager.getDisplaySize(),r="object"==typeof window&&window.devicePixelRatio?window.devicePixelRatio:1,s=t&&t.clientWidth&&t.clientHeight?{width:t.clientWidth*r,height:t.clientHeight*r}:void 0,a=i&&s&&(i.width!==s.width||i.height!==s.height);e.config.useViewportSizeForLevelCap&&a&&(this.variantManager.updateDisplaySize(s),this.transition(fn.NEED_DATA))}_periodicNeedDataCheck(){this._checkIfPlaybackLikelyToKeepUp(),this._checkForIframeAutoPause()}_checkForIframeAutoPause(){if(!this.loadedmetadata||!this.iframeMode||!this.iframeMachine.isStarted)return;const e=this.iframeMachine.iframeClockTimeSeconds,t=this.media.currentTime,i=this.desiredRate,{len:r}=this.getSourceBufferInfo(t),s=this.hls.config.leftMediaTimeToAutoPause;let a=this.media.seekable,n=a.start(0),o=a.end(a.length-1);return i>1&&o-e<s?(this.logger.info(`[iframes] near the end of media, resuming normal playback, bufferLen: ${r}, maxTime ${o}, ifrct ${e}`)(),this.autoPausedRestartTime=o-s,void this.hls.setRate(0)):i<0&&e-n<i/-2?(this.logger.info(`[iframes] near the start of media, pausing playback at ${this.autoPausedRestartTime} left, bufferLen: ${r}, minTime ${n}, ifrct ${e}`)(),this.autoPausedRestartTime=n,void this.hls.setRate(1)):void 0}estimateCurrentWaterLevel(){return this.iframeMode?this.iframeMachine.hasMore?0:1e3:super.estimateCurrentWaterLevel()}handleHighWater(){return this.iframeMode&&!this.iframeMachine.hasMore?this.iframeMachine.handleWaitForMore():Ji(super.handleHighWater(),this._prefetchIframes())}handleResetLoad(e){var t;null===(t=this.context.bufferMonitor)||void 0===t||t.notifyWaterLevelChanged(),this.context.nextLoadPosition=e.seekToPos,this.seek(e.seekToPos)}_getFragmentToLoad(e){let t=this.playbackPos;const i=this.getSourceBufferInfo(t);let{len:r,end:s}=i;return this.seeking||!0!==this.context.isFlushing.value||this.iframeMode||(s=this._startOffsetOfBufferFlush,r=void 0),this.iframeMode?this.getCandidateIframeFragment(s,r,e):this._getCandidateFragment(t,s,r,e)}_isEnded(e){if(!this.loadedmetadata||!e)return!1;let t=this.variantController.variantManager.getVariantInfo(e.level),i=null==t?void 0:t.details,r=this.media,s=r.currentTime,a=this.getSourceBufferInfo(s);if(!(null==i?void 0:i.live)&&e&&e.isLastFragment&&!(null==t?void 0:t.iframes)){const t=Math.min(r.duration,e.start+e.duration);let i=this.playingItemStartTime,n=a.len>0||s>=t;if(t-Math.max(a.end,e.start)<=Math.max(.2,e.duration)&&n){if(this.logger.info(`check ending: ${JSON.stringify(a)} = this.getSourceBufferInfo(${s}); playingItemStartTime ${i}`)(),this.logger.info(`check ending: fragPrevious.sn ${e.sn} ${e.startPTS} ${e.isLastFragment}`)(),this.logger.info(`check ending: ${t-Math.max(a.end,e.start)} = ${t} - Math.max(${a.end}, ${e.start}) <= Math.max(0.2, ${e.duration})`)(),!this.hls.config.gapless||!this.gaplessAllowed)return this.logger.info("video: item fully appended")(),this.hls.bufferController.endBuffer("main"),!0;this.hls.playingItem.itemId!==this.hls.loadingItem.itemId?this.logger.info(`[gapless] delay readyForNextItem because item ${this.hls.playingItem.itemId} is still playing and item ${this.hls.loadingItem.itemId} hasn't started`)():this.signalReadyForNextItem(a.end)}}return!1}_prefetchIframes(){return!1!==this.config.enableIFramePreloading&&this.variantManager.hasIframeLevels&&this.variantManager.validVariantList.some(e=>e.iframes)&&!this.hls.isLive?re(()=>{let e=this.hls.abrController.findNextABRAutoLevelInMode(!0);return this.loadPlaylist(e,!0)}).pipe(ka(y),Ie(e=>{if(e&&this.fragPrevious){let t=this.fragPrevious.cc,i=e.initSegments[t];if(i&&!i.data)return $i([this.fetchKey(i),re(()=>this.loadFragment(i,!0).pipe(We(e=>{i.data=e.payload})))])}return Ta}),(e=Ta,Ie((function(){return e}))),dt(()=>{})):Ta;var e}_getVideoAudioSourceBufferInfo(){let e=this.playbackPos;return Oa.bufferInfo(this.media?this.media:this,e,this.config.maxBufferHole)}combinedBufferEmpty(){let e=this._getVideoAudioSourceBufferInfo().len<this.config.almostDryBufferSec,t=e;if(this.hls.subtitleStreamController.isSubtitleTrackEnabled()){let i=this.hls.subtitleStreamController.estimateCurrentWaterLevel()<this.config.almostDryBufferSec;t=e||i}return t}getCandidateIframeFragment(e,t,i){var r;void 0!==this.iframeRateSetTime&&(this.logger.info(`[iframes] level switch to ${this.currentVariantId} for (${this.desiredRate}x) playback, spentTime = ${performance.now()-this.iframeRateSetTime}`)(),this.iframeRateSetTime=void 0);const s=i.fragments,a=null===(r=this.hls.audioStreamController)||void 0===r?void 0:r.currentFragments,{frag:n,newMediaRootTime:o}=this.iframeMachine.nextFragment(s,a,this.desiredRate,e,t);return Object(ke.c)(o)&&this.seek(o),n}_getCandidateFragment(e,t,i,r){const s=this.fragPrevious,a=r.fragments,n=a.length;if(0===n)return null;const o=a[0].start,l=a[n-1].start+a[n-1].duration;let d;if(r.live){let e=this.config.initialLiveManifestSize;if(n<e)return this.logger.warn(`Can not start playback of a level, reason: not enough fragments ${n} < ${e}`)(),null;if(null===(d=this._ensureFragmentAtLivePoint(r,t,o,l,s,a,n)))return d}else t<o&&(d=a[0]);return d||(d=this._findFragment(s,a,t,l,r)),d}_loadSessionDataIfNecessary(){let e=this.hls.sessionData;return!e||e&&!e.itemList?ie:this.sessionDataLoader.loadSessionData(e)}get isWaitingForIncompatibleCC(){return this.bufferController.isWaitingForReset(this.sbid)}_ensureFragmentAtLivePoint(e,t,i,r,s,a,n){const o=this.hls.config,l=this.media;let d,h=void 0!==o.liveMaxLatencyDuration?o.liveMaxLatencyDuration:o.liveMaxLatencyDurationCount*e.targetduration;if(t<Math.max(i-o.maxFragLookUpTolerance,r-h)){let r=this.liveSyncPosition=this.computeLivePosition(i,e);t=r,this.seek(r)}if(e.PTSKnown&&t>r&&l&&l.readyState)return null;if(this.context.startFragRequested&&!e.PTSKnown){if(s){var c=s.seqNum+1;c>=e.startSN&&c<=e.endSN&&(d=a[c-e.startSN])}d||(d=a[Math.min(n-1,Math.round(n/2))])}return d}_findFragment(e,t,i,r,s){const a=this.hls.config;let n,o,l=a.maxFragLookUpTolerance;if((o=Ua.findFragmentBySNAndBuffer(e,t,i,r,l))&&"initSegment"!==o.sn){const i=o.sn-s.startSN,r=e&&o.level===e.level,l=t[i-1],d=t[i+1];if(n=o,e&&n.sn===e.sn)if(r&&!n.backtracked)if(n.sn<s.endSN){let t=e.deltaPTS;t&&t>a.maxBufferHole&&e.dropped&&i?(n=l,this.logger.warn("SN just loaded, with large PTS gap between audio and video, maybe frag is not starting with a keyframe ? load previous one to try to overcome this")()):n=d}else n=null;else n.backtracked&&(d&&d.backtracked?(this.logger.warn(`Already backtracked from fragment ${d.sn}, will not backtrack to fragment ${n.sn}. Loading fragment ${d.sn}`)(),n=d):(this.logger.warn("Loaded fragment with dropped frames, backtracking 1 segment to find a keyframe")(),n.dropped=0,l?(n=l).backtracked=!0:n=null))}return n}getBufferedFrag(e){return Ba.search(this._bufferedFrags,(function(t){let i=t.iframe?t.iframeMediaStart:t.startPTS,r=t.iframe?t.iframeMediaStart+t.iframeMediaDuration:t.endPTS;return e<i?-1:e>r?1:0}))}get currentFragments(){var e,t;let i=null===(e=this.variantManager.getVariantInfoIfValid(this.currentVariantId))||void 0===e?void 0:e.details;return i||(i=null===(t=this.variantManager.getVariantInfoIfValid(this.levelLastLoaded))||void 0===t?void 0:t.details),null==i?void 0:i.fragments}get currentLevel(){let e=this.media;if(e){const t=this.getBufferedFrag(e.currentTime);if(t)return t.level}return-1}get nextBufferedFrag(){let e=this.media;return e?this.followingBufferedFrag(this.getBufferedFrag(e.currentTime)):null}followingBufferedFrag(e){return e?this.getBufferedFrag(e.endPTS+.5):null}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}_checkFragmentChanged(){var e,t,i=this.media;if(i&&i.readyState&&!1===i.seeking&&((t=i.currentTime)>i.playbackRate*this.lastCurrentTime&&(this.lastCurrentTime=t),Oa.isBuffered(i,t)?e=this.getBufferedFrag(t):Oa.isBuffered(i,t+.1)&&(e=this.getBufferedFrag(t+.1)),e)){var s=e;if(s!==this.fragPlaying){this.hls.trigger(r.b.FRAG_CHANGED,{frag:s});const e=s.level;(!this.fragPlaying||this.fragPlaying.level!==e||this.hls.inGaplessMode&&this.fragPlaying.itemId!==s.itemId)&&this.hls.trigger(r.b.LEVEL_SWITCHED,{level:e}),this.fragPlaying=s}}}get seeking(){return Boolean(this.context.seekInfo)||this.media&&this.media.seeking}adjustSeekPosition(e){let t=this.media,i=Oa.bufferInfo(t,e,0),r=e;if(0===i.len){let t=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(r=this._ensureNudgeStartTimeForIncompatibleCC(i.nextStart,e,t))&&this.logger.warn(`[seek] adjusted seek for incompatible cc nudge ${e}->${r}`)()}else Object(ke.c)(i.nextStart)&&i.nextStart-e<this.config.maxBufferHole&&(this.logger.warn(`close to small buffer hole, adjusted seek ${e}->${i.nextStart}`)(),r=i.nextStart);return r}getAutoSeekPosition(){var e,t;let i=(null===(e=this.variantManager.getVariantInfoIfValid(this.levelLastLoaded))||void 0===e?void 0:e.details)||(null===(t=this.variantManager.getVariantInfoIfValid(this.currentVariantId))||void 0===t?void 0:t.details);return Ui(()=>null!=i,$e(i),Ze(this.hls).event(r.b.LEVEL_UPDATED).pipe(ae(e=>e.details))).pipe(ae(e=>this.ensureAutoSeekPosition(e)),ye(1))}ensureAutoSeekPosition(e){let t,i=e.totalduration,r=e.live?e.fragments[0].start:0,s=e.startTimeOffset;return this.hls.pendingSeekToDate&&(s=this.hls.resolvePendingSeekToDate(),this.hls.pendingSeekToDate=void 0),Object(ke.c)(s)?(s<0&&(s=r+i+s),t=s):t=e.live?this.computeLivePosition(r,e):0,t}seek(e,t=!0){var i;if(isNaN(e))return;let s;if(e<0)this.context.seekInfo=null,s=this.getAutoSeekPosition();else{if(this.media&&t){let t=this.adjustSeekPosition(e);Math.abs(e-t)>=Number.EPSILON&&(e=t)}s=$e(e)}let a=""+performance.now();this.logger.info(`[seek] new seek ${e} seekId=${a} oldPos=${null===(i=this.context.seekInfo)||void 0===i?void 0:i.seekToPos} oldId=${this.seekId$.value}`)(),this.seekId$.next(a),s.pipe(Ie(e=>{var t;let{isFlushing:i}=this.context,s=this.hls.bufferController.loadedMetadata$,a=!this.context.seekInfo||Math.abs(e-this.context.seekInfo.seekToPos)>=Number.EPSILON,n={cc:NaN,seekToPos:e};if(this.currentFragments&&(null===(t=this.currentFragments[0])||void 0===t?void 0:t.iframe)===this.iframeMode){if(!this.hls.isPreloadingItem||!this.firstPlaybackStarted){let t=this.currentFragments[0].start;n.seekToPos=e=Math.max(t,e)}const t=bn.ccForTime(this.currentFragments,e,this.hls.config.maxFragLookUpTolerance);n.cc=t}return this.context.seekInfo=n,this.playbackLikelyToKeepUp=!1,this.haveEnough=!1,a&&(this.iframeMode||(this.logger.info(`startSeek(${e})`)(),this.hls.trigger(r.b.SEEKING,{seekToPos:e}))),this.media&&!this.media.paused&&this._mediaPause(),_a([$e({seekPositionChanged:a,seekToPos:e,isFirstSeek:!s.value}),i,s])}),Ie(e=>{let[i,r,s]=e;if(!i||r||!s)return Ta;let{seekToPos:a,isFirstSeek:n}=i;return n&&(a=this._adjustStartPosition(a)),t&&(this.logger.info("[seek] adjust currentTime seekToPos="+a)(),this.iframeModeSeek=this.iframeMode,this.mediaSeekFn?this.mediaSeekFn(a):this.media.currentTime=a),this.haveEnough$}),Ee(e=>!0===e),ye(1),We(()=>{var e;this.logger.info(`[seek] completeSeek(${null===(e=this.context.seekInfo)||void 0===e?void 0:e.seekToPos}) currentTime=${this.media.currentTime}`)(),this.iframeModeSeek||this.hls.trigger(r.b.SEEKED),this.iframeModeSeek=!1,this.context.seekInfo=null,this.seekId$.next(null)}),Se(e=>(this.logger.error("Error in seek "+e.message)(),Ta)),dt(()=>{}),Xe(this.seekId$.pipe(Ee(e=>e!==a)))).subscribe()}_adjustStartPosition(e){this.media;let t=this.media.currentTime,i=this.loadingItemStartTime,r=this.buffered;i=Object(ke.c)(i)?i:0;let s=Object(ke.c)(e)?e:i;const a=this.isBuffered(s);return this.hls.isPreloadingItem||t===s&&a?e:(a||(s=r.start(0),this.logger.info("target start position not buffered, seek to buffered.start(0) "+s)()),this.logger.info(`adjust currentTime from ${t} to ${s}`)(),s)}set playbackLikelyToKeepUp(e){this.playbackLikelyToKeepUp$.value!==e&&(this.playbackLikelyToKeepUp$.next(e),this.hls.trigger(r.b.PLAYER_STATE_CHANGE,{playbackLikelyToKeepUp:e}))}get playbackLikelyToKeepUp(){return this.playbackLikelyToKeepUp$.value}set haveEnough(e){this.haveEnough$.value!==e&&this.haveEnough$.next(e)}get _avgBufferAppendMs(){return!this._numAppends||this._numAppends<2?400:this._totalBufferAppendMs/this._numAppends}updateAppendBufferAvg(e){Object(ke.c)(this._numAppends)&&Object(ke.c)(this._totalBufferAppendMs)||(this._numAppends=0,this._totalBufferAppendMs=0),this._totalBufferAppendMs+=e,++this._numAppends}get _avgParseBw(){return this._totalParseSec?this._totalParsedBits/this._totalParseSec:0}updateParseBwAvg(e,t){this._totalParseSec||(this._totalParsedBits=0,this._totalParseSec=0),this._totalParsedBits+=8*e,this._totalParseSec+=t/1e3}static getEstimatedTimeToAppend(e,t,i,r,s,a,n,o){let l=1/0;if(e.len>=i)l=0;else if(r&&s&&Math.abs(r.start-e.end)<=o&&(l=n.avgAppendMs/1e3,a)){let e=t.realBitrate?Math.max(t.realBitrate,t.bitrate):t.bitrate,i=Object(ke.c)(a.total)?8*a.total:Math.ceil(r.duration*e);switch(s){case"loading":{let e=8*a.loaded,t=i-e,r=e/(performance.now()-a.tfirst)*1e3,s=n.avgNetworkBw;l+=t/(r?Math.min(s,r):s)}case"parsing":{let e=Object(ke.c)(a.tload)?(performance.now()-a.tload)/1e3:0,t=i/n.avgParseBw;l+=Math.max(0,t-e);break}}}return l}_likelyToAppendFragInTime(e,t,i,r){var s,a;let n=t.len,o=this.getSourceBufferInfo(e),l=!1,d=Dn.getEstimatedTimeToAppend(o,i,r,this.fragCurrent,this.context.fragCurrentState,(null===(a=null===(s=this.fragCurrent)||void 0===s?void 0:s.loader)||void 0===a?void 0:a.stats)||this.context.stats,{avgAppendMs:this._avgBufferAppendMs,avgParseBw:this._avgParseBw,avgNetworkBw:this.hls.abrController.getAvgBandwidthEstimate()},this.config.maxBufferHole);return(l=d<=n)&&!this.playbackLikelyToKeepUp&&this.logger.info(`[main] Probably haveEnough bufferLen=${n} nextFragAppendedDur=${d.toFixed(3)}`)(),l}_checkIfPlaybackLikelyToKeepUp(){if(!this.media||!this.loadedmetadata)return this.playbackLikelyToKeepUp=!1,void(this.haveEnough=!1);let e=this.currentVariantId,t=this.variantManager.getVariantInfoIfValid(e),i=t?t.details:void 0;if(!t||!i)return;let r=this.context.seekInfo?this.context.seekInfo.seekToPos:this.media.currentTime,s=Oa.bufferInfo(this.media,r,this.hls.config.maxBufferHole),a=s.len;if(a<=0)return this.playbackLikelyToKeepUp=!1,void(this.haveEnough=!1);let n=Math.min(i.targetduration,15);this.fragPrevious&&(n=Math.min(this.fragPrevious.duration,n));let o=Math.max(1,n*this.startTargetDurationFactor),l=this.iframeMode||a>=n||a>=o,d=i.fragments[i.fragments.length-1],h=i.fragments[0].start+i.totalduration,c=this.isWaitingForIncompatibleCC,u=this.getBufferedFrag(r);if(u){let{endFrag:e}=bn.findStartEndFragmentsInCC(i.fragments,u.cc);c=c||Object(ke.c)(u.cc)&&(!e||e.equals(u))}l&&i.live?l=r<=h-d.duration:i.live||(l=l||r>=h-n),l=l||c||this._likelyToAppendFragInTime(r,s,t,n),this.media&&!this.media.ended&&this.media.paused&&l&&0!==this.desiredRate&&!this.context.isFlushing.value&&(this.logger.info(`[main] haveEnough desiredRate=${this.desiredRate} bufferLen=${a} discontinuity=${c}`)(),this._mediaPlay()),l||!this.media.controls&&!this.hls.config.nativeControlsEnabled||!this.seeking||this.media.paused||(this.logger.warn("Seeking but not enough buffer !media.paused bufferLen="+a)(),this._mediaPause()),this.haveEnough=l&&!this.media.seeking,this.playbackLikelyToKeepUp=l&&this.media&&this.media.readyState>=this.media.HAVE_ENOUGH_DATA}_mediaPlay(){if(this.media){if(this.playPromise||this.context.isFlushing.value)return void this.logger.warn(`Ignoring play command playPromise/flushing ${Boolean(this.playPromise)}/${this.context.isFlushing.value}`)();this._expectPlayEvent=this._expectPlayEvent||this.media.paused,this.logger.info("play() expectPlayEvent="+this._expectPlayEvent)(),this.playPromise=this.media.originalPlay(),this.playPromise&&this.playPromise.then(function(){this.logger.info("play() complete")(),this.playPromise=null,this._handlePendingPlayPromises()}.bind(this)).catch(function(e){this.playPromise=null,this._expectPlayEvent=!1,this._handlePendingPlayPromises(e||new Error("Play rejected for unknown reason")),"NotAllowedError"===(null==e?void 0:e.name)?(this.logger.warn("play() not allowed, going back to rate 0")(),this.hls.desiredRate=0):this.logger.error("play() error: "+(null==e?void 0:e.message))()}.bind(this))}}_handlePendingPlayPromises(e){let t=this.pendingPlayPromises,i=t.length;if(e)for(let r=0;r<i;r++)t[r].reject(e);else for(let e=0;e<i;e++)t[e].resolve();this.pendingPlayPromises=[]}_mediaPauseInternal(){this._expectPauseEvent=this._expectPauseEvent||!this.media.paused,this.logger.info("pause() expectPauseEvent="+this._expectPauseEvent)(),this.media.originalPause()}_mediaPause(){this.media&&(this.logger.info("pause() playPromise="+Boolean(this.playPromise))(),this.playPromise?this.playPromise.then(()=>{(0===this.desiredRate||this.seeking&&!this.playbackLikelyToKeepUp)&&this._mediaPauseInternal()}).catch(e=>{this.logger.error("Promise error in pause(): "+e.message)()}):this._mediaPauseInternal())}get realCurrentTime(){return this.iframeMachine.isStarted?this.iframeMachine.iframeClockTimeSeconds:this.context.seekInfo?this.hls.isPreloadingItem?this.context.seekInfo.seekToPos-this.playingItemStartTime:this.context.seekInfo.seekToPos:this.media?this.hls.isPreloadingItem?this.media.currentTime-this.playingItemStartTime:this.media.currentTime:void this.logger.info("invalid realCurrentTime")()}set realCurrentTime(e){if(!this.media)return;let t=this.hls.isPreloadingItem?this.playingItemStartTime:0;this.logger.info("[gapless] set realCurrentTime = "+(e+t))(),this.media.currentTime=e+t}get iframeMode(){return this.isIframeRate(this.desiredRate)}get effectiveRate(){return this.media?this.iframeMode?this.desiredRate:this.media.paused?0:1:0}isIframeRate(e){return 0!==e&&1!==e}get canContinuePlaybackWithoutGap(){let e=this.hls.nextLoadLevel,t=this.variantManager.getVariantInfoIfValid(e),i=t?t.details:void 0;return Oa.canContinuePlaybackWithoutGap(this,this.media.currentTime,this.config.maxBufferHole,this.hls.playlistType,i)&&(!this.altAudio||!this.hls.audioStreamController||this.hls.audioStreamController.canContinuePlaybackWithoutGap)}get desiredRate(){return void 0!==this._desiredRate?this._desiredRate:0}disableAudioTrack(){this.altAudio=!1;let e=this.realCurrentTime;this._destroyDemuxer(),this.logger.info("[main] disable audio track @ "+e)(),this.bufferController.resetSourceBuffers({seekToPos:e,cc:null})}enableAudioTrack(e){this.clearAllLevels(),this.logger.info("[main] enable audio track @ "+e)(),this.altAudio=!0,this._destroyDemuxer(),this.bufferController.resetSourceBuffers({seekToPos:e,cc:null})}set desiredRate(e){if(!this.media)return;const t=this.desiredRate,i=this.isIframeRate(e),s=this.isIframeRate(this.desiredRate);if(!i&&!s||t===e)return this.logger.info(`Ordinary rate change ${t} -> ${e}`)(),this._desiredRate=e,this.hls.isLive&&t!==e&&(0===e?this.hls.levelController.stopLoad():this.canContinuePlaybackWithoutGap||(this._mediaPause(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY).pipe(Xe(this.destroy$)).subscribe(),this.pendingExpiredLiveBufferRange=null,this.hls.levelController.cleanupLevels())),0===e?this.media.paused||this._mediaPause():1===e&&(this.media.paused&&this._checkIfPlaybackLikelyToKeepUp(),this.state===fn.STOPPED&&this.transition(fn.NEED_INIT)),void(t!==e&&this.hls.trigger(r.b.DESIRED_RATE_CHANGED,{oldRate:t,newRate:e}));const a=this.realCurrentTime;if(this.logger.info(`[ifm] rate change ${t} -> ${e}, rct: ${a.toFixed(3)}`)(),this._desiredRate=e,this.hls.config.enableIFrameSkipBadTimestamps&&s&&this.hls.disabledAudioTrack?this.logger.info("[iframes] skip immediateLevelSwitch")():this.immediateLevelSwitch(!0),this.iframesInSourceBuffer=void 0,i)if(s)this.logger.info("[ifm] staying in iframe mode, iframeReferenceClockTime: "+a.toFixed(3))(),this.iframeMachine.checkHasMore();else{this.iframeMachine.stop(),this.muteValueAtSwitch=this.hls.media.muted,this.hls.media.muted=!0,this.hls.subtitleStreamController.prepareForTrickPlay(),this.iframeRateSetTime=performance.now();let e=this.variantManager.getVariantInfoIfValid(this.currentVariantId);e&&!e.iframes?this.levelAtSwitch=this.currentVariantId:this.logger.warn(`currentLevel is in penalty or an i-frame level ${this.currentVariantId} levelAtSwitch:${this.levelAtSwitch}`)(),Object(ke.c)(this.levelAtSwitch)||(this.levelAtSwitch=this.hls.startLevel),this.hls.abrController.nextMaxAutoLevel=-1;const t=this.hls.levelController.nextLoadLevel,i=this.variantManager.getVariantInfoIfValid(t),r=i&&i.width&&i.height?`${i.width}x${i.height}`:"N/A";this.context.nextLoadPosition=a,this.hls.config.enableIFrameSkipBadTimestamps&&(this.hls.loadLevel=t),this.logger.info(`[QE Critical] [iframes] entering iframe mode, levelAtSwitch: ${this.levelAtSwitch} iframeLevel: ${t}, resolution: ${r}, bandwidth: ${i?i.bandwidth:"undefined levelInfo"}`)()}else{this.iframeMachine.stop(),this.hls.media.muted=this.muteValueAtSwitch;const e=this.variantController.getTrickPlayResumeLevel(this.levelAtSwitch);this.hls.loadLevel=-1,this.hls.nextAutoLevel=e,this.levelAtSwitch=e,this.hls.disabledAudioTrack?this.hls.enableAudioTrack(a):this.seek(a),this.logger.info(`[QE Critical]  [iframes] leaving iframe mode, iframeReferenceClockTime: ${a.toFixed(3)} resume level: ${e}`)()}this.transition(fn.NEED_DATA),this.hls.trigger(r.b.DESIRED_RATE_CHANGED,{oldRate:t,newRate:e})}immediateLevelSwitch(e=!1){let t=this.media;this.immediateSwitch||(this.immediateSwitch=!0,t&&this._mediaPause(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY,e).pipe(We(()=>{this.relaxHighBufferStallRule=this.config.iframeStallMaxRetry}),dt(()=>{this.immediateSwitch=!1}),Xe(this.destroy$)).subscribe(),this.relaxHighBufferStallRule=0)}attemptSafeNextLevelSwitch(e,t){if(!1===this.hls.config.allowFastSwitchUp||this.hls.iframeMode)return;let i=this.media,r=this.hls.abrController.minSwitchBufferAheadSec(e,t);if(i&&i.readyState&&this.estimateCurrentWaterLevel()>=r){let e,t;if(e=r+this.hls.config.maxStarvationDelay,t=this.getBufferedFrag(i.currentTime+e)){let e=this.followingBufferedFrag(t);e&&(this.flushMainBuffer(e.startPTS,Number.POSITIVE_INFINITY).pipe(Xe(this.destroy$)).subscribe(),this.hls.isLive&&(this.fragPrevious=t,this.preserveFragPrevious=!0),this.transition(fn.NEED_INIT))}}}flushBuffer(e,t){return this.flushMainBuffer(e,t)}flushMainBuffer(e,t,i=!1,r=!0){return this.context.isFlushing.next(!0),this._startOffsetOfBufferFlush=e,this.hls.bufferController.flushBufferRange("main",e,t,i,r).pipe(We(()=>{this.logger.info(`flushMainBuffer [${e},${t}] completed`)()}))}installMediaFunctions(e){if(e&&e.play&&e.pause){let t,i;t=e.originalPlay?e.originalPlay:e.originalPlay=e.play.bind(e),i=e.originalPause?e.originalPause:e.originalPause=e.pause.bind(e),e.play=function(){let e=this.media;return e&&e.paused&&!e.seeking&&e.duration&&e.currentTime&&e.currentTime>=e.duration-this.hls.config.maxTotalDurationTolerance&&(this.fragPrevious=void 0,this.seek(0)),this.hls.desiredRate=1,e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2?Promise.resolve():new Promise((e,t)=>{this.pendingPlayPromises.push({resolve:e,reject:t})})}.bind(this),e.pause=function(){this.hls.desiredRate=0}.bind(this);let r="function"==typeof HTMLMediaElement?HTMLMediaElement.prototype:Object.getPrototypeOf(e);r&&Object.getOwnPropertyDescriptor(r,"currentTime")&&(Object.defineProperty(e,"currentTime",{enumerable:!0,configurable:!0,get:function(){return Object.getOwnPropertyDescriptor(r,"currentTime").get.call(this)},set:this.seek.bind(this)}),this.mediaSeekFn=Object.getOwnPropertyDescriptor(r,"currentTime").set.bind(e)),this.config.overridePlaybackRate&&Object.defineProperty(e,"playbackRate",{enumerable:!0,configurable:!0,get:function(){return 1},set:function(e){Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,"playbackRate").set.call(this,e)}})}}uninstallMediaFunctions(){let e=this.media;if(e&&(e.originalPlay&&(e.play=e.originalPlay,delete e.originalPlay),e.originalPause&&(e.pause=e.originalPause,delete e.originalPause),this.mediaSeekFn&&(delete e.currentTime,this.mediaSeekFn=null),this.config.overridePlaybackRate))try{e.playbackRate=1,delete e.playbackRate}catch(e){this.logger.error("Error restoring playbackRate "+e.message)()}}handleMediaAttached(e){const t=this.hls;let i=-1;if(this.levels&&this.levels.length>0)if(t.pendingSeekToDate)i=t.resolvePendingSeekToDate(),t.pendingSeekToDate=void 0;else{let e=this.config;e.autoStartLoad&&(i=e.startPosition)}this.playPromise=null,this._expectPauseEvent=this._expectPlayEvent=!1,Object(ke.c)(this._desiredRate)||(this._desiredRate=e.autoplay?1:e.paused?0:1,this.logger.info("Setting desiredRate based on media state "+this._desiredRate)()),e.autoplay&&this._mediaPause(),Object(ke.c)(i)&&t.startLoad(i)}handleMediaDetached(e){const t=this.media;t&&t.ended&&this.seek(0);const i=this.levels;i&&i.length>0&&i.forEach(e=>{e.details&&e.details.fragments.forEach(e=>{e.backtracked=void 0})}),e&&(this._handlePendingPlayPromises(new Error("Media was detached")),this.pendingPlayPromises=[]),this.playPromise=null,this._expectPauseEvent=this._expectPlayEvent=!1,this.logger.info("media detach reset loaded metadata")()}evictLoadingItem(e,t){return this.context.hasItemToEvict$.next(!0),this.flushMainBuffer(e,Number.POSITIVE_INFINITY,!0,!1).pipe(Ie(()=>(this.logger.info(`main buffer evicted @ ${e}. updating ${this.bufferController.isSourceBufferUpdating()}`)(),this.context.hasItemToEvict$.next(!1),this.hls.bufferController.updateDurationAfterEvictItem(e))))}dequeueSource(e=s.n.ApplicationInitiated){let t=this.playingItemStartTime,i=this.loadingItemStartTime;if(Object(ke.c)(i)&&Object(ke.c)(t)&&i>t){this.logger.info(`[gapless] dequeue preloaded url '${this.hls.loadingItem.url}' from ${i}s; playingItemStartTime ${t}`)(),this.media.currentTime,this.hls.stopLoad();let s=this.hls.loadingItem;return this.evictLoadingItem(i,e).pipe(We(()=>{this.logger.info("stream dequeue done. going to reload")(),this.hls.reloadSource(i)}),Ie(()=>(this.logger.info("reloading started. trigger ITEM_EVICTED event")(),X(0,y).pipe(We(()=>this.hls.trigger(r.b.ITEM_EVICTED,{url:s.url,evictedItemId:s.itemId,reason:e}))))))}return $e(-1)}endSource(){if(!this.media||!this.loadedmetadata||this.hls.isLive)return;this.logger.info("[gapless] end source")(),this.gaplessAllowed=!1;let e=this.getSourceBufferInfo(this.media.currentTime),t=this.media.duration;Object(ke.c)(t)&&Math.abs(e.end-t)<this.hls.config.maxFragLookUpTolerance&&(this.hls.bufferController.endBuffer(void 0),this.transition(fn.ENDED))}shouldReloadLameDuck(e,t){if(!this.hls.config.gapless||this.hls.loadingItem===this.hls.playingItem)return!1;let i=this.loadingItemStartTime,r=0===e.len&&i&&i>t,s=e.len>0&&e.end<i;return r?this.logger.info(`[gapless] seek to unbuffered time range @ ${t}. bufferInfo ${JSON.stringify(e)} next item start time ${i}`)():s&&this.logger.info(`[gapless] seek to buffered time range @ ${t} but there are unloaded fragments after ${e.end}s. bufferInfo ${JSON.stringify(e)} next item start time ${i}`)(),r||s}_handleSeekInfoChange(e){var t;if(!e)return;let i=e.seekToPos,r=e.cc;this.context.nextLoadPosition=this.lastCurrentTime=i,null===(t=this.context.bufferMonitor)||void 0===t||t.notifyWaterLevelChanged();let s=this.isBuffered(i);switch(this.state){case fn.NEED_DATA:{const e=this.fragCurrent;if(!e)return;let t=this.config.maxFragLookUpTolerance,a=e.start-t,n=e.start+e.duration+t;this.iframeModeSeek&&(a=e.iframeMediaStart-t,n=e.iframeMediaStart+e.iframeMediaDuration+t),(Object(ke.c)(r)&&e.cc!==r||!s&&(i<a||i>n))&&this.transition(fn.NEED_DATA);break}case fn.ENDED:case fn.STOPPED:s||(this.fragPrevious=void 0),this.transition(fn.NEED_INIT)}}onMediaSeeking(){const e=this.media,t=(this.config,e?e.currentTime:void 0);if(!e)return void this.logger.warn("Listening to media.onseeking but this.media == null")();if(this.iframeModeSeek&&!this.iframeMode&&this.context.seekInfo)return void this.logger.info("received seeking event for wrong mode type, don't overwrite existing seekToPos")();if(!this.loadedmetadata)return void this.logger.warn("ignoring seeking event before loadedmetadata")();Object(ke.c)(t)&&this.logger.info("media seeking to "+t.toFixed(3))();let i=this.loadingItemStartTime,a=this.playingItemStartTime,n=this.getSourceBufferInfo(t);if(t<a&&n.end<a){this.logger.info(`[gapless] seeked out of playable range ${t} ${a}`)(),this.transition(fn.ERROR);let e=new s.h(s.g.OTHER_ERROR,s.d.INTERNAL_EXCEPTION,!0,"seeked out of playable range");this.hls.trigger(r.b.ERROR,e)}else{if(this.shouldReloadLameDuck(n,t)){this.logger.info(`[gapless] seek back to unfinished playing item ${t}; loadingItemStartTime ${i} playingItemStartTime ${a}`)(),this.hls.stopLoad();let e=this.hls.loadingItem;this.evictLoadingItem(i,s.n.SeekToUnbufferedTimeRanges).pipe(We(()=>{this.logger.info("evicted lameduck. going to reload")(),this.hls.reloadSource(t)}),Ie(()=>(this.logger.info("lameduck completed. trigger ITEM_EVICTED event")(),X(0,y).pipe(We(()=>this.hls.trigger(r.b.ITEM_EVICTED,{url:e.url,evictedItemId:e.itemId,reason:s.n.SeekToUnbufferedTimeRanges}))))),Xe(this.destroy$)).subscribe()}this.seek(t,!1)}}onMediaSeeked(){const e=this.media,t=e?e.currentTime:void 0;Object(ke.c)(t)&&this.logger.info("[QE Critical]  media seeked to "+t.toFixed(3))(),this.context.seekInfo&&Math.abs(t-this.context.seekInfo.seekToPos)>=Number.EPSILON&&(this.logger.warn(`currentTime ${t} doesn't match last seekToPos ${this.context.seekInfo.seekToPos}`)(),this.iframeModeSeek===this.iframeMode&&this.seek(t,!1)),this._checkIfPlaybackLikelyToKeepUp()}onMediaEnded(){}onMediaPlaying(){this.firstPlaybackStarted||(this.firstPlaybackStarted=!0),this._checkIfPlaybackLikelyToKeepUp()}onMediaPlay(){const e=this.config.nativeControlsEnabled||this.media.controls;this._expectPlayEvent||(this.logger.info("Unexpected play event allowSetRate="+e)(),e&&this.hls.setRate(1)),this._expectPlayEvent=!1}onMediaPause(){const e=this.config.nativeControlsEnabled||this.media.controls;this._expectPauseEvent||(this.logger.info("Unexpected pause event allowSetRate="+e)(),e&&this.hls.setRate(0)),this._expectPauseEvent=!1}resetLoadSource(){this.fragPrevious=null,this.altAudio=!1,this._destroyDemuxer(),this.onManifestLoading()}onManifestLoading(){this._bufferedFrags=[],this.gaplessAllowed=!0,this.context.startFragRequested=!1}startItemLoad(e,t,i,s){var a=e.some(e=>e.audioCodecList&&e.audioCodecList.some(e=>-1!==e.indexOf("mp4a.40.2")));let n=e.some(e=>e.audioCodecList&&e.audioCodecList.some(e=>-1!==e.indexOf("mp4a.40.5")));if(this.shouldOverrideCodec=a&&n,this.shouldOverrideCodec&&this.logger.warn("both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC")(),t){let t=this.levelLastLoaded=e[0].persistentId,i=e[t].details;this.gotVariants$.next(!0),this.hls.trigger(r.b.LEVEL_UPDATED,{details:i,level:t})}let o=this.config;(o.autoStartLoad||this.forceStartLoad)&&(Object(ke.c)(s)||(this.hls.pendingSeekToDate&&t?(s=this.hls.resolvePendingSeekToDate(),this.hls.pendingSeekToDate=void 0):s=o.startPosition),this.gotVariants$.next(!0),this.hls.startLoad(s))}_mergeLiveExpiredBufferRange(e,t){var i;if(!e.start&&!e.end&&!this.pendingExpiredLiveBufferRange)return e;var r={start:void 0,end:void 0};if(this.pendingExpiredLiveBufferRange){var s=e.start?Math.min(this.pendingExpiredLiveBufferRange.start,e.start):this.pendingExpiredLiveBufferRange.start,a=e.end?Math.max(this.pendingExpiredLiveBufferRange.end,e.end):this.pendingExpiredLiveBufferRange.end;if(t>a)r={start:s,end:a},this.pendingExpiredLiveBufferRange=void 0;else if(t<=s)this.pendingExpiredLiveBufferRange={start:s,end:a};else{let e=null===(i=this.hls.bandwidthHistoryController)||void 0===i?void 0:i.getFragEstimate();e&&e.maxDuration&&t-s>e.maxDuration?(r={start:s,end:t-e.maxDuration},this.pendingExpiredLiveBufferRange={start:t-e.maxDuration,end:a}):this.pendingExpiredLiveBufferRange={start:s,end:a}}}else t>e.end?r=e:this.pendingExpiredLiveBufferRange=e;return r}_processLevelDetails(e,t,i){var s;let a=0;var n=e.details;if(i&&i!==this.levelLastLoaded&&(null===(n=null===(s=this.variantManager.getVariantInfo(i))||void 0===s?void 0:s.details)||void 0===n?void 0:n.live)&&this.logger.info("live playlist - merging details between levels")(),t.live||(null==n?void 0:n.live))if(n&&t.fragments.length>0){let e=Va.getExpiredFragmentsRange(n,t);if(Va.mergeDetails(n,t),this.media&&(a=t.fragments[0].start,this.liveSyncPosition=this.computeLivePosition(a,n),t.PTSKnown,this.config.liveFlushExpiredFrags)){var o=this._mergeLiveExpiredBufferRange(e,this.media.currentTime);Object(ke.c)(o.start)&&Object(ke.c)(o.end)&&this.flushMainBuffer(o.start,o.end).pipe(Xe(this.destroy$)).subscribe()}}else t.PTSKnown=!1;else t.PTSKnown=!1;e.details=t;let l=e.persistentId;this.checkIfLevelIsExpired(l,t),this.hls.trigger(r.b.LEVEL_UPDATED,{details:t,level:l})}checkIfLevelIsExpired(e,t){if(this.loadedmetadata&&this.variantController.levelIsExpired(t))throw new s.s(!1,s.f.LivePlaylistUpdateError.text,s.f.LivePlaylistUpdateError.code,!1,"level",this.hls.url,e)}get nextLoadVariantId(){return this.hls.nextLoadLevel}_updateLevelDetails(e,t){t.totalduration,e.persistentId;let i=this.levelLastLoaded;this.levelLastLoaded=e.persistentId,this._processLevelDetails(e,t,i)}loadFragment(e,t){return super.loadFragment(e,t).pipe(We(e=>{this._processLoadedFrag(e)}))}_processLoadedFrag(e){var t=e.frag;let i=e.stats,s=this.variantManager.getVariantInfoIfValid(t.level);if(!s)return void this.transition(fn.NEED_DATA);let a=s.details;if(this.logger.info(`[QE Critical]  ${t.type} Loaded  ${t.sn} of [${a.startSN},${a.endSN}], level: ${t.level}, cc: ${t.cc}, start: ${t.start} URL ${this.hls.redactUrl(t.relurl)}, bytesLoaded: ${i.loaded}, fragLoadMs: ${i.tload-i.trequest}`)(),this.bitrateTest=!1,!0===t.bitrateTest&&this.hls.nextLoadLevel){this.context.startFragRequested=!1;let e=performance.now(),s=Object.assign(Object.assign({},i),{tparseStart:e,tparsed:e,tappendStart:e,tbuffered:e});this.hls.trigger(r.b.FRAG_BUFFERED,{stats:s,frag:t,id:"main"})}else this.context.startFragRequested=!0;this.hls.trigger(r.b.FRAG_LOADED,e)}_hasAccurateTimeOffset(e){const{hasMedia:t,seeking:i}=this.bufferController.mediaState;return!(t&&i)&&(e.PTSKnown||!e.live)}_getInitPTS(e){}_parse(e,t,i,r,s,a){return super._parse(e,t,i,r,s,a).pipe(We(e=>{Object(Ga.c)(e)?this._handleFragParsingData(e):"video"!==e.track.type&&"audiovideo"!==e.track.type||(this.logger.info("[gapless] disallowing gapless for non-audio track")(),this.gaplessAllowed=!1)}))}_handleFragParsingData(e){let t=e.frag,i=this.variantManager.getVariantInfoIfValid(t.level);if(!i)return this.logger.warn(`[${this.sbid}] got invalid level onFragParsingData ${t.level}`)(),void this.transition(fn.NEED_DATA);if("video"===e.type)if(t.dropped=e.dropped,t.dropped)if(t.backtracked)this.logger.warn("Already backtracked on this fragment, appending with the gap")();else{if(this.fragPrevious&&this.fragPrevious.cc===t.cc)return this.logger.warn("missing video frame(s), backtracking fragment in "+t.cc)(),t.backtracked=!0,this.fragPrevious=t,void this.transition(fn.NEED_DATA);this.logger.warn(`missing video frame(s) in new cc ${t.cc}), reset dropped count and restart @ frag ${t.sn}`)(),e.dropped=0}else t.backtracked=!1;let s=this.hls;if(!this.iframeMode){let a=Va.updateFragPTSDTS(i.details,t,e.startPTS,e.endPTS,e.startDTS,e.endDTS);s.trigger(r.b.LEVEL_PTS_UPDATED,{details:i.details,level:this.currentVariantId,drift:a,type:e.type,start:t.startPTS,end:t.endPTS}),this.checkIfLevelIsExpired(i.persistentId,i.details)}this._handleKeyExpiryPosition(t)}onAudioTrackSwitching(e){var t=!!e.url,i=e.id;if(!t){if(this.altAudio){this._destroyDemuxer(),this.altAudio=t,this.hls.trigger(r.b.AUDIO_TRACK_SWITCHED,{id:i});let e=this.media.currentTime,s=this.variantManager.getVariantInfo(this.currentVariantId),a=s?s.details:void 0,n={seekToPos:e,cc:a?bn.ccForTime(a.fragments,e,this.hls.config.maxFragLookUpTolerance):void 0};return void this.bufferController.resetSourceBuffers(n)}let e=this.hls;this.hls.bufferController.flushBufferRange("audio",0,Number.POSITIVE_INFINITY),e.trigger(r.b.AUDIO_TRACK_SWITCHED,{id:i})}this.altAudio=t}onBufferAppended(e){let t=this.media;if(this.seeking&&t.paused&&t.buffered.length){let e=this.adjustSeekPosition(this.media.currentTime);Math.abs(t.currentTime-e)>=Number.EPSILON&&(t.currentTime=e)}this.context.bufferMonitor.notifyWaterLevelChanged()}addIframeToCurrentLevel(e){e&&Object(ke.c)(e.iframeMediaStart)&&(this.iframesInSourceBuffer&&this.iframesInSourceBuffer.level===e.level?this.iframesInSourceBuffer.buffered++:this.iframesInSourceBuffer={level:e.level,buffered:1,loading:0})}countIframesInCurrentLevel(e){let t=this.iframesInSourceBuffer&&e===this.iframesInSourceBuffer.level?this.iframesInSourceBuffer.buffered:0,i=0,r=this.fragCurrent;return r&&r.iframeMediaStart&&r.level===e&&i++,{level:e,loading:i,buffered:t}}handleFragAppended(e){if(e){let t;if(this.logger.info(`[main] buffered: ${Ka(this.buffered)} media.currentTime=${this.media.currentTime}`)(),e.iframe){this.iframeMachine.mediaAppendClockTimeSeconds;this.media.currentTime,e.start,(t=this._bufferedFrags.filter(e=>this.isBuffered((e.iframeMediaStart+e.iframeMediaStart+e.iframeMediaDuration)/2))).push(e),this.addIframeToCurrentLevel(e),this._bufferedFrags=t.sort((function(e,t){return e.iframeMediaStart-t.iframeMediaStart}))}else(t=this._bufferedFrags.filter(e=>this.isBuffered((e.startPTS+e.startPTS+e.duration)/2))).push(e),this._bufferedFrags=t.sort((function(e,t){return e.startPTS-t.startPTS}));const i=this.context.stats;i&&!i.cached&&(this.updateAppendBufferAvg(i.tbuffered-i.tappendStart),this.updateParseBwAvg(i.total,i.tparsed-i.tload)),this.hls.trigger(r.b.FRAG_BUFFERED,{stats:i,frag:e,id:"main"})}}handleBufferFullError(e,t,i){let r=this.hls.abrController;return r&&(r.maxBufferSize=e.maxTotalBytes),super.handleBufferFullError(e,t,i)}_ensureNudgeStartTimeForIncompatibleCC(e,t,i){var r;let s=e;if(void 0===s&&this.isWaitingForIncompatibleCC){let e=this.fragCurrent?this.fragCurrent:this.fragPlaying;if(e){let i=this.hls.levelController.getLevelWithPersistentId(e.level).levelInfo,a=i?null===(r=i.details)||void 0===r?void 0:r.fragments:void 0,n=e.start+e.duration;a&&(e.start>t?s=e.start:n>t?s=n:this.logger.warn(`Cannot nudge to frag.sn ${e.sn} [${e.start},${n}] at incompatible discontinuity. nextBufferStart ${s} currentTime ${t}`)())}}if(Object(ke.c)(s)){let e=s-t;(e>i||e<=0)&&(s=void 0)}return s}get loadedmetadata(){return this.hls.bufferController.loadedMetadata$.value}onFragLoadEmergencyAborted(){this.transition(fn.NEED_DATA)}onBufferFlushed(e){var t,i;this._bufferedFrags=this._bufferedFrags.filter(e=>this.isBuffered((e.startPTS+e.endPTS)/2)),this.preserveFragPrevious||(this.fragPrevious=null),this.preserveFragPrevious=void 0,this.context.isFlushing.next(!1),this._startOffsetOfBufferFlush=void 0;let r=e&&e.seekAfterFlush;this.logger.info("[gapless] buffer flushed: shouldSeek "+r)(),this.media&&this.context.seekInfo&&r&&(this.logger.info(`[iframes] buffer flushed, iframeSeekTo: ${Ot(null===(t=this.context.seekInfo)||void 0===t?void 0:t.seekToPos,3)}, currentTime: ${Ot(null===(i=this.media)||void 0===i?void 0:i.currentTime,3)}, seekable: ${Ka(this.media.seekable)}, readyState ${this.media.readyState}`)(),this.seek(this.context.seekInfo.seekToPos)),this.context.bufferMonitor.notifyWaterLevelChanged()}onLevelsChanged(e){var t;if(0===(null===(t=this.variantManager.validVariantList)||void 0===t?void 0:t.length))return this.logger.error(`[${this.sbid}] Got empty level list`)(),void this.transition(fn.ERROR);if(e.requiresReset){let e=this.playbackPos;this.bufferController.resetSourceBuffers({seekToPos:e,cc:NaN})}else this.variantManager.getVariantInfoIfValid(this.currentVariantId)||this.transition(this.state)}onBandwidthChanged(){}onStalled(e){var t,i;let{type:a,isLowBufferStall:n,bufferInfo:o,stallDurationMs:l}=e,d=this.media.currentTime;const h=o.len;if(this.logger.warn(`stall state, audio state: ${null!==(i=null===(t=this.hls.audioStreamController)||void 0===t?void 0:t.state)&&void 0!==i?i:"N/A"}, main state: ${this.state}, currentTime: ${d}, buffered: ${this.bufferController.bufferedRangeString}, nudgeSeeking:${this.nudgeSeeking}`)(),this.isWaitingForIncompatibleCC)return ie;if(this.nudgeSeeking)return ie;if(this.nudgeSeeking=!0,this.logger.warn(`playback stall type:${a} @${d}, state: ${this.state}, buffer length: ${h}, buffered ranges: ${this.bufferController.bufferedRangeString} stallMs=${Math.round(l)}`)(),!this.iframeMode){let e=n?s.f.InsufficientDataAvailable:s.f.VideoDecoderBadDataErr,t=new s.c(s.d.BUFFER_STALLED_ERROR,!1,"buffer stalled error",e,a,h);this.hls.trigger(r.b.INTERNAL_ERROR,t)}return this._startNudgeSeek(e).pipe(dt(()=>{this.nudgeSeeking=!1}))}_startNudgeSeek(e){let t=Ze(this.hls),i=e.tstalled;return ut(Ge($e(e),t.event(r.b.STALLED)).pipe(Ie((e,t)=>this._nudgeIfNeeded(e,i,t))),e=>e).pipe(ae(()=>{}))}_nudgeIfNeeded(e,t,i){const a=this.hls,n=this.config;let{type:o,isLowBufferStall:l,bufferInfo:d}=e,h=d.len,c=this.media,u=c.currentTime,f=NaN,g=null;if(l){if(h>this.config.maxSeekHole)return this.logger.warn("Got low buffer stall but above jump threshold")(),$e(!0);let e=this._ensureNudgeStartTimeForIncompatibleCC(d.nextStart,u,n.maxSeekHole);e&&(this.logger.info(`adjust currentTime from ${c.currentTime} to next buffered @ ${e}`)(),f=e,g=new s.c(s.d.BUFFER_SEEK_OVER_HOLE,!1,"got buffer seek over hole error",s.f.InsufficientDataAvailable,o,h,f-u))}else this.relaxHighBufferStallRule?(this.relaxHighBufferStallRule--,g=new s.c(s.d.BUFFER_STALLED_ERROR,!1,"got buffer stalled error",s.f.VideoDecoderBadDataErr,o,h)):i<n.nudgeMaxRetry?(f=u+(i+1)*n.nudgeOffset,g=new s.c(s.d.BUFFER_NUDGE_ON_STALL,!1,"got buffer nudge error on stall",s.f.VideoDecoderBadDataErr,o,h)):this.iframeMode?(this.logger.error(`still stuck in high buffer @${u} after ${n.nudgeMaxRetry}, non fatal in iframeMode`)(),g=new s.c(s.d.BUFFER_STALLED_ERROR,!1,"got non fatal buffer error in iframeMode",s.f.VideoDecoderBadDataErr,o,h)):(this.logger.error(`still stuck in high buffer @${u} after ${n.nudgeMaxRetry}, raise fatal error`)(),g=new s.c(s.d.BUFFER_STALLED_ERROR,!0,"got fatal buffer error",s.f.VideoDecoderBadDataErr,o,h));if(g&&a.trigger(r.b.INTERNAL_ERROR,g),Object(ke.c)(f)){this.logger.info(`stall ${o} nudge ${u}->${f}`)();let e=this.seekInfoObs.pipe(Pa(1),Ee(e=>null!=e&&Math.abs(e.seekToPos-f)>this.config.nudgeOffset),ye(1),ae(e=>!0)),i=ut(Ze(this.media).event("timeupdate").pipe(ae(()=>this.media.currentTime),Fr()),([e,t])=>t>e).pipe(ae(([,e])=>(this.logger.info(`playback not stuck anymore @${e}, after ${Math.round(performance.now()-t)}ms`)(),!0)));return Ge(re(()=>(this.seek(f),$e(!1))),e,i)}return $e(!0)}onMediaTimeUpdate(){let e=this.media.currentTime;if(this.relaxHighBufferStallRule=0,this.hls.config.gapless){let t=this.loadingItemStartTime,i=this.playingItemStartTime;t&&e>=t&&i!==t&&!this.media.seeking&&this.hls.handleItemTransitioned()}this._checkFragmentChanged()}onCanPlay(){this._checkIfPlaybackLikelyToKeepUp()}computeLivePosition(e,t){let i=t.targetduration;return Object(ke.c)(this.config.liveSyncDuration)?i=this.config.liveSyncDuration:Object(ke.c)(this.config.liveSyncDurationCount)&&(i=this.config.liveSyncDurationCount*t.targetduration),e+Math.max(0,t.totalduration-i)}get liveSyncPosition(){return this._liveSyncPosition}set liveSyncPosition(e){this._liveSyncPosition=e}get playbackEverStarted(){return this.firstPlaybackStarted}get variantController(){return super.variantController}get variantManager(){return super.variantManager}getLivePlaylistRefreshDelay(e){let t=Oa.bufferInfo(this.media,this.media.currentTime,this.config.maxBufferHole),i=0===t.len||t.len<Math.max(this.config.liveMinPlayingBufferLen,e.targetduration),r=Math.ceil(this.config.livePlaylistRefreshDelay/(1e3*e.targetduration));r=isNaN(r)?0:r;let s=this.fragCurrent&&"number"==typeof this.fragCurrent.sn&&e.endSN>this.fragCurrent.sn+r;return i&&s?this.config.livePlaylistRefreshDelay:0}get audioAndSubtitleGroups(){let e=this.hls.levelController.getLevelWithPersistentId(this.currentVariantId).levelInfo;if(e)return{audioGroup:e.audioGroupId,subtitleGroup:e.subtitleGroupId}}}var In=Dn;class wn extends Os{constructor(e){super(e,r.b.PREFERRED_HOST_CHANGED,r.b.AUDIO_TRACK_SWITCHED),this.trackId$=new te(void 0)}destroy(){this.variantManager&&this.variantManager.destroy(),cs.prototype.destroy.call(this)}resetTracks(){this.trackId$.next(void 0),this._selectedMediaOption=void 0,this.groupID=void 0}setTracks(e,t,i){let s=e.validVariantList;this.resetTracks(),this.groupID=i,this.setVariantManager(e),this._mediaSelectionGroup=t||{MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.audible"],MediaSelectionGroupMediaType:Wr.AUDIO,MediaSelectionGroupOptions:[]};let a={audioTracks:s};if(this.hls.trigger(r.b.AUDIO_TRACKS_UPDATED,a),this.selectedMediaOption)this.logger.info("[audio] already started with media option persistent id "+this.selectedMediaOption.MediaSelectionOptionsPersistentID)();else if(void 0!==this.queuedPersistentID){let e=wn.sanitizePersistentID(s,this.queuedPersistentID);e===this.queuedPersistentID||(this.queuedPersistentID=e),this.selectedPersistentID=this.queuedPersistentID,this.queuedPersistentID=void 0}else if(this.mediaSelectionOptions.length>0){let e=this.mediaSelectionOptions.find((function(e){return e.MediaSelectionOptionsIsDefault}));e?(this.logger.info("[audio] start with default "+JSON.stringify(e))(),this.selectedMediaOption=e):this.selectedMediaOption=this.mediaSelectionOptions[0]}}mainLevelHasAudioGroup(){let e=this.hls.streamController.audioAndSubtitleGroups;return e?e.audioGroup:void 0}onAudioTrackSwitched(e){var t;const i=null===(t=this.hls.currentAudioAndSubtitleGroups)||void 0===t?void 0:t.audioGroup;this.processEnqueuedTrackSwitch(i)}onPreferredHostChanged(e){if(e.mediaType===Wr.AUDIO||!Object(ke.c)(this.audioTrack)||this.audioTrack<0||0===this.variantManager.variantList.length)return;if(this.mainLevelHasAudioGroup)return;let t,i=this.variantManager&&this.variantManager.getVariantInfoIfValid(this.audioTrack),r=this.validTracks,s=i.groupCodecList;(t=r.find(e=>{let t=e.groupCodecList,r=!1;if(t.length===s.length&&1===t.length){let a=s[0],n=t[0];r=e.persistentID===i.persistentID&&ke.b.isCompatibleAudioCodec(a,n)&&e.url&&ko.hasAllowedHost(e.url,this.hls.preferredHostName)}return r}))&&(this.logger.warn("preemptively switching audio host to "+this.hls.preferredHostName)(),this.updateTrack(t.id,!0))}processEnqueuedTrackSwitch(e){let t=!1;if(this.queuedPersistentID>-1){this.logger.info(`switch to pending audio persistent ID ${this.queuedPersistentID} (${e})`)();let i=this.queuedPersistentID;this.queuedPersistentID=void 0,this.groupID=e,this.selectedPersistentID=i,t=void 0!==this.queuedPersistentID}return t}getNextBestAutoVariant(e,t){t=t||this.hls.preferredHostName;let i=this.resolveTrackId(e).trackInfo;if(!i)return-1;let r=this.validTracks.find((function(e){return e.groupId&&e.groupId!==i.groupId&&e.persistentID===i.persistentID&&e.url&&ko.hasAllowedHost(e.url,t)}));return this.logger.info("[audio] nextBestAutoVariant "+(null==r?void 0:r.id))(),r?r.id:-1}resolveTrackId(e){let t,i;return!e&&0!==e||e<0?this.logger.warn("invalid trackID "+e)():this.variantManager&&(t=this.variantManager.getVariantInfoIfValid(e),i=this.variantManager.getVariantListPosition(e)),{trackInfo:t,trackListPosition:i}}containsFallbackVariant(e){let t=this.audioTrack;return-1!==this.getNextBestAutoVariant(t,e)}setNextAutoVariant(e){this.audioTrack=e}get validTracks(){return this.variantManager&&this.variantManager.validVariantList||[]}get currentVariantId(){return this.audioTrack}set currentVariantId(e){this.setNextAutoVariant(e)}setVariantManager(e){this.variantManagerInternal=e}get variantManager(){return this.variantManagerInternal}get audioTrack(){return this.trackId$.value}set audioTrack(e){if(!this.validTracks)return;let t=this.resolveTrackId(e).trackInfo;t?this.audioTrack===e&&void 0!==t.details||this.setAudioTrackInternal(e):this.logger.error(`[audio] Invalid track set ${e} ${(new Error).stack}`)()}get mediaSelectionGroup(){return this._mediaSelectionGroup}get mediaSelectionOptions(){return this.mediaSelectionGroup?this.mediaSelectionGroup.MediaSelectionGroupOptions:[]}get selectedPersistentID(){return this.selectedMediaOption?this.selectedMediaOption.MediaSelectionOptionsPersistentID:-1}set selectedPersistentID(e){if(this.logger.info("[audio] selectedPersistentID "+e)(),e>=0&&!this._mediaSelectionGroup||this.hls.audioStreamController.shouldDeferTrackSwitch)return this.queuedPersistentID=e,void this.logger.info("[audio] enqueued selectedPersistentID "+e)();let t=this.mediaSelectionOptions.find((function(t){return t.MediaSelectionOptionsPersistentID===e}));this.selectedMediaOption=t}get selectedMediaOption(){return this._selectedMediaOption}set selectedMediaOption(e){this._selectedMediaOption=e,this.updateTrackSelection()}updateTrackSelection(){var e;if(!this._selectedMediaOption)return;let t=this._selectedMediaOption.MediaSelectionOptionsPersistentID,i=this.groupID;void 0===i&&(i=null===(e=this.hls.currentAudioAndSubtitleGroups)||void 0===e?void 0:e.audioGroup);let r=this.validTracks.find(e=>t===e.persistentID&&(!e.url||ko.hasAllowedHost(e.url,this.hls.preferredHostName))&&(!i||!e.groupId||e.groupId===i));this.hls.config.relaxAudioGroup&&(r||(this.logger.warn("[audio] try option id "+t+" without using group ("+i+"): ")(),r=this.validTracks.find(e=>t===e.persistentID&&(!e.url||ko.hasAllowedHost(e.url,this.hls.preferredHostName)))),r||(this.logger.warn("[audio] try only option id "+t)(),r=this.validTracks.find(e=>t===e.persistentID))),r?this.audioTrack=r.id:this.logger.warn("could not find audio track for selected media group ("+i+"): "+this._selectedMediaOption.MediaSelectionOptionsName+" with ID: ("+t+")")()}setAudioTrackInternal(e,t=!0){if(this.audioTrack!==e){let i=this.resolveTrackId(e).trackInfo,s=this.hls,a={id:e,type:i.type,url:i.url,userInitiated:t};this.groupID!==i.groupId&&(this.logger.info(`audio group changed from ${this.groupID} to ${i.groupId}`)(),this.groupID=i.groupId),this.logger.info(`[QE Critical] switching to audioTrack ${e} groupID ${this.groupID} - ${i.name}`)(),this.trackId$.next(e),s.trigger(r.b.AUDIO_TRACK_SWITCH,a),s.trigger(r.b.AUDIO_TRACK_SWITCHING,a)}}updateTrack(e,t){this.setAudioTrackInternal(e,t)}loadPlaylistInternal(e){let t=e.url,i=e.id;return t?re(()=>(this.logger.info("[QE Critical] (re)loading playlist for audioTrack "+i)(),this.hls.playlistLoader.loadAudioTrack(t,i))).pipe(We(e=>{this.hls.trigger(r.b.AUDIO_TRACK_LOADED,e)})):Be(new Error("No URL for audio track "+e.id))}static sanitizePersistentID(e,t){if(!e||!e.length)return t;let i;for(let r=0;r<e.length;r++){let s=e[r];if(s.persistentID===t){i=t;break}s.default&&(i=s.persistentID),i||"en-US"!==s.lang||(i=s.persistentID)}return i>=0?i:e[0].persistentID}matchAudioGroup(e){if(this.processEnqueuedTrackSwitch(e))return;if(e===this.groupID)return;let t=this.resolveTrackId(this.audioTrack).trackInfo;if(!t||!t.details||!this.hls.audioStreamController.readyToMatchAudioGroup(e,t.details.targetduration))return;let i=this.validTracks.find((function(i){return(!i.groupId||i.groupId===e)&&i.persistentID===t.persistentID}));i?(this.logger.info(`[audio] use matched track ${i.id} ${i.groupId}`)(),this.setAudioTrackInternal(i.id,!1)):this.logger.error("[audio] no matching track !")()}}var Rn=wn;const An=e=>"cc1"===e||"cc2"===e;function kn(e){let t=[];for(let i=0;i<e.length;i++){let r=e[i];("captions"===r.kind||"subtitles"===r.kind||"metadata"===r.kind&&r.customTextTrackCueRenderer)&&t.push(r)}return t}function Cn(e,t){return(e?e.id:void 0)===(t?t.id:void 0)}var Ln=class extends Os{constructor(e){super(e,r.a.MEDIA_ATTACHED,r.a.MEDIA_DETACHING,r.a.SUBTITLE_TRACKS_CREATED,r.a.PREFERRED_HOST_CHANGED),this.media=void 0,this.subtitleDisplay=!1,this.allTracksCreated=!1,this.trackRetryCount=0,this.variantManager=new hs(e,Wr.SUBTITLE)}destroy(){this.variantManager&&this.variantManager.destroy(),super.destroy()}get validTracks(){return this.variantManager&&this.variantManager.validVariantList||[]}get mediaSelectionGroup(){return this._mediaSelectionGroup}get mediaSelectionOptions(){return this.mediaSelectionGroup?this.mediaSelectionGroup.MediaSelectionGroupOptions:[]}get selectedPersistentID(){return this.selectedMediaOption?this.selectedMediaOption.MediaSelectionOptionsPersistentID:-1}set selectedPersistentID(e){if(this.logger.info("[subtitle] selectedPersistentID "+e)(),e>=0&&!this.allTracksCreated||this.hls.subtitleStreamController.shouldDeferTrackSwitch)return this.queuedPersistentID=e,void this.logger.info("[subtitle] enqueued selectedPersistentID "+e)();let t=this.mediaSelectionOptions.find((function(t){return t.MediaSelectionOptionsPersistentID===e}));this.selectedMediaOption=t}get selectedMediaOption(){return this._selectedMediaOption}set selectedMediaOption(e){var t;if(e&&!this.allTracksCreated)return void(this.queuedPersistentID=e.MediaSelectionOptionsPersistentID);let i;this._selectedMediaOption=e;let r=this.groupID;if(void 0===r&&(r=null===(t=this.hls.currentAudioAndSubtitleGroups)||void 0===t?void 0:t.subtitleGroup),e){let t=e.MediaSelectionOptionsPersistentID;(i=this.validTracks.find((function(e){return!(e.persistentID!==t||e.mediaType!==Wr.CLOSEDCAPTION&&(e.mediaType!==Wr.SUBTITLE||r&&e.groupId&&e.groupId!==r))})))||this.logger.warn("could not find subtitle track for selected media group: "+e.MediaSelectionOptionsName+" with ID: ("+t+")")()}this.logger.info("[subtitle] select main track "+(null==i?void 0:i.id))(),this.selectedTrack=i;let s=this.selectedTrack?this.selectSideTrack(this._selectedMediaOption):void 0;s&&(this.logger.info("[subtitle] select side track "+s.id)(),this.selectedSideTrack=s)}get selectedTrack(){return this._selectedTrack}set selectedTrack(e){Cn(this._selectedTrack,e)||(this.selectedSideTrack&&(this._selectedSideTrack=void 0),this.logger.info("[QE Critical] switching to subtitle/caption track "+(e?e.id+" - "+e.name+" ("+e.groupId+", "+e.persistentID+")":"(NONE)"))(),e&&e.mediaType===Wr.SUBTITLE?this.groupID=e.groupId:this.groupID=void 0,this._selectedTrack=e,this.hls.trigger(r.a.SUBTITLE_TRACK_SWITCH,{track:e}),this.updateTextTrackState())}get currentVariantId(){var e;return null===(e=this._selectedTrack)||void 0===e?void 0:e.id}set currentVariantId(e){this.setNextAutoVariant(e)}selectSideTrack(e){let t;if(this.hls.config.enableDualTrackSelection&&e&&e.MediaSelectionOptionsMediaType===Wr.CLOSEDCAPTION){e.MediaSelectionOptionsPersistentID;let i=this.selectedTrack,r=this.logger;t=this.validTracks.find((function(t){let s=t.mediaType===Wr.SUBTITLE&&t.lang===e.MediaSelectionOptionsExtendedLanguageTag&&t.forced&&t.autoselect&&t.groupId!==i.groupId;return s&&r.info(`[subtitle] pick side track persistent id ${t.persistentID} track id ${t.id} group id ${t.groupId}`)(),s}))}return t}get selectedSideTrack(){return this._selectedSideTrack}set selectedSideTrack(e){Cn(this._selectedSideTrack,e)||(this.logger.info("[QE Critical] switching to side subtitle/caption track "+(e?e.id+" - "+e.name:"(NONE)"))(),this._selectedSideTrack=e,this.hls.trigger(r.a.SUBTITLE_TRACK_SWITCH,{track:e,hidden:!0}),this.updateTextTrackState())}redirectTextTrack(e){let t=e;return this.selectedSideTrack&&e===this.selectedSideTrack.id&&(t=this.selectedTrack.id,this.logger.info(`[subtitle] promote side track id from ${e} to ${t}`)()),t}processEnqueuedTrackSwitch(e){let t=!1;if(this.queuedPersistentID>-1){this.logger.info(`switch to pending subtitle persistent ID ${this.queuedPersistentID} (${e})`)();let i=this.queuedPersistentID;this.queuedPersistentID=void 0,this.groupID=e,this.selectedPersistentID=i,t=void 0!==this.queuedPersistentID}return t}updateTextTrackState(){if(!this.media||!this.media.textTracks)return;let e=this.selectedTrack?this.hls.timelineController.getExistingHTMLTextTrack(this.selectedTrack):void 0,t=kn(this.media.textTracks);for(let i=0;i<t.length;i++){let r=t[i];r===e&&"showing"!==t[i].mode?t[i].mode="showing":r!==e&&"hidden"!==t[i].mode&&(t[i].mode="hidden")}}onMediaAttached(e){this.media=e.media,this.media&&(this.updateTextTrackState(),this.trackChangeListener=this._onTextTracksChanged.bind(this),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.subtitlePollingInterval=setInterval(()=>{this.trackChangeListener()},500):this.media.textTracks.addEventListener("change",this.trackChangeListener))}onMediaDetaching(){this.media&&(this.useTextTrackPolling?clearInterval(this.subtitlePollingInterval):this.media.textTracks.removeEventListener("change",this.trackChangeListener),this.media=void 0)}resetTracks(){this.selectedTrack=void 0,this._selectedMediaOption=void 0,this.trackRetryCount=0,this.groupID=void 0}setVariantManager(e){this.logger.info(`${this.constructor.name} setVariantManager ${e&&e.validVariantList.length}`)(),this.variantManager=e}setTracks(e,t,i){this.resetTracks(),this.groupID=i,this.setVariantManager(e),this._mediaSelectionGroup=t||{MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.legible"],MediaSelectionGroupMediaType:Wr.SUBTITLE,MediaSelectionGroupOptions:[]};let s={subtitleTracks:this.validTracks};this.hls.trigger(r.a.SUBTITLE_TRACKS_UPDATED,s)}onSubtitleTracksCreated(){this.allTracksCreated=!0,void 0===this.queuedPersistentID||this.selectedMediaOption||(this.selectedPersistentID=this.queuedPersistentID,this.queuedPersistentID=void 0)}mainLevelHasSubtitleGroup(){let e=this.hls.streamController.audioAndSubtitleGroups;return e?e.subtitleGroup:void 0}onPreferredHostChanged(e){if(e.mediaType===Wr.SUBTITLE||!this.selectedTrack||0===this.variantManager.variantList.length)return;if(this.mainLevelHasSubtitleGroup)return;let t,i=this.selectedTrack;i.url,(t=this.validTracks.find(e=>e.persistentID===i.persistentID&&e.forced===i.forced&&ko.hasAllowedHost(e.url,this.hls.preferredHostName)))&&(this.selectedSideTrack?(this.logger.warn(`preemptively switching subtitle host for side track id ${this.selectedSideTrack.id} to id ${t.id}, host=${this.hls.preferredHostName}`)(),this.selectedSideTrack=t):(this.logger.warn("preemptively switching subtitle host to "+this.hls.preferredHostName)(),this.selectedTrack=t))}_onTextTracksChanged(){if(!this.media)return;let e,t=!1,i=kn(this.media.textTracks);for(let r=0;r<i.length;r++)i[r].seen?"showing"===i[r].mode&&this.resolveTrackId(r).trackInfo&&(e=i[r].persistentId):(i[r].seen=!0,t=!0);if(!t){let t=this._selectedMediaOption;if(!t||t.MediaSelectionOptionsPersistentID!==e){let t=this.mediaSelectionOptions.find((function(t){return t.MediaSelectionOptionsPersistentID===e}));this.selectedMediaOption=t}}}loadPlaylistInternal(e){const t=e.url,i=e.id,s=this.hls.playlistLoader;return t?re(()=>(this.logger.info("[QE Critical] (re)loading playlist for subtitleTrack "+i)(),s.loadSubtitleTrack(t,i))).pipe(We(e=>{this.hls.trigger(r.a.SUBTITLE_TRACK_LOADED,e)})):Be(new Error("No URL for subtitleTrack track "+i))}containsFallbackVariant(e){return-1!==this.getNextBestAutoVariant(this.selectedTrack.id,e)}resolveTrackId(e){let t,i;return!e&&0!==e||e<0?this.logger.warn("invalid trackID "+e)():this.variantManager&&(t=this.variantManager.getVariantInfoIfValid(e),i=this.variantManager.getVariantListPosition(e)),{trackInfo:t,trackListPosition:i}}getNextBestAutoVariant(e,t){t=t||this.hls.preferredHostName;let i,r=this.resolveTrackId(e).trackInfo;return r?i=this.validTracks.find((function(e){return e.groupId!==r.groupId&&e.persistentID===r.persistentID&&e.url&&ko.hasAllowedHost(e.url,t)})):this.logger.warn("can't find substitute track in a different group id")(),i?i.id:-1}setNextAutoVariant(e){let t=this.resolveTrackId(e).trackInfo;if(t){let e=this.mediaSelectionOptions.find((function(e){return e.MediaSelectionOptionsPersistentID===t.persistentID}));this.selectedSideTrack?(this.logger.info("[subtitle] use next side track "+t.id)(),this.selectedSideTrack=t):(this.logger.info("[subtitle] use next track "+t.id)(),this._selectedMediaOption=e,this.selectedTrack=t)}}matchSubtitleGroup(e){if(this.processEnqueuedTrackSwitch(e))return;if(e===this.groupID)return;let t=this._selectedTrack;if(!t||!t.details||t.mediaType!==Wr.SUBTITLE)return;let i=this.validTracks.find((function(i){return(!i.groupId||i.groupId===e)&&i.persistentID===t.persistentID}));i?this.selectedTrack=i:this.logger.error("[subtitle] no matching track !")()}},Pn=class extends cs{constructor(e){super(e,r.b.MEDIA_ATTACHING,r.b.MEDIA_DETACHING,r.b.FRAG_PARSING_METADATA),this.id3Track=void 0,this.media=void 0}destroy(){cs.prototype.destroy.call(this)}onMediaAttaching(e){this.media=e.media,this.media&&(this.id3Track=this.media.addTextTrack("metadata","id3"),this.id3Track.mode="hidden")}onMediaDetaching(){this.media=void 0}onFragParsingMetadata(e){const t=e.frag,i=e.samples;if(!this.hls.config.enableID3Cues)return;let r=window.WebKitDataCue||window.VTTCue||window.TextTrackCue,s=t.endPTS?t.endPTS:t.duration+t.start;for(let e=0;e<i.length;e++){let t=i[e].pts,a=e<i.length-1?i[e+1].pts:s;t===a&&(a+=1e-4),i[e].frames&&i[e].frames.forEach(e=>{if(e&&!this.shouldIgnore(e)){let i=new r(t,a,"");i.value=e,this.id3Track.addCue(i)}})}}shouldIgnore(e){return"PRIV"===e.key&&("com.apple.streaming.transportStreamTimestamp"===e.info||"com.apple.streaming.audioDescription"===e.info)}};function Mn(e){return(t,i)=>{let r=0,s=0;for(const{timestamp:a,value:n}of t){const t=Math.pow(Math.max(0,a-i)/1e3,e);r+=t*n,s+=t}return r/s}}const xn={"uniform-time-weighted":Mn(0),"linear-time-weighted":Mn(1),"quadratic-time-weighted":Mn(2)};class On{constructor(e,t=(()=>{})){this.windowSize=e,this.cleanupCallback=t,this.latencyEntries=[],this.bandwidthEntries=[],this.minEntries=1,this.cleanUpExpiredEntries=this.cleanUpExpiredEntries.bind(this)}record(e){const{trequest:t,tfirst:i,tload:r,bitsDownloaded:s}=e;this.recordLatency(t,i),this.recordBandwidth(t,r,1e3*s/(r-t))}getEstimate(e="quadratic-time-weighted"){if(this.latencyEntries.length<this.minEntries)return;const t=performance.now()-this.windowSize,i=xn[e],r=this.latencyEntries.map(({start:e,end:t})=>({timestamp:t,value:t-e,duration:1}));this.bandwidthEntries=(function(e){const t=[...e].sort((e,t)=>e.start!==t.start?e.start-t.start:e.end-t.end),i=[];let r=function(e,t){if(e.length){for(let i=0;i<e.length;i++)if(e[i].start>t.start||e[i].start===t.start&&e[i].end>t.end){e.splice(i,0,t);break}}else e.push(t)};for(;t.length;){const e=t[0];let s;if(t.shift(),i.length&&(s=i[i.length-1]),0===i.length||s.end<=e.start)i.push(e);else if(e.start===s.start)e.end===s.end?s.bitsPerSec+=e.bitsPerSec:e.end<s.end?Ae.b.warn("Unexpected condition while processing bandwidth entries")():(s.bitsPerSec+=e.bitsPerSec,e.start=s.end,r(t,e));else{let a=s.end,n=s.bitsPerSec;s.end=e.start;let o={start:e.start,end:Math.min(a,e.end),bitsPerSec:e.bitsPerSec+n};if(i.push(o),a!==e.end){let i=0,s=0,o=0;a<e.end?(i=a,s=e.end,o=e.bitsPerSec):(i=e.end,s=a,o=n),r(t,{start:i,end:s,bitsPerSec:o})}}}return i})(this.bandwidthEntries);const s=this.bandwidthEntries.map(({start:e,end:t,bitsPerSec:i})=>({timestamp:t,duration:1,value:i}));return{avgLatencyMs:i(r,t),avgBandwidth:i(s,t)}}getLatest(){if(0===this.latencyEntries.length)return null;let e=this.latencyEntries[this.latencyEntries.length-1],t=this.bandwidthEntries[this.bandwidthEntries.length-1];return{avgLatencyMs:e.end-e.start,avgBandwidth:t.bitsPerSec}}recordLatency(e,t){this.latencyEntries.push({start:e,end:t}),this.updateCleanupTimeout(t)}recordBandwidth(e,t,i){this.bandwidthEntries.push({start:e,end:t,bitsPerSec:i}),this.updateCleanupTimeout(t)}setCleanupTimeout(e){this.cleanupTimeout=setTimeout(this.cleanUpExpiredEntries,Math.max(e-performance.now(),0)),this.cleanupTimestamp=e}clearCleanupTimeout(){void 0!==this.cleanupTimeout&&(clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0),this.cleanupTimestamp=void 0}updateCleanupTimeout(e){const t=e+this.windowSize;(!this.cleanupTimestamp||t<this.cleanupTimestamp)&&(this.clearCleanupTimeout(),this.setCleanupTimeout(t))}cleanUpExpiredEntries(){this.clearCleanupTimeout();const e=performance.now()-this.windowSize;if(this.latencyEntries=this.latencyEntries.filter(t=>t.end>=e),this.bandwidthEntries=this.bandwidthEntries.filter(t=>t.end>=e),this.cleanupCallback(),this.latencyEntries.length>0||this.bandwidthEntries.length>0){const e=Math.min(...this.latencyEntries.map(e=>e.end),...this.bandwidthEntries.map(e=>e.end));this.updateCleanupTimeout(e)}}destroy(){this.clearCleanupTimeout()}}class Nn extends cs{constructor(e){super(e,r.b.MEDIA_DETACHED),this.bwEstimator=new On(e.config.bandwidthHistoryWindowSize,()=>this.getAndCacheBandwidthEstimate()),this.ttl=e.config.bandwidthHistoryTTL,this.persistStats=this.persistStats.bind(this),"undefined"!=typeof window&&"function"==typeof window.addEventListener&&window.addEventListener("beforeunload",this.persistStats),this.onMediaDetached=this.persistStats,this.storage=e.config.storage,this.storageBandwidthKey=e.config.bandwidthHistoryStorageKey,this.storageKeyPrefix=e.config.storageKeyPrefix,this.countFragSamples=0,this.minFragCount=Object(ke.c)(e.config.minFragmentCount)?e.config.minFragmentCount:10,this.avgFragParseTimeMs=0,this.avgFragBufferTimeMs=0}get bwStorageKey(){return this.storageBandwidthKey}get serviceStorageKey(){return this.storageKeyPrefix+this.serviceName}getAndCacheBandwidthEstimate(){const e=this.bwEstimator.getEstimate(this.hls.config.bandwidthHistoryAggregationMethod);return e&&(this.aggregatedAt=performance.now(),this.cachedBandwidthEstimate=e),e}setServiceName(e){this.serviceName=e}sample({trequest:e,tfirst:t,tload:i,loaded:r}){this.bwEstimator.record({trequest:e,tfirst:t,tload:i,bitsDownloaded:8*r}),this.getAndCacheBandwidthEstimate()}getLatestBw(){return this.bwEstimator.getLatest()}getEstimate(){if(performance.now()-this.aggregatedAt<=this.hls.config.bandwidthHistoryGetEstimateThrottleMs)return this.cachedBandwidthEstimate;const e=this.getAndCacheBandwidthEstimate();if(e)return e;try{const e=JSON.parse(this.storage.get(this.bwStorageKey));if((null==e?void 0:e.expires)&&e.expires>=Date.now())return e}catch(e){this.logger.warn("Unable to get persisted bandwidth history, returning undefined: "+e.message)()}}sampleFrag(e){e&&(Object(ke.c)(e.duration)&&(this.maxFragDuration=Math.max(this.maxFragDuration||0,(null==e?void 0:e.duration)||0)),Object(ke.c)(e.bufferCreationDelayMs)&&(this.maxFragBufferCreationDelayMs=Math.max(this.maxFragBufferCreationDelayMs||0,(null==e?void 0:e.bufferCreationDelayMs)||0)),Object(ke.c)(e.parseTimeMs)&&Object(ke.c)(e.bufferTimeMs)&&(this.avgFragParseTimeMs=(this.avgFragParseTimeMs*this.countFragSamples+(null==e?void 0:e.parseTimeMs))/(this.countFragSamples+1),this.avgFragBufferTimeMs=(this.avgFragBufferTimeMs*this.countFragSamples+(null==e?void 0:e.bufferTimeMs))/(this.countFragSamples+1),this.countFragSamples+=1))}samplePlayList(e){this.maxPlaylistLoadTimeMs=Math.max(this.maxPlaylistLoadTimeMs||0,e.tload-e.trequest)}getFragEstimate(){let e={maxDuration:this.maxFragDuration,avgParseTimeMs:NaN,maxBufferCreationDelayMs:this.maxFragBufferCreationDelayMs,avgBufferTimeMs:NaN};this.countFragSamples>=this.minFragCount&&(e.avgParseTimeMs=this.avgFragParseTimeMs,e.avgBufferTimeMs=this.avgFragBufferTimeMs);const t=e=>e.maxDuration&&Object(ke.c)(e.avgParseTimeMs)&&e.maxBufferCreationDelayMs&&Object(ke.c)(e.avgBufferTimeMs);if(t(e))return e;try{const t=JSON.parse(this.storage.get(this.serviceStorageKey));e.maxDuration=e.maxDuration||(null==t?void 0:t.maxDuration),!Object(ke.c)(e.avgParseTimeMs)&&(null==t?void 0:t.countFragSamples)>=this.minFragCount&&(e.avgParseTimeMs=null==t?void 0:t.avgFragParseTimeMs),e.maxBufferCreationDelayMs=e.maxBufferCreationDelayMs||(null==t?void 0:t.maxFragBufferCreationDelayMs),!Object(ke.c)(e.avgBufferTimeMs)&&(null==t?void 0:t.countFragSamples)>=this.minFragCount&&(e.avgBufferTimeMs=null==t?void 0:t.avgFragBufferTimeMs)}catch(e){this.logger.warn("Unable to get persisted fragment stats, returning default values: "+e.message)()}return t(e)||(e.maxDuration=e.maxDuration||this.hls.config.defaultTargetDuration,Object(ke.c)(e.avgParseTimeMs)||(e.avgParseTimeMs=this.hls.config.statDefaults.fragParseTimeMs),e.maxBufferCreationDelayMs=e.maxBufferCreationDelayMs||this.hls.config.statDefaults.fragBufferCreationDelayMs,Object(ke.c)(e.avgBufferTimeMs)||(e.avgBufferTimeMs=this.hls.config.statDefaults.fragBufferTimeMs)),e}getPlaylistEstimate(){if(Object(ke.c)(this.maxPlaylistLoadTimeMs))return{maxPlaylistLoadTimeMs:this.maxPlaylistLoadTimeMs};try{const e=JSON.parse(this.storage.get(this.serviceStorageKey));if(null==e?void 0:e.maxPlaylistLoadTimeMs)return{maxPlaylistLoadTimeMs:e.maxPlaylistLoadTimeMs}}catch(e){this.logger.warn("Unable to get persisted playlist stats, return default variant playlist load time: "+e.message)()}return{maxPlaylistLoadTimeMs:this.hls.config.statDefaults.playlistLoadTimeMs}}persistStats(){if(void 0===this.storage.set)return void this.logger.warn("`storage.set` is not supported! Not persisting bandwidth estimates")();const e=this.getAndCacheBandwidthEstimate();if(e){const t=Object.assign({},e,{expires:Date.now()+this.ttl});this.storage.set(this.bwStorageKey,JSON.stringify(t))}let t={};Object(ke.c)(this.maxFragDuration)&&(t.maxDuration=this.maxFragDuration),Object(ke.c)(this.avgFragParseTimeMs)&&(t.avgFragParseTimeMs=this.avgFragParseTimeMs),Object(ke.c)(this.avgFragBufferTimeMs)&&(t.avgFragBufferTimeMs=this.avgFragBufferTimeMs),Object(ke.c)(this.maxFragBufferCreationDelayMs)&&(t.maxFragBufferCreationDelayMs=this.maxFragBufferCreationDelayMs),Object(ke.c)(this.maxPlaylistLoadTimeMs)&&(t.maxPlaylistLoadTimeMs=this.maxPlaylistLoadTimeMs),Object(ke.c)(this.countFragSamples)&&(t.countFragSamples=this.countFragSamples),this.storage.set(this.serviceStorageKey,JSON.stringify(t))}destroy(){"undefined"!=typeof window&&"function"==typeof window.removeEventListener&&window.removeEventListener("beforeunload",this.persistStats),this.bwEstimator.destroy(),super.destroy()}}var Fn,Bn=class{constructor(e,t,i,r={}){this._logger=e.logger,this._intervalTimeout=i.rtcIntervalTimeout,this._interval=setInterval(this._handlePeriodic.bind(this),this._intervalTimeout),this._state=Ci,this._hls=e,this._sessStartTime=this._stateStartTime=this._intervalStartTime=Date.now(),this._variantStartTime=0,this._minSwitchWindow=1e4,this._sessionData={},this._intervalData={},this._playStalledData={},this._mediaEngineStalledData={},this._keySessionCompleteData={},this._playLikelyToKeepUpData={},this._playRateChangedData={},this._playErrorData={},this._switchCompleteData={},this._variantEndData={},this._nwErrorData={},this._dimensionData={maxVideoQltyIndex:0,maxReWd:0,maxReHt:0},this._miscData={periodicEvtCnt:0,playLikelyToKeepUpEvtCnt:0,keyDataDict:{},fragmentCnt:0,sessVariantList:{},intervalVariantList:{},nonFatalMediaErrList:{},nonFatalNwErrList:{},playlistMimeTypes:new Set,segmentMimeTypes:new Set,decodedFramesForVariant:0,decodedFramesForVariantSampleCount:0,intervalSegmentBytes:0,intervalSegmentAdt:0,intervalSegmentProcessTime:0,sessSegmentBytes:0,sessSegmentAdt:0,sessSegmentProcessTime:0,sessVideoBytes:0,sessVideoDuration:0,sessAudioBytes:0,sessAudioDuration:0,intervalVideoBytes:0,intervalVideoDuration:0,intervalAudioBytes:0,intervalAudioDuration:0},t?r.reportingAgent&&(this.reportingAgent=r.reportingAgent,this._logger.info("[QE Critical] [RTCA] - Reporting session started, base SessionID: "+this.reportingAgent.SessionID)()):this._logger.info("[RTCA] - Reporting is disabled")(),this._eventEmitter=e.media,this._accessLogReporter={SessionID:e.sessionID,ServiceName:r.serviceName,ClientName:r.appName},this._accessLogData=this.createAccessLogEntry(),this._accesslog=[],this._errorlog=[]}destroy(){clearInterval(this._interval),this._accesslog=[],this._errorlog=[],this._accessLogData=void 0,this._accessLogReporter=void 0,this.reportingAgent=null,this._eventEmitter=void 0}get currentItemId(){return this.itemId}set currentItemId(e){this.itemId=e}setMedia(e){!e&&this._interval&&clearInterval(this._interval),this.media=e}getDesiredRate(){return this._desiredRate}getMedia(){return this.media}updateSvrAddrStats(e){let t=Fe.parseURL(e);if(t&&t.netLoc){let e=t.netLoc.indexOf(":"),i=e>=0?t.netLoc.slice(0,e):t.netLoc;i.startsWith("//")&&(i=i.slice(2)),this._accessLogData.svrAddr?i!==this._accessLogData.svrAddr&&this._accessLogData.svrAddrChanged++:this._accessLogData.svrAddrChanged=0,this._accessLogData.svrAddr=i}}convertStringObjectToPrimitive(e){return e?"object"==typeof e?e.toString():e:""}createAccessLogEntry(){return{fragmentCnt:0,overdue:0,startPTS:0,obrMax:0,obrMin:0,audioBytes:0,audioDuration:0,videoBytes:0,videoDuration:0,svrAddrChanged:0,svrAddr:"",PlayTimeWC:0,ViFrDr:0,StallCount:0,MediaEngineStallCount:0,ADT:0,NetBytes:0,StartupTime:0,OBRMean:0,OBRLast:0}}translateToAccessLogItem(e,t,i){let r,s=this.convertStringObjectToPrimitive(e);this.updateSvrAddrStats(s),(r=this._switchCompleteData.MediaDur?this._switchCompleteData.MediaDur:this._getBufferedDuration())||(r=0);let a={uri:s,"s-ip":this._accessLogData.svrAddr,"s-ip-changes":this._accessLogData.svrAddrChanged,"sc-wwan-count":-1,"c-transfer-duration":this._accessLogData.ADT,bytes:this._accessLogData.NetBytes,"c-total-media-requests":this._accessLogData.fragmentCnt,"cs-guid":this._accessLogReporter.SessionID,"c-start-time":this._accessLogData.startPTS,"c-startup-time":this._accessLogData.StartupTime,"c-duration-watched":this._accessLogData.PlayTimeWC/1e3,"c-frames-dropped":this._accessLogData.ViFrDr,"c-stalls":this._accessLogData.StallCount,"c-duration-downloaded":this._accessLogData.lastMediaDur?r-this._accessLogData.lastMediaDur:r,"c-overdue":this._accessLogData.overdue,"c-avg-video-bitrate":8*this._accessLogData.videoBytes/(this._accessLogData.videoDuration||1),"c-observed-max-bitrate":this._accessLogData.obrMax,"c-observed-min-bitrate":this._accessLogData.obrMin,"sc-indicated-bitrate":t.bandwidth?t.bandwidth:0,"sc-indicated-avg-bitrate":t.avgBandwidth?t.avgBandwidth:0,"c-observed-bitrate":this._accessLogData.OBRMean,"c-switch-bitrate":this._accessLogData.OBRLast,"c-provisional-entry":!1};return i.playlistType&&(a["s-playback-type"]=i.playlistType),this._accessLogData.audioBytes&&(a["c-avg-audio-bitrate"]=8*this._accessLogData.audioBytes/(this._accessLogData.audioDuration||1)),a}translateToErrorLogItem(e,t){let i=this.convertStringObjectToPrimitive(e);return this.updateSvrAddrStats(i),{date:new Date,"cs-guid":this._accessLogReporter.SessionID+"-"+this.currentItemId,uri:i,"s-ip":this._accessLogData.svrAddr,status:t.ErrCode,domain:t.ErrDomain}}addToAccessLog(e,t,i){if(!e||""===e)return;let r=this.translateToAccessLogItem(e,t,i);if(r){let e=this._accesslog.length-20;e>0&&this._accesslog.splice(0,e),this._accesslog.push(r)}this._accessLogData=this.createAccessLogEntry(),this._accessLogData.lastMediaDur=this._switchCompleteData.MediaDur?this._switchCompleteData.MediaDur:this._getBufferedDuration()}addToErrorLog(e,t){let i=this.translateToErrorLogItem(e,t);if(i){let e=this._errorlog.length-20;e>0&&this._errorlog.splice(0,e),this._errorlog.push(i)}}get accessLog(){let e=this._accesslog.slice(0);if(e){let t=this._miscData.curLevelUrl;if(t&&""!==t){let i=this._getVariantInfo(t),r=this.translateToAccessLogItem(t,i,this._miscData);r&&(r["c-provisional-entry"]=!0,e.push(r))}}return e}get errorLog(){return this._errorlog}notify(e,t){if(this._state!==Oi||e===Gt)switch(e){case Bt:this._handleCanPlay();break;case Ut:this._handleDesiredRateChange(t);break;case $t:case Vt:this._handleRateChange(e,t);break;case Wt:this._handleSeeked(t);break;case Gt:this._handlePlayEnded();break;case si:this._handleBufferStalled(t);break;case ai:this._handleMediaEngineStalled(t);break;case Ht:this._handleMediaError(t);break;case Jt:this._handleVariantEnd();break;case ei:this._handleLevelLoaded(t);break;case ri:case ti:this._handleLevelSwitched(t);break;case ii:this._handleLevelsChanged(t);break;case ni:this._handleNwError(t);break;case Kt:this._handlePlaybackInfo(t);break;case jt:this._handleBufferAppended(t);break;case qt:case zt:case Xt:case Qt:case Yt:this._aggregateStats(e,t);break;case Zt:case oi:case li:case di:case hi:case ci:case ui:case fi:case gi:case pi:case yi:case mi:this._handleKeySessionEvents(e,t)}}_handleCanPlay(){if(!this._isLikelyToKeepUp){const e=Date.now();this._state===Ci&&this._setValue([this._intervalData,this._sessionData],"InitTime",e-this._sessStartTime),this._miscData.lastLikelyToKeepUpTime=e,this._setValue([this._playLikelyToKeepUpData,this._playRateChangedData,this._accessLogData],"StartupTime",e-this._stateStartTime),this._sendPlayLikelyToKeepUpEvent(),this._isLikelyToKeepUp=!0}}_handleDesiredRateChange(e){this._desiredRate=e.rate}_handleRateChange(e,t){e===Vt&&(this._miscData.playInfo||(this._miscData.playInfo=[]),this._miscData.playInfo.push(t)),(this._rate!==this._desiredRate||0!==this._desiredRate&&this._state!==Pi)&&(this._rate=this._desiredRate,this._updateStateTimes(6106,100*this._rate),this._sendPlayRateChangedEvent())}_handleSeeked(e){this._miscData.seekInfo||(this._miscData.seekInfo=[]),this._miscData.seekInfo.push(e)}_handlePlayEnded(){let e=this._sessionData.NetBytes,t=this._intervalData.NetBytes;e=1e3*Math.round(e/1e3),t=1e3*Math.round(t/1e3),this._sessionData.NetBytes=e,this._intervalData.NetBytes=t,this._handlePeriodic(),this._updateStateTimes(vi,void 0),this._sendSummaryEvent()}_handlePeriodic(){this._finalizeStatsForPeriodic(),this._sendPeriodicEvent()}_handleBufferStalled(e){this._state===Pi&&(this._miscData.stallDetectionTime=e.stallDurationMs,this._miscData.stallType=e.type,this._miscData.bufferLength=e.bufferInfo.len,this._updateStateTimes(6103,void 0),this._inc([this._sessionData,this._intervalData,this._accessLogData],"StallCount",1),this._sendPlayStalledEvent())}_handleMediaEngineStalled(e){this._state===Pi&&(this._miscData.stallDetectionTime=e.stallDurationMs,this._miscData.stallType=e.type,this._miscData.bufferLength=e.bufferInfo.len,this._updateStateTimes(6108,void 0),this._inc([this._sessionData,this._intervalData],"MediaEngineStallCount",1),this._sendMediaEngineStalledEvent())}_handleVariantEnd(){if(this._state===Pi){const e=Date.now(),t=Math.min(e-this._variantStartTime,e-this._stateStartTime),i=Math.abs(t*(this._miscData.lastPlayRate/100));this._inc([this._variantEndData],"VarPlayTime",i),this._inc([this._variantEndData],"VarPlayTimeWC",t)}this._sendVariantEndEvent()}_handleLevelLoaded(e){if(!this._miscData.playlistType){this._miscData.playlistType=e.playlistType;let t=this._getVariantInfo(e.url);t&&(t.targetduration=e.targetduration)}this._miscData.playlistMimeTypes.has(e.contentType)||this._miscData.playlistMimeTypes.add(e.contentType),this._inc([this._sessionData,this._intervalData],"PlaylistADT",e.adt),this._setValue([this._playLikelyToKeepUpData],"PlaylistADT",e.adt),this._updateMaxValue([this._sessionData,this._intervalData],"MaxPlaylistDT",e.adt)}_handleKeySessionEvents(e,t){const i=t.timestamp;let r=this._miscData.keyDataDict[t.keyuri]||{};switch(e){case Zt:r.keyFormat="identity",r.keyDeliveryTime=t.adt,this._state===Ci&&(r.keyInitTime=i-this._sessStartTime),this._miscData.keyData=r,this._sendKeySessionCompleteEvent();break;case oi:r.keySessionStartTime=r.SPCRequestStartTime=i,this._state===Ci&&(r.keyInitTime=i-this._sessStartTime),this._miscData.keyDataDict[t.keyuri]=r;break;case li:r.SPCRequestTime=i-r.SPCRequestStartTime;break;case di:r.keyFormat=t.keyFormat,r.SPCSubmitStartTime=i;break;case hi:r.cdmVersion=t.cdmVersion,r.SPCCreationTime=i-r.SPCSubmitStartTime;break;case ci:r.CKCRequestStartTime=i;break;case ui:r.CKCResponseTime=i-r.CKCRequestStartTime;break;case fi:r.CKCSubmitStartTime=i;break;case gi:r&&(r.CKCProcessTime=i-r.CKCSubmitStartTime,r.keyDeliveryTime=i-r.keySessionStartTime,this._miscData.keyData=r,this._sendKeySessionCompleteEvent(),delete this._miscData.keyDataDict[t.keyuri]);break;case pi:case yi:case mi:r&&(r.isKeyError=!0,r.keyErrorType=e,this._miscData.keyData=r,this._sendKeySessionCompleteEvent(),delete this._miscData.keyDataDict[t.keyuri])}}_handleLevelSwitched(e){const t=Date.now();let i,r=!1;if(this._miscData.curLevelUrl){let t=this._getVariantInfo(this._miscData.curLevelUrl),s=this._getVariantInfo(e.url);i=s.bandwidth<t.bandwidth?"Down":"Up",r=s.iframes}if(this._inc([this._sessionData,this._intervalData],"SwCnt",1),this._miscData.isBadSw=this._isBadSw(i,r,t,this._minSwitchWindow,this._miscData,e.isSeeking),e.failedSwitchUrl)this._miscData.failedSwitchUrl=e.failedSwitchUrl;else{if(this._state===Pi){const e=Math.min(t-this._variantStartTime,t-this._stateStartTime),i=Math.abs(e*(this._miscData.lastPlayRate/100));this._inc([this._switchCompleteData],"PlayTimeLastSW",i);const r=Math.min(e,t-this._intervalStartTime);this._updateLevelStats(r,this._miscData.curLevelUrl)}this._miscData.lastSwitchDir=i,this._miscData.lastSwitchTime=t,this._miscData.variantStartTimeMedia=this._getCurrentMediaTimeMilliSec(),this._miscData.lastLevelIsIframe=r,this._miscData.prevLevelUrl=this._miscData.curLevelUrl,this._miscData.curLevelUrl=e.url,this._variantStartTime=t}this._sendSwitchComplete()}_handleLevelsChanged(e){this._computeVariantInfo(e.levels)}_handleMediaError(e){if(this._inc([this._sessionData,this._intervalData],"PlayerErrCount",1),e.fatal){let t={errDomain:"mediaError",errIsFatal:e.fatal,errCode:e.details,errReason:e.reason,errCount:1};this._miscData.playErrData=t,this._inc([this._sessionData,this._intervalData],"FatalPlayerErrCount",1),this._updateStateTimes(6107,void 0),this._sendPlayError()}else{let t=e.details+"/"+e.reason,i=this._miscData.nonFatalMediaErrList[t]||0;this._miscData.nonFatalMediaErrList[t]=i+1}}_handleNwError(e){if(this._inc([this._sessionData,this._intervalData],"NwErrCount",1),e.fatal){let t={errDomain:"networkError",errIsFatal:e.fatal,errCode:e.details,errReason:e.reason,errCount:1,errTime:Date.now()};this._miscData.nwErrData=t,this._inc([this._sessionData,this._intervalData],"FatalNwErrCount",1),this._updateStateTimes(6202,void 0),this._sendNwError()}else{let t=e.details+"/"+e.reason,i=this._miscData.nonFatalNwErrList[t]||0;this._miscData.nonFatalNwErrList[t]=i+1}}_handleBatchMediaError(){let e=this._miscData.nonFatalMediaErrList;Object.keys(e).forEach(t=>{let i=t.split("/"),r={errDomain:"mediaError",errCode:i[0],errReason:parseInt(i[1]),errIsFatal:!1,errCount:e[t]};this._miscData.playErrData=r,this._sendPlayError()}),this._miscData.nonFatalMediaErrList={}}_handleBatchNwError(){let e=this._miscData.nonFatalNwErrList;Object.keys(e).forEach(t=>{let i=t.split("/"),r={errDomain:"networkError",errIsFatal:!1,errCode:i[0],errReason:parseInt(i[1]),errCount:e[t],errTime:Date.now()};this._miscData.nwErrData=r,this._sendNwError()}),this._miscData.nonFatalNwErrList={}}_handlePlaybackInfo(e){e.droppedVideoFrames<this._miscData.droppedVideoFrames&&(this._miscData.droppedVideoFrames=0),e.decodedFrameCount<this._miscData.decodedFrameCount&&(this._miscData.decodedFrameCount=0);let t=e.droppedVideoFrames-(this._miscData.droppedVideoFrames||0),i=e.decodedFrameCount-(this._miscData.decodedFrameCount||0);this._miscData.droppedVideoFrames=e.droppedVideoFrames,this._miscData.decodedFrameCount=e.decodedFrameCount,this._miscData.decodedFramesForVariant+=i,this._miscData.decodedFramesForVariantSampleCount+=1,t&&(this._inc([this._accessLogData],"ViFrDr",t),t>=3?(this._inc([this._sessionData,this._intervalData],"GroupViFrDr",t),this._inc([this._sessionData,this._intervalData],"GroupViFrDrEvtCount",1)):(this._inc([this._sessionData,this._intervalData],"SparseViFrDr",t),this._inc([this._sessionData,this._intervalData],"SparseViFrDrEvtCount",1)))}_handleBufferAppended(e){this._miscData.bufferAppendInfo||(this._miscData.bufferAppendInfo=[]),this._miscData.bufferAppendInfo.push(e)}_sendSummaryEvent(){clearInterval(this._interval);let e=this._sessionData.NetBytes||0,t=this._sessionData.ADT||0,i=e&&t?8*e/(t/1e3):0,r=this._sessionData.SegmentProcessTime||0,s=e&&t?8*e/((t+r)/1e3):0,a=this._sessionData.SegmentParseTime||0;e=this._miscData.sessSegmentBytes,t=this._miscData.sessSegmentAdt,r=this._miscData.sessSegmentProcessTime;let n=e&&t?8*e/((t+r+a)/1e3):0,o=8*(this._miscData.sessVideoBytes||0)/(this._miscData.sessVideoDuration||1),l=8*(this._miscData.sessAudioBytes||0)/(this._miscData.sessAudioDuration||1),d=this._findTimeWeightedValues(this._miscData.sessVariantList),h=this._getVariantInfo(this._miscData.curLevelUrl),c=this._miscData.manifestData||{},u="";this._miscData.playlistMimeTypes.forEach(e=>{u+=e+","});let f="";this._miscData.segmentMimeTypes.forEach(e=>{f+=e+","}),this._sessionData.PlayType=this._miscData.playlistType,this._sessionData.TWOBR=i,this._sessionData.PerceivedTWOBR=s,this._sessionData.NetTWOBR=n,this._sessionData.AvgVideoBitrate=o,this._sessionData.AvgAudioBitrate=l,this._sessionData.PlayerTWIBR=d.twIBR,this._sessionData.PlayerTWIABR=d.twIABR,this._sessionData.TWBitRk=d.twBRnk,this._sessionData.TargetDur=h.targetduration,this._sessionData.VariantList=c.trimmedVarList,this._sessionData.PlaylistMimeType=u.slice(0,-1),this._sessionData.SegmentMimeType=f.slice(0,-1),this._sessionData.Rate=this._miscData.lastPlayRate,this._sessionData.ReWd=h.width,this._sessionData.ReHt=h.height,this._fillAndFire(vi,bi,this._sessionData),this._sessionData={},this._miscData.sessVariantList={},this._miscData.sessSegmentBytes=0,this._miscData.sessSegmentAdt=0,this._miscData.sessSegmentProcessTime=0}_sendPeriodicEvent(){let e=this._intervalData.NetBytes,t=this._intervalData.ADT,i=e&&t?8*e/(t/1e3):0,r=this._intervalData.SegmentProcessTime||0,s=e&&t?8*e/((t+r)/1e3):0,a=this._intervalData.SegmentParseTime||0;e=this._miscData.intervalSegmentBytes,t=this._miscData.intervalSegmentAdt,r=this._miscData.intervalSegmentProcessTime;let n=e&&t?8*e/((t+r+a)/1e3):0,o=8*(this._miscData.intervalVideoBytes||0)/(this._miscData.intervalVideoDuration||1),l=8*(this._miscData.intervalAudioBytes||0)/(this._miscData.intervalAudioDuration||1),d=this._findTimeWeightedValues(this._miscData.intervalVariantList),h=this._getVariantInfo(this._miscData.curLevelUrl),c=this._miscData.manifestData||{},u=this._computeMediaStats();this._intervalData.EventCounter=++this._miscData.periodicEvtCnt,this._intervalData.PlayType=this._miscData.playlistType,this._intervalData.TWOBR=i,this._intervalData.PerceivedTWOBR=s,this._intervalData.NetTWOBR=n,this._intervalData.AvgVideoBitrate=o,this._intervalData.AvgAudioBitrate=l,this._intervalData.PlayerTWIBR=d.twIBR,this._intervalData.PlayerTWIABR=d.twIABR,this._intervalData.TWBitRk=d.twBRnk,this._intervalData.TargetDur=h.targetduration,this._intervalData.VariantList=c.trimmedVarList,this._intervalData.Rate=this._miscData.lastPlayRate,this._intervalData.ReWd=h.width,this._intervalData.ReHt=h.height,u&&(this._intervalData.MedianBufferAppendLatency=u.bufLatencyInfo.median,this._intervalData.MaxBufferAppendLatency=u.bufLatencyInfo.max,this._intervalData.MedianBufferAppendSize=u.bufSizeInfo.median,this._intervalData.MaxBufferAppendSize=u.bufSizeInfo.max,this._intervalData.MedianSeekLatency=u.seekLatencyInfo.median,this._intervalData.MaxSeekLatency=u.seekLatencyInfo.max,this._intervalData.MedianPlayLatency=u.playLatencyInfo.median,this._intervalData.MaxPlayLatency=u.playLatencyInfo.max),(this._intervalData.PlayTimeWC>0||this._intervalData.ADT)&&this._fillAndFire(6110,Si,this._intervalData),this._intervalData={},this._miscData.intervalVariantList={},this._miscData.intervalSegmentBytes=0,this._miscData.intervalSegmentAdt=0,this._miscData.intervalSegmentProcessTime=0,this._miscData.intervalVideoBytes=0,this._miscData.intervalVideoDuration=0,this._miscData.intervalAudioBytes=0,this._miscData.intervalAudioDuration=0,this._miscData.playInfo=null,this._miscData.seekInfo=null,this._miscData.bufferAppendInfo=null}_sendPlayStalledEvent(){var e,t;const i=Date.now();let r=this._getVariantInfo(this._miscData.curLevelUrl);this._playStalledData.MediaDur=this._getBufferedDuration(),this._playStalledData.BitRnk=r.brRnk,this._playStalledData.Codecs=r.codecs,this._playStalledData.PlayTime=this._sessionData.PlayTime,this._playStalledData.PlayType=this._miscData.playlistType,this._playStalledData.LastLikelyToKeepUp=i-this._miscData.lastLikelyToKeepUpTime,this._playStalledData.LastSwitch=i-this._miscData.lastSwitchTime,this._playStalledData.NwErrTime=null===(e=this._miscData.nwErrData)||void 0===e?void 0:e.errTime,this._playStalledData.NwErrCode=null===(t=this._miscData.nwErrData)||void 0===t?void 0:t.errCode,this._playStalledData.StallDetectionTime=this._miscData.stallDetectionTime,this._playStalledData.StallType=this._miscData.stallType,this._playStalledData.BufferLength=this._miscData.bufferLength,this._playStalledData.LaSwDir=this._miscData.lastSwitchDir,this._playStalledData.TargetDur=r.targetduration,this._playStalledData.PlayerIABR=r.avgBandwidth,this._playStalledData.PlayerIBR=r.bandwidth,this._playStalledData.Rate=this._miscData.lastPlayRate,this._fillAndFire(6103,Ti,this._playStalledData),this._playStalledData={}}_sendMediaEngineStalledEvent(){const e=Date.now();let t=this._getVariantInfo(this._miscData.curLevelUrl);this._mediaEngineStalledData.MediaDur=this._getBufferedDuration(),this._mediaEngineStalledData.BitRnk=t.brRnk,this._mediaEngineStalledData.Codecs=t.codecs,this._mediaEngineStalledData.PlayTime=this._sessionData.PlayTime,this._mediaEngineStalledData.PlayType=this._miscData.playlistType,this._mediaEngineStalledData.LastLikelyToKeepUp=e-this._miscData.lastLikelyToKeepUpTime,this._mediaEngineStalledData.LastSwitch=e-this._miscData.lastSwitchTime,this._mediaEngineStalledData.LaSwDir=this._miscData.lastSwitchDir,this._mediaEngineStalledData.StallDetectionTime=this._miscData.stallDetectionTime,this._mediaEngineStalledData.StallType=this._miscData.stallType,this._mediaEngineStalledData.BufferLength=this._miscData.bufferLength,this._mediaEngineStalledData.TargetDur=t.targetduration,this._mediaEngineStalledData.PlayerIABR=t.avgBandwidth,this._mediaEngineStalledData.PlayerIBR=t.bandwidth,this._mediaEngineStalledData.Rate=this._miscData.lastPlayRate,this._fillAndFire(6108,wi,this._mediaEngineStalledData),this._mediaEngineStalledData={}}_sendKeySessionCompleteEvent(){this._keySessionCompleteData.KeyFormat=this._miscData.keyData.keyFormat,this._keySessionCompleteData.CDMVersion=this._miscData.keyData.cdmVersion,this._keySessionCompleteData.SPCRequestTime=this._miscData.keyData.SPCRequestTime,this._keySessionCompleteData.SPCCreationTime=this._miscData.keyData.SPCCreationTime,this._keySessionCompleteData.CKCResponseTime=this._miscData.keyData.CKCResponseTime,this._keySessionCompleteData.CKCProcessTime=this._miscData.keyData.CKCProcessTime,this._keySessionCompleteData.KeyDeliveryTime=this._miscData.keyData.keyDeliveryTime,this._keySessionCompleteData.CurrentMediaTime=this._getCurrentMediaTimeMilliSec(),this._keySessionCompleteData.KeyInitTime=this._miscData.keyData.keyInitTime,this._miscData.keyData.isKeyError&&(this._keySessionCompleteData.KeyErrorType=this._miscData.keyData.keyErrorType),this._fillAndFire(6104,Ei,this._keySessionCompleteData),this._keySessionCompleteData={},delete this._miscData.keyData}_sendPlayLikelyToKeepUpEvent(){let e=this._getVariantInfo(this._miscData.curLevelUrl);this._playLikelyToKeepUpData.EventCounter=++this._miscData.playLikelyToKeepUpEvtCnt,this._playLikelyToKeepUpData.PlayType=this._miscData.playlistType,this._playLikelyToKeepUpData.PlayerIABR=e.avgBandwidth,this._playLikelyToKeepUpData.PlayerIBR=e.bandwidth,this._playLikelyToKeepUpData.MediaDur=this._getBufferedDuration(),this._playLikelyToKeepUpData.BitRnk=e.brRnk,this._playLikelyToKeepUpData.Codecs=e.codecs,this._playLikelyToKeepUpData.TargetDur=e.targetduration,this._fillAndFire(6105,_i,this._playLikelyToKeepUpData),this._playLikelyToKeepUpData={}}_sendPlayRateChangedEvent(){let e=this._getVariantInfo(this._miscData.curLevelUrl);this._playRateChangedData.Rate=this._miscData.lastPlayRate,this._playRateChangedData.PlayType=this._miscData.playlistType,this._playRateChangedData.StNPT=this._getCurrentMediaTimeMilliSec(),this._playRateChangedData.PlayerIABR=e.avgBandwidth,this._playRateChangedData.PlayerIBR=e.bandwidth,this._playRateChangedData.BitRnk=e.brRnk,this._playRateChangedData.MediaDur=this._getBufferedDuration(),this._playRateChangedData.Codecs=e.codecs,this._fillAndFire(6106,Di,this._playRateChangedData),this._playRateChangedData={}}_sendPlayError(){const e=Date.now();let t=this._getVariantInfo(this._miscData.curLevelUrl);this._playErrorData.ErrDomain=this._miscData.playErrData.errDomain,this._playErrorData.ErrIsFatal=this._miscData.playErrData.errIsFatal,this._playErrorData.ErrCode=this._miscData.playErrData.errCode,this._playErrorData.ErrReason=this._miscData.playErrData.errReason,this._playErrorData.PlayerErrCount=this._miscData.playErrData.errCount,this._playErrorData.PlayType=this._miscData.playlistType,this._playErrorData.BitRnk=t.brRnk,this._playErrorData.MediaDur=this._getBufferedDuration(),this._playErrorData.PlayTime=this._sessionData.PlayTime,this._playErrorData.PlayTimeWC=this._sessionData.PlayTimeWC,this._playErrorData.PlayerIABR=t.avgBandwidth,this._playErrorData.PlayerIBR=t.bandwidth,this._playErrorData.LastLikelyToKeepUp=e-this._miscData.lastLikelyToKeepUpTime,this._playErrorData.LastSwitch=e-this._miscData.lastSwitchTime,this._playErrorData.VideoQltyIndex=t.qltyIndex,this.addToErrorLog(this._miscData.curLevelUrl,this._playErrorData),this._fillAndFire(6107,Ii,this._playErrorData),this._playErrorData={}}_sendSwitchComplete(){let e=this._miscData.prevLevelUrl,t=this._miscData.failedSwitchUrl||this._miscData.curLevelUrl,i=!!this._miscData.failedSwitchUrl;this._miscData.failedSwitchUrl=void 0;let r=this._getVariantInfo(e),s=this._getVariantInfo(t);this._switchCompleteData.FrBitRnk=r.brRnk,this._switchCompleteData.ToBitRnk=s.brRnk,this._switchCompleteData.TimeToBitrate=Date.now()-this._sessStartTime,this._switchCompleteData.MediaDur=this._getBufferedDuration(),this._switchCompleteData.Rate=this._miscData.lastPlayRate,this._switchCompleteData.PlayType=this._miscData.playlistType,this._switchCompleteData.SwFail=i,this._switchCompleteData.PlayerIBR=s.bandwidth,this._switchCompleteData.PlayerIABR=s.avgBandwidth,this._switchCompleteData.LastPlayerIBR=r.bandwidth,this._switchCompleteData.LastPlayerIABR=r.avgBandwidth,this._switchCompleteData.PlayTime=this._sessionData.PlayTime,this._switchCompleteData.BadSw=this._miscData.isBadSw,this._switchCompleteData.ReWd=s.width,this._switchCompleteData.ReHt=s.height,this.addToAccessLog(e,r,this._miscData),this._fillAndFire(6109,Ri,this._switchCompleteData),this._switchCompleteData={}}_sendVariantEndEvent(){let e=this._getVariantInfo(this._miscData.curLevelUrl),t=this._miscData.decodedFramesForVariant/(this._miscData.decodedFramesForVariantSampleCount||1);this._miscData.decodedFramesForVariant=0,this._miscData.decodedFramesForVariantSampleCount=0,this._variantEndData.Rate=this._miscData.lastPlayRate,this._variantEndData.PlayType=this._miscData.playlistType,this._variantEndData.VarAvgBitrate=e.avgBandwidth,this._variantEndData.VarPeakBitrate=e.bandwidth,this._variantEndData.VarBitRk=e.brRnk,this._variantEndData.VarSTTime=this._miscData.variantStartTimeMedia,this._variantEndData.VarEndTime=this._getCurrentMediaTimeMilliSec(),this._variantEndData.IFR=e.framerate,this._variantEndData.ODR=t,this._variantEndData.ReWd=e.width,this._variantEndData.ReHt=e.height,this._fillAndFire(6111,Ai,this._variantEndData),this._variantEndData={}}_sendNwError(){let e=this._getVariantInfo(this._miscData.curLevelUrl);this._nwErrorData.BitRnk=e.brRnk,this._nwErrorData.PlayTime=this._sessionData.PlayTime,this._nwErrorData.PlayTimeWC=this._sessionData.PlayTimeWC,this._nwErrorData.PlayType=this._miscData.playlistType,this._nwErrorData.ErrDomain=this._miscData.nwErrData.errDomain,this._nwErrorData.ErrIsFatal=this._miscData.nwErrData.errIsFatal,this._nwErrorData.ErrCode=this._miscData.nwErrData.errCode,this._nwErrorData.ErrReason=this._miscData.nwErrData.errReason,this._nwErrorData.NwErrCount=this._miscData.nwErrData.errCount,this.addToErrorLog(this._miscData.curLevelUrl,this._nwErrorData),this._fillAndFire(6202,ki,this._nwErrorData),this._nwErrorData={}}_aggregateStats(e,t){switch(e){case qt:this._aggregateManifestParsedStats(t);break;case zt:this._aggregateManifestLoadedStats(t);break;case Xt:this._aggregateFragLoadingStats();break;case Qt:this._aggregateFragLoadedStats(t);break;case Yt:this._aggregateFragBufferedStats(t)}}_aggregateManifestParsedStats(e){this._computeVariantInfo(e.levels)}_aggregateManifestLoadedStats(e){this._miscData.playlistMimeTypes.has(e.contentType)||this._miscData.playlistMimeTypes.add(e.contentType),this._inc([this._sessionData,this._intervalData],"MasterPlaylistADT",e.adt)}_aggregateFragLoadingStats(){this._inc([this._sessionData,this._intervalData],"MediaRequestsSent",1)}_aggregateFragObserverdBitrate(e,t,i,r){const s=8*i/(r/1e3);return{obr:s,obrLast:8*e.bytes/(e.adt/1e3),obrMean:s/t}}_aggregateFragMinMaxBitrate(e,t){(!e.obrMax||t>e.obrMax)&&(e.obrMax=t),(!e.obrMin||t<e.obrMin)&&(e.obrMin=t)}_hasGap(e,t,i,r){return void 0!==e&&void 0!==i&&(e-r>1||i-t>1)}_aggregateFragLoadedStats(e){if(this._miscData.segmentMimeTypes.has(e.contentType)||this._miscData.segmentMimeTypes.add(e.contentType),"string"==typeof e.cdnServer&&Fi.includes(e.cdnServer.toLowerCase())&&(this._miscData.lastMediaCDNServer=e.cdnServer),e.serverInfo&&(this._miscData.serverInfo=e.serverInfo),"main"===e.fragType||"video"===e.fragType){this._inc([this._sessionData,this._intervalData,this._accessLogData],"NetBytes",e.bytes),this._inc([this._sessionData,this._intervalData,this._accessLogData],"ADT",e.adt),this._inc([this._sessionData,this._intervalData,this._accessLogData],"SegmentProcessTime",e.processTime);const t=this._aggregateFragObserverdBitrate(e,++this._miscData.fragmentCnt,this._sessionData.NetBytes,this._sessionData.ADT),i=this._aggregateFragObserverdBitrate(e,++this._accessLogData.fragmentCnt,this._accessLogData.NetBytes,this._accessLogData.ADT);if(this._playStalledData.OBRLast=t.obrLast,this._playStalledData.OBRMean=t.obrMean,this._mediaEngineStalledData.OBRLast=t.obrLast,this._mediaEngineStalledData.OBRMean=t.obrMean,this._accessLogData.OBRLast=i.obrLast,this._accessLogData.OBRMean=i.obrMean,this._aggregateFragMinMaxBitrate(this._accessLogData,i.obr),(this.media?this.media.currentTime:0)>e.startPTS&&this._eventEmitter&&!this._eventEmitter.seeking&&this._accessLogData.overdue++,this._hasGap(e.startPTS,e.endPTS,this._accessLogData.lastStartPTS,this._accessLogData.lastEndPTS)){let e=this._getVariantInfo(this._miscData.curLevelUrl);this.addToAccessLog(this._miscData.curLevelUrl,e,this._miscData)}this._accessLogData.startPTS||(this._accessLogData.startPTS=e.startPTS),this._accessLogData.lastStartPTS=e.startPTS,this._accessLogData.lastEndPTS=e.endPTS,this._miscData.sessVideoBytes+=e.bytes,this._miscData.sessVideoDuration+=e.duration,this._miscData.intervalVideoBytes+=e.bytes,this._miscData.intervalVideoDuration+=e.duration,this._accessLogData.videoBytes+=e.bytes,this._accessLogData.videoDuration+=e.duration}else"audio"===e.fragType&&(this._miscData.sessAudioBytes+=e.bytes,this._miscData.sessAudioDuration+=e.duration,this._miscData.intervalAudioBytes+=e.bytes,this._miscData.intervalAudioDuration+=e.duration,this._accessLogData.audioBytes+=e.bytes,this._accessLogData.audioDuration+=e.duration)}_aggregateFragBufferedStats(e){"main"!==e.fragType&&"video"!==e.fragType||(this._miscData.intervalSegmentBytes+=e.bytes,this._miscData.intervalSegmentAdt+=e.adt,this._miscData.intervalSegmentProcessTime+=e.processTime,this._miscData.sessSegmentBytes+=e.bytes,this._miscData.sessSegmentAdt+=e.adt,this._miscData.sessSegmentProcessTime+=e.processTime,this._inc([this._sessionData,this._intervalData,this._accessLogData],"SegmentParseTime",e.parseTime))}_inc(e,t,i){t&&i&&e&&t&&e.forEach(e=>{e[t]=e[t]?e[t]+i:i})}_updateMaxValue(e,t,i){t&&i&&e&&t&&e.forEach(e=>{(!e[t]||e[t]<i)&&(e[t]=i)})}_setValue(e,t,i){t&&i&&e&&t&&e.forEach(e=>{e[t]=i})}_clearValue(e,t){t&&e&&t&&e.forEach(e=>{delete e[t]})}_updateLevelStats(e,t){if(e&&t){let i=this._getVariantInfo(t),r={bandwidth:i.bandwidth,avgBandwidth:i.avgBandwidth,framerate:i.framerate,brRnk:i.brRnk,playTime:0},s=r,a=Object.assign({},r),n=this._miscData.intervalVariantList,o=this._miscData.sessVariantList,l=n[t]?n[t].playTime:0,d=o[t]?o[t].playTime:0;s.playTime=l+e,a.playTime=d+e,n[t]=s,o[t]=a}}_finalizeStatsForPeriodic(){const e=Date.now();let t=e-this._intervalStartTime,i=e-this._stateStartTime;if(this._intervalStartTime=e,this._miscData.pInterval=t,i=Math.min(t,i),this._setValue([this._intervalData],"PInterval",t),this._state===Pi){this._inc([this._intervalData],"PlayTimeWC",i);const t=Math.abs(i*(this._miscData.lastPlayRate/100));this._inc([this._intervalData],"PlayTime",t);const r=Math.min(e-this._variantStartTime,i);this._updateLevelStats(r,this._miscData.curLevelUrl)}else this._state===Mi?this._inc([this._intervalData],"StallTime",i):this._state===xi?this._inc([this._intervalData],"MediaEngineStallTime",i):this._state===Li&&this._inc([this._intervalData],"PauseTime",i);this._handleBatchMediaError(),this._handleBatchNwError()}_updateStateTimes(e,t){if(-1===Ni.indexOf(e))return;const i=Date.now(),r=i-this._stateStartTime,s=Math.min(i-this._intervalStartTime,r),a=Math.min(i-this._variantStartTime,r);if(this._state===Pi){this._inc([this._sessionData,this._accessLogData],"PlayTimeWC",r);const e=Math.abs(r*(this._miscData.lastPlayRate/100));this._inc([this._sessionData],"PlayTime",e);let t=Math.abs(s*(this._miscData.lastPlayRate/100));this._inc([this._intervalData],"PlayTimeWC",s),this._inc([this._intervalData],"PlayTime",t);let i=Math.abs(a*(this._miscData.lastPlayRate/100));this._inc([this._variantEndData],"VarPlayTime",i),this._inc([this._variantEndData],"VarPlayTimeWC",a),this._inc([this._switchCompleteData],"PlayTimeLastSW",i);let n=Math.min(a,s);this._updateLevelStats(n,this._miscData.curLevelUrl),this._inc([this._playRateChangedData],"RateChangePlayTime",r),this._setValue([this._playStalledData,this._mediaEngineStalledData,this._playErrorData,this._nwErrorData],"LastResume",r)}else this._state===Mi?(this._inc([this._sessionData],"StallTime",r),this._inc([this._intervalData],"StallTime",s),this._setValue([this._sessionData,this._playErrorData,this._playRateChangedData],"LastStall",r)):this._state===xi?(this._inc([this._sessionData],"MediaEngineStallTime",r),this._inc([this._intervalData],"MediaEngineStallTime",s),this._setValue([this._sessionData,this._playErrorData,this._playRateChangedData],"LastMediaEngineStall",r)):this._state===Li&&(this._inc([this._sessionData],"PauseTime",r),this._inc([this._intervalData],"PauseTime",s),this._setValue([this._sessionData,this._playErrorData,this._playRateChangedData],"LastPause",r));switch(this._stateStartTime=i,e){case 6103:this._state=Mi,this._miscData.lastPlayRate=0,this._isLikelyToKeepUp=!1;break;case 6108:this._state=xi,this._miscData.lastPlayRate=0,this._isLikelyToKeepUp=!1;break;case 6106:0===t?this._state=Li:(this._state=Pi,this._clearValue([this._sessionData],"LastStall"),this._clearValue([this._sessionData],"LastMediaEngineStall"),this._clearValue([this._sessionData],"LastPause")),this._miscData.lastPlayRate=t;break;case 6202:case 6107:case vi:this._state=Oi,this._miscData.lastPlayRate=0,this._isLikelyToKeepUp=!1}}_fillAndFire(e,t,i){if(!(e&&t&&i&&this.reportingAgent))return;this._miscData.lastMediaCDNServer&&(i.LastMediaCDNServer=this._miscData.lastMediaCDNServer),this._miscData.serverInfo&&(i.ServerInfo=this._miscData.serverInfo),i.MaxVideoQltyIndex=this._dimensionData.maxVideoQltyIndex,i.MaxReWd=this._dimensionData.maxReWd,i.MaxReHt=this._dimensionData.maxReHt,i.IsGapless=this._hls.inGaplessMode,i.IsAudioOnly=this._hls.streamController.gaplessAllowed,this._hls.config.gapless&&this._hls.eventReporter.getFirstInstance()&&(e===vi||6111===e||6110===e)?i.IsFirstItem=!0:i.IsFirstItem=this._hls.isFirstItem,i.ItemID=this._hls.sessionID+"-"+this.currentItemId;let r={};t.forEach(e=>{let t=i[e];if(Object(ke.c)(t)&&(t=Number(Number(t).toFixed(2))),"object"==typeof t)for(var s in t)t.hasOwnProperty(s)&&(r[s]=t[s]);else r[e]=t});const s=e===vi||6110===e?1:0;this.reportingAgent.issueReportingEvent(e,r,s)}_findTimeWeightedValues(e){let t={};if(e){let i=0,r=0,s=0,a=0,n=0;Object.values(e).forEach(e=>{e.playTime&&(r+=e.bandwidth*e.playTime,i+=e.brRnk*e.playTime,s+=e.playTime,e.avgBandwidth&&(a+=e.avgBandwidth*e.playTime,n+=e.playTime))}),s&&(t.twBRnk=i/s,t.twIBR=r/s),a&&n&&(t.twIABR=a/n)}return t}_computeMediaStats(){let e=this._miscData.bufferAppendInfo,t=[],i=[];e&&e.forEach&&e.forEach(e=>{t.push(e.latency),i.push(e.size)});let r=this._computeStats(t),s=this._computeStats(i),a=this._miscData.seekInfo;t=[],a&&a.forEach&&this._miscData.seekInfo.forEach(e=>t.push(e.latency));let n=this._computeStats(t),o=this._miscData.playInfo;return t=[],o&&o.forEach&&this._miscData.playInfo.forEach(e=>t.push(e.latency)),{bufLatencyInfo:r,bufSizeInfo:s,seekLatencyInfo:n,playLatencyInfo:this._computeStats(t)}}_computeStats(e){let t,i;if(e){const r=e.filter(e=>e>0);if(r.length>0){t=r.reduce((e,t)=>Math.max(e,t));const e=r.length,s=r.sort((e,t)=>e-t),a=Math.ceil(e/2);i=e%2==0?(s[a]+s[a-1])/2:s[a-1]}}return{max:t,median:i}}_computeVariantInfo(e){let t={},i={},r=0,s=0,a=this._getMaxNormalizedPeak(e);e.forEach(e=>{if(e.attrs){let i=this._getVideoFourCC(e.attrs.CODECS),r=this._getVideoQualityIndex(i,e.attrs["VIDEO-RANGE"])||0,n={codecs:e.attrs.CODECS,width:e.width,height:e.height,bandwidth:parseInt(e.attrs.BANDWIDTH),avgBandwidth:parseInt(e.attrs["AVERAGE-BANDWIDTH"]),framerate:parseFloat(e.attrs["FRAME-RATE"]),iframes:e.iframes,brRnk:this._getBitrateRank(parseInt(e.attrs.BANDWIDTH),i,a),qltyIndex:r};s=r>s?r:s,t[e.url]=n}let n=e.width*e.height;n>r&&(r=n,i={width:e.width,height:e.height})}),this._miscData.manifestData={},this._miscData.manifestData.variantList=t,this._miscData.manifestData.trimmedVarList=Object.keys(t).length>0?Object.values(t).map(e=>e.bandwidth+":"+e.avgBandwidth).join(","):void 0,this._dimensionData.maxVideoQltyIndex=s,this._dimensionData.maxReWd=i.width,this._dimensionData.maxReHt=i.height}_getBufferedDuration(){let e=0;if(this.media&&this.media.buffered){let t=this.media.buffered;for(let i=0;i<t.length;i++)e+=t.end(i)-t.start(i)}return Math.round(1e3*e)}_getVariantInfo(e){return e&&this._miscData.manifestData&&this._miscData.manifestData.variantList&&this._miscData.manifestData.variantList[e]?this._miscData.manifestData.variantList[e]:{}}_getVideoFourCC(e){return e?e.split(",").map(e=>e.split(".")[0].trim()).find(e=>Bi.hasOwnProperty(e)):e}_getVideoQualityIndex(e,t){return"object"==typeof Bi[e]?Bi[e][t]:Bi[e]}_getNormalizedPeak(e,t){return"object"==typeof Bi[t]?1.5*e:1*e}_getMaxNormalizedPeak(e){let t=0;return e.forEach(e=>{let i=e.attrs;if(i){let e=i.BANDWIDTH||0,r=this._getNormalizedPeak(e,this._getVideoFourCC(i.CODECS)),s=Math.max(e,r);t=s>t?s:t}}),t}_getBitrateRank(e,t,i){const r=Math.max(1,this._getNormalizedPeak(e,t));return Math.ceil(100*r/i)}_getCurrentMediaTimeMilliSec(){return this.media&&this.media.currentTime?Math.round(1e3*this.media.currentTime):0}_isBadSw(e,t,i,r,s,a){let n=!1,o=s.lastSwitchTime||0,l=s.lastSwitchDir||e;return i-o<r&&l!==e&&s.lastLevelIsIframe===t&&!a&&(n=!0),n}},Un=class extends cs{constructor(e){super(e,r.b.MEDIA_ATTACHING,r.b.MEDIA_DETACHING,r.b.MANIFEST_LOADING,r.b.MANIFEST_LOADED,r.b.MANIFEST_PARSED,r.b.LEVEL_LOADED,r.b.LEVELS_CHANGED,r.b.FRAG_LOADING,r.b.FRAG_LOADED,r.b.FRAG_BUFFERED,r.b.SEEKING,r.b.SEEKED,r.b.STALLED,r.b.RESUME_FROM_STALL,r.b.DESIRED_RATE_CHANGED,r.b.KEY_LOADED,r.b.LEVEL_SWITCHED,r.b.KEY_REQUEST_STARTED,r.b.ITEM_TRANSITIONED,r.b.BUFFER_APPENDING,r.b.BUFFER_APPENDED,r.b.ERROR,r.b.INTERNAL_ERROR),this.enablePerformanceLogging=this.hls.config.enablePerformanceLogging,this.enableRtcReporting=this.hls.config.enableRtcReporting,this.firstInstance=!0,this.rtcAggregatorGroup={playingAggregator:void 0,loadingAggregator:void 0},this.media=null}destroy(){this._removeMediaEventListeners(this.media),cs.prototype.destroy.call(this)}get accessLog(){let e=this._getAggregator();return e?e.accessLog:[]}get errorLog(){let e=this._getAggregator();return e?e.errorLog:[]}getFirstInstance(){return this.firstInstance}setAppData(e){this.appData=e}setRate(e){this.desiredRate=e,this._getAggregator()&&this._logAndReport("Set desired rate to: "+e,Ut,{rate:e})}onDesiredRateChanged(e){this.setRate(e.newRate),0===e.newRate&&(this._logAndReport("[QE Critical] [PlayerState]Paused/rate=0",$t),this._logAndReport("[QE Critical] [PlayerEvent]Paused"))}onItemTransitioned(e){this._logAndReport("Variant end for itemId: "+e.prevItemId,Jt),this._logAndReport(null,Ut,{rate:0}),this._logAndReport("[QE Critical] Play ended for itemId "+e.prevItemId,Gt),this.logger.info("Destroying RTC Aggregator, itemId: "+this.rtcAggregatorGroup.playingAggregator.currentItemId)(),this.rtcAggregatorGroup.playingAggregator.destroy(),this.firstInstance&&(this.firstInstance=!1),this.rtcAggregatorGroup.playingAggregator=this.rtcAggregatorGroup.loadingAggregator,this.rtcAggregatorGroup.loadingAggregator=void 0,this.setRate(this.hls.streamController.desiredRate),this._logAndReport("[QE Critical] [PlayerEvent]CanPlay",Bt),this._logAndReport("[QE Critical] [PlayerState]Playing/rate="+this.desiredRate,Vt,{latency:0})}onMediaAttaching(e){this.media=e.media,this._addMediaEventListeners(this.media),this._getAggregator()&&this._getAggregator().setMedia(this.media)}onMediaDetaching(){let e=this.frag?this.frag.level:void 0;this._logAndReport("Variant end for level: "+e,Jt),this._logAndReport(null,Ut,{rate:0}),this._logAndReport("[QE Critical] Play ended",Gt),this._removeMediaEventListeners(this.media),clearInterval(this.timer),this._getAggregator()&&this._getAggregator().destroy()}onFragLoading(){this._logAndReport(null,Xt)}onFragLoaded(e){if(e&&e.frag){let t={fragType:e.frag.type,adt:e.stats.tload-e.stats.trequest,processTime:e.stats.tdataack-e.stats.tload,bytes:e.stats.total,duration:e.frag.duration||0,startPTS:e.frag.start,endPTS:e.frag.start+e.frag.duration,contentType:e.stats.contentType,cdnServer:e.stats.cdnServer,serverInfo:e.serverInfo};this._logAndReport(null,Qt,t)}}onFragBuffered(e){if(e&&e.frag){let t=e.stats,i={fragType:e.frag.type,adt:t.tload-t.trequest,processTime:t.tdataack-t.tload,parseTime:t.tparsed-t.tparseStart,bytes:t.total};this._logAndReport(null,Yt,i)}}onKeyLoaded(e){"AES-128"===e.decryptdata.method&&this._logAndReport(null,Zt,{adt:e.stats.tload-e.stats.trequest,timestamp:e.timestamp})}onKeyRequestStarted(e){this._logAndReport(null,oi,e)}findCurLevelInfo(e){let t=this.hls.levelController.variantManager.getVariantInfo(e);return t||this.logger.warn(`Level ${e} is missing from variantManager`)(),t}onLevelSwitched(e){let t=this.level,i=this.level=e.level;t>=0&&this._logAndReport("Variant end for level: "+t,Jt);let r=this.findCurLevelInfo(i);if(r){let s=JSON.stringify(r,["bitrate","bandwidth","avgBandwidth","width","height"])+" "+JSON.stringify(r.attrs,["CODECS","FRAME-RATE"]);e.url=r.url,e.isSeeking=!!this.seekStart,this._logAndReport(`[QE Critical] Playing level switch from ${t} to ${i}. ${s}`,ri,e)}}onManifestLoading(){let e=void 0,t=void 0;if(this.hls.userInfo&&(this.enableRtcReporting=this.hls.userInfo.diagnosticsAndUsage||this.hls.userInfo.internalBuild),this.hls.config.enableRtcReporting&&!this.enableRtcReporting&&(this.enableRtcReporting=!0),this.hls.playingItem.itemId===this.hls.loadingItem.itemId){let i=this.hls.playingItem.appData;this.rtcAggregatorGroup.playingAggregator=new Bn(this.hls,this.enableRtcReporting,this.hls.config,i),this.rtcAggregatorGroup.playingAggregator.currentItemId=this.hls.playingItem.itemId,e=this.hls.playingItem.itemId,t=i&&i.reportingAgent?i.reportingAgent.SessionID:void 0}else{let i=this.hls.loadingItem.appData;this.rtcAggregatorGroup.loadingAggregator=new Bn(this.hls,this.enableRtcReporting,this.hls.config,i),this.rtcAggregatorGroup.loadingAggregator.currentItemId=this.hls.loadingItem.itemId,e=this.hls.loadingItem.itemId,t=i&&i.reportingAgent?i.reportingAgent.SessionID:void 0}let i=this._getAggregator();if(i&&(this.media&&!i.getMedia()&&i.setMedia(this.media),this.desiredRate&&!i.getDesiredRate())){let e=this.desiredRate;this._logAndReport("Set desired rate to: "+e,Ut,{rate:e})}this.logger.info(`[QE Critical] isGapless: ${this.hls.inGaplessMode}, isFirstItem: ${this.hls.isFirstItem}, SessionID: ${t}, sub itemID: ${e}`)()}onManifestLoaded(e){this._logAndReport(null,zt,{adt:e.stats.tload-e.stats.trequest,contentType:e.stats.contentType})}onManifestParsed(e){this._logAndReport(null,qt,e)}onLevelLoaded(e){let t={url:e.details.url,targetduration:e.details.targetduration,adt:e.stats.tload-e.stats.trequest,contentType:e.stats.contentType,playlistType:e.playlistType};this._logAndReport(null,ei,t)}onLevelsChanged(e){const t=`[QE Critical] levels changed, ${e.levels.length} valid levels found, levels ${Fs(e.levels)}`;this._logAndReport(t,ii,{levels:e.levels})}onBufferAppending(e){let t=e.frag.level+"-"+e.frag.sn;this.bufferEventDict||(this.bufferEventDict={}),this.bufferEventDict[t]={timeStamp:Date.now(),size:e.byteLength,startPTS:e.startPTS,endPTS:e.endPTS}}onBufferAppended(e){if(!e.frag)return;let t=Date.now(),i=e.frag.level+"-"+e.frag.sn,r=this.bufferEventDict[i],s=t-r.timeStamp;this.seekStart&&this.seekToPos>=r.startPTS&&this.seekToPos<=r.endPTS&&(this.seekStart=t);let a=this.hls.media;a&&Oa.isBuffered(a,a.currentTime)&&(this.playStart=t),delete this.bufferEventDict[i],this._logAndReport(null,jt,{latency:s,size:r.size})}onError(e){return this.onInternalError(e)}onSeeking(e){this.seekStart=Date.now(),this.seekToPos=e.seekToPos,this._logAndReport("[QE Critical] [PlayerEvent]Seeking to pos"+e.seekToPos)}onSeeked(){let e=Date.now()-this.seekStart;this.seekStart=null,this.seekToPos=null,this._logAndReport("[QE Critical] [PlayerEvent]Seeked",Wt,{latency:e})}onStalled(e){e.type===Ga.b.LowBuffer||e.type===Ga.b.Seek&&e.isLowBufferStall?this._logAndReport("[QE Critical] Buffer stalled due to insufficient data",si,e):this._logAndReport("Stalled due to high buffer (media engine)",ai,e),this.isStalled=!0}onResumeFromStall(){this.isStalled&&(this._logAndReport("[QE Critical] [PlayerState]Playing/rate="+this.desiredRate,0===this.desiredRate?$t:Vt,{latency:0}),this.isStalled=!1)}onInternalError(e){if(e){let t={details:e.details,fatal:e.fatal,isSeeking:!!this.seekStart};e instanceof s.s&&!e.fatal?(t.failedSwitchUrl=e.url,this._logAndReport(null,ti,t)):e.type===s.g.NETWORK_ERROR?(t.reason=e.response?e.response.code:void 0,t.stallType=e instanceof s.c?e.stallType:void 0,this._logAndReport("Network Error",ni,t)):(t.reason=e.response?e.response.code:void 0,t.stallType=e instanceof s.c?e.stallType:void 0,this._logAndReport("Media Error",Ht,t))}}notifyKeySessionEvent(e,t){switch(t.timestamp=Date.now(),e){case li:this._logAndReport(null,li,t);break;case di:this._logAndReport(null,di,t);break;case hi:this._logAndReport(null,hi,t),this._logAndReport(null,ci,t);break;case fi:this._logAndReport(null,ui,t),this._logAndReport(null,fi,t);break;case gi:this._logAndReport(null,gi,t);break;case pi:this._logAndReport(null,pi,t);break;case mi:this._logAndReport(null,mi,t);break;case yi:this._logAndReport(null,yi,t)}}_getAggregator(){if(void 0!==this.hls.playingItem&&void 0!==this.hls.loadingItem)return this.hls.playingItem.itemId!==this.hls.loadingItem.itemId?this.rtcAggregatorGroup.loadingAggregator:this.rtcAggregatorGroup.playingAggregator}_timeRangeToArray(e){let t=[];for(let i=0;i<e.length;i++)t.push([e.start(i),e.end(i)]);return t}_isWebkitMediaElement(e){return"webkitDroppedFrameCount"in e}_isHtmlVideoElement(e){return"getVideoPlaybackQuality"in e}_videoPlaybackInfo(){let e=this.hls.media;if(!e)return;let t,i,r={readyToPlay:e.readyState>=e.HAVE_FUTURE_DATA,playbackLikelyToKeepUp:this.hls.playbackLikelyToKeepUp,rate:e.playbackRate,paused:e.paused,position:e.currentTime,duration:e.duration,seekableTimeRanges:this._timeRangeToArray(e.seekable),loadedTimeRanges:this._timeRangeToArray(e.buffered)};if(this._isHtmlVideoElement(e)){let s=e.getVideoPlaybackQuality;if(s&&typeof s==typeof Function){let s=e.getVideoPlaybackQuality();t=r.droppedVideoFrames=s.droppedVideoFrames,r.corruptedVideoFrames=s.corruptedVideoFrames,r.totalVideoFrames=s.totalVideoFrames,i=r.totalVideoFrames-t}}else this._isWebkitMediaElement(e)&&(t=r.droppedVideoFrames=e.webkitDroppedFrameCount,i=r.decodedFrameCount=e.webkitDecodedFrameCount);this._logAndReport("[QE Critical] hls player: "+JSON.stringify(r),Kt,{droppedVideoFrames:t,decodedFrameCount:i})}_addMediaEventListeners(e){e&&(this.onloadstart=this._onloadstart.bind(this),this.onplay=this._onplay.bind(this),this.onplaying=this._onplaying.bind(this),e.addEventListener("loadstart",this.onloadstart),e.addEventListener("play",this.onplay),e.addEventListener("playing",this.onplaying))}_removeMediaEventListeners(e){e&&(e.removeEventListener("loadstart",this.onloadstart),e.removeEventListener("play",this.onplay),e.removeEventListener("playing",this.onplaying))}_onloadstart(){this.timer&&clearInterval(this.timer),this.timer=setInterval(this._videoPlaybackInfo.bind(this),1e3),this._logAndReport("[QE Critical] [PlayerEvent]LoadStart")}_onplay(){this._logAndReport("[QE Critical] [PlayerEvent]Play"),this.playStart=Date.now()}_onplaying(){if(this.timer||(this.timer=setInterval(this._videoPlaybackInfo.bind(this),1e3)),this.desiredRate||this.setRate(this.hls.streamController.desiredRate),!this.isStalled){let e=Date.now()-this.playStart;this._logAndReport("[QE Critical] [PlayerEvent]CanPlay",Bt),this._logAndReport("[QE Critical] [PlayerState]Playing/rate="+this.desiredRate,Vt,{latency:e}),this.playStart=null,this.logger.info("[QE Critical] [PlayerEvent]Playing, sessionID: "+this.hls.sessionID+"-"+this.hls.playingItem.itemId)()}}_logAndReport(e,t,i){this.enablePerformanceLogging&&e&&this.logger.info(e)(),this._getAggregator()&&t&&this._getAggregator().notify(t,i)}};!(function(e){e.LowBandwidth="LowBandwidth",e.HighBandwidth="HighBandwidth"})(Fn||(Fn={}));class $n extends x{constructor(e){super(),this.hls=e,this._fragDownloadSlow=!1,this._fragDownloadTooSlow=!1,this._levelDownloadSlow=!1,this._highBWTrigger=Number.POSITIVE_INFINITY,this._shouldSwitchLevel=!1,this.maxBufferSize=Number.POSITIVE_INFINITY,this.logger=e.logger,this._nextMaxAutoLevel=-1,this.shortTermBandwidthFactor=1.8,this.hls=e,this.flowMeasurementPeriodMS=2e3,this.underflowAllowanceMS=1e3,this.numBandwidthSamples=0,this.minItemsInBandwidthAverage=4,this.minTargetDurations=e.config&&e.config.minTargetDurations||1,"bandwidth-history-controller"!==this.hls.config.abrBandwidthEstimator&&this.logger.warn(`Unsupported configuration: ${this.hls.config.abrBandwidthEstimator} for ABR bandwidth estimator`)(),this.maxBufStarvationSec=this.hls.config.maxStarvationDelay,this.bwUpFactor=this.hls.config.abrBandWidthUpFactor,this.bwFactor=this.hls.config.abrBandWidthFactor}destroy(){}_subscribe(e){let t=Ze(this.hls);function i(e){return"main"===e.type&&"initSegment"!==e.sn}return e.add(Ge(t.event(r.a.LEVELS_CHANGED,this.onLevelsChanged.bind(this)),t.event(r.a.LEVEL_SWITCHING,this.onLevelSwitching.bind(this)),t.event(r.a.BUFFER_CREATED,this.onBufferCreated.bind(this)),t.event(r.a.FRAG_LOADING).pipe(Ee(e=>i(e.frag)),Ie(e=>(this.setShouldSwitchLevel(!1,"Loading fragment"),this.monitorFragmentLoad(e.frag)))),t.event(r.a.FRAG_LOADED).pipe(Ee(e=>i(e.frag)),We(e=>{this.onFragLoaded(e)})),t.event(r.a.FRAG_BUFFERED,this.onFragBuffered.bind(this)),t.event(r.a.BUFFER_CHANGED,this.onBufferChanged.bind(this)),t.event(r.a.DESIRED_RATE_CHANGED,this.onDesiredRateChanged.bind(this)),t.event(r.a.INTERNAL_ERROR,this.onInternalError.bind(this))).subscribe()),super._subscribe(e)}monitorFragmentLoad(e){this.fragCurrent=e;let t=Ze(this.hls);return Ge(X(0,100).pipe(Ie(()=>(this._abandonRulesCheck(),ie))),t.event(r.a.FRAG_LOAD_PROGRESS).pipe(Ee(t=>t.frag.fragTag===e.fragTag),Ie(e=>(this.onFragLoadProgress(e),ie)))).pipe(Xe(Ji(t.event(r.a.FRAG_LOADED).pipe(Ee(t=>t.frag.equals(e))),t.event(r.a.FRAG_LOAD_EMERGENCY_ABORTED),t.event(r.a.INTERNAL_ERROR).pipe(Ee(t=>t instanceof s.m&&t.frag.equals(e))))),Se(e=>(this.logger.warn("[abr] monitorFragmentLoad aborted due to error:"+e.message)(),ie)),dt(()=>{}))}getMaxStarvationDelaySec(e){return Object(ke.c)(e)?Math.min(e,this.maxBufStarvationSec):this.maxBufStarvationSec}_abandonRulesCheck(){var e,t,i;let a=this.hls,n=a.media,o=this.fragCurrent,l=o.loader,d=a.iframeMode,h=a.levelWithPersistentId(o.level),c=null==h?void 0:h.levelInfo;if(!l)throw new Error(`[${o.type}] loader of frag ${o.sn} level ${o.level} destroy or aborted`);if(!c)throw new Error(`[${o.type}] while loading frag ${o.sn}, level ${o.level} is moved to penalty box`);if(!c)throw new Error(`[${o.type}] level in penalty box`);let u=l.stats,f=h.levelListPosition;if(!n||(n.paused||0===n.playbackRate)&&n.readyState||!o.autoLevel||0===f)return;const g=performance.now();let p=g-u.trequest,m=Math.abs(n.playbackRate),y=this.getMaxStarvationDelaySec(o.duration);if(p<Math.min(1e3*y,500*o.duration/m))return;let v=Math.max(1,1e3*u.loaded/p),b=c.realBitrate?Math.max(c.realBitrate,c.bitrate):c.bitrate,S=((u.total?u.total:Math.max(u.loaded,Math.round(o.duration*b/8)))-u.loaded)/v;const T=this._bufferedDuration;let E;if(Object(ke.c)(T)&&T>0)E=T;else{let e=p/1e3;E=e<E?y-e:y}let _=2*((null===(e=c.details)||void 0===e?void 0:e.targetduration)||o.duration);if(!(E>0&&E<=_&&(S>=E||this.fragDownloadSlow)))return;this.fragDownloadSlow=!0;let D=!1,I=NaN;const w=a.levels.filter(e=>e.iframes===d),R=Math.min(w.length-1,f-1),A=8*v;let k=this.getAllStats(),C=Object.assign({},k,{avgBandwidth:A}),L=this._findBestLevel(c,o.duration,C,0,R,E,1,1,w,d);if(-1!==L.levelId||S>=E&&-1!==(null===(t=L=this._findBestLevel(c,o.duration,C,0,R,S,1,1,w,d))||void 0===t?void 0:t.levelId)?(D=!0,I=L.levelId):-1!==(null===(i=L=this._findBestLevel(c,o.duration,k,0,R,S,1,1,w,d))||void 0===i?void 0:i.levelId)&&(I=L.levelId),Object(ke.c)(I)&&(this.logger.info(`[abr] capping level to ${I} because likelyToStall`)(),this.nextMaxAutoLevel=I),D)throw this.logger.warn("[abr] loading too slow, abort fragment loading and switch to level "+I)(),this._sampleBandwidth(Object.assign({},u,{tfirst:u.tfirst||g,tload:u.tload||g,tparsed:void 0,tparseStart:void 0})),this.fragDownloadTooSlow=!0,this.setShouldSwitchLevel(!0,"Loading aborted"),a.trigger(r.a.FRAG_LOAD_EMERGENCY_ABORTED,{frag:o,stats:u}),new s.a("Emergency aborting fragment")}_fragResponseIsValid(e){let t=this.hls,i=!0;if(!t.levelWithPersistentId(e).levelInfo){let a=new s.h(s.g.OTHER_ERROR,s.d.INTERNAL_EXCEPTION,!1,"empty level info for level "+e);a.response=s.f.InternalError,a.url=t.url,t.trigger(r.a.INTERNAL_ERROR,a),i=!1}return i}onBufferCreated(e){this._sampleFrag({duration:void 0,parseTimeMs:void 0,bufferCreationDelayMs:e.mediaSourceCreateMs+e.sourceBufferCreateMs,bufferTimeMs:void 0})}onFragLoadProgress(e){let t=e.frag,i=e.stats;if(0!==i.loaded){if(!this._fragResponseIsValid(t.level))return;let e=this.hls.levelWithPersistentId(t.level).levelInfo,r=e.realBitrate?Math.max(e.realBitrate,e.bitrate):e.bitrate,s=i.total?i.total:Math.max(i.loaded,Math.round(t.duration*r/8)),a=performance.now()-i.tfirst,n=i.loaded*t.duration*1e3/s;a>=this.flowMeasurementPeriodMS&&a-n>=this.underflowAllowanceMS&&(this.fragDownloadSlow=!0),a>=1e3*t.duration&&(this.logger.warn(`[abr][${t.type}] too much time spent downloading fragment, likely to switch down ${a} > ${1e3*t.duration}`)(),this.fragDownloadTooSlow=!0)}}onFragLoaded(e){let t=e.frag;if(this._fragResponseIsValid(t.level)){if(this.nextMaxAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){const i=this.hls.levelWithPersistentId(t.level).levelInfo;let r=(i.loaded?i.loaded.bytes:0)+e.stats.loaded,s=(i.loaded?i.loaded.duration:0)+e.frag.duration;i.loaded={bytes:r,duration:s},i.realBitrate=Math.round(8*r/s)}if(e.frag.bitrateTest){let i=Object.assign(Object.assign({},e.stats),{tparseStart:e.stats.tload,tparsed:e.stats.tload,tappendStart:e.stats.tload,tbuffered:e.stats.tload});this.onFragBuffered({frag:t,stats:i})}}}onFragBuffered(e){var t=e.stats,i=e.frag;if(!(t.cached||"initSegment"===i.sn||i.bitrateTest&&t.tload!==t.tbuffered)){let e=t.tparsed-t.trequest,r=t.tload-t.trequest,s=t.tdataack-t.tload;if(this.logger.info(`[QE Critical] [${i.type}]latency/loading/dataack/parsing/append:${Math.round(t.tfirst-t.trequest)}/${Math.round(t.tload-t.tfirst)}/${Math.round(s)}/${Math.round(t.tparsed-t.tparseStart)}/${Math.round(t.tbuffered-t.tappendStart)}`)(),this.logger.info(`[QE Critical] [${i.type}]fragLoadingProcessingMs/stats.loaded/viddur/fragLoadMs: ${e}/${t.loaded}/${i.duration}/${r}`)(),"main"===i.type&&(this.fragDownloadSlow=!1),("main"===i.type||"audio"===i.type)&&!i.iframe&&Object(ke.c)(e)){this._sampleBandwidth(t),this._sampleFrag({duration:i.duration,parseTimeMs:t.tparsed-t.tparseStart,bufferCreationDelayMs:0,bufferTimeMs:t.tbuffered-t.tappendStart});const s=this.getAvgBandwidthEstimate();this.logger.info(`[abr][${i.type}]fragNetworkDownloadKbps/fragDownloadKbps/bwEstimateKbps: ${Math.round(8*t.loaded/r)}/${Math.round(8*t.loaded/e)}/${Math.round(s/1e3)}`)(),i.bitrateTest?this.bitrateTestDelay=e/1e3:this.bitrateTestDelay=0;let a=this.bwUpFactor,n=this.getAdjustedBW(this.getAvgBandwidthEstimate(),a,this.bwFactor);"main"===i.type&&n.bwUp>this.highBWTrigger&&this.onBandwidthChanged(Fn.HighBandwidth)}}}set fragDownloadSlow(e){this._fragDownloadSlow!==e&&(this._fragDownloadSlow=e,e&&this.onBandwidthChanged(Fn.LowBandwidth))}get fragDownloadSlow(){return this._fragDownloadSlow}set fragDownloadTooSlow(e){this._fragDownloadTooSlow!==e&&(this._fragDownloadTooSlow=e,e&&this.onBandwidthChanged(Fn.LowBandwidth))}get fragDownloadTooSlow(){return this._fragDownloadTooSlow}set levelDownloadSlow(e){this._levelDownloadSlow!==e&&(this._levelDownloadSlow=e,e&&this.onBandwidthChanged(Fn.LowBandwidth))}get levelDownloadSlow(){return this._levelDownloadSlow}get _gotSlowMedia(){return this.levelDownloadSlow||this.fragDownloadTooSlow}onBandwidthChanged(e){this.logger.info(`bandwidth note ${e} ${Math.round(this.getAvgBandwidthEstimate())/1e3}kbps`)(),this._gotSlowMedia||!this.hls.seeking&&!this.hls.waitingForIncompatibleCCFragLoad?this.setShouldSwitchLevel(!0,e):this.logger.warn(`[abr] Could be ignoring bandwidth change seeking=${this.hls.seeking} incompatibleCC ${this.hls.waitingForIncompatibleCCFragLoad}`)(),this.hls.trigger(r.a.BANDWIDTH_CHANGED,{reason:e})}onLevelsChanged(){this.hls.streamController&&(this.hls.levelWithPersistentId(this.hls.streamController.currentVariantId).levelInfo||this.setShouldSwitchLevel(!0,`Current level ${this.hls.streamController.currentVariantId} in penalty box`),this.highBWTrigger=this._getLowestSuperiorBW(this.hls.streamController.currentVariantId))}onLevelSwitching(e){this.setShouldSwitchLevel(!1,"Level switching"),this.fragDownloadTooSlow=!1,this.fragDownloadSlow=!1,this.levelDownloadSlow=!1,this.highBWTrigger=this._getLowestSuperiorBW(e.persistentId)}onInternalError(e){switch(e.details){case s.d.FRAG_LOAD_TIMEOUT:this.fragDownloadTooSlow=!0;break;case s.d.LEVEL_LOAD_TIMEOUT:this.levelDownloadSlow=!0}}minSwitchBufferAheadSec(e,t){var i;if(-1!==this._nextMaxAutoLevel&&!this.hasReliableBandwidthEstimate())return Number.POSITIVE_INFINITY;let r=t.bitrate>e.bitrate,{fetchDuration:s}=this.getLevelInfoMetrics(t,r,this.getAllStats(),this.bwUpFactor,this.bwFactor,(null===(i=this.fragCurrent)||void 0===i?void 0:i.duration)||0,this.maxBufferSize);return s}get nextAutoLevel(){let e=this.nextMaxAutoLevel;return this.hls.levelController.variantManager.getVariantInfoIfValid(e)||(this.nextMaxAutoLevel=e=-1),-1===e||this.hasReliableBandwidthEstimate()?this._nextABRAutoLevel:e}get _bufferedDuration(){var e=this.hls;const t=e.media,i=t?t.currentTime:0,r=t&&0!==t.playbackRate?Math.abs(t.playbackRate):1;return(Na.bufferInfo(t,i,e.config.maxBufferHole).end-i)/r}findNextABRAutoLevelInMode(e){const t=this.hls.levelController.variantManager,i=t.validVariantList.filter(t=>t.iframes===e);let r=i.length-1,s=this.nextMaxAutoLevel;if(-1!==s){let e=i.findIndex(e=>e.persistentId===s);r=e>=0?e:r}let a=this.hls.config;const n=this.hls.streamController.currentVariantId,o=t.getVariantInfo(n),l=o?o.details:void 0,d=this.getAllStats(),h=this._bufferedDuration;let c,u,f,g=this.bwFactor,p=this.bwUpFactor;if(e){const e=this.hls.config.desiredIframeFPS;f=this.fragCurrent&&void 0!==this.fragCurrent.iframeMediaDuration?this.fragCurrent.iframeMediaDuration:l?l.targetduration/e:0,f=Math.max(1/e,f)}else f=this.fragCurrent&&void 0!==this.fragCurrent.duration?this.fragCurrent.duration:l?l.targetduration:0;if((u=(c=this._findBestLevel(o,f,d,0,r,h,g,p,i,e)).levelId)<0){let t=this.getMaxStarvationDelaySec(f);if(0===h){let e=this.bitrateTestDelay;e&&(t=(f?Math.min(f,a.maxLoadingDelay):a.maxLoadingDelay)-e,g=p=1)}u=-1===(c=this._findBestLevel(o,f,d,0,r,h+t,g,p,i,e)).levelId?i[0].persistentId:c.levelId}return u}_getLowestSuperiorBW(e){let t=1/0,i=this.hls.levelWithPersistentId(e),r=i.levelInfo;if(!r)return;let s=i.levelListPosition,a=r.frameRate,n=r.realBitrate?Math.max(r.realBitrate,r.bitrate):r.bitrate,o=this.hls.levels,l=o.length-1;for(let e=this.hls.config.abrMaxWithRealBitrate?0:Math.max(0,s+1);e<=l;++e){let i=o[e];if(i.iframes!==r.iframes||void 0!==a&&i.frameRate<a)continue;let s=i.realBitrate?Math.max(i.realBitrate,i.bitrate):i.bitrate;if(s>n&&(t=Math.min(s,t),!this.hls.config.abrMaxWithRealBitrate))break}return t}set highBWTrigger(e){this._highBWTrigger!==e&&(this._highBWTrigger=e)}get highBWTrigger(){return this._highBWTrigger}hasReliableBandwidthEstimate(){return!!this.hls.bandwidthHistoryController.getEstimate()}getAllStats(){return Object.assign({},this.getBandwidthStats(),this.hls.bandwidthHistoryController.getFragEstimate(),this.hls.bandwidthHistoryController.getPlaylistEstimate())}getBandwidthStats(){return this.hls.bandwidthHistoryController.getEstimate()||{avgBandwidth:this.hls.config.abrDefaultEstimate||this.hls.config.abrEwmaDefaultEstimate,avgLatencyMs:0}}getAvgBandwidthEstimate(){return this.getBandwidthStats().avgBandwidth}_sampleBandwidth(e){++this.numBandwidthSamples,this.hls.bandwidthHistoryController.sample(e)}_sampleFrag(e){this.hls.bandwidthHistoryController.sampleFrag(e)}getAdjustedBW(e,t,i){let r,s;return this.numBandwidthSamples>=this.minItemsInBandwidthAverage?(r=e*t,s=e*i):r=s=e/this.shortTermBandwidthFactor,{bwUp:r,bwDown:s}}onDesiredRateChanged(e){let{oldRate:t,newRate:i}=e;(0!==t&&1!==t)!=(0!==i&&1!==i)&&this.setShouldSwitchLevel(!0,"mode change")}onBufferChanged(e){this.hls.seeking||this.hls.waitingForIncompatibleCCFragLoad||e.reason!==on.LowWaterLevel||this.setShouldSwitchLevel(!0,e.reason)}setShouldSwitchLevel(e,t){e!==this._shouldSwitchLevel&&(this.logger.info(`[abr] shouldSwitchLevel: ${this._shouldSwitchLevel}->${e} reason:${t}`)(),this._shouldSwitchLevel=e)}get shouldSwitchLevel(){return this.hls.levelWithPersistentId(this.hls.streamController.currentVariantId).levelInfo||this.setShouldSwitchLevel(!0,"Current level not in variant list"),this._shouldSwitchLevel}get _nextABRAutoLevel(){let e,t=this.hls,i=t.iframeMode,r=t.config.minFramesBeforeSwitchingLevel,s=this.hls.streamController.currentVariantId;if(i){let s=t.countIframesInCurrentLevel();e=!t.levelWithPersistentId(s.level).levelInfo||s.loading+s.buffered===0||s.buffered>=r?this.findNextABRAutoLevelInMode(i):s.level}else this.logger.info("should switch level: "+this.shouldSwitchLevel)(),e=this.shouldSwitchLevel?this.findNextABRAutoLevelInMode(i):s;return this.logger.info(`[abr] nextABRAutoLevel ${s}->${e}`)(),e}getLevelInfoMetrics(e,t,i,r,s,a,n){const o=this.getAdjustedBW(i.avgBandwidth,r,s);let l=t?o.bwUp:o.bwDown,d=Math.max(e.realBitrate||0,e.bitrate),h=e.details,c=null!=h&&h.live,u=h?h.totalduration/h.fragments.length:a,f=d*u/l;!c||h&&h.PTSKnown&&!$n.likelyOutOfDate(h,i)||(f*=2);let g=e.bandwidth,p=l>d&&l<g&&this._bufferedDuration<=2*u,m=(g||d||0)*(h&&h.targetduration||u);return{adjustedbw:l,bitrate:d,fetchDuration:f,rejectLevelDueToPeakBW:p,canFitMultipleSegments:this.minTargetDurations*m/8<=n}}getInstantBw(){var e,t;return(null===(t=null===(e=this.hls.bandwidthHistoryController)||void 0===e?void 0:e.getLatestBw())||void 0===t?void 0:t.avgBandwidth)||NaN}instantBwTooSlow(e){let t=this.getInstantBw();return this.fragDownloadSlow||this.fragDownloadTooSlow||Object(ke.c)(t)&&t<e}_findBestLevel(e,t,i,r,s,a,n,o,l,d){if(!l.length)return{levelId:-1,holdOffDuration:-1};const h=e&&e.persistentId,c=null!=l.find(e=>e.persistentId===h),u=this.hls.preferredHostName,f=this.maxBufferSize,g=e?e.score:void 0,p=e?e.frameRate:void 0;s=Math.max(0,Math.min(l.length-1,s)),r=Math.max(0,Math.min(l.length-1,r));for(let m=s;m>=r;m--){let r=l[m],s=r.persistentId,y=r.score,v=r.details,b=v?v.totalduration/v.fragments.length:t,S=null!=e&&r.bitrate>e.bitrate,T=null!=e&&r.bitrate<e.bitrate,E=r.url,_=!E||ko.hasAllowedHost(E,u);if(!Object(ke.c)(b)||r.iframes!==d||!_)continue;if(void 0!==p&&(S&&r.frameRate<p||T&&r.frameRate>p))continue;if(S&&e&&e.height>r.height)continue;if(this.hls.hasScoreAvailable&&S&&(y<g||y===g&&r.bitrate>=e.bitrate))continue;let{adjustedbw:D,bitrate:I,fetchDuration:w,rejectLevelDueToPeakBW:R,canFitMultipleSegments:A}=this.getLevelInfoMetrics(r,S,i,o,n,t,f);if(D>I&&A&&!R&&(d||!w||w<a))return this.instantBwTooSlow(D)&&c&&this._bufferedDuration<=2*b&&S&&(this.logger.info(`[abr] Last fragment too slow, not switching up ${h}->${s}`)(),s=h),{levelId:s,holdOffDuration:w}}return{levelId:-1,holdOffDuration:-1}}set nextMaxAutoLevel(e){if(!Object(ke.c)(e)){try{throw Error("nextMaxAutoLevel set with non-finite value="+e)}catch(e){this.logger.warn(`${e.message} ${e.stack}`)()}this._nextMaxAutoLevel=-1}this._nextMaxAutoLevel=e}get nextMaxAutoLevel(){return this._nextMaxAutoLevel}static likelyOutOfDate(e,t){let i=t.maxPlaylistLoadTimeMs||t.avgLatencyMs;return performance.now()-e.trequest+i>e.totalduration}}var Vn=$n;class Gn extends x{constructor(e){super(),this.mediaElement=e,this.readyState$=new te("closed"),this.sbAdded$=new Z,this.sbUpdated$=new Z,this.tcreate=performance.now(),this.topen=NaN,this.mediaSource=new MediaSource}_subscribe(e){return e.add(this._attachToMedia().subscribe()),e.add(this.sbAdded$.pipe(fe(e=>Ge(e.pipe(dt(()=>{e.destroy(this.mediaSource.readyState),this.mediaSource.removeSourceBuffer(e.realSourceBuffer)})),e.onupdateend$.pipe(We(()=>this.sbUpdated$.next({which:e.parent})))))).subscribe()),e.add(()=>{this.objectUrl&&(URL.revokeObjectURL(this.objectUrl),this.mediaElement.src===this.objectUrl&&(this.mediaElement.removeAttribute("src"),this.mediaElement.load()),this.objectUrl=null)}),super._subscribe(e)}_attachToMedia(){let e=Ze(this.mediaSource);return Ge(Ge(e.event("sourceclose"),e.event("sourceopen"),e.event("sourceended")).pipe(Ie(()=>("open"===this.mediaSource.readyState&&(this.topen=performance.now()),this.readyState$.next(this.mediaSource.readyState),ie))),re(()=>(this.objectUrl=URL.createObjectURL(this.mediaSource),this.mediaElement.src=this.objectUrl,ie)))}get readyState(){return this.mediaSource.readyState}set duration(e){this.mediaSource.duration=e}get duration(){return this.mediaSource.duration}endOfStream(e){this.mediaSource.endOfStream(e)}createSourceBufferAdapter(e,t,i,r,s){const a=this.mediaSource.addSourceBuffer(t),n=new cn(e,a,i,r,s);return this.sbAdded$.next(n),n}}class Hn extends x{constructor(e){super(),this.defaultMaxBufferHole=e,this.mediaElement$=new te(null),this.msAdapter$=new te(null),this.sourceBufferMap=new Map,this.loadedMetadata$=new te(!1),this.logger=Ae.b}get mediaElement(){return this.mediaElement$.value}_subscribe(e){return e.add(this.mediaElement$.pipe(Ie(e=>{if(!e)return ie;this._checkIfLoadedMetadata();let t=Ze(e);return Ge(t.event("loadedmetadata"),t.event("canplay")).pipe(We(()=>this._checkIfLoadedMetadata()),dt(()=>this.setLoadedMetadata(!1)))})).subscribe()),e.add(_a([this.mediaElement$,this.msAdapter$]).pipe(Ie(([e,t])=>e&&t?Ge(t,t.sbUpdated$.pipe(We(()=>this._checkIfLoadedMetadata()))).pipe(dt(()=>{this.setLoadedMetadata(!1),this.sourceBufferMap.clear()})):ie)).subscribe()),super._subscribe(e)}setMediaElement(e){this.mediaElement$.next(e)}getCombinedWaterLevel(e=this.defaultMaxBufferHole){return Na.bufferInfo(this,this.currentTime,e).len}get mediaSource(){return this.msAdapter$.value}get hasMediaSource(){return null!=this.mediaSource}ensureMediaSource(){if(!this.mediaElement)return Be(new Error("No media element attached"));if(this.mediaSource)return ut(this.mediaSource.readyState$,e=>"open"===e).pipe(ae(()=>({tcreate:this.mediaSource.tcreate,topen:this.mediaSource.topen})));let e=new Gn(this.mediaElement);return this.msAdapter$.next(e),ut(e.readyState$,e=>"open"===e).pipe(W(1e4),ae(()=>({tcreate:e.tcreate,topen:e.topen})))}destroyMediaSource(){this.msAdapter$.next(null)}get hasMedia(){return Boolean(this.mediaElement)}get mediaSourceIsOpen(){var e;return"open"===(null===(e=this.mediaSource)||void 0===e?void 0:e.readyState)}get bufferIsUpdating(){let e=!1;for(let t of this.sourceBufferMap.values())e=e||t.updating;return e}get buffered(){var e,t;return null!==(t=null===(e=this.mediaElement)||void 0===e?void 0:e.buffered)&&void 0!==t?t:new TimeRanges}get currentTime(){var e,t;return null!==(t=null===(e=this.delicateOriginalMedia)||void 0===e?void 0:e.currentTime)&&void 0!==t?t:0}set currentTime(e){this.mediaElement&&(this.mediaElement.currentTime=e)}get duration(){var e,t;return null!==(t=null===(e=this.mediaSource)||void 0===e?void 0:e.duration)&&void 0!==t?t:0}set duration(e){this.mediaSource&&(this.mediaSource.duration=e)}setDuration(e){return this.mediaSource?(this.logger.info("duration set to "+e)(),this.mediaSource.duration=e,this.waitForDurationChange()):ct}waitForDurationChange(){let e=this.bufferIsUpdating;return Ui(()=>!e,ct,Ke(this.mediaElement,"durationchange")).pipe(ye(1),Ie(()=>ct))}get muted(){var e,t;return null!==(t=null===(e=this.mediaElement)||void 0===e?void 0:e.muted)&&void 0!==t&&t}set muted(e){this.mediaElement&&(this.mediaElement.muted=e)}get playbackRate(){var e,t;return null!==(t=null===(e=this.mediaElement)||void 0===e?void 0:e.playbackRate)&&void 0!==t?t:0}get paused(){var e,t;return null!==(t=null===(e=this.mediaElement)||void 0===e?void 0:e.paused)&&void 0!==t&&t}get readyState(){var e,t;return null!==(t=null===(e=this.mediaElement)||void 0===e?void 0:e.readyState)&&void 0!==t?t:0}get seekable(){var e,t;return null!==(t=null===(e=this.mediaElement)||void 0===e?void 0:e.seekable)&&void 0!==t?t:new TimeRanges}get seeking(){var e,t;return null!==(t=null===(e=this.mediaElement)||void 0===e?void 0:e.seeking)&&void 0!==t&&t}get controls(){var e,t;return null!==(t=null===(e=this.mediaElement)||void 0===e?void 0:e.controls)&&void 0!==t&&t}get ended(){var e,t;return null!==(t=null===(e=this.mediaElement)||void 0===e?void 0:e.ended)&&void 0!==t&&t}get error(){var e;return null===(e=this.mediaElement)||void 0===e?void 0:e.error}get haveEnoughData(){if(!this.hasMedia)return!1;const e=this.mediaElement;return e.readyState>=e.HAVE_ENOUGH_DATA}endOfStream(e){this.logger.info("mediaSource endofStreamed")(),this.mediaSource.endOfStream(e)}get delicateOriginalMedia(){return this.mediaElement}createSourceBufferAdapter(e,t,i,r){let s=this.mediaSource.createSourceBufferAdapter(e,t,i,r,this.defaultMaxBufferHole);return this.sourceBufferMap.set(e,s),s}_checkIfLoadedMetadata(){let e=this.loadedMetadata$.value;this.setLoadedMetadata(null!=this.mediaElement&&this.mediaElement.readyState>=this.mediaElement.HAVE_METADATA&&(e||this.buffered.length>0&&this.seekable.length>0))}setLoadedMetadata(e){this.loadedMetadata$.value!==e&&this.loadedMetadata$.next(e)}}function Kn(e){let t={};return e.forEach(e=>{let i={};i.frag=e.frag?{cc:e.frag.cc}:void 0,t[e.parent]=i}),JSON.stringify(t)}class jn extends x{constructor(e){super(),this.hls=e,this.resetting$=new te(!1),this.waitingForDisco$=new te(!1),this.mediaChange$=new Z,this.forceReset$=new Z,this._needsEos=!1,this.aboutToFlush$=new Z,this.sbContexts=new Map,this.sbWaitingContexts$=new te(new Map),this.logger=e.logger,this._msDuration=null,this._levelDuration=null,this.mediaAdapter=new Hn(e.config.maxBufferHole)}get hasMedia(){var e,t;return null!==(t=null===(e=this.mediaAdapter)||void 0===e?void 0:e.hasMedia)&&void 0!==t&&t}get mediaElement(){var e;return null===(e=this.mediaAdapter)||void 0===e?void 0:e.delicateOriginalMedia}get mediaState(){return{hasMedia:this.mediaAdapter.hasMedia,seeking:this.mediaAdapter.seeking,currentTime:this.mediaAdapter.currentTime,duration:this.mediaAdapter.duration}}get sourceBufferCount(){return this.sbContexts.size}getSourceBufferContext(e){var t;return null!==(t=this.sbContexts.get(e))&&void 0!==t?t:null}_subscribe(e){let t=Ze(this.hls,this);return e.add(Ge(t.event(r.a.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated),t.event(r.a.LEVEL_UPDATED,this.onLevelUpdated),t.event(r.a.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded)).subscribe()),e.add(this.mediaChange$.pipe(Ie(this._setMedia.bind(this))).subscribe()),e.add(this.mediaAdapter.subscribe()),super._subscribe(e)}get totalItemDuration(){return this._msDuration}onLevelPtsUpdated(e){if("audio"===e.type&&this.updateMp3Timestamps){let t=this.getSourceBufferContext("audio");if(t&&t.sourceBuffer){let i=t.sourceBuffer;if(Math.abs(i.timestampOffset-e.start)>.1){let t=i.updating;try{i.abort()}catch(e){t=!0,this.logger.warn("can not abort audio buffer: "+e)()}t?this.audioTimestampOffset=e.start:(this.logger.warn("change mpeg audio timestamp offset from "+i.timestampOffset+" to "+e.start)(),i.timestampOffset=e.start)}}}this.onLevelUpdated(e)}get expectedSbCount(){return this.hls.streamController.altAudio?2:1}_setMedia(e){if(this.mediaAdapter.setMediaElement(e),!e)return ie;let t=this.mediaAdapter.ensureMediaSource().pipe(Ie(()=>{this.logger.info("[buf] media source fully attaching (readyState === open) #disco")(),this.updateMediaElementDuration();const e={media:this.mediaAdapter.delicateOriginalMedia};return this.hls.trigger(r.a.MEDIA_ATTACHED,e),ie}),Se(e=>(this.logger.error("Error creating media source "+e.message)(),ie)));return Ge(Ta.pipe(dt(()=>{this.updateMp3Timestamps=!1,this.hls.trigger(r.a.MEDIA_DETACHED)})),t)}attachMedia(e,t=!1){this.logger.info("[buf] media source attaching #disco")(),this.mediaChange$.next(e)}detachMedia(){this.logger.info("media source detaching")(),this.mediaChange$.next(null)}resetLoadSource(){}isParentSourceBufferUpdating(e){return this.getSourceBufferContext(e).sourceBuffer.updating}isSourceBufferUpdating(){return this.mediaAdapter.bufferIsUpdating}get loadedMetadata$(){return this.mediaAdapter.loadedMetadata$}onSBUpdateEnd(e,t){if(this.audioTimestampOffset){let e=this.getSourceBufferContext("audio");if(e&&e.sourceBuffer){let t=e.sourceBuffer;this.logger.warn("change mpeg audio timestamp offset from "+t.timestampOffset+" to "+this.audioTimestampOffset)(),t.timestampOffset=this.audioTimestampOffset,delete this.audioTimestampOffset}}this._needsEos&&this.checkEos();let i={};this.sbContexts.forEach(e=>{if(e.sourceBuffer){const{track:t}=e;i[t.type]=e.sourceBuffer.buffered}});let s={parent:e,pending:0,timeRanges:i,frag:t?t.frag:void 0,tappendStart:t?t.tstart:void 0,tappendEnd:t?t.tend:void 0};this.hls.trigger(r.a.BUFFER_APPENDED,s),this.updateMediaElementDuration()}pickCodec(e,t){return void 0===(e=t&&"vp09"===e?t.substring(0,13):e||t)?"":e}pickHighestCodec(e,t){var i,r,s;let a=e||t;return ke.b.isVideoCodec(a)&&a.split(",").length<2&&(a=null!==(s=null===(r=null===(i=this.hls.levelController)||void 0===i?void 0:i.variantManager)||void 0===r?void 0:r.getHighestCodecByFamily(e))&&void 0!==s?s:e),void 0===a?"":a}appendBuffer(e,t,i,r,s,a,n,o,l=!1){let{level:d,sn:h,cc:c}=n,u={level:d,sn:h,cc:c,startPTS:i,endPTS:r};n.decryptdata&&(u.decryptdata={keyId:n.decryptdata.keyId});let f={type:e,data:t,startPTS:i,endPTS:r,parent:s,content:a,frag:u};return this._ensureInitSegmentAppend(s,e,u,o,l).pipe(Ie(()=>{let e=this.getSourceBufferContext(s);return e.sourceBuffer.waitForBufferUpdate().pipe(Ie(()=>this._appendBufferAsync(e,f,o)))}),ye(1),Xe(Ji(this.forceReset$,ut(this.aboutToFlush$,e=>e.parent===s&&!(e.start>=r||e.end<=i))).pipe(We(()=>this.logger.warn("[buf] append aborted")))),dt(()=>{this.logger.info("[buf] appendBuffer done")()}))}_ensureInitSegmentAppend(e,t,i,r,s){return this.resetting$.pipe(Ie(t=>t?ie:(this.logger.info("[buf] _ensureInitSegmentAppend isResetting$ acquired")(),this.waitForPendingDataCompatibility(e,i,r,s))),Ie(()=>{var s,a,n,o;const l=this.getSourceBufferContext(e);let{level:d,cc:h}=i,c=(null===(s=null==l?void 0:l.curInitSegment)||void 0===s?void 0:s.keyId)||new Uint8Array,u=(null===(a=i.decryptdata)||void 0===a?void 0:a.keyId)||new Uint8Array;if((null===(n=l.curInitSegment)||void 0===n?void 0:n.cc)!==i.cc||(null===(o=l.curInitSegment)||void 0===o?void 0:o.level)!==i.level||pt.b.utf8arrayToStr(c)!==pt.b.utf8arrayToStr(u)){let s=!1;return l.sourceBuffer.waitForBufferUpdate().pipe(Ie(()=>{let s=r.initSegment,a={type:t,data:s,startPTS:NaN,endPTS:NaN,parent:e,content:"initSegment",frag:{level:d,cc:h,sn:"initSegment",startPTS:NaN,endPTS:NaN,decryptdata:i.decryptdata}};return this._appendBufferAsync(l,a,r)}),ae(()=>{var e;s=!0,l.curInitSegment={level:d,cc:h,keyId:null===(e=i.decryptdata)||void 0===e?void 0:e.keyId}}),dt(()=>{s||(this.logger.warn(`[${e}] completed without appending init segment`)(),l.curInitSegment={level:-1,cc:-1,keyId:void 0})}))}return ct}),dt(()=>{this.logger.info("[buf] _ensureInitSegmentAppend isResetting$ finalized")()}))}isBuffered(e,t){var i;const r=null===(i=this.getSourceBufferContext(e))||void 0===i?void 0:i.sourceBuffer;return!!r&&null!=r.bufferedSegments.find(e=>{const i=e.frag;return i.level===t.level&&i.cc===t.cc&&i.sn===t.sn})}getEstimatedMaxBuffer(e){const t=this.getSourceBufferContext(e),i=null==t?void 0:t.sourceBuffer;return i?i.maxTotalBytes:Number.POSITIVE_INFINITY}endBuffer(e){this.logger.info(`ending ${e} buffer`)(),this.sbContexts.forEach((t,i)=>{if(!e||i===e){let e=t.sourceBuffer;e&&!e.ended&&(e.ended=!0,this.logger.info(i+" sourceBuffer now EOS")())}}),this.checkEos()}checkEos(){if(this.hasMedia){for(let[e,t]of this.sbContexts){let e=t.sourceBuffer;if(e){if(!e.ended)return;if(e.updating)return void(this._needsEos=!0)}}this.logger.info("all media data available, signal endOfStream() to MediaSource and stop loading fragment")();try{this.mediaAdapter.endOfStream()}catch(e){this.logger.warn("exception while calling mediaSource.endOfStream()")()}this._needsEos=!1}else this._needsEos=!1}flushBufferRange(e,t,i,s=!1,a=!0){return 0===this.sourceBufferCount?ct:(this.aboutToFlush$.next({parent:e,start:t,end:i,forceAll:s}),this.waitForBufferUpdate(e).pipe(Ie(()=>this._flushBufferAsync(e,t,i,s)),We(()=>{this.hls.trigger(r.a.BUFFER_FLUSHED,{seekAfterFlush:a})}),Xe(this.forceReset$)))}onLevelUpdated(e){let t=e.details;t&&0!==t.fragments.length&&(this._levelDuration=t.totalduration+t.fragments[0].start,this.updateMediaElementDuration())}onAudioTrackLoaded(e){this.onLevelUpdated(e)}updateMediaElementDuration(){let e=this.mediaAdapter,t=this._levelDuration;if(null===t||!this.hasMedia||!e.mediaSourceIsOpen)return;if(e.bufferIsUpdating)return void this.logger.warn("can't set duration whilst a buffer is updating")();let i=e.duration;if(null===this._msDuration||!isFinite(i)||t>this._msDuration&&t>i)try{e.duration=t,this._msDuration=t}catch(e){this.logger.error("Exception setting mediasource duration "+e.message)()}}updateDurationAfterEvictItem(e){return this.logger.info(`[gapless] media duration after EVICT_ITEM flush = ${e}, updating ${this.isSourceBufferUpdating()}`)(),this._msDuration=this._levelDuration=e,this.mediaAdapter.setDuration(e).pipe(Ie(()=>(this.logger.info(`[buf] durationchanged: ${this.mediaAdapter.duration} needsEos ${this._needsEos}, updating ${this.isSourceBufferUpdating()}`)(),this._needsEos&&this.checkEos(),$e(e))))}checkPendingCompatibility(e,t){const i=this.sbContexts;let r=this.sbContexts.size===this.expectedSbCount;if(!r)return r;for(let[t,s]of e)if(i.has(t)){const e=i.get(t);let a=ke.b.isCompatibleCodecString(e.track.codec,s.track.codec);a||(r=r&&a)}return r}static calculateRange(e){let t=-1,i=Number.MAX_SAFE_INTEGER,r=-1;for(let s of e.values())s.frag&&(s.frag.startPTS>t&&(t=s.frag.startPTS,r=s.frag.cc),s.frag.endPTS<i&&(i=s.frag.endPTS));return{cc:r,startPTS:t,endPTS:i}}checkReset(){}supportsVideoPlayback(){var e;let t=null===(e=this.getSourceBufferContext("main"))||void 0===e?void 0:e.track.type;return"video"===t||"audiovideo"===t}checkGaplessCompatibility(e,t){let i=!0;return this.hls.isPreloadingItem&&(ke.b.isVideoCodec(t.codec)?(this.logger.warn("[gapless] detected video playlist")(),i=!1):this.supportsVideoPlayback()&&"main"===e&&"audio"===t.type&&(this.logger.warn("[gapless] detected audio-only playlist after a video playlist")(),i=!1)),i}get isResetting(){return this.resetting$.value}doReset(e,t){return this.isResetting||(this.logger.info(`[buf] resetting media source waiting=${Kn(t)} #disco`)(),this.logger.info("[buf] resetting media source LOCK #disco")(),this.resetting$.next(!0),this._resetSourceBuffers(),this.initializeSourceBuffers(t).pipe(ae(t=>{this.sbContexts=t;let i={ccLoadInfo:e,sbContexts:this.sbContexts};return this.updateMediaElementDuration(),this.logger.info(`[buf] resetting media source UNLOCK ccLoadInfo ${JSON.stringify(e)} #disco`)(),e?this.hls.streamController.seek(e.seekToPos):this.logger.warn("[buf] no seekToPos for new cc")(),i}),We(t=>{this.logger.info(`[buf] reset complete ccLoadInfo ${JSON.stringify(e)} sbCtx:${Kn(this.sbContexts)} #disco`)()}),dt(()=>{this.logger.info("[buf] doReset finalized")(),this.resetting$.next(!1)}),Xe(this.mediaChange$)).subscribe()),ut(this.resetting$,e=>!e).pipe(ae(()=>{}))}waitToResetSourceBuffers(e,t,i,r){return this.waitingForDisco$.next(!0),ut(Ge(e,Ge(Ke(this.mediaElement,"seeking"),Ke(this.mediaElement,"timeupdate")).pipe(ae(e=>this.mediaAdapter.currentTime))),e=>e>=t.startPTS-i&&e<=t.endPTS).pipe(Ie(e=>{let i=t.startPTS;this.logger.info("[QE Critical] checkDiscontinuityState seeking, seekToPos: "+i.toFixed(3))();const s={cc:t.cc,seekToPos:i};return this.doReset(s,r)}),dt(()=>{this.logger.info("[buf] waitToResetSourceBuffers finalized")(),this.waitingForDisco$.next(!1)}))}updateSourceBuffers(e,t,i){if(0===this.sbContexts.size)return this.logger.info(`[buf][${t}] uninitialized, creating source buffers #disco`)(),this.doReset(null,e);{let r=this.checkPendingCompatibility(e,t);if(this.sourceBufferCount>0&&r&&this.hls.config.alwaysResetOnNewCC){const i=this.sbContexts.get("main").frag,s=e.get("main").frag;r=s&&i.cc===s.cc,this.logger.error(`[buf][${t}]  overriding exiting compatible`)()}if(this.logger.info(`[buf][${t}]  existing buffers compatible=${r} #disco`)(),r){for(let[t,i]of e)this.sbContexts.get(t).allowedCCs.add(i.frag.cc);return ct}if(i){const i=jn.calculateRange(e);let r=this.mediaAdapter.currentTime,s=new Map;e.forEach((e,t)=>{s.set(t,Object.assign({},e))}),this.logger.info(`[buf][${t}] immediate reset seekToPos: ${r.toFixed(3)} ${Kn(s)}`)();const a={cc:i.cc,seekToPos:r};return this.doReset(a,s)}{const i=jn.calculateRange(e),r=this.hls.config.discontinuitySeekTolerance;let s=$e(this.mediaAdapter.currentTime);this.hls.seeking&&(this.logger.warn(`[buf][${t}] override currentTime with seekInfoObs #disco`)(),s=this.hls.seekInfoObs.pipe(ae(e=>e?e.seekToPos:this.mediaAdapter.currentTime)));let a=new Map;return e.forEach((e,t)=>{a.set(t,Object.assign({},e))}),s.pipe(Ie(e=>(this.logger.info(`[buf][${t}] wait for incompat disco, seeking ${this.mediaAdapter.seeking}, currentTime ${e}, waitingRange ${JSON.stringify(i)} #disco`)(),this.waitToResetSourceBuffers(s,i,r,a))))}}}findMatchingOtherFragInSameCC(e,t,i){var r;let s="main"===t?"audio":"main",a=this.sbContexts.get(s),n=null==a?void 0:a.sourceBuffer.bufferedSegments,o=null===(r=null==n?void 0:n.find(e=>!(e.endPTS<=i.startPTS||e.startPTS>=i.endPTS)&&i.cc===e.frag.cc))||void 0===r?void 0:r.frag;return o||(null===(a=e.get(s))||void 0===a?void 0:a.frag.cc)===i.cc&&(o=a.frag),o?Object.assign(Object.assign({},a),{frag:o}):null}waitForPendingDataCompatibility(e,t,i,r=!1){const a=this.sbWaitingContexts$.value,n={parent:e,frag:t,track:i,levelCodec:null,sourceBuffer:null,allowedCCs:new Set([t.cc])};let o;a.set(e,n);let l=new Map;const d=Object.assign({},n);if(l.set(e,d),this.logger.info(`[buf][${e}] waitForPendingDataCompatibility sbWaitingMap ${Kn(a)} futureSbMap ${Kn(l)}`)(),this.sbWaitingContexts$.next(a),1===this.expectedSbCount&&"main"===e)o=$e(l);else{if(1===this.expectedSbCount&&"audio"===e)return Be(()=>new s.h(s.g.OTHER_ERROR,s.d.INTERNAL_EXCEPTION,!1,"Unexpected audio when sbCount === 1"));o=this.sbWaitingContexts$.pipe(Ie(i=>{let r="main"===e?"audio":"main",s=this.findMatchingOtherFragInSameCC(i,e,t);return s?(l.set(r,s),$e(l)):ie}))}let h=!1;return o.pipe(ye(1),Ie(t=>this.updateSourceBuffers(t,e,r)),We(()=>{h=!0}),Xe(this.forceReset$),dt(()=>{var i;h||(null===(i=a.get(e))||void 0===i?void 0:i.frag)===t&&(a.delete(e),this.sbWaitingContexts$.next(a))}))}isWaitingForReset(e){return this.isResetting||!0===this.waitingForDisco$.value}initializeSourceBuffers(e){return this.mediaAdapter.ensureMediaSource().pipe(ae(({tcreate:t,topen:i})=>{let a=performance.now();return this.updateMediaElementDuration(),e.forEach((e,t)=>{const{track:i,frag:r}=e,a=`${i.container};codecs=${i.codec}`;try{const s=this.mediaAdapter.createSourceBufferAdapter(t,a,i.codec,`cc/level: ${r.cc}/${r.level}`);e.sourceBuffer=s,e.curInitSegment=null,s.timestampOffset=-1*this.hls.config.audioPrimingDelay,"audio"===i.type&&"audio/mpeg"===i.container&&(this.updateMp3Timestamps=!0)}catch(e){this.logger.error(`error while trying to add ${a} sourceBuffer:${e.message}`)();let t=new s.u(s.d.BUFFER_ADD_CODEC_ERROR,!1,e.message,s.f.VideoDecoderBadDataErr);throw t.mimeType=a,t}}),this.hls.trigger(r.a.BUFFER_CREATED,{buffers:e,mediaSourceCreateMs:i-t,sourceBufferCreateMs:performance.now()-a}),new Map(e)}))}resetSourceBuffers(e){this.isResetting?this.logger.warn("[buf] already resetting, ignoring "+JSON.stringify(e))():(this.resetting$.next(!0),this.logger.info("[buf] forceReset$ now !!!")(),this._resetSourceBuffers(),this.forceReset$.next(e),this.resetting$.next(!1))}_resetSourceBuffers(){this.logger.info("[buf] resetMediaSource #disco #append")(),this.sbContexts.size>0&&(this.mediaAdapter.destroyMediaSource(),this.sbContexts.clear())}_appendBufferAsync(e,t,i){let a=e.parent;if(!this.mediaAdapter.hasMedia)return Be(()=>new s.h(s.g.OTHER_ERROR,s.d.BUFFER_APPEND_ERROR,!1,"Media not attached"));if(this.mediaAdapter.error)return this.logger.error("trying to append although a media error occured, flush segment and abort #append")(),Be(()=>new s.b(s.d.BUFFER_APPEND_ERROR,!1,"SourceBuffer already has error",s.f.VideoDecoderBadDataErr,a));let n=e.sourceBuffer;const{type:o,frag:l,content:d,startPTS:h,endPTS:c,data:u}=t,{byteLength:f}=t.data;n.ended=!1;let g={type:o,parent:a,content:d,frag:l,startPTS:h,endPTS:c,byteLength:f};this.hls.trigger(r.a.BUFFER_APPENDING,g);let p={startPTS:h,endPTS:c,bytes:u.byteLength,tstart:performance.now(),frag:l};return this.logAppendTiming(a,p,"appending"),n.appendBuffer(u,p).pipe(ae(e=>{this.logAppendTiming(a,p,"appended");const t={tstart:p.tstart,tend:performance.now()};return this.onSBUpdateEnd(a,Object.assign(Object.assign({},p),{tend:t.tend})),t}),dt(()=>{}))}waitForBufferUpdate(e){var t;const i=null===(t=this.getSourceBufferContext(e))||void 0===t?void 0:t.sourceBuffer;return i?i.waitForBufferUpdate():$e("nosourcebuffer: "+e)}_flushBufferAsync(e,t,i,r=!1){let s,a;const n=this.mediaAdapter.currentTime;this.logger.info(`parent/flushBuffer,pos/start/end/forceAll: ${e}/${n.toFixed(3)}/${t}/${i}/${r}`)();const{track:o,sourceBuffer:l}=this.sbContexts.get(e),d=l;d.ended=!1;let h=ct;for(let n=0;n<d.buffered.length;n++){let o,l;s=d.buffered.start(n),a=d.buffered.end(n),-1!==navigator.userAgent.toLowerCase().indexOf("firefox")&&i===Number.POSITIVE_INFINITY?(o=t,l=i):(o=Math.max(s,t),l=Math.min(a,i)),(r&&Math.min(l,a)>o||Math.min(l,a)-o>.5)&&(h=h.pipe(Ie(()=>d.waitForBufferUpdate()),Ie(()=>d.remove(o,l)),ae(t=>{this.onSBUpdateEnd(e)})))}return h}logAppendTiming(e,t,i){this.hls.config.enablePerformanceLogging&&this.logger.info("[timing] "+JSON.stringify({t:performance.now(),name:e,level:t.frag.level,sn:t.frag.sn,cc:t.frag.cc,startPTS:t.startPTS,endPTS:t.endPTS,stage:i}))()}get bufferedRangeString(){var e;let t="";for(let i of this.sbContexts.values())if(i.sourceBuffer){const{parent:r,sourceBuffer:s}=i;t+=`(${r}${(null===(e=s.buffered)||void 0===e?void 0:e.length)?Ka(s.buffered):"[N/A]"})`}return t}}var Wn=jn;class qn extends yn{constructor(e,t){super(e,{name:"audio",initialContext:new mn(e,t,"audio"),initialState:fn.STOPPED},"audio"),this.altAudio$=new te(!1),this.initPTSChanged$=new Z,this.initPTSs=new Map}get haveAltAudio(){return this.altAudio$.value}set haveAltAudio(e){this.altAudio$.next(e)}hasInitPTS(e){return this.initPTSs.has(e)}_subscribe(e){const t=Ze(this.hls,this);return e.add(Ge(t.event(r.b.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching),t.event(r.b.BUFFER_APPENDED,this.onBufferAppended),t.event(r.b.BUFFER_FLUSHED,this.onBufferFlushed),t.event(r.b.INIT_PTS_FOUND,this.onInitPtsFound),t.event(r.b.DESIRED_RATE_CHANGED,this.onDesiredRateChanged.bind(this))).subscribe()),super._subscribe(e)}resetLoadSource(){this.logger.info("[audio] resetLoadSource clear initPTSes")(),this.initPTSs=new Map,this.initPTSChanged$.next(),this.haveAltAudio=!1,this.stopLoad()}stopLoad(){this.state!==fn.STOPPED&&(this.transition(fn.STOPPED),this._destroyDemuxer())}in_NEED_INIT(){let e=Ge(ct,Ze(this.hls).event(r.b.AUDIO_TRACK_SWITCHING)).pipe(ae(()=>this.haveAltAudio));return ut(_a([this.hls.seekInfoObs,e]),([e,t])=>e&&Object(ke.c)(e.cc)&&t).pipe(We(()=>{this.transition(fn.NEED_DATA)}))}handleMediaDetached(e){this.media,this.media&&this.media.ended&&(this.context.nextLoadPosition=null),this.hls.config.firstAudioMustOverlapVideoStart&&(this.logger.info("[audio] handleMediaDetached clear initPTSes")(),this.initPTSs=new Map,this.initPTSChanged$.next())}handleResetLoad(e){var t;null===(t=this.context.bufferMonitor)||void 0===t||t.notifyWaterLevelChanged(),this.logger.info("[audio] handleResetLoad clear initPTSes")(),this.initPTSs=new Map,this.context.nextLoadPosition=e.seekToPos}_handleSeekInfoChange(e){var t;if(this.logger.info(`[audio][seek] setPendingSeek seekInfo: ${JSON.stringify(e)} fragCurrent:${JSON.stringify(this.fragCurrent,["cc","start"])} #disco`)(),this.context.seekInfo=e,!this.haveAltAudio||e&&!Object(ke.c)(e.cc))this.transition(fn.STOPPED);else if(e)if(null===(t=this.context.bufferMonitor)||void 0===t||t.notifyWaterLevelChanged(),this.state===fn.STOPPED)this.context.nextLoadPosition=e.seekToPos,this.transition(fn.NEED_DATA);else if(this.state===fn.NEED_DATA||this.state===fn.ENDED){if(this.bufferController.isResetting)return this.logger.warn("Got seek while reset in progress")(),void(this.context.nextLoadPosition=e.seekToPos);let t=this.getSourceBufferInfo(this.playbackPos),i=this.getSourceBufferInfo(e.seekToPos);if(this.hls.iframeMode&&t.start===i.start&&t.len>0)return void this.logger.warn(`[audio] iframeMode ignoring seek, curBuffer:${JSON.stringify(t)} seekInfo:${JSON.stringify(e)}`)();const r=this.fragCurrent;if(r){const{seekToPos:t,cc:i}=e,s=this.isBuffered(t);(r.cc!==i||!s&&(r.start>t||r.start+r.duration<=t))&&(this.logger.info(`[audio] currently loading ${r.fragTag}, audio range: ${r.rangeString}, outside of seekToPos: ${t}, cancel it`)(),this.context.nextLoadPosition=e.seekToPos,this.transition(fn.NEED_DATA))}else this.context.nextLoadPosition=e.seekToPos,this.transition(fn.NEED_DATA)}}get targetDuration(){return this.hls.streamController.targetDuration}get shouldDeferTrackSwitch(){return void 0!==this.audioSwitch||this.hls.streamController.isWaitingForIncompatibleCC}flushBuffer(e,t){return this.context.isFlushing.next(!0),this.bufferController.flushBufferRange("audio",e,t)}get currentFragments(){var e,t,i;if(!this.tracks||!Object(ke.c)(this.trackId))return[];const r=null===(i=null===(t=null===(e=this.hls.audioTrackController.resolveTrackId(this.trackId))||void 0===e?void 0:e.trackInfo)||void 0===t?void 0:t.details)||void 0===i?void 0:i.fragments;return null!=r?r:[]}haveEnoughBufferToSwitchAudio(e,t,i){return e-t>Math.max(i,this.hls.config.minMatchGroupDuration)}readyToMatchAudioGroup(e,t){if(!this.bufferController.hasMedia)return!1;if(this.state!==fn.NEED_DATA)return!1;if(this.shouldDeferTrackSwitch)return!1;let i=this.getSourceBufferInfo(this.media.currentTime);return!!this.haveEnoughBufferToSwitchAudio(i.end,this.media.currentTime,t)}get nextLoadVariantId(){return this.variantController.currentVariantId}getLivePlaylistRefreshDelay(){return 0}_isEnded(e){const t=this.audioSwitch,i=this.variantManager.getVariantInfo(e.level).details,{seeking:r,currentTime:s,duration:a}=this.bufferController.mediaState,n=this.getSourceBufferInfo(s).end;return!(t||i.live||!e||e.sn!==i.endSN||this.hls.iframeMode||r&&!(a-n<e.duration/2)||(this.hls.bufferController.endBuffer("audio"),0))}_getFragmentToLoad(e){var t;let i=this.playbackPos;if(this.config.firstAudioMustOverlapVideoStart&&this.hls.seeking){let e=this.hls.streamController.getSourceBufferInfo(i);i=Math.max(e.start,i-this.targetDuration),this.logger.info("[audio] use video buffer start @"+i.toFixed(3))()}if(Object(ke.c)(null===(t=this.context.seekInfo)||void 0===t?void 0:t.cc)){let t=this.context.seekInfo.cc,{startFrag:r}=bn.findStartEndFragmentsInCC(e.fragments,t);i=Math.max(r.start,i),this.logger.info(`[audio] snap audio pos to cc:${t} start:${r.start.toFixed(3)}`)()}let r=this.getSourceBufferInfo(i),s=r.end,a=this.fragPrevious,n=this.audioSwitch,o=e.fragments,l=o.length,d=o[0].start,h=o[l-1].start+o[l-1].duration,c=null;if(n&&n.userInitiated)if(this.context.startFragRequested&&e.live&&!e.PTSKnown)this.logger.info("switching audiotrack, live stream, unknown PTS, load first fragment")(),s=0;else if(s=i,e.PTSKnown&&i<d){if(!(r.end>d||r.nextStart))return c;this.logger.info("[audio] adjust currentTime to alt audio track start")(),this.media.currentTime=d+.05}if(s<=d){if(c=o[0],e.live&&this.fragPrevious&&this.fragPrevious.equals(c)){const e=r.nextStart?r.nextStart:d;return this.logger.info(`[audio] no alt audio available @currentTime:${this.media.currentTime}, seeking @${e+.05}`)(),this.media.currentTime=e+.05,c}}else{let t=null,i=this.hls.config.firstAudioMustOverlapVideoStart?0:this.hls.config.maxFragLookUpTolerance;t=Ua.findFragmentBySNAndBuffer(a,o,s,h,i),this.hls.isLive&&null===a&&t&&"number"==typeof t.sn&&(s>=h||h-s<=i)&&o.length>0&&t.sn===o[o.length-1].sn&&t.level===o[o.length-1].level&&(this.logger.info(`Dropping ${t.sn} as a repeat download`)(),t=null),t&&(c=t,d=t.start,a&&c&&c.level===a.level&&c.sn===a.sn&&("initSegment"!==c.sn&&c.sn<e.endSN?(c=o[c.sn+1-e.startSN],this.logger.info("[audio] SN just loaded, load next one: "+c.sn)()):c=null))}return c}get loadedmetadata(){return this.hls.streamController.loadedmetadata||this.bufferedRangeSource.buffered.length>0}get tracks(){return this.hls.audioTracks}onAudioTrackSwitching(e){if(this.haveAltAudio=!!e.url,this.trackId=e.id,!this.haveAltAudio)return this.stopLoad(),void this._destroyDemuxer();this.haveAltAudio&&(this.audioSwitch={userInitiated:e.userInitiated},Object(ke.c)(this.playbackPos)&&this.transition(fn.NEED_DATA))}_updateLevelDetails(e,t){var i,r,s=e.id,a=this.hls.audioTrackController.resolveTrackId(s).trackInfo,n=(t.totalduration,a.details);let o=this.trackLastLoaded;this.trackLastLoaded=s,t.live||(null==n?void 0:n.live)?(n=a.details,Object(ke.c)(o)&&o!==this.trackLastLoaded&&(this.logger.info("live playlist - merging details between audio tracks")(),this.logger.info(`audio track current: ${s}, prev: ${o}`)(),n=null===(i=this.hls.audioTrackController.variantManager.getVariantInfo(o))||void 0===i?void 0:i.details,this.logger.info(`curDetails startSN/endSN: ${null==n?void 0:n.startSN}/${null==n?void 0:n.endSN}`)(),this.logger.info(`newDetails startSN/endSN: ${null==t?void 0:t.startSN}/${null==t?void 0:t.endSN}`)()),n&&t.endSN===n.endSN&&this.logger.warn(`[${this.sbid}] unchanged playlist`)(),n&&(null===(r=t.fragments)||void 0===r?void 0:r.length)>0?(Va.mergeDetails(n,t),t.fragments[0].start,t.PTSKnown):t.PTSKnown=!1):t.PTSKnown=!1,a.details=t}loadFragment(e,t){return super.loadFragment(e,t).pipe(We(e=>{this._processLoadedFrag(e)}))}_processLoadedFrag(e){let t=e.frag;const i=t.level,s=this.variantManager.getVariantInfoIfValid(i);if(!s)return this.logger.warn(`track ${i} in penalty unexpectedly`)(),void this.transition(fn.NEED_DATA);const a=s.details;this.logger.info(`${t.type} Loaded ${t.sn} of [${a.startSN},${a.endSN}], level: ${t.level}, cc: ${t.cc}, start: ${t.start} URL ${this.hls.redactUrl(t.relurl)}`)(),this.context.startFragRequested=!0,this.hls.trigger(r.b.FRAG_LOADED,e)}_hasAccurateTimeOffset(){return!1}_getInitPTS(e){return this.initPTSs.get(e.cc)}_parse(e,t,i,r,s,a){return(this.initPTSs.has(i.cc)?$e(void 0):this.initPTSChanged$).pipe(ae(()=>this.initPTSs.has(i.cc)),Ee(e=>!0===e),ye(1),Ie(()=>super._parse(e,t,i,r,s,a)),We(e=>{Object(Ga.c)(e)?this._handleFragParsingData(e):this._handleFragParsingInitSegment(e)}))}onInitPtsFound(e){let t=e.id,i=e.frag.cc,r=e.initPTS90k;"main"===t&&(this.initPTSs.set(i,r),this.initPTSChanged$.next())}shouldCheckWaterLevel(){return super.shouldCheckWaterLevel()&&!(this.audioSwitch&&this.audioSwitch.userInitiated)}_handleFragParsingInitSegment(e){this.fragCurrent;const t=e.frag;"audio"!==e.track.type&&this.logger.warn(`${e.id}: missing audio track @ level ${t.level} cc ${t.cc}`)()}ensureValidIframeTimestamp(e){const t=e.frag;let i=!0;return this.hls.config.enableIFrameSkipBadTimestamps&&this.hls.iframeMode&&Math.abs(t.start-e.startPTS)>t.duration&&(this.logger.warn(`[audio] invalid discontinuity ${t.cc} timestamp ${e.startPTS} during trickplay. Expected in the range of ${t.start}`)(),i=!1),i}disableAudioTrack(){this.logger.info("[audio] disable audio track")(),this.transition(fn.STOPPED),this.haveAltAudio=!1,this._destroyDemuxer()}enableAudioTrack(e){this.logger.info(`[audio] enable audio track @ ${e}, clear initPTSes`)(),this.haveAltAudio=!0,this.clearAllLevels(),this._destroyDemuxer(),this.initPTSs=new Map}_handleFragParsingData(e){const t=e.frag;if(!this.ensureValidIframeTimestamp(e))return void this.hls.disableAudioTrack();this.audioSwitch&&this.audioSwitch.userInitiated&&this.buffered.length&&(this.logger.info("user initiated audio switch, caching frag and flushing")(),this.flushBuffer(0,Number.POSITIVE_INFINITY).pipe(Xe(this.destroy$)).subscribe());let i=this.trackId,s=this.hls.audioTrackController.resolveTrackId(i).trackInfo,a=this.hls;Va.updateFragPTSDTS(s.details,t,e.startPTS,e.endPTS),this._handleKeyExpiryPosition(t);let n=this.audioSwitch,o=this.media;if(n&&o){let t=n.userInitiated;this.hls.isPreloadingItem&&this.hls.loadingItem.itemId!==this.hls.playingItem.itemId?this.transition(fn.STOPPED):e.resetNow=Boolean(this.audioSwitch),this.audioSwitch=void 0,a.trigger(r.b.AUDIO_TRACK_SWITCHED,{id:i,userInitiated:t})}}handleFragAppended(e){if(!e)return;const t=this.hls;let i=this.context.stats;if(i.tbuffered=performance.now(),t.trigger(r.b.FRAG_BUFFERED,{stats:i,frag:e,id:"audio"}),this.logger.info("[audio] buffered: "+Ka(this.buffered))(),this.audioSwitch){let e=this.audioSwitch.userInitiated;this.audioSwitch=void 0,t.trigger(r.b.AUDIO_TRACK_SWITCHED,{id:this.trackId,userInitiated:e})}}onBufferFlushed(e){this.context.bufferMonitor.notifyWaterLevelChanged()}onBufferAppended(e){e.frag||e.parent!==this.sbid||this.context.isFlushing.next(!1),this.context.bufferMonitor.notifyWaterLevelChanged()}onDesiredRateChanged(e){this.haveAltAudio&&0===e.oldRate&&this.state===fn.STOPPED&&Object(ke.c)(this.playbackPos)&&this.transition(fn.NEED_DATA)}get canContinuePlaybackWithoutGap(){let e=this.trackId,t=this.hls.audioTrackController.resolveTrackId(e).trackInfo,i=t?t.details:void 0;return Oa.canContinuePlaybackWithoutGap(this,this.media.currentTime,this.config.maxBufferHole,this.hls.playlistType,i)}}var zn=qn,Xn=i(12),Qn={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Yn=function(e){var t=e;return Qn.hasOwnProperty(e)&&(t=Qn[e]),String.fromCharCode(t)},Jn=100,Zn={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},eo={17:2,18:4,21:6,22:8,23:10,19:13,20:15},to={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},io={25:2,26:4,29:6,30:8,31:10,27:13,28:15},ro=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],so={verboseFilter:{DATA:3,DEBUG:3,INFO:2,WARNING:2,TEXT:1,ERROR:0},time:null,verboseLevel:0,setTime:function(e){this.time=e},log:function(e,t){var i=this.verboseFilter[e];this.verboseLevel>=i&&console.log(this.time+" ["+e+"] "+t)}},ao=function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class no{constructor(e,t,i,r,s){this.foreground=e||"white",this.underline=t||!1,this.italics=i||!1,this.background=r||"black",this.flash=s||!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){var t;t=e,Object.assign(this,t)}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class oo{constructor(e,t,i,r,s,a){this.uchar=e||" ",this.penState=new no(t,i,r,s,a)}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class lo{constructor(){this.chars=[];for(var e=0;e<Jn;e++)this.chars.push(new oo);this.pos=0,this.currPenState=new no}equals(e){for(var t=!0,i=0;i<Jn;i++)if(!this.chars[i].equals(e.chars[i])){t=!1;break}return t}copy(e){for(var t=0;t<Jn;t++)this.chars[t].copy(e.chars[t])}isEmpty(){for(var e=!0,t=0;t<Jn;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(so.log("ERROR","Negative cursor position "+this.pos),this.pos=0):this.pos>Jn&&(so.log("ERROR","Too large cursor position "+this.pos),this.pos=Jn)}moveCursor(e){var t=this.pos+e;if(e>1)for(var i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();var t=Yn(e);this.pos>=Jn?so.log("ERROR","Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!"):(this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1))}clearFromPos(e){var t;for(t=e;t<Jn;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){for(var e=[],t=!0,i=0;i<Jn;i++){var r=this.chars[i].uchar;" "!==r&&(t=!1),e.push(r)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class ho{constructor(){this.rows=[];for(var e=0;e<15;e++)this.rows.push(new lo);this.currRow=14,this.nrRollUpRows=null,this.reset()}reset(){for(var e=0;e<15;e++)this.rows[e].clear();this.currRow=14}equals(e){for(var t=!0,i=0;i<15;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(var t=0;t<15;t++)this.rows[t].copy(e.rows[t])}isEmpty(){for(var e=!0,t=0;t<15;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){so.log("INFO","setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){so.log("INFO","pacData = "+JSON.stringify(e));var t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let e=0;e<15;e++)this.rows[e].clear();var i=this.currRow+1-this.nrRollUpRows;const e=this.lastOutputScreen;if(e){var r=e.rows[i].cueStartTime;if(r&&r<so.time)for(let r=0;r<this.nrRollUpRows;r++)this.rows[t-this.nrRollUpRows+r+1].copy(e.rows[i+r])}}this.currRow=t;var s=this.rows[this.currRow];if(null!==e.indent){var a=e.indent,n=Math.max(a-1,0);s.setCursor(e.indent),e.color=s.chars[n].penState.foreground}var o={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(o)}setBkgData(e){so.log("INFO","bkgData = "+JSON.stringify(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(null!==this.nrRollUpRows){so.log("INFO","TEXT "+this.getDisplayText());var e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),so.log("INFO","Rolling up")}else so.log("DEBUG","roll_up but nrRollUpRows not set yet")}getDisplayText(e){e=e||!1;for(var t=[],i="",r=-1,s=0;s<15;s++){var a=this.rows[s].getTextString();a&&(r=s+1,e?t.push("Row "+r+": '"+a+"'"):t.push(a.trim()))}return t.length>0&&(i=e?"["+t.join(" | ")+"]":t.join("\n")),i}getTextAndFormat(){return this.rows}}class co{constructor(e,t){this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new ho,this.nonDisplayedMemory=new ho,this.lastOutputScreen=new ho,this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.lastCueEndTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,so.log("INFO","MODE="+e),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(var t=0;t<e.length;t++)this.writeScreen.insertChar(e[t]);var i=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";so.log("INFO",i+": "+this.writeScreen.getDisplayText(!0)),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(so.log("TEXT","DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){so.log("INFO","RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){so.log("INFO","BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){so.log("INFO","DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){so.log("INFO","RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){so.log("INFO","FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){so.log("INFO","RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){so.log("INFO","TR"),this.setMode("MODE_TEXT")}ccRTD(){so.log("INFO","RTD"),this.setMode("MODE_TEXT")}ccEDM(){so.log("INFO","EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){so.log("INFO","CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){so.log("INFO","ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(so.log("INFO","EOC - End Of Caption"),"MODE_POP-ON"===this.mode){var e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,so.log("TEXT","DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){so.log("INFO","TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){var t={flash:!1,underline:!1,italics:!1};if(t.underline=e%2==1,t.italics=e>=46,t.italics)t.foreground="white";else{var i=Math.floor(e/2)-16;t.foreground=["white","green","blue","cyan","red","yellow","magenta"][i]}so.log("INFO","MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){var t=so.time;null!==t&&this.outputFilter&&(this.outputFilter.updateData&&this.outputFilter.updateData(t,this.displayedMemory),null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue&&(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),!0===e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue()),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class uo{constructor(e,t){this.handler=e,this.track=t,this.startTime=null,this.endTime=null,this.screen=null}dispatchCue(){null!==this.startTime&&(this.handler.addCues("cc"+this.track,this.startTime,this.endTime,this.screen),this.startTime=null)}newCue(e,t,i){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.handler.createHTMLCaptionsTrack(this.track)}}function fo(e,t,i){return e.substr(i||0,t.length)===t}function go(e){let t=5381,i=e.length;for(;i;)t=33*t^e.charCodeAt(--i);return(t>>>0).toString()}function po(e){let t=Math.floor(e),i=t+.5,r=t+1;return e>=i?e-i>=r-e?r:i:e-t>=i-e?i:t}function mo(e,t=0,i=8589934592){if(!Number.isFinite(t))return e;const r=i/2,s=Math.abs(e-t)%i;return t+(e>t?-1:1)*(s>r?i-s:-s)}var yo=function(e,t,i,r,s,a,n){let o=pt.b.utf8arrayToStr(new Uint8Array(e)).trim().replace(/\r\n|\n\r|\n|\r/g,"\n").split("\n"),l=0,d=0,h=[],c=null,u=!0;const f=new Xn.WebVTTParser(window,Xn.WebVTTParser.StringDecoder(),n);f.oncue=function(e){let s=mo(mo(l)-t,9e4*i[r].start)/9e4;e.startTime=mo(e.startTime+s-d,0,95443.7176888889),e.endTime=mo(e.endTime+s-d,0,95443.7176888889),e.id=go(po(e.startTime).toString())+go(po(e.endTime-e.startTime).toString())+go(e.text),e.text=decodeURIComponent(encodeURIComponent(e.text)),e.endTime>0&&h.push(e)},f.onparsingerror=function(e){c=e},f.onflush=function(){c&&a?a(c):s(h)},o.forEach(e=>{if(u){if(fo(e,"X-TIMESTAMP-MAP="))return u=!1,void e.substr(16).split(",").forEach(t=>{if(fo(t,"LOCAL:")){let i;try{i=(function(e){let t=parseInt(e.substr(-3)),i=parseInt(e.substr(-6,2)),r=parseInt(e.substr(-9,2)),s=e.length>9?parseInt(e.substr(0,e.indexOf(":"))):0;return Object(ke.c)(t)&&Object(ke.c)(i)&&Object(ke.c)(r)&&Object(ke.c)(s)?(t+=1e3*i,t+=6e4*r,t+=36e5*s):-1})(t.substr(6))}catch(e){i=-1}-1!==i?d=i/1e3:c=new Error("Malformed X-TIMESTAMP-MAP: "+e)}else fo(t,"MPEGTS:")&&(l=parseInt(t.substr(7)))});""===e&&(u=!1)}f.parse(e+"\n")}),f.flush()};function vo(e){if(e&&e.cues)for(;e.cues.length>0;)e.removeCue(e.cues[0])}class bo extends x{constructor(e){super(),this.hls=e,this.initPTSChanged$=new Z,this.destroy$=new Z,this.hls=e,this.config=e.config,this.logger=e.logger||Ae.b,this.enabled=!0,this.Cues=e.config.cueHandler,this.tracks=[],this.initPTS=[],this.cueRanges=[],this.channelToTrackMap={},this.htmlTextTrackMap=new Map,this.mediaAttached=!1,this.gotTracks=!1}destroy(){this.vttCCs=void 0,this.initPTS=[],this.destroy$.next()}_subscribe(e){const t=Ze(this.hls,this);return e.add(Ge(t.event(r.b.MEDIA_ATTACHING,this.onMediaAttaching),t.event(r.b.MEDIA_DETACHING,this.onMediaDetaching),t.event(r.b.FRAG_PARSING_USERDATA,this.onFragParsingUserdata),t.event(r.b.FRAG_PARSING_CAPTIONDATA,this.onFragParsingCaptiondata),t.event(r.b.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated),t.event(r.b.FRAG_LOADED,this.onFragLoaded),t.event(r.b.LEVEL_SWITCHING,this.onLevelSwitching),t.event(r.b.INIT_PTS_FOUND,this.onInitPtsFound),t.event(r.b.INLINE_STYLES_PARSED,this.onInlineStylesParsed)).pipe(dt(()=>this.destroy$.next())).subscribe()),super._subscribe(e)}addCues(e,t,i,r){const s=this.cueRanges;let a=!1;for(let e=s.length;e--;){let r=s[e],h=(n=r[0],o=r[1],l=t,d=i,Math.min(o,d)-Math.max(n,l));if(h>=0&&(r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],i),a=!0,h/(i-t)>.5))return}var n,o,l,d;a||s.push([t,i]),this.Cues.newCue(this.channelToTrackMap[e],t,i,r,this.media)}onInitPtsFound(e){"main"===e.id&&(this.initPTS[e.frag.cc]=e.initPTS90k,this.initPTSChanged$.next())}getExistingHTMLTextTrackWithChannelNumber(e){const t=this.media;if(t)for(let i=0;i<t.textTracks.length;i++){let r=t.textTracks[i],s="cc"+e;if(An(s)&&!0===r[s])return r}return null}sendAddTrackEvent(e,t){var i=null;try{i=new window.Event("addtrack")}catch(e){(i=document.createEvent("Event")).initEvent("addtrack",!1,!1)}i.track=e,t.dispatchEvent(i)}createHTMLCaptionsTrackGuts(e,t,i,r){let s="cc"+e;if(!this.channelToTrackMap[s]){let a=this.getExistingHTMLTextTrackWithChannelNumber(e);if(a)this.channelToTrackMap[s]=a,vo(this.channelToTrackMap[s]),this.sendAddTrackEvent(this.channelToTrackMap[s],this.media);else{const e=this.createHTMLTextTrackGuts("captions",t,i,r);e&&An(s)&&(e[s]=!0,this.channelToTrackMap[s]=e)}}return this.channelToTrackMap[s]}createHTMLCaptionsTrack(e){return this.createHTMLCaptionsTrackGuts(e,this.config["captionsTextTrack"+e+"Label"],this.config.captionsTextTrack1LanguageCode,!1)}getExistingHTMLTextTrack(e){return this.hls.config.condenseSubtitleTrack?this.htmlTextTrackMap.get(e.persistentID):this.htmlTextTrackMap.get(e.id)}setExistingHTMLTextTrack(e,t){return t.persistentId=e.persistentID,this.hls.config.condenseSubtitleTrack?this.htmlTextTrackMap.set(e.persistentID,t):this.htmlTextTrackMap.set(e.id,t)}createHTMLTextTrack(e){let t=this.getExistingHTMLTextTrack(e);if(t)this.logger.info(`reuse HTML text track for track ${e.id}: persistent id ${t.persistentId} kind ${t.kind} label ${t.label} lang ${t.language}`)();else{if("sbtl"===e.mediaType)t=this.createHTMLTextTrackGuts("subtitles",e.name,e.lang,e.forced);else{let i=1;e.inStreamID&&(i=Number(e.inStreamID.substring(2))),t=this.createHTMLCaptionsTrackGuts(i,e.name,e.lang,!1)}t?(this.setExistingHTMLTextTrack(e,t),this.logger.info(`new HTML text track for track ${e.id}: persistent id ${t.persistentId} kind ${t.kind} label ${t.label} lang ${t.language}`)()):this.logger.error(`failed to create HTML text track for track ${e.id}: persistent id ${e.persistentID} name ${e.name} lang ${e.lang} inStreamID ${e.inStreamID}`)()}return t}createHTMLTextTrackGuts(e,t,i,r){const s=this.media;if(s){let r=!1;"metadata"!==e&&this.config.customTextTrackCueRenderer&&(r=!0,e="metadata");let a=s.addTextTrack(e,t,i);return r&&(a.customTextTrackCueRenderer=!0),a}}onMediaAttaching(e){this.media=e.media,this.mediaAttached=!0,this.attachSubtitleTracks()}onMediaDetaching(){vo(this.textTrack1),vo(this.textTrack2)}resetLoadSource(){this.resetInitPTS(),this.resetCCs(),this.resetTracks()}resetInitPTS(){this.initPTS=[],this.initPTSChanged$.next()}resetCCs(){this.lastSn=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0}}resetTracks(){this._cleanTracks(),this.cueRanges=[]}_cleanTracks(){const e=this.media;if(e){const t=e.textTracks;if(t)for(let e=0;e<t.length;e++)vo(t[e])}}getCuesOfEnabledTrack(e,t=!1){let i=[];if(t){let t=this._getCuesOfEnabledTrack(e);for(let e=0;e<t.length;e++){let r=t[e];Boolean(r.webVTTCue)&&i.push(r)}}else i=this._getCuesOfEnabledTrack(e);return i}_getCuesOfEnabledTrack(e){const t=this.tracks[e],i=this.hls.config.condenseSubtitleTrack?t.persistentID:t.id;let r=this.htmlTextTrackMap.get(i);return r&&r.cues?Array.from(r.cues):null}attachSubtitleTracks(){this.mediaAttached&&this.gotTracks&&(this.tracks.forEach(e=>{this.createHTMLTextTrack(e)}),this.hls.trigger(r.b.SUBTITLE_TRACKS_CREATED))}onSubtitleTracksUpdated(e){this.resetCCs(),this._cleanTracks(),this.htmlTextTrackMap=new Map,this.initPTS=[],this.cueRanges=[],this.config.enableWebVTT&&(this.tracks=e.subtitleTracks||[]),this.gotTracks=!0,this.attachSubtitleTracks()}onLevelSwitching(){this.enabled="NONE"!==this.hls.levelWithPersistentId(this.hls.levelController.currentVariantId).levelInfo.closedcaption}onInlineStylesParsed(e){}hasDiscontinuityOffset(e){return this.vttCCs[e]}processSubtitleFrag(e){return re(()=>{let t=e.frag,i=e.payload;if(i.byteLength){if("initSegment"!==t.sn)return(Object(ke.c)(this.initPTS[t.cc])?$e(void 0):this.initPTSChanged$).pipe(ye(1),Ie(()=>(Object(ke.c)(this.initPTS[t.cc])?this._parseVTTs(t,i):this.hls.trigger(r.b.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t,outOfSync:!0}),$e(t))));this.hls.trigger(r.b.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:t})}else this.hls.trigger(r.b.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t});return $e(t)})}resetClosedCaptionParser(){var e;null===(e=this.cea608Parser)||void 0===e||e.reset()}prepareForTrickPlay(){this.cea608Parser=void 0}onFragLoaded(e){let t=e.frag;if("main"===t.type&&"initSegment"!==t.sn){var i=t.sn;i!==this.lastSn+1&&this.resetClosedCaptionParser(),this.lastSn=i}}_parseVTTs(e,t){let i=this.vttCCs;i[e.cc]||(i[e.cc]={start:e.start,prevCC:this.prevCC,new:!0},this.prevCC=e.cc);let s=this.hls,a=!1;yo(t,this.initPTS[e.cc],i,e.cc,t=>{const i=this.tracks[e.trackId],n=this.getExistingHTMLTextTrack(i);a=!0,(t=t.filter(e=>!n.cues.getCueById(e.id))).map(t=>{try{n.addCue(t)}catch(e){this.logger.warn("retry addCue. Previous addCue failed: "+e.message)();const i=new VTTCue(t.startTime,t.endTime,t.text);i.id=t.id,n.addCue(i),t=i}return t.fragSN=e.sn,t.webVTTCue=!0,t}),s.trigger(r.b.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e,cues:t})},t=>{s.trigger(r.b.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e})},e=>{s.trigger(r.b.INLINE_STYLES_PARSED,{styles:e})}),a||(this.logger.info("[subtitle] empty webvtt segment: fake a completion event")(),s.trigger(r.b.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e,cues:[]}))}_ensureParser(){if(!this.cea608Parser){var e=new uo(this,1),t=new uo(this,2);this.cea608Parser=new class{constructor(e=1,t,i){this.field=e,this.currChNr=-1,this.lastCmdA=null,this.lastCmdB=null,this.channels=[new co(1,t),new co(2,i)],this.dataCounters={padding:0,char:0,cmd:0,other:0}}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){let i,r,s,a=null;so.setTime(e);for(var n=0;n<t.length;n+=2)r=127&t[n],s=127&t[n+1],r>=16&&r<=31&&r===this.lastCmdA&&s===this.lastCmdB?(this.lastCmdA=null,this.lastCmdB=null,so.log("DEBUG","Repeated command ("+ao([r,s])+") is dropped")):0!==r||0!==s?(so.log("DATA","["+ao([t[n],t[n+1]])+"] -> ("+ao([r,s])+")"),(i=this.parseCmd(r,s))||(i=this.parseMidrow(r,s)),i||(i=this.parsePAC(r,s)),i||(i=this.parseBackgroundAttributes(r,s)),i||(a=this.parseChars(r,s))&&(this.currChNr&&this.currChNr>=0?this.channels[this.currChNr-1].insertChars(a):so.log("WARNING","No channel found yet. TEXT-MODE?")),i?this.dataCounters.cmd+=2:a?this.dataCounters.char+=2:(this.dataCounters.other+=2,so.log("WARNING","Couldn't parse cleaned data "+ao([r,s])+" orig: "+ao([t[n],t[n+1]])))):this.dataCounters.padding+=2}parseCmd(e,t){var i;if(!((20===e||21===e||28===e||29===e)&&32<=t&&t<=47||(23===e||31===e)&&33<=t&&t<=35))return!1;i=20===e||23===e?1:2;var r=this.channels[i-1];return 20===e||21===e||28===e||29===e?32===t?r.ccRCL():33===t?r.ccBS():34===t?r.ccAOF():35===t?r.ccAON():36===t?r.ccDER():37===t?r.ccRU(2):38===t?r.ccRU(3):39===t?r.ccRU(4):40===t?r.ccFON():41===t?r.ccRDC():42===t?r.ccTR():43===t?r.ccRTD():44===t?r.ccEDM():45===t?r.ccCR():46===t?r.ccENM():47===t&&r.ccEOC():r.ccTO(t-32),this.lastCmdA=e,this.lastCmdB=t,this.currChNr=i,!0}parseMidrow(e,t){var i=null;if((17===e||25===e)&&32<=t&&t<=47){if((i=17===e?1:2)!==this.currChNr)return so.log("ERROR","Mismatch channel in midrow parsing"),!1;var r=this.channels[i-1];return r.insertChars([32]),r.ccMIDROW(t),so.log("DEBUG","MIDROW ("+ao([e,t])+")"),this.lastCmdA=e,this.lastCmdB=t,!0}return!1}parsePAC(e,t){var i,r;if(!((17<=e&&e<=23||25<=e&&e<=31)&&64<=t&&t<=127||(16===e||24===e)&&64<=t&&t<=95))return!1;i=e<=23?1:2,r=64<=t&&t<=95?1===i?Zn[e]:to[e]:1===i?eo[e]:io[e];var s=this.interpretPAC(r,t);return this.channels[i-1].setPAC(s),this.lastCmdA=e,this.lastCmdB=t,this.currChNr=i,!0}interpretPAC(e,t){var i,r={color:null,italics:!1,indent:null,underline:!1,row:e};return i=t>95?t-96:t-64,r.underline=1==(1&i),i<=13?r.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(r.italics=!0,r.color="white"):r.indent=4*Math.floor((i-16)/2),r}parseChars(e,t){var i,r=null,s=null,a=null;(e>=25?(r=2,a=e-8):(r=1,a=e),17<=a&&a<=19)?(i=17===a?t+80:18===a?t+112:t+144,so.log("INFO","Special char '"+Yn(i)+"' in channel "+r),s=[i],this.lastCmdA=e,this.lastCmdB=t):32<=e&&e<=127&&(s=0===t?[e]:[e,t],this.lastCmdA=null,this.lastCmdB=null);if(s){var n=ao(s);so.log("DEBUG","Char codes =  "+n.join(","))}return s}parseBackgroundAttributes(e,t){var i,r,s;return((16===e||24===e)&&32<=t&&t<=47||(23===e||31===e)&&45<=t&&t<=47)&&(i={underline:!1},16===e||24===e?(r=Math.floor((t-32)/2),i.background=ro[r],t%2==1&&(i.background=i.background+"_semi")):45===t?i.background="transparent":(i.foreground="black",47===t&&(i.underline=!0)),s=e<24?1:2,this.channels[s-1].setBkgData(i),this.lastCmdA=null,this.lastCmdB=null,!0)}reset(){for(var e=0;e<this.channels.length;e++)this.channels[e]&&this.channels[e].reset();this.lastCmdA=null,this.lastCmdB=null}cueSplitAtTime(e){for(var t=0;t<this.channels.length;t++)this.channels[t]&&this.channels[t].cueSplitAtTime(e)}}(0,e,t)}}onFragParsingCaptiondata(e){if(this.enabled&&this.config.enableCEA708Captions){this._ensureParser();for(let t=0;t<e.samples.length;t++){let i=e.samples[t].pts,r=e.samples[t].bytes;for(let e=0;e<r.length;e+=2){let s=[];s.push(r[e]),e+1<r.length?s.push(r[e+1]):(this.logger.warn(`CEA608 sample ${t} not even length (index ${e+1} >= length ${r.length})`)(),s.push(80)),this.cea608Parser.addData(i,s),i+=1001/3e4}}}}onFragParsingUserdata(e){if(this.enabled&&this.config.enableCEA708Captions){this._ensureParser();for(let t=0;t<e.samples.length;t++){let i=bo.extractCea608Data(e.samples[t].bytes);this.cea608Parser.addData(e.samples[t].pts,i)}}}static extractCea608Data(e){for(var t,i,r,s=31&e[0],a=2,n=[],o=0;o<s;o++)t=e[a++],i=127&e[a++],r=127&e[a++],0===i&&0===r||0!=(4&t)&&0==(3&t)&&(n.push(i),n.push(r));return n}}class So extends gn{constructor(e,t){super(),this.levelLoaded$=new Z,this.variantController=t}}class To extends pn{constructor(e,t){super(e,{name:"subtitle",initialContext:new So(e,t),initialState:fn.STOPPED},void 0),this.fragQueue=[],this.fragNumCues={},this.latestCueStart=0,this.tracks=null,this.enabledTrack=null,this.useSubtitle$=new te(!1)}get haveSubtitle(){return this.useSubtitle$.value}set haveSubtitle(e){this.useSubtitle$.next(e)}destroy(){this.transition(fn.STOPPED),this.onMediaDetaching(),this.destroy$.next()}resetLoadSource(){this.hls.timelineController.resetLoadSource(),this.haveSubtitle=!1,this.transition(fn.STOPPED)}_subscribe(e){const t=Ze(this.hls,this);return e.add(Ge(t.event(r.b.MEDIA_ATTACHING,this.onMediaAttaching),t.event(r.b.MEDIA_DETACHING,this.onMediaDetaching),t.event(r.b.INTERNAL_ERROR,this.onInternalError),t.event(r.b.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated),t.event(r.b.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch),t.event(r.b.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed)).subscribe()),e.add(this.hls.seekInfoObs.pipe(Ee(e=>Boolean(e)&&Object(ke.c)(e.cc)&&this.haveSubtitle),We(e=>{this.logger.info(`[${this.logname}] got seekInfo: ${JSON.stringify(e)}`)(),this.setPendingSeek(e)})).subscribe()),super._subscribe(e)}in_STOPPED(){return Ta}in_NEED_INIT(){return Ta}in_NEED_DATA(){let e=this.waitForVariantWithURL().pipe(ka(y),Ie(e=>this.setVariantAndLoad(e)),fs({bufferSize:1,refCount:!0}));return Ge(e,e.pipe(ye(1),$r(e=>(this.context.targetDuration=e.targetduration,this.estimateCurrentWaterLevel()>this.highWaterLevel?this.handleHighWater():this.loadAndAppendMedia(this.enabledTrack.id,e).pipe(We(e=>{})))),We(()=>{this.enabledTrack.id!==this.nextLoadVariantId&&this.transition(fn.NEED_DATA)}),Se(this._catchError.bind(this)),dt(()=>{this.fragCurrent=null}),Cs(e=>e.pipe(ja(0))))).pipe(Se(this._catchError.bind(this)),dt(()=>{}))}in_ENDED(){return Ta}in_ERROR(){return Ta}waitForVariantWithURL(){return re(()=>{var e;return(null===(e=this.enabledTrack)||void 0===e?void 0:e.url)?$e(this.enabledTrack.id):Ta})}waitForLevelRefresh(){return this.context.levelLoaded$.pipe(We(()=>{this.logger.info("resume frag loading after level refresh")()}),ye(1))}setVariantAndLoad(e){return re(()=>this.loadPlaylist(e))}handleHighWater(){let e=Ze(this.hls);return Ji(e.event(r.b.BUFFER_CHANGED).pipe(Ee(e=>"subtitle"===e.parent)),e.event(r.b.DESIRED_RATE_CHANGED).pipe(Ee(e=>0===e.newRate))).pipe(ye(1))}loadAndAppendMedia(e,t){return re(()=>{const e=this._getFragmentToLoad(t);if(!e){if(this.hls.isLive)return this.waitForLevelRefresh();if(this.fragPrevious&&this.fragPrevious.isLastFragment)return this.transition(fn.STOPPED),ct;{let e=this.hls.config.maxBufferLength+1;return e=Object(ke.c)(e)&&e>=0?e:1,this.logger.info(`[${this.logname}] sleep for ${e} seconds`)(),Ji(Ze(this.hls).event(r.b.SEEKING),X(1e3*e)).pipe(We(()=>this.transition(fn.NEED_DATA)))}}return this.loadFragment(e,!1).pipe(Ie(e=>this.processSubtitleFrag(e)))}).pipe(Se(this._catchError.bind(this)))}_getFragmentToLoad(e){let t=this._findFragment();if(t)return this.fragPrevious&&t.sn===this.fragPrevious.sn&&t.level===this.fragPrevious.level||(this.fragCurrent=t),t}getLivePlaylistRefreshDelay(e){return 0}setPendingSeek(e){this.haveSubtitle&&(this.logger.info(`[${this.logname}] setPendingSeek seekInfo: ${JSON.stringify(e)}`)(),this.context.nextLoadPosition=e.seekToPos,this.transition(fn.NEED_DATA))}isBuffered(e){return!1}_updateLevelDetails(e,t){var i=e.id,r=this.enabledTrack=this.hls.subtitleTrackController.resolveTrackId(i).trackInfo;t.totalduration,r.details=t}get highWaterLevel(){return Number.POSITIVE_INFINITY}get targetDuration(){return this.hls.streamController.targetDuration}get nextLoadVariantId(){return this.variantController.currentVariantId}prepareForTrickPlay(){this.hls.timelineController.prepareForTrickPlay()}isSubtitleTrackEnabled(){return this.findEnabledTrack()&&(this.findEnabledTrack().mediaType===Wr.SUBTITLE||this.enabledTrack.sideTrackId)}estimateCurrentWaterLevel(){if(!this.hls.media)return 0;const e=this.hls.media.currentTime;if(this.hls.isLive)return this.latestCueStart-e;{const{bufferedFrags:t}=this._checkFragBufferedState();return Na.fragmentsBufferedInfo(t,e,this.hls.config.maxBufferHole).end-e}}processSubtitleFrag(e){return e.frag,this.enabledTrack.details,this.hls.timelineController.processSubtitleFrag(e)}loadPlaylist(e){var t;return e!==(null===(t=this.enabledTrack)||void 0===t?void 0:t.id)?Be(()=>new Error(`Invalid level requested ${e} should be ${this.enabledTrack.id} (with ${this.enabledTrack.sideTrackId})`)):super.loadPlaylist(e,!1).pipe(We(t=>{let i=this.variantManager.getVariantInfoIfValid(e);if(!i)throw Error("Loaded invalid level! "+e);{let e=i.details;(null==e?void 0:e.trequest)!==t.trequest&&this._updateLevelDetails(i,t)}this.enabledTrack.details=t,this._addAllFragmentsToQueue(),this.context.levelLoaded$.next()}))}_findFragment(){const{hls:e}=this;let t;Object(ke.c)(this.context.nextLoadPosition)?(t=this.context.nextLoadPosition,this.context.nextLoadPosition=void 0,this.logger.info(`[${this.logname}] use seek position ${t} currentTime ${this.media.currentTime}`)()):t=this.media.currentTime;const i=t+e.config.maxBufferLength;return e.isLive&&"EVENT"!==e.playlistType?this._findFragmentLive(i):this._findFragmentVod(t,i)}_findFragmentLive(e){return e>this.latestCueStart?this.fragQueue.shift():null}_findFragmentVod(e,t){const{loadableFrags:i}=this._checkFragBufferedState();for(const r of i){const i=r.start,s=i+r.duration;if(i<=e&&s>e||i<=t&&s>t||i>=e&&s<=t)return r}return null}_checkFragBufferedState(){if(!this.enabledTrack)return{bufferedFrags:[],loadableFrags:[]};let e=[],t=[];const{fragQueue:i,fragNumCues:r}=this,s=this.hls.timelineController.getCuesOfEnabledTrack(this.enabledTrack.id,void 0!==this.enabledTrack.sideTrackId);if(null!=s&&s.length>0&&i.length>0){const a={};for(let e=0;e<s.length;e++){const t=s[e];null==a[t.fragSN]?a[t.fragSN]=1:a[t.fragSN]++}for(const s of i){const i=s.sn,n=r[i],o=a[i];null==o||null==n||n>o?t.push(s):e.push(s)}}else t=[...i];return{bufferedFrags:e,loadableFrags:t}}_addAllFragmentsToQueue(){const{fragQueue:e,enabledTrack:t}=this,{details:i,id:r}=t;e.length,i.fragments.forEach(t=>{t.trackId=r,"number"==typeof t.sn&&(null==this.fragPrevious||t.sn>this.fragPrevious.sn)&&(0===e.length||t.sn>e[e.length-1].sn)&&e.push(t)})}_findAllDiscontinuityFragmentsBefore(e){let t,i=[];return this.enabledTrack.details.fragments.forEach(r=>{if(e.sn>r.sn){let e=this.hls.timelineController.hasDiscontinuityOffset(r.cc);void 0!==t&&r.cc===t||e||(i.push(r),t=r.cc)}}),i}onMediaAttaching(e){this.media=e.media,this.handleMediaAttached(e.media)}handleMediaAttached(e){this.mediaEventListeners={seeked:this.onMediaSeeked.bind(this)};for(let t of Object.keys(this.mediaEventListeners))e.addEventListener(t,this.mediaEventListeners[t])}onMediaDetaching(){this.media=null,this.bufferMonitor&&(this.bufferMonitor.destroy(),this.bufferMonitor=null),this.handleMediaDetached(!0)}handleMediaDetached(e){if(this.media&&this.mediaEventListeners){for(let e of Object.keys(this.mediaEventListeners))this.media.removeEventListener(e,this.mediaEventListeners[e]);this.mediaEventListeners={}}}onMediaSeeked(){this.state!==fn.NEED_DATA&&this.transition(fn.NEED_DATA)}onSubtitleTracksUpdated(e){this.tracks=e.subtitleTracks,this.fragQueue=[],this.fragNumCues=[],this.latestCueStart=0}onSubtitleTrackSwitch(e){var t;if(e.hidden&&e.track){let t=this.hls.subtitleTrackController.redirectTextTrack(e.track.id);this.enabledTrack=this.hls.subtitleTrackController.resolveTrackId(t).trackInfo,this.enabledTrack.sideTrackId=e.track.id,this.enabledTrack.url=this.hls.subtitleTrackController.resolveTrackId(e.track.id).trackInfo.url}else this.enabledTrack=e.track;if(this.haveSubtitle=!!(null===(t=this.enabledTrack)||void 0===t?void 0:t.url),this.fragPrevious&&this.enabledTrack&&this.fragPrevious.trackId!==this.enabledTrack.id&&(this.fragPrevious=null),this.logger.info(`[${this.logname}] enable track id: ${this.enabledTrack?this.enabledTrack.id:"undefined"} side track id `+(this.enabledTrack?this.enabledTrack.sideTrackId:"undefined"))(),this.enabledTrack){this.bufferMonitor&&this.bufferMonitor.destroy();let e=()=>this.estimateCurrentWaterLevel();this.bufferMonitor=new dn(this.hls,this.hls.media,e,"subtitle",this.config.maxBufferHole,this.config.maxBufferLength,this.config.defaultTargetDuration,this.config.almostDryBufferSec)}else this.bufferMonitor&&(this.bufferMonitor.destroy(),this.bufferMonitor=null);this.fragQueue=[],this.fragNumCues=[],this.latestCueStart=0,this.fragCurrent=null,this.needDataNow()}needDataNow(){if(!this.haveSubtitle)return this.logger.info(`[${this.logname}] track has no url`)(),void this.transition(fn.STOPPED);this.transition(fn.NEED_DATA)}get shouldDeferTrackSwitch(){return this.hls.streamController.isWaitingForIncompatibleCC}onSubtitleFragProcessed({frag:e,cues:t,outOfSync:i}){if(this.enabledTrack&&this.enabledTrack.id===e.level&&(this.fragPrevious=e,this.fragCurrent=null,"number"==typeof e.sn&&(t=t||[],this.updateLatestCueStart(t),this.fragNumCues[e.sn]=t.length,this.bufferMonitor.notifyWaterLevelChanged()),i)){let e=this.hls.streamController.playbackPos;this.setPendingSeek({cc:void 0,seekToPos:e})}}updateLatestCueStart(e){this.latestCueStart=Math.max(this.latestCueStart,...e.map(e=>e.startTime))}findEnabledTrack(){return this.enabledTrack}onInternalError(e){this.logger.warn(`[${this.logname}] got error, not doing anything ${e.message}`)(),e.fatal&&this.upgradeInternalErrorAndDie(e).pipe(Xe(this.destroy$)).subscribe()}get variantController(){return this.hls.subtitleTrackController}}let Eo={maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},_o={maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3};const Do={autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,defaultVideoCodec:void 0,debug:!1,debugLevel:void 0,buildType:void 0,minFramesBeforeSwitchingLevel:11,minTargetDurations:3,initialLiveManifestSize:1,maxBufferLength:60,maxBufferHole:.5,maxSeekHole:2,discontinuitySeekTolerance:2,almostDryBufferSec:.5,maxTotalDurationTolerance:.1,lowBufferWatchdogPeriod:.5,highBufferWatchdogPeriod:3,seekWatchdogPeriod:5,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.2,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,liveFlushExpiredFrags:!0,allowFastSwitchUp:!1,minMatchGroupDuration:5,desiredIframeFPS:8,initialIframeFPS:6,minRemainingTimeInMediaPipeline:3,leftMediaTimeToAutoPause:10,startTargetDurationFactor:.9,enableWorker:!0,enableSoftwareAES:!0,keySystemPreference:void 0,clearMediaKeysOnPromise:!0,useMultipleKeySessions:!1,enablePlayReadyKeySystem:!1,useMediaKeySystemAccessFilter:!1,playReadyMessageFormat:"utf16",startLevel:void 0,livePlaylistRefreshDelay:2500,liveMinPlayingBufferLen:5,enableIFramePreloading:!0,enableIFrameSkipBadTimestamps:!1,useMediaCapabilities:!1,enableID3Cues:!0,manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Eo,errorRetry:_o,forceContentLenCheckIfNoHeader:!1,reportCDNServer:!0},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Eo,errorRetry:_o,reportCDNServer:!0}},maxNumAddLevelToPenaltyBox:4,fragLoadingLoopThreshold:3,firstAudioMustOverlapVideoStart:!1,keyLoadingDefaultTimeout:2e4,keyLoadingMinTimeout:3e3,keyLoadingRetryDelay:1e3,keyRetryCountOnError:3,keyHoldTimeAfterExpiry:15e3,startFragPrefetch:!1,appendErrorMaxRetry:3,alwaysResetOnNewCC:!1,loader:gt,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,abrController:Vn,bufferController:Wn,audioStreamController:zn,audioTrackController:Rn,iframeMaxExitSeekDuration:2e3,iframeStallMaxRetry:5,audioPrimingDelay:0,subtitleStreamController:To,subtitleTrackController:Ln,timelineController:bo,cueHandler:{newCue:function(e,t,i,r,s){let a,n,o,l,d;const h={foreground:!1,background:!1,italics:!1,underline:!1,flash:!1,styleStack:[]};for(const[c,u]of r.rows.entries())if(n=!0,o=0,l="",!u.isEmpty()){for(let e=0;e<u.chars.length;e++)u.chars[e].uchar.match(/\s/)&&n?o++:(l+=this.getFormattedChar(u.chars[e],h),n=!1);u.cueStartTime=t,t===i&&(i+=1e-4),l=l.trim().replace(/<br(?: \/)?>/gi,"\n"),l+=this.closeStyles(h),a=new Xn.VTTCue(t,i,l),o>=16?o--:o++,d=navigator.userAgent.match(/Firefox\//)?c+1:c>7?c:c+1,a.snapToLines=!1,a.line=10+5.33*d,a.align="left",a.position=this.getPosition(o,s),e.addCue(a)}},getPosition:function(e,t){let i=4/3;t&&t.offsetWidth&&t.offsetHeight&&t.offsetWidth/t.offsetHeight>=1.6&&(i=16/9);let r=10+e/32*80,s=10,a=90;return i===16/9&&(r=12.5+.75*r,s=20,a=80),Math.max(s,Math.min(a,r+(navigator.userAgent.match(/Firefox\//)?50:0)))},getRootStyleTag:function(e){let t=e[0];return"c"===t?t:e},closeStyles:function(e){let t="";for(let i=e.styleStack.length-1;i>=0;--i)t+="</"+this.getRootStyleTag(e.styleStack[i])+">",e.styleStack.pop();return t},beginStyleAndBalance:function(e,t){let i="";return"c"===t[0]&&(i+=this.closeStyleAndBalance(e,"c")),i+="<"+t+">",e.styleStack.push(t),i},closeStyleAndBalance:function(e,t){let i=e.styleStack.length,r=0,s="",a=!1;for(let n=i-1;n>=0;--n){let o=e.styleStack[n],l=this.getRootStyleTag(o);if(t[0]===o[0]){s+="</"+l+">",e.styleStack.splice(i-1-r);break}a=!0,"c"===l[0]?(e.background="",e.foreground="",e.flash=!1,s+="</c>"):"u"===l[0]?(e.underline=!1,s+="</u>"):"i"===l[0]&&(e.italics=!1,s+="</i>"),r++}return s},getFormattedChar:function(e,t){let i="",r=e.uchar,s="",a=e.penState.foreground!==t.foreground,n=e.penState.background!==t.background,o=e.penState.flash!==t.flash;return(a||n||o)&&(s="."+e.penState.foreground,s+=".bg_"+e.penState.background,e.penState.flash&&o&&(s+=".blink"),e.penState.foreground||e.penState.background||e.penState.blink?i+=this.beginStyleAndBalance(t,"c"+s):i+=this.closeStyleAndBalance(t,"c"),a&&(t.foreground=e.penState.foreground),n&&(t.background=e.penState.background),o&&(t.flash=e.penState.flash)),e.penState.underline!==t.underline&&(i+=e.penState.underline?this.beginStyleAndBalance(t,"u"):this.closeStyleAndBalance(t,"u"),t.underline=e.penState.underline),e.penState.italics!==t.italics&&(i+=e.penState.italics?this.beginStyleAndBalance(t,"i"):this.closeStyleAndBalance(t,"i"),t.italics=e.penState.italics),i+r}},enableCEA708Captions:!0,customTextTrackCueRenderer:!1,enableWebVTT:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",enableDualTrackSelection:!1,condenseSubtitleTrack:!1,stretchShortVideoTrack:!1,forceKeyFrameOnDiscontinuity:!0,useFirstLevelAtIncompatDiscontinuity:!0,abrBandwidthEstimator:"bandwidth-history-controller",abrEwmaDefaultEstimate:5e5,abrDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.9,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,enableRtcReporting:!1,rtcIntervalTimeout:3e5,rtcSender:"HLSJS",rtcSessionTag:"none",useHTTPPlaybackSessionId:!1,warmupCdms:!1,enablePerformanceLogging:!1,overridePlaybackRate:!1,nativeControlsEnabled:!1,enableAdaptiveStartup:!0,relaxAudioGroup:!0,bandwidthHistoryWindowSize:12e4,bandwidthHistoryTTL:6e5,bandwidthHistoryAggregationMethod:"quadratic-time-weighted",bandwidthHistoryGetEstimateThrottleMs:1e3,defaultTargetDuration:10,targetStartupMs:4e3,adaptiveStartupMetricsOverride:{maxValidHeight:1080,maxValidBitrate:1/0,maxPreferredBitrate:1/0},bandwidthHistoryStorageKey:"AppleHLS-bandwidth-estimation",storageKeyPrefix:"AppleHLS-",storage:{get:"undefined"==typeof localStorage?void 0:localStorage.getItem.bind(localStorage),set:"undefined"==typeof localStorage?void 0:localStorage.setItem.bind(localStorage)},minFragmentCount:10,enableCDNFallback:!0,enableQueryParamsForITunes:!1,gapless:!1,useViewportSizeForLevelCap:!1,statDefaults:{playlistLoadTimeMs:500,fragBufferTimeMs:50,fragParseTimeMs:50,fragBufferCreationDelayMs:200},disableVideoCodecList:new Set([]),disableAudioCodecList:new Set([])};class Io extends x{constructor(){super(e=>this._count$.pipe(Ee(e=>0===e),ye(1),ji(void 0)).subscribe(e)),this._count$=new te(0)}do(e){this.add(),K(e).pipe(We({error:e=>this._count$.error(e)}),dt(()=>this.done())).subscribe()}add(e=1){this._count$.next(this._count$.value+e)}done(e=1){this._count$.next(this._count$.value-e)}}const wo=[".*.itunes.apple.com"],Ro={deviceName:"&xapdn=",deviceModel:"&xapdm=",language:"&xapdl=",dsid:"&xapdsid=",subs:"&xapsub="};class Ao extends an{constructor(e={}){super(),this.firstItem=!0,this.media=null,this.fatalErrorPosted=!1,this.destroyWG=new Io,this.destroy$=new Z;let t=Ao.DefaultConfig;if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");this.config=Object.assign(Object.assign({},t),e);const{config:i}=this;if(void 0!==i.liveMaxLatencyDurationCount&&i.liveMaxLatencyDurationCount<=i.liveSyncDurationCount)throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be gt "liveSyncDurationCount"');if(void 0!==i.liveMaxLatencyDuration&&(i.liveMaxLatencyDuration<=i.liveSyncDuration||void 0===i.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be gt "liveSyncDuration"');this.logger=new Ae.a,this.logger.enable(i.debug,i.debugLevel),this.config=i,this._autoLevelCapping=-1,this.trigger=function(e,...t){if(t&&t.length&&"object"!=typeof t[0])return void this.logger.warn(`[QE Critical] [EventTrigger] ${e.toString()} data[0]: ${t[0]} is not an object`)();let i={loadItemId:this.loadingItem?this.loadingItem.options.itemId:void 0,playItemId:this.playingItem?this.playingItem.options.itemId:void 0};if(t.length?t[0].itemData=i:t[0]={itemData:i},"hlsFragLoadProgress"!==e.toString()){let i="";"hlsInternalError"!==e&&"hlsError"!==e||!t.length||(i=JSON.stringify(t[0],["fatal","details","reason"])),this.logger.info(`[QE Critical] [EventTrigger] ${e.toString()} ${i}`)()}this.emit(e,e,...t)}.bind(this),void 0===this.off&&(this.off=function(e,...t){this.removeListener(e,...t)}),this.bufferChangedFn=this.onBufferChanged.bind(this),this.on(r.a.BUFFER_CHANGED,this.bufferChangedFn);const s=this.bandwidthHistoryController=new Nn(this),a=this.abrController=new i.abrController(this),n=(this.bufferController=new i.bufferController(this),this.playlistLoader=new ya(this)),o=this.fragmentLoader=new Sa(this),l=this.keyLoader=new Jr(this),d=this.networkErrorHandler=new Ks(this),h=[n,o,l,a,new Pn(this),d,s],c=this.levelController=new Hs(this,n);let u=new Rn(this);this.audioTrackController=u,h.push(u);const f=this.streamController=new In(this);this.audioStreamController=new qn(this,u);let g=new Ln(this);this.subtitleTrackController=g,h.push(g),this.subtitleStreamController=new To(this,g),this.subtitleStreamController.pipe(Xe(this.destroy$)).subscribe(),Ge(this.abrController,this.streamController,this.audioStreamController,this.bufferController).pipe(Xe(this.destroy$)).subscribe();let p=[c,f];if(this.networkControllers=p,i.timelineController){let e=this.timelineController=new i.timelineController(this);e.pipe(Xe(this.destroy$)).subscribe(),h.push(e)}const m=this.eventReporter=new Un(this);h.push(m),this.coreComponents=h,this.isValid=!0,this.cdnReferenceBaseURL=void 0,this.cdnWhiteList=new Set}static initialize(e){let t=Ao.DefaultConfig,i=Object.assign(Object.assign({},t),e);Ao.DefaultConfig=i,Ae.b.enable(i.debug,i.debugLevel),!0===i.warmupCdms&&Xr.warmupCDM()}static get version(){return"2.15.11"}static isSupported(){return (function(){try{const e=window.MediaSource||window.WebKitMediaSource,t=window.SourceBuffer||window.WebKitSourceBuffer,i=e&&"function"==typeof e.isTypeSupported&&e.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),r=!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove;return!!i&&!!r}catch(e){return!1}})()}static get Events(){return r.a}static get ErrorTypes(){return s.g}static get ErrorDetails(){return s.d}static get ErrorResponses(){return s.f}static get GaplessEvictReason(){return s.n}static get DefaultConfig(){return Ao.defaultConfig?Ao.defaultConfig:Do}static set DefaultConfig(e){Ao.defaultConfig=e}destroy(){return this._isObjectValid()?(this.logger.info("destroy")(),this.trigger(r.a.DESTROYING),this.detachMedia(),this.destroy$.next(),this.coreComponents.concat(this.networkControllers).forEach(e=>{e.destroy()}),this.setPlayingItem(null),this.setLoadingItem(null),this.removeAllListeners(),this._autoLevelCapping=-1,this.cdnReferenceBaseURL=void 0,this.cdnWhiteList.clear(),this.isValid=!1,this.bufferEndPromiseWrapper=void 0,this.destroyWG.toPromise()):Promise.resolve()}scheduleFatalError(e){return this.fatalErrorPosted?ct:(this.fatalErrorPosted=!0,X(0,y).pipe(Ie(()=>(this.trigger(r.a.ERROR,e),ct)),Xe(this.destroy$)))}get isFirstItem(){return this.firstItem}get seekInfoObs(){return this.streamController.seekInfoObs}evictItemOnFatalError(e){let t=this.isPreloadingItem&&this.playingItem.itemId!==this.loadingItem.itemId;if(t){e.escalated=s.e.Downgraded;let t=this.loadingItem;this.streamController.evictLoadingItem(this.loadingItem.startTime,Ao.GaplessEvictReason.FatalErrorWhileLoading).pipe(We(()=>{this.logger.info("evicted item due to fatal error. reloading @ "+this.loadingItem.startTime)(),this.reloadSource(t.startTime)}),Ie(()=>(this.logger.info("fatal error confirmed. trigger ITEM_EVICTED event")(),X(0,y).pipe(We(()=>this.trigger(r.a.ITEM_EVICTED,{url:t.url,evictedItemId:t.itemId,reason:s.n.FatalErrorWhileLoading}))))),Xe(this.destroy$)).subscribe()}return t}fatalErrorRequiresAction(e){return!e.escalated&&!this.evictItemOnFatalError(e)}upgradeInternalError(e){return e.escalated?ie:(e.escalated=s.e.Upgraded,this.scheduleFatalError(e))}upgradeInternalErrorIfNecessary(e){return e.escalated||this.evictItemOnFatalError(e)||(e.escalated=s.e.Upgraded,this.scheduleFatalError(e).pipe(Xe(this.destroy$)).subscribe()),e.escalated===s.e.Upgraded}attachMedia(e){this._isObjectValid()&&(this.logger.info("attachMedia")(),this.media=e,this.fatalErrorPosted=!1,this.streamController.installMediaFunctions(e),this.trigger(r.a.MEDIA_ATTACHING,{media:e}),this.bufferController.attachMedia(e,!1))}detachMedia(){this._isObjectValid()&&this.media&&(this.logger.info("detachMedia")(),this.streamController.uninstallMediaFunctions(),this.trigger(r.a.MEDIA_DETACHING),this.bufferController.detachMedia(),this.media=null)}get isPreloadingItem(){return this.config.gapless&&this.loadingItem&&Object(ke.c)(this.loadingItem.startTime)&&this.media&&this.media.buffered&&this.media.buffered.length>0}get inGaplessMode(){return this.config.gapless&&this.streamController.gaplessAllowed}cleanupItem(e){if(e&&e.cachedManifestCtx){let t=e.cachedManifestCtx;[t.levels,t.audioTracks,t.subtitleTracks].forEach(e=>{e&&e.destroy()}),e.cachedManifestCtx=void 0}}setLoadingItem(e){if(this.loadingItemInternal!==e)if(this.loadingItemInternal&&this.loadingItemInternal===this.playingItem){let e=this.loadingItemInternal.cachedManifestCtx;e&&[e.levels,e.audioTracks,e.subtitleTracks].forEach(e=>e.stopTimers())}else this.cleanupItem(this.loadingItemInternal);let t=e&&e.cachedManifestCtx;t&&[t.levels,t.audioTracks,t.subtitleTracks].forEach(e=>e.startTimers()),this.loadingItemInternal=e}get loadingItem(){return this.loadingItemInternal}setPlayingItem(e){this.playingItemInternal!==e&&this.cleanupItem(this.playingItemInternal),this.playingItemInternal=e}get playingItem(){return this.playingItemInternal}get playingItemDuration(){return this.media.duration-(Object(ke.c)(this.playingItem.startTime)?this.playingItem.startTime:0)}queueSource(e,t={}){if(!this._isObjectValid()||!this.media||!this.config.gapless)return;if(t===this.playingItem.options)return void this.logger.error("[gapless] queueSource must not reuse the options object from loadSource")();if(this.loadingItem.itemId!==this.playingItem.itemId)return void Ae.b.error(`[gapless] already enqueued. loading item ${this.loadingItem.itemId}, playing item ${this.playingItem.itemId}`)();let i=this.bufferController.totalItemDuration;this.resetLoadSource(),this.firstItem=!1,this.logger.info("[gapless] start loading next item @ "+i)(),this.loadSource(e,t,i)}dequeueSource(e=s.n.ApplicationInitiated){this._isObjectValid()&&this.media&&this.config.gapless&&this.dequeueSourceInternal(e).pipe(Xe(this.destroy$)).subscribe()}dequeueSourceInternal(e=s.n.ApplicationInitiated){return this.loadingItem.itemId!==this.playingItem.itemId?(this.logger.info("[gapless] dequeueSource "+e)(),this.streamController.dequeueSource(e)):(Ae.b.error(`[gapless] nothing to dequeue. loading item ${this.loadingItem.itemId}, playing item ${this.playingItem.itemId}`)(),$e(-1))}endSource(){this._isObjectValid()&&this.media&&this.config.gapless&&this.streamController.endSource()}get hasScoreAvailable(){return this.scoreAvailable}set hasScoreAvailable(e){this.scoreAvailable=e}get accessLog(){if(!this._isObjectValid())return;let e=this.eventReporter;return e?e.accessLog:[]}get errorLog(){if(!this._isObjectValid())return;let e=this.eventReporter;return e?e.errorLog:[]}get url(){if(this._isObjectValid())return this.playingItem?this.playingItem.url:this.loadingItem?this.loadingItem.url:void 0}_isObjectValid(){return this.isValid||this.logger.error("Hls object already destroyed")(),this.isValid}_getHostName(e){return Ne.getHostName(e)}_urlNeedsUpdate(e){if(!0===this.config.enableQueryParamsForITunes){let t=this._getHostName(e);return void 0!==wo.find(e=>new RegExp(e).exec(t))}return!1}_shouldUpdateUrlWithDeviceNameAndModel(e){let t=e.model,i=e.manufacturer;return t&&i||this.logger.warn(`Missing model/manufacturer in platformInfo model ${t} manufacturer ${i}`)(),!!t&&!!i}_updateUrlWithDeviceNameAndModel(e,t){let i,r,s=t.model,a=t.manufacturer,n=-1!==e.indexOf("?");return i=encodeURIComponent(s),r=encodeURIComponent(a),(e=n?e:e+"?")+Ro.deviceName+r+Ro.deviceModel+i}_updateUrlWithOptionsQuery(e,t){let i,r=-1!==e.indexOf("?");for(i in e=r?e:e+"?",t)t[i]?e+=Ro[i]+("subs"===i?encodeURIComponent(t[i]):t[i]):this.logger.warn(`Missing ${i} info`)();return e}_updateUrlWithQueryStrings(e,t,i){return this._shouldUpdateUrlWithDeviceNameAndModel(t)&&(e=this._updateUrlWithDeviceNameAndModel(e,t)),this._updateUrlWithOptionsQuery(e,i)}_createSessionID(){var e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,r=4294967295*Math.random()|0,s=[];for(let e=0;e<256;++e)s[e]=(e<16?"0":"")+e.toString(16);return s[255&e]+s[e>>8&255]+s[e>>16&255]+s[e>>24&255]+"-"+s[255&t]+s[t>>8&255]+"-"+s[t>>8&15|64]+s[t>>16&255]+"-"+s[63&i|128]+s[i>>8&255]+"-"+s[i>>8&255]+s[i>>16&255]+s[255&r]+s[r>>8&255]+s[r>>16&255]+s[r>>24&255]}resetLoadSource(){var e;this.logger.info("[gapless] clean up current source")(),this.streamController.resetLoadSource(),null===(e=this.audioStreamController)||void 0===e||e.resetLoadSource(),this.levelController.resetLoadSource(),this.bufferController.resetLoadSource()}loadSource(e,t={},i){if(!this._isObjectValid())return;let a;if(t.appData&&(a=t.appData.reportingAgent,this.bandwidthHistoryController&&this.bandwidthHistoryController.setServiceName(t.appData.serviceName)),this.sessionID=a?a.SessionID:this._createSessionID(),this.streamID=t.streamID,this.logger.setStreamAndSessionIDs(this.sessionID,this.streamID),this.logger.info("[QE Critical] hls player version "+Ao.version)(),"playready"===this.config.keySystemPreference&&!this.config.enablePlayReadyKeySystem){let t=new s.h(s.g.OTHER_ERROR,s.d.INTERNAL_EXCEPTION,!0,"Playready key system is not supported now");return t.url=e,void this.trigger(r.a.ERROR,t)}if(!e||!e.trim().length){let t=new s.h(s.g.OTHER_ERROR,s.d.INTERNAL_EXCEPTION,!0,"Empty loadSource url");return t.url=e,void this.trigger(r.a.ERROR,t)}if(this.config.gapless&&void 0===t.itemId){let e=new s.h(s.g.OTHER_ERROR,s.d.INTERNAL_EXCEPTION,!0,"Undefined itemId");this.trigger(r.a.ERROR,e)}else{if(e=Ne.buildAbsoluteURL(window.location.href,e,{alwaysNormalize:!0}),this.platformInfo=t.platformInfo,this._userInfo=t.userInfo,this._urlNeedsUpdate(e)){let i={language:t.language,dsid:t.dsid,subs:t.subs};e=this._updateUrlWithQueryStrings(e,this.platformInfo,i),t.inheritQuery=!1}this.loadSourceInternal(e,t,i)}}reloadSource(e){this.resetLoadSource(),this.logger.info(`[gapless] reload item ${this.playingItem.itemId} @ ${this.playingItem.startTime}, seek to ${e}; stale loading item ${this.loadingItem.itemId}`)(),this.loadSourceInternal(this.playingItem.url,this.playingItem.options,Object(ke.c)(this.playingItem.startTime)?this.playingItem.startTime:0,e)}loadSourceInternal(e,t={},i,r){let s=t&&t.itemId;if(this.playingItem&&s===this.playingItem.itemId?this.setLoadingItem(this.playingItem):(this.setLoadingItem({url:e,itemId:t.itemId,inheritQuery:Boolean(t.inheritQuery),secureStop:Boolean(t.generateSecureStop),appData:t.appData,startTime:i,options:t}),(!Object(ke.c)(i)||i<0)&&(this.logger.info("[gapless] loadSource: setting playingItem as current loadingItem")(),this.setPlayingItem(this.loadingItem),void 0===this.playingItem.startTime&&(this.playingItem.startTime=0))),this.logger.info(`[QE Critical] loadSource:${this.redactUrl(e)}, itemId:${t.itemId}`)(),this.tloadsource=performance.now(),this.loadingItem.cachedManifestCtx)this.handleParsedManifestData(this.loadingItem.cachedManifestCtx,r);else{let i=js({url:e},this.config.manifestLoadPolicy);this.playlistLoader.loadManifest(e,t,s).pipe(Ws(i,!1,this.networkErrorHandler,null),Ie(e=>this.handleManifestLoadedData(e,s)),Se(e=>(e.fatal&&this.upgradeInternalErrorIfNecessary(e),ie)),Xe(this.destroy$)).subscribe()}}handleManifestLoadedData(e,t){return this.trigger(r.a.MANIFEST_LOADED,e),K(this.levelController.parseManifestLoadedData(e)).pipe(ae(i=>{if(this.loadingItem.itemId!==t)return void this.logger.warn("[gapless] item switched before manifest parsed for "+t)();let s=e.stats;this.loadingItem.cachedManifestCtx=i,this.handleParsedManifestData(i);let a={levels:this.levels,firstLevel:this.levelController.firstLevel,audio:i.audioCodecFound,video:i.videoCodecFound,altAudio:i.altAudio,audioTracks:this.audioTracks,audioMediaSelectionGroup:i.audioMediaSelectionGroup,subtitleMediaSelectionGroup:i.subtitleMediaSelectionGroup,stats:s};if(this.trigger(r.a.MANIFEST_PARSED,a),e.isMediaPlaylist){let e=this.levels[0].details,t=this.playlistType,i={level:this.levels[0].persistentId,details:e,playlistType:t,id:this.levels[0].persistentId,stats:{trequest:s.trequest,tload:s.tload,contentType:s.contentType},livePlaylistUpdateError:!1};this.trigger(r.a.LEVEL_LOADED,i)}}),Se(e=>{let t;throw this.logger.error("manifest parse error:"+e.message)(),e instanceof s.t?t=Object.assign(Object.assign({},e),{url:this.url}):((t=new s.h(s.g.OTHER_ERROR,s.d.INTERNAL_EXCEPTION,void 0,e.message)).response=s.f.InternalError,t.url=this.url),t.fatal=!0,this.trigger(r.a.ERROR,t),e}))}handleParsedManifestData(e,t){let{levels:i,audioTracks:r,subtitleTracks:s,isMediaPlaylist:a,audioCodecFound:n,videoCodecFound:o,altAudio:l,audioMediaSelectionGroup:d,subtitleMediaSelectionGroup:h}=e;this.logger.info(`handleParsedManifestData ${i.validVariantList.length}/${r.validVariantList.length}/${s.validVariantList.length}`)();let c=i.variantList;if(this.cdnWhiteList=new Set,c.forEach(e=>{yt.isCustomUrl(e.url)||this.addCDNToWhiteList(Ne.getHostName(e.url))}),this.levelController.setVariantManager(i),this.audioTrackController){let e=this.levelController.variantManager.startingVariant.audioGroupId;this.logger.info("initial audio group "+e)(),this.audioTrackController.setTracks(r,d,e)}if(this.subtitleTrackController){let e=this.levelController.variantManager.startingVariant.subtitleGroupId;this.logger.info("initial subtitle group "+e)(),this.subtitleTrackController.setTracks(s,h,e)}o||i.variantList.length,this.streamController.startItemLoad(c,a,l,t)}handleItemTransitioned(){let e=this.playingItem?this.playingItem.itemId:void 0,t=this.loadingItem;this.logger.info(`[QE Critical] [gapless] transitioning from ${e} to ${t.itemId}`)(),this.setPlayingItem(t),this.trigger(r.a.ITEM_TRANSITIONED,{prevItemId:e,nextItemId:t.itemId,nextStartTime:this.playingItem.startTime,nextDuration:this.playingItem.totalduration})}get bufferDryPromise(){if(this.streamController.combinedBufferEmpty())return Promise.resolve();if(!this.bufferEndPromiseWrapper){this.bufferEndPromiseWrapper={};let e=new Promise((e,t)=>{this.bufferEndPromiseWrapper.resolve=e,this.bufferEndPromiseWrapper.reject=t});this.bufferEndPromiseWrapper.promise=e.then(()=>{this.bufferEndPromiseWrapper=void 0}).catch(e=>{throw this.bufferEndPromiseWrapper=void 0,e})}return this.bufferEndPromiseWrapper.promise}onBufferChanged(e,t){switch(t.reason){case on.AlmostDryWaterLevel:this.bufferEndPromiseWrapper&&this.bufferEndPromiseWrapper.resolve()}}get realCurrentTime(){if(this._isObjectValid())return this.streamController.realCurrentTime}set realCurrentTime(e){this._isObjectValid()&&this.media&&(this.streamController.realCurrentTime=e)}get iframeMode(){if(this._isObjectValid())return this.streamController.iframeMode}get effectiveRate(){return this.streamController.effectiveRate}set desiredRate(e){this.setRate(e)}get desiredRate(){return this._isObjectValid()?this.streamController.desiredRate:0}addCDNToWhiteList(e){this.cdnWhiteList.add(e)}removeCDNFromWhiteList(e){this.cdnWhiteList.delete(e)}isValidCDN(e){return this.cdnWhiteList.has(e)}hasFallBack(){return this.cdnWhiteList.size>1&&this.config.enableCDNFallback}static hasAllowedHost(e,t){return yt.isCustomUrl(e)||Ne.getHostName(e)===t}get preferredHostName(){return this.cdnReferenceBaseURL}set preferredHostName(e){this.cdnReferenceBaseURL=e}setRate(e){if(!this._isObjectValid()||!this.media)return;this.logger.info("setRate "+e)();const t=Math.abs(e);let i=[0,1];if("VOD"===this.playlistType&&i.push(8,24,48,96),!i.some(e=>e===t))return this.logger.warn(`unsupported rate(${e})`)(),-3;const r=0!==e&&1!==e;if(r&&!this.levelController.hasIframeLevels)return this.logger.warn("can't switch to iframe mode")(),-1;if(this.config.overridePlaybackRate){let e=r?2:1;try{this.media.playbackRate=e,this.logger.info("[iframes] setting playbackRate to "+e)()}catch(t){this.logger.error(`Exception when setting playbackRate=${e}: ${t.message}`)()}}return this.streamController.desiredRate=e,0}startLoad(e=-1){this._isObjectValid()&&this.media&&(this.logger.info(`Hls startLoad(${e})`)(),this.networkControllers.forEach(t=>{t.startLoad(e)}))}stopLoad(){this._isObjectValid()&&(this.logger.info("stopLoad")(),this.networkControllers.forEach(e=>{e.stopLoad()}))}setAppData(e){this._isObjectValid()&&(e&&this.eventReporter&&this.eventReporter.setAppData(e),e&&this.bandwidthHistoryController&&this.bandwidthHistoryController.setServiceName(e.serviceName))}set userInfo(e){this._isObjectValid()&&e&&(this._userInfo=e)}get userInfo(){if(this._isObjectValid())return this._userInfo}get keysystems(){if(this._isObjectValid())return this.keyLoader.keySystemController.availableKeySystems}setProtectionData(e){this._isObjectValid()&&this.keyLoader.keySystemController.initialize(e)}generateKeyRequest(e,t){this._isObjectValid()&&(this.keyLoader.keySystemController.generateRequest(e,t),this.eventReporter.notifyKeySessionEvent(li,{keyuri:e}))}setLicenseResponse(e,t){this._isObjectValid()&&this.keyLoader.keySystemController.setLicenseResponse(e,t)}registerProgramDateTime(e,t){if(!this._isObjectValid())return;this.availableProgramDateTime||(this.availableProgramDateTime=new Map);let i=new Date(e);this.availableProgramDateTime.set(i.getTime(),t)}resolvePendingSeekToDate(){if(!this._isObjectValid())return;let e=-1;return this.availableProgramDateTime&&this.availableProgramDateTime.size>0&&this.pendingSeekToDate&&(e=this.resolveProgramDateTimeToPTS(this.pendingSeekToDate)),e}resolveProgramDateTimeToPTS(e){if(!this._isObjectValid())return;let t=Array.from(this.availableProgramDateTime.keys());t.sort((function(e,t){return e-t}));let i,r=new Date("1970-01-01 00:00:00").getTime(),s=0,a=0,n=0;if(t.length){for(i=0;i<t.length;++i){let s=t[i];if(e.getTime()<s)break;r=s}if(0===i){let i=t[0],r=this.availableProgramDateTime.get(i);r>0&&(n=r-(a=(i-e.getTime())/1e3))}else n=(s=this.availableProgramDateTime.get(r))+(a=(e.getTime()-r)/1e3)}return n}seekToDate(e){if(this._isObjectValid()&&e instanceof Date&&Object(ke.c)(e.getTime()))if(this.availableProgramDateTime&&0!==this.availableProgramDateTime.size){let t=this.resolveProgramDateTimeToPTS(e);null!=t&&isFinite(t)&&(this.logger.info("adjust currentTime to date "+t)(),this.media.currentTime=t)}else this.pendingSeekToDate=e}handleResolvedUri(e,t){this._isObjectValid()&&this.trigger(r.a.UNRESOLVED_URI_LOADED,{uri:e,response:t})}redactUrl(e){return"production"===this.config.buildType?"<redacted>":e}disableAudioTrack(){!this.disabledAudioTrack&&this.audioStreamController.haveAltAudio&&(this.disabledAudioTrack=!0,this.audioStreamController.disableAudioTrack(),this.streamController.disableAudioTrack())}enableAudioTrack(e){this.disabledAudioTrack&&(this.disabledAudioTrack=!1,this.audioStreamController.enableAudioTrack(e),this.streamController.enableAudioTrack(e))}recoverMediaError(){this._isObjectValid()&&this.bufferController.resetSourceBuffers({seekToPos:this.streamController.playbackPos,cc:null})}get levels(){if(this._isObjectValid())return this.levelController.validLevels}get currentLevel(){if(this._isObjectValid())return this.streamController.currentLevel}levelWithPersistentId(e){if(this._isObjectValid())return this.levelController.getLevelWithPersistentId(e)}set currentLevel(e){this._isObjectValid()&&(this.loadLevel=e,this.streamController.immediateLevelSwitch())}get loadLevel(){if(this._isObjectValid())return this.levelController.currentVariantId}set loadLevel(e){this._isObjectValid()&&(this.levelController.manualLevel=e)}get nextLoadLevel(){if(this._isObjectValid())return this.levelController.nextLoadLevel}set nextLoadLevel(e){this._isObjectValid()&&(this.levelController.nextLoadLevel=e)}get startLevel(){if(this._isObjectValid())return this.levelController.startLevel}set startLevel(e){this._isObjectValid()&&(this.levelController.startLevel=e)}get autoLevelCapping(){if(this._isObjectValid())return this._autoLevelCapping}set autoLevelCapping(e){this._isObjectValid()&&(this._autoLevelCapping=e)}get autoLevelEnabled(){if(this._isObjectValid())return-1===this.levelController.manualLevel}get manualLevel(){if(this._isObjectValid())return this.levelController.manualLevel}get seeking(){return!!this._isObjectValid()&&this.streamController.seeking}get playbackLikelyToKeepUp(){return!!this._isObjectValid()&&this.streamController.playbackLikelyToKeepUp}get waitingForIncompatibleCCFragLoad(){return!!this._isObjectValid()&&this.streamController.isWaitingForIncompatibleCC}getLowestBitrateLevel(e){if(this._isObjectValid())return this.levelController.lowestBitrateLevel(e)}countIframesInCurrentLevel(){return this.streamController.countIframesInCurrentLevel(this.levelController.currentVariantId)}get nextAutoLevel(){if(this._isObjectValid())return 0!==this.levels.length?this.abrController.nextAutoLevel:void 0}set nextAutoLevel(e){this._isObjectValid()&&(this.abrController.nextMaxAutoLevel=e)}get sessionData(){if(this._isObjectValid())return this.playlistLoader.parsedSessionData}get liveSyncPosition(){if(this._isObjectValid())return this.streamController.liveSyncPosition}get audioTracks(){if(!this._isObjectValid())return;const e=this.audioTrackController;return e?e.validTracks:[]}get audioTrack(){if(!this._isObjectValid())return;const e=this.audioTrackController;return e?e.audioTrack:-1}get audioMediaOptions(){if(!this._isObjectValid())return;const e=this.audioTrackController;return e&&e.mediaSelectionGroup?e.mediaSelectionGroup.MediaSelectionGroupOptions:void 0}get audioSelectedPersistentID(){if(!this._isObjectValid())return;const e=this.audioTrackController;return e&&e.selectedMediaOption?e.selectedPersistentID:void 0}set audioSelectedPersistentID(e){if(!this._isObjectValid())return;const t=this.audioTrackController;t&&(t.selectedPersistentID=e)}get subtitleTracks(){if(!this._isObjectValid())return;const e=this.subtitleTrackController;return e?e.validTracks:[]}get subtitleMediaOptions(){if(!this._isObjectValid())return;const e=this.subtitleTrackController;return e&&e.mediaSelectionGroup?e.mediaSelectionGroup.MediaSelectionGroupOptions:void 0}get subtitleSelectedPersistentID(){if(!this._isObjectValid())return;const e=this.subtitleTrackController;return e&&e.selectedMediaOption?e.selectedPersistentID:void 0}set subtitleSelectedPersistentID(e){if(!this._isObjectValid())return;const t=this.subtitleTrackController;t&&(t.selectedPersistentID=e)}get currentAudioAndSubtitleGroups(){let e=this.levelController.getLevelWithPersistentId(this.currentLevel).levelInfo;if(e)return{audioGroup:e.audioGroupId,subtitleGroup:e.subtitleGroupId}}matchAudioAndSubtitleGroups(e){let t=this.levelController.getLevelWithPersistentId(e).levelInfo;t&&(this.audioStreamController.shouldDeferTrackSwitch||this.subtitleStreamController.shouldDeferTrackSwitch||(this.audioTrackController&&t.audioGroupId&&this.audioTrackController.matchAudioGroup(t.audioGroupId),this.subtitleTrackController&&t.subtitleGroupId&&this.subtitleTrackController.matchSubtitleGroup(t.subtitleGroupId)))}get selectedMediaArray(){if(!this._isObjectValid())return;let e=[],t=this.audioTrackController?this.audioTrackController.selectedMediaOption:void 0,i=this.subtitleTrackController?this.subtitleTrackController.selectedMediaOption:void 0;if(t){let i={MediaSelectionGroupMediaType:Wr.AUDIO,MediaSelectionOptionsPersistentID:t.MediaSelectionOptionsPersistentID};e.push(i)}if(i){let t=i.MediaSelectionOptionsDisplaysNonForcedSubtitles?i.MediaSelectionOptionsDisplaysNonForcedSubtitles:qr.NO,r={MediaSelectionGroupMediaType:Wr.SUBTITLE,MediaSelectionOptionsDisplaysNonForcedSubtitles:t,MediaSelectionOptionsPersistentID:i.MediaSelectionOptionsPersistentID};e.push(r)}return e}set selectedMediaArray(e){this._isObjectValid()&&e.forEach(e=>{e.MediaSelectionGroupMediaType===Wr.AUDIO||e.MediaSelectionOptionsMediaType===Wr.AUDIO?this.audioSelectedPersistentID=e.MediaSelectionOptionsPersistentID:e.MediaSelectionGroupMediaType!==Wr.SUBTITLE&&e.MediaSelectionOptionsMediaType!==Wr.SUBTITLE&&e.MediaSelectionOptionsMediaType!==Wr.CLOSEDCAPTION||(this.subtitleSelectedPersistentID=e.MediaSelectionOptionsPersistentID)})}get mediaSelectionArray(){if(!this._isObjectValid())return;let e=new Array;const t=this.subtitleTrackController,i=this.audioTrackController;return i&&i.mediaSelectionGroup&&e.push(i.mediaSelectionGroup),t&&t.mediaSelectionGroup&&e.push(t.mediaSelectionGroup),e}get subtitleDisplay(){if(!this._isObjectValid())return;const e=this.subtitleTrackController;return!!e&&e.subtitleDisplay}set subtitleDisplay(e){if(!this._isObjectValid())return;const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get hasPlaybackEverStarted(){if(this._isObjectValid())return this.streamController.playbackEverStarted}updatePlaylistAttributes(e){let t=e.type,i="VOD",r=e.live;return"EVENT"===t&&r?i="EVENT":t&&"LIVE"!==t||!r||(i="LIVE"),this.isLive=r,this.playlistType=i,{playlistType:i,isLive:r}}getHTMLTextTrack(e){let t=this.subtitleTrackController.resolveTrackId(e);return t?this.timelineController.getExistingHTMLTextTrack(t.trackInfo):void 0}}var ko=t.default=Ao}),(function(e,t,i){"use strict";i.r(t),i.d(t,"createDemuxerWorker",(function(){return n})),i.d(t,"createDecryptorWorker",(function(){return o}));var r=i(13);i.d(t,"DemuxerInline",(function(){return r.a}));var s=i(14);i.d(t,"SegmentDecryptorInline",(function(){return s.a}));const a=(e,t)=>i(25)(e,t),n=()=>a(26),o=()=>a(27)})]).default}));